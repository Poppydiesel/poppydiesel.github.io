<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.48.0/dist/umd/supabase.min.js"></script>
<script>
(function () {
  const SUPABASE_URL = "https://yaiutswdcbfwkxfqxkzy.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlhaXV0c3dkY2Jmd2t4ZnF4a3p5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1MDE2MDgsImV4cCI6MjA4MDA3NzYwOH0.HOLFxzjsZ5Ieqg0b-aTdP0hAdLsPVXL6Zjs-HgOHgc8";
  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth: { persistSession: true, detectSessionInUrl: true }
  });

  // Expected elements in your login.html:
  // <form id="loginForm">
  //   <input id="email" type="email" />
  //   <button id="btnSendLink" type="submit">Send verification link</button>
  // </form>
  // <div id="status"></div>

  const form = document.getElementById("loginForm");
  const emailEl = document.getElementById("email");
  const statusEl = document.getElementById("status");
  const btn = document.getElementById("btnSendLink");

  function setStatus(msg, type) {
    if (!statusEl) return;
    statusEl.textContent = msg || "";
    statusEl.style.color = type === "error" ? "#b3261e" : (type === "success" ? "#0f7b46" : "#6b7280");
  }

  // Respect ?next=/dashboard-secure.html etc
  const qs = new URLSearchParams(window.location.search);
  const next = qs.get("next") || "/dashboard-secure.html";

  form?.addEventListener("submit", async (e) => {
    e.preventDefault();
    setStatus("");

    const email = (emailEl?.value || "").trim().toLowerCase();
    if (!email) {
      setStatus("Please enter your email.", "error");
      return;
    }

    btn && (btn.disabled = true);
    setStatus("Sending verification link…");

    try {
      const redirectTo = `${window.location.origin}/auth-callback.html?next=${encodeURIComponent(next)}`;

      const { error } = await sb.auth.signInWithOtp({
        email,
        options: {
          emailRedirectTo: redirectTo
        }
      });

      if (error) throw error;

      setStatus("Link sent. Check your inbox (and spam). Click it to verify and continue.", "success");
    } catch (err) {
      console.error("[TBP] OTP send error:", err);
      setStatus("Couldn’t send the link. Please double-check the email and try again.", "error");
    } finally {
      btn && (btn.disabled = false);
    }
  });
})();
</script>

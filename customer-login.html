<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>TradeBotPro — Customer Login</title>

  <style>
    :root{
      --primary:#1f4e79;
      --bg:#f3f4f9;
      --text:#151820;
      --muted:#6b7280;
      --border:rgba(15,23,42,.12);
      --err:#b3261e;
      --ok:#0f7b46;
      --white:#ffffff;
    }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{background:var(--white);border-bottom:1px solid var(--border)}
    .inner{max-width:1100px;margin:0 auto;padding:14px 18px;display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
    .brand{font-weight:900}
    .muted{color:var(--muted)}
    main{max-width:1100px;margin:0 auto;padding:18px}
    .card{background:#fff;border:1px solid var(--border);border-radius:16px;padding:18px;box-shadow:0 20px 50px rgba(15,23,42,.10)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    label{display:block;font-weight:900;margin:12px 0 6px}
    input{
      width:100%;
      max-width:520px;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      font-size:16px;
      outline:none;
    }
    input:focus{border-color:rgba(31,78,121,.45); box-shadow:0 0 0 4px rgba(31,78,121,.10)}
    .btn{
      border-radius:999px;
      padding:12px 16px;
      border:1px solid var(--border);
      background:#fff;
      font-weight:900;
      cursor:pointer;
    }
    .btnPrimary{background:var(--primary);color:#fff;border-color:transparent}
    .msg{margin-top:12px;font-weight:900;white-space:pre-wrap}
    .msg.ok{color:var(--ok)}
    .msg.err{color:var(--err)}
    a{color:var(--primary);font-weight:900;text-decoration:none}
  </style>
</head>

<body>
  <header>
    <div class="inner">
      <div>
        <div class="brand">TradeBotPro</div>
        <div class="muted">Customer secure login</div>
      </div>
      <div class="row">
        <a href="index.html">Home</a>
      </div>
    </div>
  </header>

  <main>
    <div class="card">
      <h2 style="margin:0 0 6px">Get a secure login link</h2>
      <div class="muted">
        Enter the email you used to sign up. We’ll send you a secure link to access your dashboard.
        This also verifies your email for security.
      </div>

      <label for="email">Email address</label>
      <input id="email" type="email" placeholder="you@company.co.uk" autocomplete="email"/>

      <div style="margin-top:14px" class="row">
        <button id="btnSend" class="btn btnPrimary" type="button">Send secure link</button>
        <a href="client-secure-dashboard.html">Already logged in?</a>
      </div>

      <div id="msg" class="msg"></div>

      <div class="muted" style="margin-top:14px;font-size:14px;line-height:1.5">
        If you don’t receive the email within a minute, check spam/junk and try again.
      </div>
    </div>
  </main>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  const SUPABASE_URL = "https://yaiutswdcbfwkxfqxkzy.supabase.co";
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInlhaXV0c3dkY2Jmd2t4ZnF4a3p5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1MDE2MDgsImV4cCI6MjA4MDA3NzYwOH0.HOLFxzjsZ5Ieqg0b-aTdP0hAdLsPVXL6Zjs-HgOHgc8";

  const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const emailEl = document.getElementById("email");
  const btn = document.getElementById("btnSend");
  const msg = document.getElementById("msg");

  function setMsg(text, ok = false) {
    if (!msg) return;
    msg.textContent = text || "";
    msg.className = "msg " + (ok ? "ok" : "err");
    if (!text) msg.className = "msg";
  }

  function fmtAuthError(e) {
    const name = e?.name ? String(e.name) : "Auth error";
    const status = e?.status ? ` (status ${e.status})` : "";
    const message = e?.message ? String(e.message) : "Unknown error";
    return `${name}${status}: ${message}`;
  }

  // Reads ?return_to=ENCODED_URL from THIS login page URL (if present)
  function getReturnTo() {
    const qs = new URLSearchParams(location.search);
    const rt = (qs.get("return_to") || "").trim();
    if (!rt) return null;

    try {
      const decoded = decodeURIComponent(rt);
      const u = new URL(decoded, location.origin);
      if (u.origin !== location.origin) return null; // safety
      return u.toString();
    } catch (_) {
      return null;
    }
  }

  if (!btn || !emailEl) {
    console.error("[TBP] customer-login: Missing #btnSend or #email element");
  } else {
    btn.addEventListener("click", async () => {
      if (btn.disabled) return;

      try {
        const email = (emailEl.value || "").trim().toLowerCase();
        if (!email || !email.includes("@")) {
          throw new Error("Please enter a valid email address.");
        }

        btn.disabled = true;
        setMsg("Sending secure link…", true);

        const returnTo = getReturnTo();

        // Supabase will redirect to THIS after they click the email link
        const redirectUrl = new URL("client-secure-dashboard.html", location.origin);
        if (returnTo) {
          redirectUrl.searchParams.set("return_to", encodeURIComponent(returnTo));
        }

        const { error } = await sb.auth.signInWithOtp({
          email,
          options: { emailRedirectTo: redirectUrl.toString() }
        });

        if (error) throw error;

        setMsg("Secure link sent ✔\nCheck your inbox/spam and click the link to sign in.", true);
      } catch (e) {
        console.error("[TBP] customer-login error:", e);
        setMsg(fmtAuthError(e), false);
      } finally {
        btn.disabled = false;
      }
    });
  }
</script>


</body>
</html>

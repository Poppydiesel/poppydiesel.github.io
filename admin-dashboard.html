<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TradeBotPro — Control Panel (Phase 4A)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --primary-blue: #1f4e79;
      --accent-blue: #00a3ff;
      --dark-text: #1b1b1f;
      --muted-text: #6b7280;
      --bg-page: #f5f7fa;
      --bg-card: #ffffff;
      --border-subtle: #e5e7eb;
      --pill-bg: #e5f2ff;
      --pill-text: #1f4e79;
      --danger: #b91c1c;
      --warning: #b45309;
      --success: #15803d;
      --paused: #6b21a8;
      --shadow-soft: 0 10px 25px rgba(15, 23, 42, 0.08);
      --radius-lg: 16px;
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      background: radial-gradient(circle at top left, #e0f2ff 0, #f5f7fa 45%, #e5e7eb 100%);
      color: var(--dark-text);
    }

    body {
      display: flex;
      flex-direction: column;
    }

    .app-shell {
      max-width: 1280px;
      margin: 0 auto;
      padding: 24px 16px 32px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .brand-block {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-circle {
      width: 42px;
      height: 42px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #ffffff 0, #a5d8ff 25%, var(--primary-blue) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--shadow-soft);
      font-weight: 700;
      letter-spacing: 0.04em;
      color: #ffffff;
      font-size: 20px;
    }

    .brand-text h1 {
      margin: 0;
      font-size: 22px;
      font-weight: 650;
      letter-spacing: 0.03em;
      color: var(--primary-blue);
    }

    .brand-text p {
      margin: 2px 0 0;
      font-size: 13px;
      color: var(--muted-text);
    }

    .meta {
      text-align: right;
      font-size: 12px;
      color: var(--muted-text);
      display: flex;
      flex-direction: column;
      gap: 4px;
      align-items: flex-end;
    }

    .meta .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 3px 8px;
      border-radius: 999px;
      background: #e0f2fe;
      color: var(--primary-blue);
      font-weight: 500;
    }

    .meta .dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #22c55e;
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 3fr);
      gap: 18px;
      align-items: flex-start;
    }

    @media (max-width: 960px) {
      .layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      padding: 16px 18px 18px;
      border: 1px solid rgba(148, 163, 184, 0.25);
    }

    .card h2 {
      margin: 0 0 10px;
      font-size: 17px;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      color: var(--primary-blue);
    }

    .card h3 {
      margin: 10px 0 6px;
      font-size: 14px;
      font-weight: 600;
      color: var(--dark-text);
    }

    .card small {
      color: var(--muted-text);
      font-size: 12px;
    }

    .pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 4px;
    }

    .pill {
      padding: 4px 10px;
      border-radius: 999px;
      background: var(--pill-bg);
      color: var(--pill-text);
      font-size: 11px;
      font-weight: 500;
      border: 1px solid rgba(37, 99, 235, 0.18);
      white-space: nowrap;
    }

    .pill-muted {
      background: #eef2ff;
      color: #4338ca;
      border-color: #c7d2fe;
    }

    .pill-danger {
      background: #fee2e2;
      color: var(--danger);
      border-color: #fecaca;
    }

    .pill-warning {
      background: #fef3c7;
      color: var(--warning);
      border-color: #fde68a;
    }

    .pill-success {
      background: #dcfce7;
      color: var(--success);
      border-color: #bbf7d0;
    }

    .pill-paused {
      background: #f3e8ff;
      color: var(--paused);
      border-color: #e9d5ff;
    }

    /* Summary cards row */
    .summary-row {
      display: grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap: 10px;
      margin-top: 6px;
    }

    @media (max-width: 1200px) {
      .summary-row {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
    }

    @media (max-width: 720px) {
      .summary-row {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    .summary-card {
      background: #f9fafb;
      border-radius: 12px;
      padding: 8px 9px;
      border: 1px solid var(--border-subtle);
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-height: 62px;
    }

    .summary-label {
      font-size: 11px;
      color: var(--muted-text);
      text-transform: uppercase;
      letter-spacing: 0.07em;
    }

    .summary-value {
      font-size: 18px;
      font-weight: 650;
      color: var(--dark-text);
    }

    .summary-caption {
      font-size: 11px;
      color: var(--muted-text);
    }

    /* Filters */
    .filters {
      margin-top: 12px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .filters label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--muted-text);
    }

    .filters select,
    .filters input[type="search"] {
      font-size: 12px;
      padding: 5px 8px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: #ffffff;
      min-width: 130px;
      outline: none;
    }

    .filters input[type="search"] {
      min-width: 170px;
    }

    /* Table */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      font-size: 12px;
    }

    thead {
      position: sticky;
      top: 0;
      background: #f9fafb;
      z-index: 1;
    }

    th, td {
      text-align: left;
      padding: 6px 4px;
      border-bottom: 1px solid #e5e7eb;
    }

    th {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--muted-text);
    }

    tbody tr {
      cursor: pointer;
      transition: background 0.12s ease;
    }

    tbody tr:hover {
      background: #eef2ff;
    }

    tbody tr.selected {
      background: #ddeafe;
    }

    .cell-pill {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      font-size: 11px;
      gap: 4px;
    }

    .cell-pill span.dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #9ca3af;
    }

    .cell-pill.live span.dot {
      background: #22c55e;
    }

    .cell-pill.trial span.dot {
      background: #0ea5e9;
    }

    .cell-pill.cancelled span.dot {
      background: #ef4444;
    }

    .cell-pill.paused span.dot {
      background: #a855f7;
    }

    .cell-pill.attention span.dot {
      background: #f97316;
    }

    .muted-text {
      color: var(--muted-text);
    }

    .nowrap {
      white-space: nowrap;
    }

    /* Detail pane */
    .detail-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px 14px;
      margin-top: 6px;
    }

    @media (max-width: 720px) {
      .detail-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .detail-field {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .detail-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--muted-text);
    }

    .detail-value {
      font-size: 13px;
      color: var(--dark-text);
      word-break: break-word;
    }

    .detail-mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      color: #4b5563;
    }

    .detail-section {
      margin-top: 10px;
      padding-top: 8px;
      border-top: 1px dashed var(--border-subtle);
    }

    .detail-section p {
      margin: 4px 0;
      font-size: 13px;
    }

    /* Status mix placeholder */
    .status-mix {
      margin-top: 10px;
      border-top: 1px dashed var(--border-subtle);
      padding-top: 8px;
      font-size: 12px;
      color: var(--muted-text);
    }

    .status-mix-list {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }

    .status-mix-item {
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px dashed #d1d5db;
      background: #f9fafb;
    }

    .status-mix-item strong {
      font-weight: 600;
      margin-right: 4px;
    }

    /* Loading / error text */
    .inline-note {
      font-size: 12px;
      color: var(--muted-text);
      margin-top: 4px;
    }

    .inline-note.error {
      color: var(--danger);
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header>
      <div class="brand-block">
        <div class="logo-circle">TB</div>
        <div class="brand-text">
          <h1>TradeBotPro Control Panel</h1>
          <p>Signups, statuses &amp; setup at a glance (Phase 4A – read-only)</p>
        </div>
      </div>
      <div class="meta">
        <div class="badge">
          <span class="dot"></span>
          Internal use only · v4A
        </div>
        <span>Data source: Supabase · <span id="last-refresh">Never loaded</span></span>
      </div>
    </header>

    <div class="layout">
      <!-- LEFT: Signups overview -->
      <section class="card" aria-label="Signups overview">
        <h2>
          Signups overview
          <small id="overview-loading" class="inline-note">Loading signups from Supabase…</small>
        </h2>

        <div id="overview-error" class="inline-note error" style="display:none;">
          Something went wrong loading signups. Check the browser console if needed.
        </div>

        <div class="summary-row" aria-live="polite">
          <div class="summary-card">
            <div class="summary-label">Total signups</div>
            <div class="summary-value" id="summary-total">–</div>
            <div class="summary-caption">All time</div>
          </div>
          <div class="summary-card">
            <div class="summary-label">Pending setup</div>
            <div class="summary-value" id="summary-pending">–</div>
            <div class="summary-caption">pending_setup = true</div>
          </div>
          <div class="summary-card">
            <div class="summary-label">Need attention</div>
            <div class="summary-value" id="summary-attention">–</div>
            <div class="summary-caption">account_status ≠ OK or pending</div>
          </div>
          <div class="summary-card">
            <div class="summary-label">Live / active</div>
            <div class="summary-value" id="summary-live">–</div>
            <div class="summary-caption">plan_status = live</div>
          </div>
          <div class="summary-card">
            <div class="summary-label">Paused / on break</div>
            <div class="summary-value" id="summary-paused">–</div>
            <div class="summary-caption">plan_status = paused</div>
          </div>
        </div>

        <!-- Filters -->
        <div class="filters" style="margin-top: 14px;">
          <label for="filter-plan">Plan</label>
          <select id="filter-plan">
            <option value="all">All plans</option>
            <option value="trial">Trial</option>
            <option value="live">Live</option>
            <option value="paused">Paused</option>
            <option value="cancelled">Cancelled</option>
          </select>

          <label for="filter-account">Account</label>
          <select id="filter-account">
            <option value="all">All account states</option>
            <option value="ok">OK</option>
            <option value="pause">Pause / on break</option>
            <option value="churn">Churn risk</option>
            <option value="blocked">Blocked</option>
            <option value="other">Other</option>
          </select>

          <label for="filter-trade">Trade</label>
          <select id="filter-trade">
            <option value="all">All trades</option>
            <option value="plumbing">Plumbing &amp; Heating</option>
            <option value="heating">Heating only</option>
            <option value="general">General plumbing</option>
            <option value="other">Other / misc</option>
          </select>

          <input id="filter-search" type="search" placeholder="Search name, email, postcode…" />
        </div>

        <!-- Table -->
        <div style="margin-top: 10px; max-height: 420px; overflow: auto; border-radius: 12px; border: 1px solid #e5e7eb; background:#fafafa;">
          <table aria-label="Signups table">
            <thead>
              <tr>
                <th>Business &amp; contact</th>
                <th>Trade</th>
                <th>Postcode</th>
                <th>Plan</th>
                <th>Setup</th>
                <th>Account</th>
              </tr>
            </thead>
            <tbody id="signups-body">
              <tr>
                <td colspan="6" class="muted-text">Loading…</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- RIGHT: Selected signup detail -->
      <section class="card" aria-label="Selected signup">
        <h2>Selected signup <small id="selected-label">(none selected)</small></h2>
        <p class="inline-note">
          Choose a signup on the left to see full details here. This is read-only for now –
          Phase 4B will add buttons for changing statuses, pausing, etc.
        </p>

        <div class="detail-grid">
          <div class="detail-field">
            <span class="detail-label">Business name</span>
            <span class="detail-value" id="detail-business">–</span>
          </div>
          <div class="detail-field">
            <span class="detail-label">Trade type</span>
            <span class="detail-value" id="detail-trade">–</span>
          </div>
          <div class="detail-field">
            <span class="detail-label">Contact name</span>
            <span class="detail-value" id="detail-contact">–</span>
          </div>
          <div class="detail-field">
            <span class="detail-label">Owner name</span>
            <span class="detail-value" id="detail-owner">–</span>
          </div>
          <div class="detail-field">
            <span class="detail-label">Base postcode</span>
            <span class="detail-value" id="detail-postcode">–</span>
          </div>
          <div class="detail-field">
            <span class="detail-label">Website</span>
            <span class="detail-value" id="detail-website">–</span>
          </div>
        </div>

        <div class="detail-section">
          <h3>Status &amp; plan</h3>
          <div class="pill-row">
            <span class="pill" id="detail-plan-pill">Plan: –</span>
            <span class="pill-muted" id="detail-setup-pill">Setup: –</span>
            <span class="pill-warning" id="detail-account-pill">Account: –</span>
          </div>
        </div>

        <div class="detail-section">
          <h3>Pricing signals</h3>
          <div class="detail-grid">
            <div class="detail-field">
              <span class="detail-label">Call-out fee</span>
              <span class="detail-value" id="detail-callout">–</span>
            </div>
            <div class="detail-field">
              <span class="detail-label">First hour</span>
              <span class="detail-value" id="detail-first-hour">–</span>
            </div>
            <div class="detail-field">
              <span class="detail-label">Hourly rate</span>
              <span class="detail-value" id="detail-hourly">–</span>
            </div>
            <div class="detail-field">
              <span class="detail-label">Boiler service from</span>
              <span class="detail-value" id="detail-boiler">–</span>
            </div>
            <div class="detail-field">
              <span class="detail-label">Quote minimum</span>
              <span class="detail-value" id="detail-quote-min">–</span>
            </div>
          </div>
        </div>

        <div class="detail-section">
          <h3>What they want from the AI</h3>
          <div class="detail-field">
            <span class="detail-label">Services summary</span>
            <span class="detail-value" id="detail-services">–</span>
          </div>
          <div class="detail-field">
            <span class="detail-label">AI style notes</span>
            <span class="detail-value" id="detail-style">–</span>
          </div>
        </div>

        <div class="detail-section">
          <h3>System fields</h3>
          <div class="detail-grid">
            <div class="detail-field">
              <span class="detail-label">Created at</span>
              <span class="detail-value" id="detail-created">–</span>
            </div>
            <div class="detail-field">
              <span class="detail-label">Raw ID</span>
              <span class="detail-value detail-mono" id="detail-id">–</span>
            </div>
          </div>
        </div>

        <div class="status-mix">
          <strong>Assistant suggestions (Phase 4C preview)</strong>
          <p class="inline-note">
            Later we’ll plug the AI in here to suggest next actions for each signup (follow-up,
            onboarding steps, issues to fix, etc.).
          </p>

          <div class="status-mix-list" id="status-mix">
            <!-- Filled from JS: e.g. Live: 3, Trial: 1, Paused: 1 -->
          </div>
        </div>
      </section>
    </div>
  </div>

  <script type="module">
    // 1) CONFIG – FILL THESE IN WITH YOUR REAL VALUES (same as the signup form)
    const SUPABASE_URL = "https://yaiutswdcbfwkxfqxkzy.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlhaXV0c3dkY2Jmd2t4ZnF4a3p5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1MDE2MDgsImV4cCI6MjA4MDA3NzYwOH0.HOLFxzjsZ5Ieqg0b-aTdP0hAdLsPVXL6Zjs-HgOHgc8";

    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const overviewLoadingEl = document.getElementById('overview-loading');
    const overviewErrorEl = document.getElementById('overview-error');
    const lastRefreshEl = document.getElementById('last-refresh');
    const signupsBody = document.getElementById('signups-body');
    const selectedLabel = document.getElementById('selected-label');

    // Summary elements
    const summaryTotal = document.getElementById('summary-total');
    const summaryPending = document.getElementById('summary-pending');
    const summaryAttention = document.getElementById('summary-attention');
    const summaryLive = document.getElementById('summary-live');
    const summaryPaused = document.getElementById('summary-paused');

    // Filters
    const filterPlan = document.getElementById('filter-plan');
    const filterAccount = document.getElementById('filter-account');
    const filterTrade = document.getElementById('filter-trade');
    const filterSearch = document.getElementById('filter-search');

    // Detail elements
    const detailBusiness = document.getElementById('detail-business');
    const detailTrade = document.getElementById('detail-trade');
    const detailContact = document.getElementById('detail-contact');
    const detailOwner = document.getElementById('detail-owner');
    const detailPostcode = document.getElementById('detail-postcode');
    const detailWebsite = document.getElementById('detail-website');

    const detailPlanPill = document.getElementById('detail-plan-pill');
    const detailSetupPill = document.getElementById('detail-setup-pill');
    const detailAccountPill = document.getElementById('detail-account-pill');

    const detailCallout = document.getElementById('detail-callout');
    const detailFirstHour = document.getElementById('detail-first-hour');
    const detailHourly = document.getElementById('detail-hourly');
    const detailBoiler = document.getElementById('detail-boiler');
    const detailQuoteMin = document.getElementById('detail-quote-min');

    const detailServices = document.getElementById('detail-services');
    const detailStyle = document.getElementById('detail-style');
    const detailCreated = document.getElementById('detail-created');
    const detailId = document.getElementById('detail-id');

    const statusMixEl = document.getElementById('status-mix');

    let allSignups = [];
    let currentSelectedId = null;

    function normalise(str) {
      return (str || '').toString().trim().toLowerCase();
    }

    function formatMoney(value) {
      if (value === null || value === undefined || value === '') return '–';
      const num = Number(value);
      if (Number.isNaN(num)) return value;
      return `£${num.toFixed(2).replace(/\.00$/, '')}`;
    }

    function formatDate(value) {
      if (!value) return '–';
      const d = new Date(value);
      if (Number.isNaN(d.getTime())) return value;
      return d.toLocaleString('en-GB', {
        year: 'numeric',
        month: 'short',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function inferTradeBucket(trade) {
      const t = normalise(trade);
      if (!t) return 'other';
      if (t.includes('plumb') && t.includes('heat')) return 'plumbing';
      if (t.includes('heat') || t.includes('boiler')) return 'heating';
      if (t.includes('plumb')) return 'general';
      return 'other';
    }

    function isPauseAccountStatus(accountStatus) {
      const a = normalise(accountStatus);
      return a.includes('pause');
    }

    function computeSummary(signups) {
      const total = signups.length;
      const pending = signups.filter(s => !!s.pending_setup).length;
      const live = signups.filter(s => normalise(s.plan_status) === 'live').length;
      const paused = signups.filter(s => normalise(s.plan_status) === 'paused' || isPauseAccountStatus(s.account_status)).length;
      const attention = signups.filter(s => {
        const acc = normalise(s.account_status);
        if (s.pending_setup) return true;
        if (!acc || acc === 'ok') return false;
        return true;
      }).length;

      summaryTotal.textContent = total;
      summaryPending.textContent = pending;
      summaryLive.textContent = live;
      summaryPaused.textContent = paused;
      summaryAttention.textContent = attention;
    }

    function computeStatusMix(signups) {
      const counts = new Map();

      for (const s of signups) {
        const key = normalise(s.plan_status) || 'unspecified';
        counts.set(key, (counts.get(key) || 0) + 1);
      }

      statusMixEl.innerHTML = '';
      if (!signups.length) {
        const span = document.createElement('span');
        span.textContent = 'No signups loaded yet.';
        statusMixEl.appendChild(span);
        return;
      }

      for (const [key, count] of counts.entries()) {
        const item = document.createElement('div');
        item.className = 'status-mix-item';
        const label = key === 'unspecified' ? 'Unspecified' : key[0].toUpperCase() + key.slice(1);
        item.innerHTML = `<strong>${label}:</strong> ${count}`;
        statusMixEl.appendChild(item);
      }
    }

    function applyFilters() {
      const planValue = filterPlan.value;
      const accountValue = filterAccount.value;
      const tradeValue = filterTrade.value;
      const searchValue = normalise(filterSearch.value);

      return allSignups.filter(s => {
        const plan = normalise(s.plan_status);
        const account = normalise(s.account_status);
        const tradeBucket = inferTradeBucket(s.trade_type);

        // Plan filter
        if (planValue !== 'all') {
          if (planValue === 'paused') {
            if (plan !== 'paused' && !isPauseAccountStatus(account)) return false;
          } else if (plan !== planValue) {
            return false;
          }
        }

        // Account filter
        if (accountValue !== 'all') {
          if (accountValue === 'ok') {
            if (account !== 'ok') return false;
          } else if (accountValue === 'pause') {
            if (!isPauseAccountStatus(account)) return false;
          } else if (accountValue === 'churn') {
            if (!account.includes('churn')) return false;
          } else if (accountValue === 'blocked') {
            if (!account.includes('blocked')) return false;
          } else {
            // other: not ok, not blank
            if (!account || account === 'ok') return false;
          }
        }

        // Trade filter
        if (tradeValue !== 'all') {
          const bucket = tradeBucket;
          if (tradeValue === 'plumbing' && bucket !== 'plumbing') return false;
          if (tradeValue === 'heating' && bucket !== 'heating') return false;
          if (tradeValue === 'general' && bucket !== 'general') return false;
          if (tradeValue === 'other' && bucket !== 'other') return false;
        }

        // Search filter
        if (searchValue) {
          const haystack = normalise(
            (s.business_name || '') +
            ' ' + (s.contact_name || '') +
            ' ' + (s.owner_name || '') +
            ' ' + (s.email || '') +
            ' ' + (s.phone || '') +
            ' ' + (s.base_postcode || '')
          );
          if (!haystack.includes(searchValue)) return false;
        }

        return true;
      });
    }

    function renderTable(signups) {
      signupsBody.innerHTML = '';

      if (!signups.length) {
        const row = document.createElement('tr');
        const cell = document.createElement('td');
        cell.colSpan = 6;
        cell.className = 'muted-text';
        cell.textContent = 'No signups match the current filters.';
        row.appendChild(cell);
        signupsBody.appendChild(row);
        return;
      }

      for (const s of signups) {
        const row = document.createElement('tr');
        row.dataset.id = s.id;

        // Business & contact
        const businessCell = document.createElement('td');
        const name = s.business_name || '(no business name)';
        const contact = s.contact_name || s.owner_name || '';
        const email = s.email || '';
        businessCell.innerHTML = `
          <div class="nowrap"><strong>${name}</strong></div>
          <div class="muted-text">${contact || '(no contact name)'}</div>
          <div class="muted-text">${email}</div>
        `;
        row.appendChild(businessCell);

        // Trade
        const tradeCell = document.createElement('td');
        tradeCell.textContent = s.trade_type || '–';
        row.appendChild(tradeCell);

        // Postcode
        const pcCell = document.createElement('td');
        pcCell.textContent = s.base_postcode || '–';
        row.appendChild(pcCell);

        // Plan
        const planCell = document.createElement('td');
        const planNorm = normalise(s.plan_status);
        let planClass = '';
        if (planNorm === 'live') planClass = 'live';
        else if (planNorm === 'trial') planClass = 'trial';
        else if (planNorm === 'cancelled') planClass = 'cancelled';
        else if (planNorm === 'paused') planClass = 'paused';

        planCell.innerHTML = `
          <span class="cell-pill ${planClass}">
            <span class="dot"></span>
            ${s.plan_status || '–'}
          </span>
        `;
        row.appendChild(planCell);

        // Setup
        const setupCell = document.createElement('td');
        const pending = !!s.pending_setup;
        setupCell.innerHTML = pending
          ? '<span class="pill-warning">Pending</span>'
          : '<span class="pill-success">Ready</span>';
        row.appendChild(setupCell);

        // Account
        const accountCell = document.createElement('td');
        const accNorm = normalise(s.account_status);
        let accClass = '';
        if (isPauseAccountStatus(accNorm)) accClass = 'pill-paused';
        else if (!accNorm || accNorm === 'ok') accClass = 'pill-success';
        else accClass = 'pill-danger';

        accountCell.innerHTML = `
          <span class="pill ${accClass}">
            ${s.account_status || 'OK'}
          </span>
        `;
        row.appendChild(accountCell);

        row.addEventListener('click', () => {
          currentSelectedId = s.id;
          for (const r of signupsBody.querySelectorAll('tr')) {
            r.classList.toggle('selected', r.dataset.id === currentSelectedId);
          }
          renderDetail(s);
        });

        signupsBody.appendChild(row);
      }

      // If we had a previously selected row that still exists, keep it selected
      if (currentSelectedId) {
        const existing = signups.find(s => s.id === currentSelectedId);
        if (existing) {
          const row = signupsBody.querySelector(`tr[data-id="${currentSelectedId}"]`);
          if (row) {
            row.classList.add('selected');
            renderDetail(existing);
          }
        }
      }
    }

    function renderDetail(s) {
      selectedLabel.textContent = s.business_name || '(no business name)';

      detailBusiness.textContent = s.business_name || '–';
      detailTrade.textContent = s.trade_type || '–';
      detailContact.textContent = s.contact_name || '–';
      detailOwner.textContent = s.owner_name || '–';
      detailPostcode.textContent = s.base_postcode || '–';

      if (s.website_url) {
        const url = s.website_url;
        detailWebsite.innerHTML = `<a href="${url}" target="_blank" rel="noreferrer">${url}</a>`;
      } else {
        detailWebsite.textContent = '–';
      }

      const plan = s.plan_status || '–';
      const account = s.account_status || 'OK';
      const pending = !!s.pending_setup;

      detailPlanPill.textContent = `Plan: ${plan}`;
      detailSetupPill.textContent = pending ? 'Setup: Pending' : 'Setup: Ready';
      detailAccountPill.textContent = `Account: ${account}`;

      // Pricing
      detailCallout.textContent = formatMoney(s.callout_fee);
      detailFirstHour.textContent = formatMoney(s.first_hour_rate);
      detailHourly.textContent = formatMoney(s.hourly_rate);
      detailBoiler.textContent = formatMoney(s.boiler_service_from);
      detailQuoteMin.textContent = formatMoney(s.quote_minimum);

      // AI texts
      detailServices.textContent = s.services_summary || '–';
      detailStyle.textContent = s.ai_style_notes || '–';

      // System
      detailCreated.textContent = formatDate(s.created_at);
      detailId.textContent = s.id || '–';
    }

    async function loadSignups() {
      overviewLoadingEl.style.display = 'inline';
      overviewErrorEl.style.display = 'none';

      const { data, error } = await supabase
        .from('tradebotpro_signups')
        .select(`
          id,
          created_at,
          business_name,
          owner_name,
          contact_name,
          email,
          phone,
          trade_type,
          base_postcode,
          website_url,
          plan_status,
          pending_setup,
          account_status,
          account_status_reason,
          callout_fee,
          first_hour_rate,
          hourly_rate,
          boiler_service_from,
          quote_minimum,
          services_summary,
          ai_style_notes,
          is_active
        `)
        .order('created_at', { ascending: false });

      overviewLoadingEl.style.display = 'none';

      if (error) {
        console.error('Error loading signups from Supabase:', error);
        overviewErrorEl.style.display = 'block';
        signupsBody.innerHTML = `
          <tr>
            <td colspan="6" class="muted-text">Error loading signups. See console for details.</td>
          </tr>
        `;
        return;
      }

      allSignups = data || [];
      const filtered = applyFilters();
      computeSummary(allSignups);
      computeStatusMix(allSignups);
      renderTable(filtered);

      lastRefreshEl.textContent = new Date().toLocaleString('en-GB', {
        year: 'numeric',
        month: 'short',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });

      // Auto-select first record if available
      if (allSignups.length && !currentSelectedId) {
        currentSelectedId = allSignups[0].id;
        const firstRow = signupsBody.querySelector('tr[data-id]');
        if (firstRow) {
          firstRow.classList.add('selected');
          renderDetail(allSignups[0]);
        }
      }
    }

    // Hook up filters
    for (const el of [filterPlan, filterAccount, filterTrade]) {
      el.addEventListener('change', () => {
        const filtered = applyFilters();
        renderTable(filtered);
      });
    }

    filterSearch.addEventListener('input', () => {
      const filtered = applyFilters();
      renderTable(filtered);
    });

    // Initial load
    loadSignups();

    // Optional: refresh every 60s if the tab is visible
    setInterval(() => {
      if (!document.hidden) {
        loadSignups();
      }
    }, 60000);
  </script>
</body>
</html>

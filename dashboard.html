<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TradeBotPro — Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      --primary-blue:#1f4e79;
      --accent-blue:#00a3ff;
      --dark-text:#1b1b1f;
      --light-bg:#f5f7fa;
      --white:#ffffff;

      --card:#ffffff;
      --border:rgba(0,0,0,0.12);
      --shadow:0 8px 24px rgba(0,0,0,0.08);
      --radius:16px;
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      background:var(--light-bg);
      color:var(--dark-text);
      line-height:1.5;
    }

    header{
      padding:18px 16px;
      background:#fff;
      border-bottom:1px solid var(--border);
    }
    header .wrap{
      max-width:1200px;
      margin:0 auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:800;
      color:var(--primary-blue);
      letter-spacing:.2px;
    }
    .pill{
      padding:6px 10px;
      border:1px solid var(--border);
      border-radius:999px;
      background:#fff;
      font-weight:800;
      font-size:12px;
      white-space:nowrap;
    }
    .header-right{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    main{
      max-width:1200px;
      margin:18px auto;
      padding:0 16px 40px;
      display:grid;
      grid-template-columns: 360px 1fr;
      gap:16px;
    }
    @media (max-width:980px){
      main{ grid-template-columns:1fr; }
    }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
    }

    .card h2{
      margin:0 0 12px;
      font-size:16px;
      color:var(--primary-blue);
      letter-spacing:.2px;
    }

    .muted{
      font-size:12px;
      color:rgba(0,0,0,0.55);
      line-height:1.5;
      margin:8px 0 0;
    }

    input{
      width:100%;
      padding:11px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#fff;
      outline:none;
      font-size:14px;
    }

    .status-boxes{
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
      margin-top:10px;
    }

    .status-box{
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
      background:#fff;
      cursor:pointer;
      transition:transform .06s ease, box-shadow .06s ease, outline-color .06s ease;
    }
    .status-box:hover{
      box-shadow:0 6px 18px rgba(0,0,0,0.08);
      transform:translateY(-1px);
    }
    .status-box.active{
      outline:2px solid rgba(31,78,121,0.55);
    }
    .status-box .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .status-box .name{
      font-weight:900;
      font-size:14px;
      color:rgba(0,0,0,0.82);
    }
    .status-box .count{
      font-weight:900;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      font-size:13px;
    }

    .search{ margin-top:12px; }

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border-radius:14px;
      border:1px solid var(--border);
      background:#fff;
    }
    th, td{
      padding:12px 10px;
      border-bottom:1px solid rgba(0,0,0,0.08);
      font-size:14px;
      vertical-align:top;
    }
    th{
      text-align:left;
      font-size:12px;
      letter-spacing:.4px;
      text-transform:uppercase;
      color:rgba(0,0,0,0.6);
      background:#fafbfc;
    }
    tr:last-child td{ border-bottom:none; }

    .tag{
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      font-weight:800;
      font-size:12px;
      white-space:nowrap;
    }

    button{
      border:none;
      border-radius:12px;
      padding:11px 14px;
      font-weight:900;
      cursor:pointer;
      font-size:13px;
    }
    .btn-primary{
      background:var(--primary-blue);
      color:#fff;
    }
    .btn-outline{
      background:#fff;
      border:1px solid var(--border);
      color:var(--dark-text);
    }

    .top-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="brand">TradeBotPro — Dashboard</div>
    <div class="header-right">
      <div class="pill" id="pillFilter">Filter: All</div>
      <!-- ✅ NEW CUSTOMER BUTTON -->
      <button class="btn-outline" id="btnNew" type="button">New customer</button>
    </div>
  </div>
</header>

<main>
  <aside class="card">
    <h2>Onboarding stages</h2>
    <div class="status-boxes" id="statusBoxes"></div>

    <div class="search">
      <input id="search" placeholder="Search name, email, phone, postcode…" />
    </div>

    <p class="muted">Click a stage box to filter. Click again to clear.</p>
  </aside>

  <section class="card">
    <div class="top-row">
      <h2 style="margin:0;">Customers</h2>
      <div class="pill" id="pillCount">0 customers</div>
    </div>
    <div id="tableWrap"></div>
  </section>
</main>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

 window.SUPABASE_URL = "https://yaiutswdcbfwkxfqxkzy.supabase.co";  // <--- YOUR URL in quotes
  window.SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlhaXV0c3dkY2Jmd2t4ZnF4a3p5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1MDE2MDgsImV4cCI6MjA4MDA3NzYwOH0.HOLFxzjsZ5Ieqg0b-aTdP0hAdLsPVXL6Zjs-HgOHgc8";  
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const ONBOARDING_STATUSES = [
    "New Signup",
    "Demo Booked",
    "Demo Completed",
    "WhatsApp Connected",
    "Flows Built",
    "Calendar Linked",
    "Payments Connected",
    "Live",
    "Paused",
    "Closed / Not Proceeding"
  ];

  const statusBoxesEl = document.getElementById("statusBoxes");
  const tableWrap = document.getElementById("tableWrap");
  const pillFilter = document.getElementById("pillFilter");
  const pillCount = document.getElementById("pillCount");
  const searchEl = document.getElementById("search");
  const btnNew = document.getElementById("btnNew");

  let currentStatusFilter = null;
  let searchTerm = "";

  function esc(s){
    return (s ?? "").toString().replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }

  function renderStatusBoxes(counts){
    statusBoxesEl.innerHTML = "";
    for (const status of ONBOARDING_STATUSES){
      const count = counts[status] || 0;

      const box = document.createElement("div");
      box.className = "status-box" + (currentStatusFilter === status ? " active" : "");
      box.innerHTML = `
        <div class="row">
          <div class="name">${esc(status)}</div>
          <div class="count">${count}</div>
        </div>
      `;

      box.onclick = () => {
        currentStatusFilter = (currentStatusFilter === status) ? null : status;
        pillFilter.textContent = "Filter: " + (currentStatusFilter || "All");
        loadAll();
      };

      statusBoxesEl.appendChild(box);
    }
  }

  function renderTable(rows){
    pillCount.textContent = `${rows.length} customer${rows.length === 1 ? "" : "s"}`;

    tableWrap.innerHTML = `
      <table>
        <thead>
          <tr>
            <th>Business</th>
            <th>Contact</th>
            <th>Status</th>
            <th>Lead Source</th>
            <th>Updated</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          ${rows.map(r => `
            <tr>
              <td>
                <div style="font-weight:900">${esc(r.business_name || "—")}</div>
                <div class="muted">${esc(r.trade_type || "")}</div>
              </td>
              <td>
                <div>${esc(r.contact_name || r.owner_name || "—")}</div>
                <div class="muted">${esc(r.email || "")}</div>
                <div class="muted">${esc(r.phone || r.whatsapp_number || "")}</div>
                <div class="muted">${esc(r.base_postcode || "")}</div>
              </td>
              <td><span class="tag">${esc(r.onboarding_status || "New Signup")}</span></td>
              <td><span class="tag">${esc(r.lead_source || "—")}</span></td>
              <td class="muted">${esc(r.updated_at ? new Date(r.updated_at).toLocaleString() : "—")}</td>
              <td style="text-align:right">
                <button class="btn-primary" onclick="window.open('app.html?id=${esc(r.id)}','_blank')">Open in wizard</button>
              </td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    `;
  }

  async function loadCounts(){
    const { data, error } = await supabase.from("customers").select("onboarding_status");
    if (error){ console.error("Load counts error:", error); return {}; }

    const counts = {};
    for (const row of (data || [])){
      const s = row.onboarding_status || "New Signup";
      counts[s] = (counts[s] || 0) + 1;
    }
    for (const s of ONBOARDING_STATUSES) counts[s] ||= 0;
    return counts;
  }

  async function loadCustomers(){
    let q = supabase.from("customers").select("*").order("updated_at", { ascending:false });
    if (currentStatusFilter) q = q.eq("onboarding_status", currentStatusFilter);

    const { data, error } = await q;
    if (error){ console.error("Load customers error:", error); return []; }

    const rows = data || [];
    if (!searchTerm) return rows;

    const t = searchTerm.toLowerCase();
    return rows.filter(r => {
      const blob = [
        r.business_name, r.trade_type, r.contact_name, r.owner_name,
        r.email, r.phone, r.whatsapp_number, r.base_postcode,
        r.lead_source, r.onboarding_status
      ].join(" ").toLowerCase();
      return blob.includes(t);
    });
  }

  async function loadAll(){
    const [counts, customers] = await Promise.all([loadCounts(), loadCustomers()]);
    renderStatusBoxes(counts);
    renderTable(customers);
  }

  searchEl.oninput = () => { searchTerm = searchEl.value.trim(); loadAll(); };

  // ✅ New customer: open wizard without id (it will create on first autosave)
  btnNew.onclick = () => window.open("app.html", "_blank");

  loadAll();
</script>

</body>
</html>

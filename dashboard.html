<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TradeBotPro — Client Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta
    name="description"
    content="TradeBotPro internal client onboarding dashboard."
  />

  <style>
    :root {
      --primary-blue: #1f4e79;
      --accent-blue: #00a3ff;
      --dark-text: #151820;
      --muted-text: #6b7280;
      --light-bg: #f3f4f9;
      --white: #ffffff;
      --border-subtle: rgba(15, 23, 42, 0.12);
      --success-green: #0f7b46;
      --error-red: #b3261e;
      --chip-bg: #eef2ff;
      --chip-border: rgba(37, 99, 235, 0.3);
    }

    * {
      box-sizing: border-box;
    }

    html {
      scroll-behavior: smooth;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      background: radial-gradient(circle at top left, #e0ebff 0, #f3f4f9 40%, #fdfdfd 100%);
      color: var(--dark-text);
      line-height: 1.5;
    }

    a {
      color: inherit;
      text-decoration: none;
    }

    /* PAGE LAYOUT */

    .page {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      border-bottom: 1px solid rgba(15, 23, 42, 0.06);
      background: rgba(248, 250, 252, 0.96);
      backdrop-filter: blur(6px);
      position: sticky;
      top: 0;
      z-index: 20;
    }

    .header-inner {
      max-width: 1100px;
      margin: 0 auto;
      padding: 0.6rem 1.25rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
    }

    .logo-wrap {
      display: flex;
      align-items: center;
      gap: 0.6rem;
    }

    .logo-icon {
      width: 30px;
      height: 30px;
      border-radius: 9px;
      background: var(--primary-blue);
      position: relative;
    }

    .logo-icon::before,
    .logo-icon::after {
      content: "";
      position: absolute;
      background: var(--white);
      border-radius: 4px;
    }

    .logo-icon::before {
      width: 11px;
      height: 17px;
      left: 7px;
      top: 6px;
    }

    .logo-icon::after {
      width: 6px;
      height: 11px;
      right: 7px;
      top: 9px;
    }

    .logo-main {
      font-weight: 700;
      font-size: 1rem;
      color: var(--primary-blue);
    }

    .logo-tag {
      font-size: 0.75rem;
      color: var(--muted-text);
    }

    .header-note {
      font-size: 0.75rem;
      color: var(--muted-text);
    }

    .header-note strong {
      color: var(--primary-blue);
      font-weight: 600;
    }

    main {
      flex: 1;
      padding: 2rem 1.25rem 3rem;
      display: flex;
      justify-content: center;
    }

    .dashboard-shell {
      width: 100%;
      max-width: 1100px;
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.9fr);
      gap: 1.75rem;
      align-items: flex-start;
    }

    .panel-left {
      padding: 1.4rem 1.5rem;
      border-radius: 1.2rem;
      background: rgba(255, 255, 255, 0.92);
      box-shadow:
        0 24px 60px rgba(15, 23, 42, 0.15),
        0 0 0 1px rgba(15, 23, 42, 0.03);
    }

    .panel-right {
      padding: 1.4rem 1.5rem;
      border-radius: 1.2rem;
      background: rgba(248, 250, 252, 0.96);
      border: 1px solid rgba(148, 163, 184, 0.35);
      backdrop-filter: blur(4px);
    }

    /* LEFT PANEL CONTENT */

    .panel-title-kicker {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--accent-blue);
      margin-bottom: 0.35rem;
    }

    .panel-title {
      margin: 0 0 0.3rem;
      font-size: 1.4rem;
      color: var(--primary-blue);
    }

    .panel-subtitle {
      margin: 0 0 0.8rem;
      font-size: 0.9rem;
      color: var(--muted-text);
    }

    .pipeline-summary {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 0.75rem;
      margin-bottom: 1.1rem;
    }

    .summary-pill {
      padding: 0.65rem 0.7rem;
      border-radius: 0.9rem;
      background: #f1f5f9;
      border: 1px dashed rgba(148, 163, 184, 0.6);
      font-size: 0.8rem;
      display: flex;
      flex-direction: column;
      gap: 0.1rem;
    }

    .summary-pill-label {
      color: var(--muted-text);
    }

    .summary-pill-value {
      font-weight: 600;
      color: var(--primary-blue);
      font-size: 0.95rem;
    }

    .filter-section {
      margin-top: 0.8rem;
      padding-top: 0.9rem;
      border-top: 1px dashed rgba(148, 163, 184, 0.6);
    }

    .filter-label {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--accent-blue);
      margin-bottom: 0.4rem;
    }

    .filter-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 0.7rem;
    }

    .filter-input {
      flex: 1;
      min-width: 180px;
      padding: 0.55rem 0.7rem;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      font-size: 0.85rem;
      background: #ffffff;
    }

    .filter-input:focus {
      outline: 0;
      border-color: rgba(37, 99, 235, 0.65);
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.35);
    }

    .filter-select {
      padding: 0.45rem 0.7rem;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      font-size: 0.8rem;
      background: #ffffff;
    }

    .filter-helper {
      font-size: 0.75rem;
      color: var(--muted-text);
      margin-top: 0.3rem;
    }

    .panel-note {
      margin-top: 0.8rem;
      font-size: 0.78rem;
      color: var(--muted-text);
      background: #f1f5f9;
      border-radius: 0.7rem;
      padding: 0.7rem 0.8rem;
    }

    .panel-note strong {
      color: var(--primary-blue);
    }

    /* CHIPS */

    .chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.45rem;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.32rem 0.8rem;
      border-radius: 999px;
      border: 1px solid rgba(0, 0, 0, 0.12);
      background: #ffffff;
      font-size: 0.78rem;
      line-height: 1.2;
      cursor: pointer;
      user-select: none;
      white-space: nowrap;
      transition:
        background 0.15s ease,
        border-color 0.15s ease,
        color 0.15s ease,
        box-shadow 0.15s ease;
    }

    .chip.is-active {
      background: #e8f0fa !important;
      border-color: #1f4e79 !important;
      color: #1f4e79 !important;
      box-shadow: 0 0 0 2px rgba(31, 78, 121, 0.2) !important;
      font-weight: 600;
    }

    .chip:hover {
      border-color: #1f4e79;
      background: rgba(31, 78, 121, 0.06);
    }

    /* RIGHT PANEL – CLIENT LIST */

    .clients-header-row {
      display: flex;
      justify-content: space-between;
      gap: 0.75rem;
      align-items: baseline;
      margin-bottom: 0.9rem;
    }

    .clients-title {
      font-size: 1.05rem;
      font-weight: 600;
      color: var(--primary-blue);
      margin: 0;
    }

    .clients-subtitle {
      margin: 0;
      font-size: 0.8rem;
      color: var(--muted-text);
    }

    .clients-counter {
      font-size: 0.78rem;
      color: var(--muted-text);
    }

    .clients-grid {
      display: flex;
      flex-direction: column;
      gap: 0.85rem;
    }

    .client-card {
      border-radius: 1rem;
      background: #ffffff;
      border: 1px solid rgba(148, 163, 184, 0.4);
      padding: 0.9rem 0.95rem;
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
    }

    .client-card-header {
      display: flex;
      justify-content: space-between;
      gap: 0.75rem;
      align-items: flex-start;
    }

    .client-main {
      min-width: 0;
    }

    .client-name-row {
      display: flex;
      align-items: center;
      gap: 0.35rem;
      margin-bottom: 0.15rem;
    }

    .client-name {
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--primary-blue);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .client-plan-pill {
      font-size: 0.7rem;
      border-radius: 999px;
      padding: 0.1rem 0.55rem;
      background: #e0f2fe;
      color: #075985;
      border: 1px solid rgba(37, 99, 235, 0.3);
      white-space: nowrap;
    }

    .client-contact-line {
      font-size: 0.78rem;
      color: var(--muted-text);
      display: flex;
      flex-wrap: wrap;
      gap: 0.3rem;
    }

    .client-contact-line span {
      white-space: nowrap;
    }

    .client-contact-line .dot {
      opacity: 0.5;
    }

    .client-meta-row {
      font-size: 0.75rem;
      color: var(--muted-text);
      display: flex;
      flex-wrap: wrap;
      gap: 0.35rem;
      margin-top: 0.2rem;
    }

    .meta-pill {
      padding: 0.12rem 0.5rem;
      border-radius: 999px;
      background: #f3f4f6;
      border: 1px solid rgba(148, 163, 184, 0.5);
      white-space: nowrap;
    }

    .client-origin-pill {
      font-size: 0.7rem;
      padding: 0.16rem 0.55rem;
      border-radius: 999px;
      border: 1px dashed rgba(148, 163, 184, 0.8);
      color: var(--muted-text);
      background: #f9fafb;
      white-space: nowrap;
    }

    .client-tag-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.3rem;
      margin-top: 0.3rem;
    }

    .client-tag {
      font-size: 0.7rem;
      padding: 0.14rem 0.5rem;
      border-radius: 999px;
      background: #eff6ff;
      color: #1d4ed8;
    }

    /* CONTROLS AREA */

    .client-controls-row {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.1fr);
      gap: 0.75rem;
      margin-top: 0.4rem;
    }

    .control-block {
      font-size: 0.78rem;
    }

    .control-label {
      font-size: 0.75rem;
      color: var(--muted-text);
      margin-bottom: 0.2rem;
    }

    .control-select {
      width: 100%;
      padding: 0.4rem 0.55rem;
      border-radius: 0.55rem;
      border: 1px solid var(--border-subtle);
      font-size: 0.78rem;
      background: #ffffff;
    }

    .control-select:focus {
      outline: 0;
      border-color: rgba(37, 99, 235, 0.7);
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.4);
    }

    .areas-chip-row {
      margin-top: 0.2rem;
    }

    .client-notes {
      margin-top: 0.4rem;
      font-size: 0.78rem;
    }

    .client-notes textarea {
      width: 100%;
      padding: 0.45rem 0.55rem;
      border-radius: 0.55rem;
      border: 1px solid var(--border-subtle);
      font: inherit;
      font-size: 0.78rem;
      min-height: 55px;
      resize: vertical;
      background: #f9fafb;
    }

    .client-notes textarea:focus {
      outline: 0;
      border-color: rgba(37, 99, 235, 0.7);
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.4);
      background: #ffffff;
    }

    .client-footer-row {
      margin-top: 0.45rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .client-buttons {
      display: flex;
      gap: 0.45rem;
      flex-wrap: wrap;
    }

    .btn {
      border-radius: 999px;
      border: 1px solid transparent;
      padding: 0.4rem 0.85rem;
      font-size: 0.78rem;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      background: transparent;
    }

    .btn-secondary {
      border-color: var(--border-subtle);
      background: #f9fafb;
      color: var(--dark-text);
    }

    .btn-secondary:hover {
      background: #e5e7eb;
    }

    .btn-outline {
      border-color: rgba(148, 163, 184, 0.8);
      background: transparent;
      color: var(--muted-text);
    }

    .btn-outline:hover {
      border-color: #1f4e79;
      color: #1f4e79;
      background: #e5efff;
    }

    .client-save-status {
      font-size: 0.72rem;
      min-height: 1.1em;
      color: var(--muted-text);
    }

    .client-save-status--saving {
      color: #92400e;
    }

    .client-save-status--success {
      color: var(--success-green);
    }

    .client-save-status--error {
      color: var(--error-red);
    }

    /* RESPONSIVE */

    @media (max-width: 900px) {
      main {
        padding-top: 1.5rem;
      }

      .dashboard-shell {
        grid-template-columns: minmax(0, 1fr);
      }

      .panel-left {
        order: -1;
      }
    }

    @media (max-width: 600px) {
      .header-inner {
        flex-direction: column;
        align-items: flex-start;
      }

      .panel-left,
      .panel-right {
        padding: 1.1rem 1.1rem;
      }

      .pipeline-summary {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }

      .client-controls-row {
        grid-template-columns: minmax(0, 1fr);
      }
    }
  </style>
</head>
<body>
<div class="page">
  <!-- HEADER -->
  <header>
    <div class="header-inner">
      <div class="logo-wrap">
        <div class="logo-icon" aria-hidden="true"></div>
        <div>
          <div class="logo-main">TradeBotPro</div>
          <div class="logo-tag">More jobs. Less admin. Powered by AI.</div>
        </div>
      </div>
      <div class="header-note">
        Internal view: keep track of <strong>demos, trials and upsell opportunities</strong>.
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <main>
    <div class="dashboard-shell">
      <!-- LEFT PANEL -->
      <aside class="panel-left">
        <div class="panel-title-kicker">Overview</div>
        <h1 class="panel-title">Pipeline & onboarding status</h1>
        <p class="panel-subtitle">
          Filter by onboarding stage or search by business, contact, email or postcode.
          Use the controls on each card to keep your follow-ups organised.
        </p>

        <div class="pipeline-summary" id="pipeline-summary">
          <div class="summary-pill">
            <div class="summary-pill-label">New / needs setup</div>
            <div class="summary-pill-value" id="summary-new">0</div>
          </div>
          <div class="summary-pill">
            <div class="summary-pill-label">Demos / trials</div>
            <div class="summary-pill-value" id="summary-demo">0</div>
          </div>
          <div class="summary-pill">
            <div class="summary-pill-label">Live / active</div>
            <div class="summary-pill-value" id="summary-live">0</div>
          </div>
        </div>

        <div class="filter-section">
          <div class="filter-label">Quick filters</div>
          <div class="filter-row">
            <input
              id="search-input"
              class="filter-input"
              type="text"
              placeholder="Search name, contact, email, postcode…"
            />
            <select id="status-filter" class="filter-select">
              <option value="">All onboarding stages</option>
              <option value="New lead">New lead</option>
              <option value="Needs setup">Needs setup</option>
              <option value="Demo booked">Demo booked</option>
              <option value="Demo complete">Demo complete</option>
              <option value="Free trial">Free trial</option>
              <option value="Live – Starter">Live – Starter</option>
              <option value="Live – Pro">Live – Pro</option>
              <option value="Paused">Paused</option>
              <option value="Not interested">Not interested</option>
            </select>
          </div>
          <div class="filter-helper">
            Tip: use the <strong>Onboarding status</strong>, <strong>Comfort level</strong> and
            <strong>More areas</strong> controls on each card to keep your pipeline tidy.
          </div>
        </div>

        <div class="panel-note">
          <strong>How this works:</strong> each card saves straight into
          <code>business_profiles</code>. You can always re-open the full setup wizard later using
          the <em>Open in wizard</em> button for a deeper refresh.
        </div>
      </aside>

      <!-- RIGHT PANEL -->
      <section class="panel-right">
        <div class="clients-header-row">
          <div>
            <h2 class="clients-title">Clients</h2>
            <p class="clients-subtitle" id="clients-subtitle">
              Loading clients from Supabase…
            </p>
          </div>
          <div class="clients-counter" id="clients-counter"></div>
        </div>

        <div id="clients-grid" class="clients-grid"></div>
      </section>
    </div>
  </main>
</div>

<script>
  // ---------------------------------------------------------
  // Supabase config
  // ---------------------------------------------------------
  window.SUPABASE_URL = "https://yaiutswdcbfwkxfqxkzy.supabase.co";
  window.SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlhaXV0c3dkY2Jmd2t4ZnF4a3p5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1MDE2MDgsImV4cCI6MjA4MDA3NzYwOH0.HOLFxzjsZ5Ieqg0b-aTdP0hAdLsPVXL6Zjs-HgOHgc8";

  async function supabaseFetch(path, options = {}) {
    if (!window.SUPABASE_URL || !window.SUPABASE_KEY) {
      console.error("Supabase is not configured. Check SUPABASE_URL and SUPABASE_KEY.");
      return {
        data: null,
        error: { status: 0, statusText: "Supabase config missing", details: null }
      };
    }

    const res = await fetch(`${window.SUPABASE_URL}/rest/v1${path}`, {
      ...options,
      headers: {
        apikey: window.SUPABASE_KEY,
        Authorization: `Bearer ${window.SUPABASE_KEY}`,
        ...(options.headers || {})
      }
    });

    let data = null;
    try {
      data = await res.json();
    } catch (e) {
      // ignore
    }

    if (!res.ok) {
      console.error("Supabase HTTP error", res.status, res.statusText, data);
      return {
        data: null,
        error: {
          status: res.status,
          statusText: res.statusText,
          details: data
        }
      };
    }

    return { data, error: null };
  }

  // ---------------------------------------------------------
  // Dashboard logic
  // ---------------------------------------------------------
  document.addEventListener("DOMContentLoaded", () => {
    const clientsGrid = document.getElementById("clients-grid");
    const clientsSubtitle = document.getElementById("clients-subtitle");
    const clientsCounter = document.getElementById("clients-counter");
    const searchInput = document.getElementById("search-input");
    const statusFilter = document.getElementById("status-filter");

    const summaryNew = document.getElementById("summary-new");
    const summaryDemo = document.getElementById("summary-demo");
    const summaryLive = document.getElementById("summary-live");

    let profiles = [];
    let signupsIndex = {};
    let filteredProfiles = [];

    function humanStatusFromRow(row) {
      // account_status is your manual override / human label; fall back to plan flags
      if (row.account_status && row.account_status.trim() !== "") {
        return row.account_status.trim();
      }
      if (row.plan_status === "Trial") return "Free trial";
      if (row.is_active) return "Live – Starter";
      if (row.pending_setup) return "Needs setup";
      return "New lead";
    }

    function recomputeSummaries() {
      let newCount = 0;
      let demoCount = 0;
      let liveCount = 0;

      profiles.forEach((row) => {
        const hs = humanStatusFromRow(row);
        if (["New lead", "Needs setup"].includes(hs)) newCount++;
        if (["Demo booked", "Demo complete", "Free trial"].includes(hs)) demoCount++;
        if (hs.startsWith("Live")) liveCount++;
      });

      summaryNew.textContent = newCount;
      summaryDemo.textContent = demoCount;
      summaryLive.textContent = liveCount;
    }

    function applyFilters() {
      const q = (searchInput.value || "").toLowerCase().trim();
      const statusVal = statusFilter.value;

      filteredProfiles = profiles.filter((row) => {
        const hs = humanStatusFromRow(row);

        if (statusVal && hs !== statusVal) return false;

        if (q) {
          const haystack = [
            row.business_name || "",
            row.contact_name || row.owner_name || "",
            row.email || "",
            row.phone || "",
            row.base_postcode || ""
          ]
            .join(" ")
            .toLowerCase();
          if (!haystack.includes(q)) return false;
        }

        return true;
      });

      renderProfiles();
    }

    function originLabel(row) {
      if (row.signup_id && signupsIndex[row.signup_id]) {
        return "Self-signup";
      }
      if (row.signup_id && !signupsIndex[row.signup_id]) {
        return "Added manually";
      }
      return "Added manually"; // older/orphaned records
    }

    function safeDate(iso) {
      if (!iso) return "";
      const d = new Date(iso);
      if (Number.isNaN(d.getTime())) return "";
      return d.toLocaleDateString("en-GB", {
        day: "2-digit",
        month: "short",
        year: "numeric"
      });
    }

    function renderProfiles() {
      clientsGrid.innerHTML = "";

      if (!filteredProfiles.length) {
        clientsGrid.innerHTML =
          '<div style="font-size:0.85rem;color:var(--muted-text);">No clients match your filters yet.</div>';
        clientsCounter.textContent = "";
        clientsSubtitle.textContent = "Adjust filters or search to see more clients.";
        return;
      }

      clientsCounter.textContent = `${filteredProfiles.length} client${
        filteredProfiles.length === 1 ? "" : "s"
      } shown`;
      clientsSubtitle.textContent = "Click controls on each card to update onboarding details.";

      filteredProfiles.forEach((row) => {
        const card = document.createElement("article");
        card.className = "client-card";
        card.dataset.profileId = row.id;
        card.dataset.signupId = row.signup_id || "";

        const hs = humanStatusFromRow(row);
        const planLabel = row.plan_status || "No plan yet";
        const createdAt = safeDate(row.created_at);
        const origin = originLabel(row);

        const servicesTags =
          (row.services_summary || "")
            .split(",")
            .map((s) => s.trim())
            .filter(Boolean) || [];

        // HEADER
        const header = document.createElement("div");
        header.className = "client-card-header";

        const left = document.createElement("div");
        left.className = "client-main";

        const nameRow = document.createElement("div");
        nameRow.className = "client-name-row";

        const nameEl = document.createElement("div");
        nameEl.className = "client-name";
        nameEl.textContent = row.business_name || "(No business name)";

        const planPill = document.createElement("div");
        planPill.className = "client-plan-pill";
        planPill.textContent = planLabel;

        nameRow.appendChild(nameEl);
        nameRow.appendChild(planPill);

        const contactLine = document.createElement("div");
        contactLine.className = "client-contact-line";
        const primaryContact = row.contact_name || row.owner_name || "";
        const phone = row.phone || "";
        const email = row.email || "";
        const postcode = row.base_postcode || "";

        if (primaryContact) contactLine.innerHTML += `<span>${primaryContact}</span>`;
        if (phone) {
          if (contactLine.innerHTML) contactLine.innerHTML += '<span class="dot">•</span>';
          contactLine.innerHTML += `<span>${phone}</span>`;
        }
        if (email) {
          if (contactLine.innerHTML) contactLine.innerHTML += '<span class="dot">•</span>';
          contactLine.innerHTML += `<span>${email}</span>`;
        }
        if (postcode) {
          if (contactLine.innerHTML) contactLine.innerHTML += '<span class="dot">•</span>';
          contactLine.innerHTML += `<span>${postcode}</span>`;
        }

        const metaRow = document.createElement("div");
        metaRow.className = "client-meta-row";

        const statusPill = document.createElement("div");
        statusPill.className = "meta-pill";
        statusPill.textContent = hs;

        const createdPill = document.createElement("div");
        createdPill.className = "meta-pill";
        createdPill.textContent = createdAt ? `Joined ${createdAt}` : "Date unknown";

        metaRow.appendChild(statusPill);
        metaRow.appendChild(createdPill);

        left.appendChild(nameRow);
        left.appendChild(contactLine);
        left.appendChild(metaRow);

        const right = document.createElement("div");
        const originPill = document.createElement("div");
        originPill.className = "client-origin-pill";
        originPill.textContent = origin;
        right.appendChild(originPill);

        header.appendChild(left);
        header.appendChild(right);

        card.appendChild(header);

        // TAGS
        if (servicesTags.length) {
          const tagRow = document.createElement("div");
          tagRow.className = "client-tag-row";

          servicesTags.forEach((tag) => {
            const tagEl = document.createElement("span");
            tagEl.className = "client-tag";
            tagEl.textContent = tag;
            tagRow.appendChild(tagEl);
          });

          card.appendChild(tagRow);
        }

        // CONTROLS
        const controlsRow = document.createElement("div");
        controlsRow.className = "client-controls-row";

        // Block 1 – Onboarding status
        const block1 = document.createElement("div");
        block1.className = "control-block";

        const label1 = document.createElement("div");
        label1.className = "control-label";
        label1.textContent = "Onboarding status";

        const select1 = document.createElement("select");
        select1.className = "control-select";
        select1.innerHTML = `
          <option value="">(Choose status)</option>
          <option value="New lead">New lead</option>
          <option value="Needs setup">Needs setup</option>
          <option value="Demo booked">Demo booked</option>
          <option value="Demo complete">Demo complete</option>
          <option value="Free trial">Free trial</option>
          <option value="Live – Starter">Live – Starter</option>
          <option value="Live – Pro">Live – Pro</option>
          <option value="Paused">Paused</option>
          <option value="Not interested">Not interested</option>
        `;
        select1.value = hs || "";

        block1.appendChild(label1);
        block1.appendChild(select1);

        // Block 2 – Comfortable subscription level
        const block2 = document.createElement("div");
        block2.className = "control-block";

        const label2 = document.createElement("div");
        label2.className = "control-label";
        label2.textContent = "Comfortable subscription level";

        const select2 = document.createElement("select");
        select2.className = "control-select";
        select2.innerHTML = `
          <option value="">(Not discussed yet)</option>
          <option value="Interested in Starter only">Interested in Starter only</option>
          <option value="Happy with Pro if results are good">Happy with Pro if results are good</option>
          <option value="Price-sensitive / needs strong proof">Price-sensitive / needs strong proof</option>
          <option value="Premium / happy to invest if it works">Premium / happy to invest if it works</option>
        `;
        select2.value = row.pricing_notes || "";

        block2.appendChild(label2);
        block2.appendChild(select2);

        controlsRow.appendChild(block1);
        controlsRow.appendChild(block2);

        card.appendChild(controlsRow);

        // More areas interest chips
        const areasBlock = document.createElement("div");
        areasBlock.className = "control-block";
        const labelAreas = document.createElement("div");
        labelAreas.className = "control-label";
        labelAreas.textContent = "More areas interest";
        areasBlock.appendChild(labelAreas);

        const areasRow = document.createElement("div");
        areasRow.className = "chip-row areas-chip-row";
        areasRow.dataset.field = "callout_notes";

        const areaOptions = [
          "Not discussed yet",
          "Core area only",
          "Open to more areas later",
          "Definitely wants more areas"
        ];
        const currentArea = row.callout_notes || "";

        areaOptions.forEach((opt) => {
          const chip = document.createElement("button");
          chip.type = "button";
          chip.className = "chip";
          chip.textContent = opt;
          if (opt === currentArea) {
            chip.classList.add("is-active");
          }
          areasRow.appendChild(chip);
        });

        areasBlock.appendChild(areasRow);
        card.appendChild(areasBlock);

        // Notes
        const notesBlock = document.createElement("div");
        notesBlock.className = "client-notes";

        const notesLabel = document.createElement("div");
        notesLabel.className = "control-label";
        notesLabel.textContent = "Follow-up & next steps (internal only)";

        const notesArea = document.createElement("textarea");
        notesArea.value = row.notes || "";

        notesBlock.appendChild(notesLabel);
        notesBlock.appendChild(notesArea);
        card.appendChild(notesBlock);

        // Footer: buttons + save status
        const footerRow = document.createElement("div");
        footerRow.className = "client-footer-row";

        const btnRow = document.createElement("div");
        btnRow.className = "client-buttons";

        const openWizardBtn = document.createElement("button");
        openWizardBtn.type = "button";
        openWizardBtn.className = "btn btn-secondary";
        openWizardBtn.textContent = "Open in wizard";
        openWizardBtn.addEventListener("click", () => {
          const signupId = row.signup_id;
          if (signupId) {
            window.open(`app.html?signup_id=${encodeURIComponent(signupId)}`, "_blank");
          } else {
            window.open("app.html", "_blank");
          }
        });

        const openCrmBtn = document.createElement("button");
        openCrmBtn.type = "button";
        openCrmBtn.className = "btn btn-outline";
        openCrmBtn.textContent = "Open CRM / messages";
        openCrmBtn.addEventListener("click", () => {
          alert("CRM / messages view to be built – this is a placeholder for now.");
        });

        btnRow.appendChild(openWizardBtn);
        btnRow.appendChild(openCrmBtn);

        const saveStatus = document.createElement("div");
        saveStatus.className = "client-save-status";
        saveStatus.textContent = "";

        footerRow.appendChild(btnRow);
        footerRow.appendChild(saveStatus);

        card.appendChild(footerRow);

        // Attach events for autosave
        attachAutosaveHandlers({
          card,
          row,
          selectStatus: select1,
          selectComfort: select2,
          areasRow,
          notesArea,
          saveStatusEl: saveStatus
        });

        clientsGrid.appendChild(card);
      });
    }

    async function updateProfileField(profileId, patch, saveStatusEl) {
      if (!profileId) return;

      if (saveStatusEl) {
        saveStatusEl.textContent = "Saving...";
        saveStatusEl.className = "client-save-status client-save-status--saving";
      }

      const { data, error } = await supabaseFetch(
        `/business_profiles?id=eq.${encodeURIComponent(profileId)}`,
        {
          method: "PATCH",
          headers: {
            "Content-Type": "application/json",
            Prefer: "return=representation"
          },
          body: JSON.stringify(patch)
        }
      );

      if (error) {
        console.error("Update profile error", error);
        if (saveStatusEl) {
          saveStatusEl.textContent = "Save failed – please try again.";
          saveStatusEl.className = "client-save-status client-save-status--error";
        }
        return null;
      }

      if (saveStatusEl) {
        saveStatusEl.textContent = "Saved \u2713";
        saveStatusEl.className = "client-save-status client-save-status--success";
        setTimeout(() => {
          saveStatusEl.textContent = "";
          saveStatusEl.className = "client-save-status";
        }, 2000);
      }

      return data && data[0] ? data[0] : null;
    }

    function attachAutosaveHandlers(config) {
      const {
        card,
        row,
        selectStatus,
        selectComfort,
        areasRow,
        notesArea,
        saveStatusEl
      } = config;

      const profileId = row.id;

      // Onboarding status -> account_status
      if (selectStatus) {
        selectStatus.addEventListener("change", async () => {
          const newVal = selectStatus.value || null;
          const updated = await updateProfileField(
            profileId,
            { account_status: newVal },
            saveStatusEl
          );
          if (updated) {
            row.account_status = updated.account_status;
            // re-render summaries and human status label
            recomputeSummaries();
            applyFilters();
          }
        });
      }

      // Comfortable subscription level -> pricing_notes
      if (selectComfort) {
        selectComfort.addEventListener("change", async () => {
          const newVal = selectComfort.value || null;
          const updated = await updateProfileField(
            profileId,
            { pricing_notes: newVal },
            saveStatusEl
          );
          if (updated) {
            row.pricing_notes = updated.pricing_notes;
          }
        });
      }

      // More areas interest -> callout_notes
      if (areasRow) {
        const chips = Array.from(areasRow.querySelectorAll(".chip"));
        chips.forEach((chip) => {
          chip.addEventListener("click", async () => {
            const alreadyActive = chip.classList.contains("is-active");

            chips.forEach((c) => c.classList.remove("is-active"));

            let newVal = null;
            if (!alreadyActive) {
              chip.classList.add("is-active");
              newVal = chip.textContent.trim();
            }

            const updated = await updateProfileField(
              profileId,
              { callout_notes: newVal },
              saveStatusEl
            );
            if (updated) {
              row.callout_notes = updated.callout_notes;
            }
          });
        });
      }

      // Notes -> notes
      if (notesArea) {
        let notesTimeout = null;
        notesArea.addEventListener("blur", async () => {
          const newVal = notesArea.value || null;
          const updated = await updateProfileField(profileId, { notes: newVal }, saveStatusEl);
          if (updated) {
            row.notes = updated.notes;
          }
        });

        // Optional: also autosave after a short pause while typing
        notesArea.addEventListener("input", () => {
          if (notesTimeout) clearTimeout(notesTimeout);
          notesTimeout = setTimeout(() => {
            notesArea.dispatchEvent(new Event("blur"));
          }, 2500);
        });
      }
    }

    async function loadData() {
      clientsSubtitle.textContent = "Loading clients from Supabase…";

      const [profilesRes, signupsRes] = await Promise.all([
        supabaseFetch("/business_profiles?select=*"),
        supabaseFetch("/tradebotpro_signups?select=id,created_at")
      ]);

      if (profilesRes.error) {
        console.error("Error loading business_profiles", profilesRes.error);
        clientsSubtitle.textContent =
          "Error loading clients. Check console for details or retry.";
        return;
      }

      profiles = profilesRes.data || [];

      signupsIndex = {};
      if (!signupsRes.error && Array.isArray(signupsRes.data)) {
        signupsRes.data.forEach((s) => {
          signupsIndex[s.id] = s;
        });
      }

      recomputeSummaries();
      filteredProfiles = profiles.slice().sort((a, b) => {
        const da = new Date(a.created_at || 0).getTime();
        const db = new Date(b.created_at || 0).getTime();
        return db - da;
      });

      applyFilters();
    }

    // Filters
    if (searchInput) {
      searchInput.addEventListener("input", () => {
        applyFilters();
      });
    }
    if (statusFilter) {
      statusFilter.addEventListener("change", () => {
        applyFilters();
      });
    }

    loadData();
  });
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TradeBotPro – Client Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta
    name="description"
    content="TradeBotPro dashboard for managing trade accounts and onboarding."
  />

  <style>
    :root {
      --primary-blue: #1f4e79;
      --accent-blue: #00a3ff;
      --dark-text: #151820;
      --muted-text: #6b7280;
      --light-bg: #f3f4f9;
      --white: #ffffff;
      --border-subtle: rgba(15, 23, 42, 0.12);
      --success-green: #0f7b46;
      --error-red: #b3261e;
      --chip-bg-muted: #f3f4f6;
      --chip-border-muted: rgba(148, 163, 184, 0.6);
    }

    * {
      box-sizing: border-box;
    }

    html {
      scroll-behavior: smooth;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      background: radial-gradient(circle at top left, #e0ebff 0, #f3f4f9 40%, #fdfdfd 100%);
      color: var(--dark-text);
      line-height: 1.5;
    }

    a {
      color: inherit;
      text-decoration: none;
    }

    /* PAGE LAYOUT (matching app.html) */

    .page {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      border-bottom: 1px solid rgba(15, 23, 42, 0.06);
      background: rgba(248, 250, 252, 0.96);
      backdrop-filter: blur(6px);
      position: sticky;
      top: 0;
      z-index: 20;
    }

    .header-inner {
      max-width: 1100px;
      margin: 0 auto;
      padding: 0.6rem 1.25rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
    }

    .logo-wrap {
      display: flex;
      align-items: center;
      gap: 0.6rem;
    }

    .logo-icon {
      width: 30px;
      height: 30px;
      border-radius: 9px;
      background: var(--primary-blue);
      position: relative;
    }

    .logo-icon::before,
    .logo-icon::after {
      content: "";
      position: absolute;
      background: var(--white);
      border-radius: 4px;
    }

    .logo-icon::before {
      width: 11px;
      height: 17px;
      left: 7px;
      top: 6px;
    }

    .logo-icon::after {
      width: 6px;
      height: 11px;
      right: 7px;
      top: 9px;
    }

    .logo-main {
      font-weight: 700;
      font-size: 1rem;
      color: var(--primary-blue);
    }

    .logo-tag {
      font-size: 0.75rem;
      color: var(--muted-text);
    }

    .header-note {
      font-size: 0.75rem;
      color: var(--muted-text);
    }

    .header-note strong {
      color: var(--primary-blue);
      font-weight: 600;
    }

    main {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2.5rem 1.25rem 3rem;
    }

    .dashboard-shell {
      width: 100%;
      max-width: 1100px;
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1.4fr);
      gap: 1.75rem;
      align-items: flex-start;
    }

    .dashboard-left {
      padding: 1.5rem 1.6rem;
      border-radius: 1.2rem;
      background: rgba(255, 255, 255, 0.92);
      box-shadow:
        0 24px 60px rgba(15, 23, 42, 0.15),
        0 0 0 1px rgba(15, 23, 42, 0.03);
    }

    .dashboard-right {
      padding: 1.5rem 1.6rem;
      border-radius: 1.2rem;
      background: rgba(248, 250, 252, 0.96);
      border: 1px solid rgba(148, 163, 184, 0.35);
      backdrop-filter: blur(4px);
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    /* LEFT PANEL CONTENT */

    .dash-title-kicker {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--accent-blue);
      margin-bottom: 0.35rem;
    }

    .dash-title {
      margin: 0 0 0.4rem;
      font-size: 1.6rem;
      color: var(--primary-blue);
    }

    .dash-subtitle {
      margin: 0 0 0.85rem;
      font-size: 0.92rem;
      color: var(--muted-text);
    }

    .dash-summary-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.75rem;
      margin: 1rem 0 1.2rem;
    }

    .summary-card {
      padding: 0.7rem 0.8rem;
      border-radius: 0.9rem;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: #f8fafc;
      font-size: 0.8rem;
    }

    .summary-label {
      color: var(--muted-text);
      margin-bottom: 0.2rem;
    }

    .summary-value {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--primary-blue);
    }

    .summary-pill {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.1rem 0.55rem;
      border-radius: 999px;
      font-size: 0.72rem;
      background: #e5f9ee;
      color: #166534;
      margin-top: 0.25rem;
    }

    .dash-note {
      margin-top: 0.9rem;
      font-size: 0.8rem;
      color: var(--muted-text);
      border-radius: 0.7rem;
      padding: 0.7rem 0.8rem;
      background: #f1f5f9;
    }

    .dash-note strong {
      color: var(--primary-blue);
      font-weight: 600;
    }

    .dash-legend {
      margin-top: 0.9rem;
      font-size: 0.8rem;
      color: var(--muted-text);
    }

    .legend-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.35rem 0.75rem;
      margin-top: 0.3rem;
    }

    .legend-pill {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      font-size: 0.76rem;
    }

    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
    }

    .legend-dot.needs-setup {
      background: #fee2e2;
      border: 1px solid #b91c1c;
    }

    .legend-dot.trial {
      background: #e0f2fe;
      border: 1px solid #0369a1;
    }

    .legend-dot.live {
      background: #dcfce7;
      border: 1px solid #15803d;
    }

    .legend-dot.paused {
      background: #fef3c7;
      border: 1px solid #d97706;
    }

    /* RIGHT PANEL: FILTERS + LIST */

    .dashboard-right-header {
      margin-bottom: 1rem;
    }

    .dashboard-step-label {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--accent-blue);
      margin-bottom: 0.25rem;
    }

    .dashboard-step-title {
      margin: 0 0 0.25rem;
      font-size: 1.2rem;
      color: var(--primary-blue);
    }

    .dashboard-step-subtitle {
      margin: 0;
      font-size: 0.88rem;
      color: var(--muted-text);
    }

    /* CHIPS (reuse wizard style) */

    .chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 0.45rem;
      margin-bottom: 0.65rem;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.4rem 0.9rem;
      border-radius: 999px;
      border: 1px solid rgba(0, 0, 0, 0.12);
      background: #ffffff;
      font-size: 0.82rem;
      line-height: 1.2;
      cursor: pointer;
      user-select: none;
      white-space: nowrap;
      transition:
        background 0.15s ease,
        border-color 0.15s ease,
        color 0.15s ease,
        box-shadow 0.15s ease;
    }

    .chip:hover {
      border-color: #1f4e79;
      background: rgba(31, 78, 121, 0.06);
    }

    .chip.is-active {
      background: #e8f0fa !important;
      border-color: #1f4e79 !important;
      color: #1f4e79 !important;
      box-shadow: 0 0 0 2px rgba(31, 78, 121, 0.2) !important;
      font-weight: 600;
    }

    .filter-bar {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      margin-bottom: 0.8rem;
    }

    .search-row {
      display: flex;
      gap: 0.6rem;
      flex-wrap: wrap;
      align-items: center;
    }

    .search-input-wrap {
      flex: 1;
      min-width: 180px;
    }

    .search-input {
      width: 100%;
      padding: 0.55rem 0.75rem;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      font-size: 0.85rem;
      background: #ffffff;
    }

    .search-input:focus {
      outline: 0;
      border-color: rgba(37, 99, 235, 0.7);
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.4);
    }

    .small-label {
      font-size: 0.75rem;
      color: var(--muted-text);
    }

    /* CLIENT LIST */

    .clients-scroll {
      margin-top: 0.5rem;
      border-top: 1px dashed rgba(148, 163, 184, 0.55);
      padding-top: 0.9rem;
      overflow-y: auto;
      max-height: 520px;
    }

    .client-card {
      padding: 0.75rem 0.85rem;
      border-radius: 0.9rem;
      border: 1px solid rgba(148, 163, 184, 0.45);
      background: #ffffff;
      margin-bottom: 0.75rem;
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
      transition:
        box-shadow 0.15s ease,
        transform 0.12s ease;
    }

    .client-card:hover {
      box-shadow: 0 10px 24px rgba(15, 23, 42, 0.14);
      transform: translateY(-1px);
    }

    .client-header-row {
      display: flex;
      justify-content: space-between;
      gap: 0.7rem;
      align-items: flex-start;
    }

    .client-name {
      font-size: 0.98rem;
      font-weight: 600;
      color: var(--primary-blue);
    }

    .client-sub {
      font-size: 0.8rem;
      color: var(--muted-text);
    }

    .client-meta-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.3rem 0.8rem;
      font-size: 0.78rem;
      color: var(--muted-text);
    }

    .client-meta-item {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
    }

    .meta-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.9);
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      border-radius: 999px;
      padding: 0.2rem 0.6rem;
      font-size: 0.74rem;
      font-weight: 500;
    }

    .status-pill.needs-setup {
      background: #fef2f2;
      color: #b91c1c;
      border: 1px solid #fecaca;
    }

    .status-pill.trial {
      background: #eff6ff;
      color: #1d4ed8;
      border: 1px solid #bfdbfe;
    }

    .status-pill.live {
      background: #ecfdf5;
      color: #15803d;
      border: 1px solid #bbf7d0;
    }

    .status-pill.paused {
      background: #fffbeb;
      color: #92400e;
      border: 1px solid #fde68a;
    }

    .status-pill.unknown {
      background: #f3f4f6;
      color: #374151;
      border: 1px solid #e5e7eb;
    }

    .tag-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.35rem;
      margin-top: 0.1rem;
    }

    .small-tag {
      border-radius: 999px;
      padding: 0.12rem 0.5rem;
      font-size: 0.72rem;
      background: #f3f4f6;
      color: #4b5563;
      border: 1px solid rgba(148, 163, 184, 0.6);
    }

    .origin-self {
      background: #ecfdf5;
      color: #166534;
      border-color: #bbf7d0;
    }

    .origin-manual {
      background: #eff6ff;
      color: #1d4ed8;
      border-color: #bfdbfe;
    }

    .origin-profile-only {
      background: #fef9c3;
      color: #92400e;
      border-color: #facc15;
    }

    .client-actions-row {
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
      margin-top: 0.35rem;
      flex-wrap: wrap;
    }

    .btn {
      border-radius: 999px;
      border: 1px solid transparent;
      padding: 0.45rem 0.9rem;
      font-size: 0.8rem;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      background: transparent;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary-blue), #163857);
      color: #ffffff;
      border-color: transparent;
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.4);
    }

    .btn-primary:hover {
      filter: brightness(1.03);
      box-shadow: 0 12px 26px rgba(15, 23, 42, 0.5);
    }

    .btn-secondary {
      border-color: var(--border-subtle);
      background: #f9fafb;
      color: var(--dark-text);
    }

    .btn-secondary:hover {
      background: #e5e7eb;
    }

    .pill-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: currentColor;
    }

    .empty-state {
      font-size: 0.85rem;
      color: var(--muted-text);
      padding: 0.5rem 0;
    }

    .small-mono {
      font-family: "SF Mono", ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono",
        "Courier New", monospace;
      font-size: 0.72rem;
      color: #6b7280;
    }

    #dashboard-status-message {
      margin-top: 0.5rem;
      font-size: 0.78rem;
      min-height: 1.2em;
    }

    .status-error {
      color: var(--error-red);
    }

    .status-success {
      color: var(--success-green);
    }

    /* RESPONSIVE */

    @media (max-width: 900px) {
      main {
        padding-top: 1.5rem;
      }

      .dashboard-shell {
        grid-template-columns: minmax(0, 1fr);
      }

      .dashboard-left {
        order: -1;
      }

      .clients-scroll {
        max-height: unset;
      }
    }

    @media (max-width: 600px) {
      .header-inner {
        flex-direction: column;
        align-items: flex-start;
      }

      .dashboard-left,
      .dashboard-right {
        padding: 1.1rem 1.1rem;
      }
    }
  </style>
</head>
<body>
<div class="page">
  <!-- HEADER (matches app.html) -->
  <header>
    <div class="header-inner">
      <div class="logo-wrap">
        <div class="logo-icon" aria-hidden="true"></div>
        <div>
          <div class="logo-main">TradeBotPro</div>
          <div class="logo-tag">More jobs. Less admin. Powered by AI.</div>
        </div>
      </div>
      <div class="header-note">
        Shows every client with a <strong>business profile</strong> – whether they self-signed up
        or were added manually.
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <main>
    <div class="dashboard-shell">
      <!-- LEFT PANEL: OVERVIEW / SUMMARY -->
      <aside class="dashboard-left">
        <div class="dash-title-kicker">Client dashboard</div>
        <h1 class="dash-title">Your TradeBotPro clients</h1>
        <p class="dash-subtitle">
          A live view of everyone in the system – from first demo to free trial to fully live
          subscription. This panel is for <strong>you, not your clients</strong>.
        </p>

        <div class="dash-summary-grid">
          <div class="summary-card">
            <div class="summary-label">Total clients with profiles</div>
            <div class="summary-value" id="summary-total">–</div>
            <div class="summary-pill">
              <span class="pill-dot"></span>
              <span id="summary-new-label">New + in setup</span>
            </div>
          </div>
          <div class="summary-card">
            <div class="summary-label">Trial &amp; live accounts</div>
            <div class="summary-value" id="summary-live">–</div>
            <div class="summary-pill" style="background:#eff6ff;color:#1d4ed8;border-color:#bfdbfe;">
              <span class="pill-dot"></span>
              <span id="summary-live-label">Trial, paid &amp; active</span>
            </div>
          </div>
        </div>

        <div class="dash-note">
          <strong>How to use this screen:</strong> Filter by onboarding stage, search by business
          or postcode and click <em>Open in wizard</em> to tune their AI setup. The small tag on
          each card shows whether they <strong>self-signed up</strong> or were
          <strong>added manually</strong>.
        </div>

        <div class="dash-legend">
          <div class="small-label">Onboarding legend</div>
          <div class="legend-row">
            <div class="legend-pill">
              <span class="legend-dot needs-setup"></span>
              <span>Needs setup / no plan</span>
            </div>
            <div class="legend-pill">
              <span class="legend-dot trial"></span>
              <span>Trial setup or live</span>
            </div>
            <div class="legend-pill">
              <span class="legend-dot live"></span>
              <span>Full plan live</span>
            </div>
            <div class="legend-pill">
              <span class="legend-dot.paused"></span>
              <span>Paused / inactive</span>
            </div>
          </div>
        </div>

        <div class="dash-note" style="margin-top:1.1rem;">
          <strong>Source tags:</strong><br />
          <span class="small-tag origin-self">Self-signup</span> – they filled the homepage form
          first.<br />
          <span class="small-tag origin-manual">Added manually</span> – you created them via the
          wizard (signup + profile at the same time).<br />
          <span class="small-tag origin-profile-only">Profile only</span> – older records where
          no signup row exists.
        </div>
      </aside>

      <!-- RIGHT PANEL: FILTERS + CLIENT LIST -->
      <section class="dashboard-right" aria-live="polite">
        <div class="dashboard-right-header">
          <div class="dashboard-step-label">Overview</div>
          <h2 class="dashboard-step-title">Pipeline &amp; onboarding status</h2>
          <p class="dashboard-step-subtitle">
            Filter by onboarding stage or search by business, contact, email or postcode.
          </p>
        </div>

        <div class="filter-bar">
          <div>
            <div class="small-label">Filter by stage</div>
            <div class="chip-row" id="stage-filters">
              <button type="button" class="chip is-active" data-stage-filter="all">
                All clients
              </button>
              <button type="button" class="chip" data-stage-filter="needs_setup">
                Needs setup
              </button>
              <button type="button" class="chip" data-stage-filter="trial">
                Trial (setup or live)
              </button>
              <button type="button" class="chip" data-stage-filter="live">
                Live &amp; paying
              </button>
              <button type="button" class="chip" data-stage-filter="paused">
                Paused / inactive
              </button>
            </div>
          </div>

          <div class="search-row">
            <div class="search-input-wrap">
              <input
                id="search-input"
                class="search-input"
                type="text"
                placeholder="Search by business, contact, email or postcode…"
                autocomplete="off"
              />
            </div>
            <div class="small-label">
              Showing <span id="summary-visible">0</span> of
              <span id="summary-total-inline">0</span>
            </div>
          </div>
        </div>

        <div class="clients-scroll" id="clients-list">
          <!-- Cards injected here -->
        </div>

        <div id="dashboard-status-message"></div>
      </section>
    </div>
  </main>
</div>

<script>
  // Supabase config (same as app.html)
  window.SUPABASE_URL = "https://yaiutswdcbfwkxfqxkzy.supabase.co";
  window.SUPABASE_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlhaXV0c3dkY2Jmd2t4ZnF4a3p5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1MDE2MDgsImV4cCI6MjA4MDA3NzYwOH0.HOLFxzjsZ5Ieqg0b-aTdP0hAdLsPVXL6Zjs-HgOHgc8";

  // ---- Supabase helper ----
  async function supabaseFetch(path, options = {}) {
    if (!window.SUPABASE_URL || !window.SUPABASE_KEY) {
      console.error("Supabase is not configured. Check SUPABASE_URL and SUPABASE_KEY.");
      return {
        data: null,
        error: { status: 0, statusText: "Supabase config missing", details: null }
      };
    }

    const res = await fetch(`${window.SUPABASE_URL}/rest/v1${path}`, {
      ...options,
      headers: {
        apikey: window.SUPABASE_KEY,
        Authorization: `Bearer ${window.SUPABASE_KEY}`,
        ...(options.headers || {})
      }
    });

    let data = null;
    try {
      data = await res.json();
    } catch (e) {
      // no JSON body
    }

    if (!res.ok) {
      console.error("Supabase HTTP error", res.status, res.statusText, data);
      return {
        data: null,
        error: {
          status: res.status,
          statusText: res.statusText,
          details: data
        }
      };
    }

    return { data, error: null };
  }

  document.addEventListener("DOMContentLoaded", () => {
    const clientsListEl = document.getElementById("clients-list");
    const stageFiltersEl = document.getElementById("stage-filters");
    const searchInputEl = document.getElementById("search-input");
    const statusMessageEl = document.getElementById("dashboard-status-message");

    const summaryTotalEl = document.getElementById("summary-total");
    const summaryLiveEl = document.getElementById("summary-live");
    const summaryVisibleEl = document.getElementById("summary-visible");
    const summaryTotalInlineEl = document.getElementById("summary-total-inline");

    let allClients = [];
    let signupMap = {}; // id -> signup row from tradebotpro_signups
    let activeStageFilter = "all";
    let searchTerm = "";

    // ---- Stage helpers ----
    function computeStageKey(client) {
      const plan = (client.plan_status || "").toLowerCase();
      const pending = client.pending_setup === true;
      const active = client.is_active === true;

      if (!plan && pending) return "needs_setup";
      if (!plan && !pending && !active) return "needs_setup";

      if (plan === "trial" && !active) return "trial_setup";
      if (plan === "trial" && active) return "trial_live";

      if (plan && plan !== "trial" && active) return "live";
      if (plan && plan !== "trial" && !active) return "paused";

      return "unknown";
    }

    function isTrialStage(stageKey) {
      return stageKey === "trial_setup" || stageKey === "trial_live";
    }

    function stageLabel(stageKey, plan_status) {
      const plan = (plan_status || "").toLowerCase();
      switch (stageKey) {
        case "needs_setup":
          return "Needs setup";
        case "trial_setup":
          return "Trial – setup";
        case "trial_live":
          return "Trial – live";
        case "live":
          return plan ? `${plan_status} – live` : "Live";
        case "paused":
          return "Paused / inactive";
        default:
          return plan_status ? plan_status : "Status not set";
      }
    }

    function stagePillClass(stageKey) {
      if (stageKey === "needs_setup") return "needs-setup";
      if (stageKey === "trial_setup" || stageKey === "trial_live") return "trial";
      if (stageKey === "live") return "live";
      if (stageKey === "paused") return "paused";
      return "unknown";
    }

    // ---- Origin helpers (self-signup vs manual) ----
    function computeOrigin(client) {
      const signupId = client.signup_id || null;
      const signupRow = signupId ? signupMap[signupId] : null;

      if (!signupRow) {
        return { label: "Profile only", cls: "origin-profile-only" };
      }

      // If we have both timestamps, use time difference
      const profileTime = client.created_at ? new Date(client.created_at) : null;
      const signupTime = signupRow.created_at ? new Date(signupRow.created_at) : null;

      if (profileTime && signupTime && !isNaN(profileTime) && !isNaN(signupTime)) {
        const diffMs = Math.abs(profileTime.getTime() - signupTime.getTime());

        // If created within 15s of each other, treat as "Added manually"
        if (diffMs <= 15000) {
          return { label: "Added manually", cls: "origin-manual" };
        }

        // Otherwise, signup existed first → they came through the homepage
        if (signupTime < profileTime) {
          return { label: "Self-signup", cls: "origin-self" };
        }
      }

      // Fallback if dates are weird
      return { label: "Self-signup", cls: "origin-self" };
    }

    // ---- Rendering ----
    function render() {
      if (!clientsListEl) return;

      const trimmed = (searchTerm || "").trim().toLowerCase();

      const filtered = allClients.filter((client) => {
        const stage = computeStageKey(client);

        if (activeStageFilter === "needs_setup" && stage !== "needs_setup") {
          return false;
        }
        if (activeStageFilter === "trial" && !isTrialStage(stage)) {
          return false;
        }
        if (activeStageFilter === "live" && stage !== "live") {
          return false;
        }
        if (activeStageFilter === "paused" && stage !== "paused") {
          return false;
        }

        if (!trimmed) return true;

        const haystack =
          [
            client.business_name,
            client.contact_name,
            client.email,
            client.phone,
            client.base_postcode,
            client.services_summary
          ]
            .filter(Boolean)
            .join(" | ")
            .toLowerCase() || "";

        return haystack.includes(trimmed);
      });

      clientsListEl.innerHTML = "";

      if (!filtered.length) {
        const empty = document.createElement("div");
        empty.className = "empty-state";
        empty.textContent =
          allClients.length === 0
            ? "No clients found in business_profiles yet."
            : "No clients match your current filters.";
        clientsListEl.appendChild(empty);
      } else {
        filtered.forEach((client) => {
          const card = document.createElement("article");
          card.className = "client-card";

          const stageKey = computeStageKey(client);
          const pillClass = stagePillClass(stageKey);
          const pillLabel = stageLabel(stageKey, client.plan_status);

          const createdAtText = client.created_at
            ? new Date(client.created_at).toLocaleDateString("en-GB", {
                day: "2-digit",
                month: "short",
                year: "numeric"
              })
            : "Unknown date";

          const basePostcode = client.base_postcode || "No postcode set";
          const planStatus = client.plan_status || "No plan";
          const servicesSummary = client.services_summary || "";

          const origin = computeOrigin(client);

          // Derive link to wizard:
          // Prefer signup_id → app.html?signup_id=...
          // Otherwise use profile id → app.html?profile_id=...
          const signupId = client.signup_id || null;
          const profileId = client.id;
          const wizardUrl = signupId
            ? `app.html?signup_id=${encodeURIComponent(signupId)}`
            : `app.html?profile_id=${encodeURIComponent(profileId)}`;

          // Build tags from services_summary (simple split)
          const tags = servicesSummary
            .split(",")
            .map((s) => s.trim())
            .filter(Boolean);

          card.innerHTML = `
            <div class="client-header-row">
              <div>
                <div class="client-name">${client.business_name || "Unnamed business"}</div>
                <div class="client-sub">
                  ${client.contact_name ? client.contact_name + " · " : ""}${
            client.email || "No email yet"
          }
                </div>
              </div>
              <div>
                <div class="status-pill ${pillClass}">
                  <span class="pill-dot"></span>
                  <span>${pillLabel}</span>
                </div>
              </div>
            </div>

            <div class="client-meta-row">
              <div class="client-meta-item">
                <span class="meta-dot"></span>
                <span>${basePostcode}</span>
              </div>
              <div class="client-meta-item">
                <span class="meta-dot"></span>
                <span>Plan: ${planStatus}</span>
              </div>
              ${
                client.phone
                  ? `<div class="client-meta-item">
                       <span class="meta-dot"></span>
                       <span>${client.phone}</span>
                     </div>`
                  : ""
              }
              <div class="client-meta-item">
                <span class="meta-dot"></span>
                <span>Profile created: ${createdAtText}</span>
              </div>
            </div>

            <div class="tag-row">
              <span class="small-tag ${origin.cls}">${origin.label}</span>
              ${
                tags.length
                  ? tags
                      .map(
                        (t) =>
                          `<span class="small-tag">${t
                            .replace("Emergency / urgent jobs", "Emergency")
                            .replace("Small jobs / quick wins", "Small jobs")
                            .replace("Bigger projects / installs", "Big projects")
                            .replace("Maintenance / servicing", "Servicing")
                            .replace("Landlords / repeat clients", "Landlords")
                          }</span>`
                      )
                      .join("")
                  : ""
              }
            </div>

            <div class="client-actions-row">
              <button type="button" class="btn btn-secondary" data-action="open-wizard" data-href="${wizardUrl}">
                Open in wizard
              </button>
              <button type="button" class="btn btn-primary" data-action="open-messages" data-id="${profileId}">
                Open CRM / messages
              </button>
            </div>
          `;

          clientsListEl.appendChild(card);
        });
      }

      // Summary counts
      const total = allClients.length;
      const liveCount = allClients.filter((c) => {
        const stage = computeStageKey(c);
        return stage === "live" || isTrialStage(stage);
      }).length;

      if (summaryTotalEl) summaryTotalEl.textContent = total.toString();
      if (summaryTotalInlineEl) summaryTotalInlineEl.textContent = total.toString();
      if (summaryVisibleEl) summaryVisibleEl.textContent = filtered.length.toString();
      if (summaryLiveEl) summaryLiveEl.textContent = liveCount.toString();
    }

    // ---- Load data ----
    async function loadClients() {
      if (statusMessageEl) {
        statusMessageEl.textContent = "Loading clients from business_profiles…";
        statusMessageEl.className = "";
      }

      // 1) Load business_profiles
      const { data, error } = await supabaseFetch(
        "/business_profiles?select=*&order=created_at.desc",
        { method: "GET" }
      );

      if (error) {
        console.error("Error loading business_profiles:", error);
        if (statusMessageEl) {
          statusMessageEl.textContent =
            "There was a problem loading clients. Please refresh or try again later.";
          statusMessageEl.className = "status-error";
        }
        return;
      }

      allClients = Array.isArray(data) ? data : [];
      console.log("Loaded business_profiles for dashboard:", allClients);

      // 2) Load matching tradebotpro_signups for any signup_ids
      const signupIds = Array.from(
        new Set(
          allClients
            .map((c) => c.signup_id)
            .filter((id) => !!id)
        )
      );

      signupMap = {};

      if (signupIds.length) {
        const inList = signupIds.join(",");
        const { data: signups, error: signupsError } = await supabaseFetch(
          `/tradebotpro_signups?select=*&id=in.(${inList})`,
          { method: "GET" }
        );

        if (signupsError) {
          console.error("Error loading tradebotpro_signups:", signupsError);
        } else if (Array.isArray(signups)) {
          signups.forEach((row) => {
            if (row.id) {
              signupMap[row.id] = row;
            }
          });
          console.log("Loaded linked tradebotpro_signups:", signupMap);
        }
      }

      if (statusMessageEl) {
        statusMessageEl.textContent = "";
        statusMessageEl.className = "";
      }

      render();
    }

    // ---- Event wiring ----
    if (stageFiltersEl) {
      stageFiltersEl.addEventListener("click", (evt) => {
        const btn = evt.target.closest(".chip[data-stage-filter]");
        if (!btn) return;
        const value = btn.getAttribute("data-stage-filter");
        if (!value) return;

        activeStageFilter = value;
        Array.from(stageFiltersEl.querySelectorAll(".chip")).forEach((chip) =>
          chip.classList.toggle("is-active", chip === btn)
        );
        render();
      });
    }

    if (searchInputEl) {
      searchInputEl.addEventListener("input", () => {
        searchTerm = searchInputEl.value || "";
        render();
      });
    }

    if (clientsListEl) {
      clientsListEl.addEventListener("click", (evt) => {
        const btn = evt.target.closest("button[data-action]");
        if (!btn) return;
        const action = btn.getAttribute("data-action");
        if (action === "open-wizard") {
          const href = btn.getAttribute("data-href");
          if (href) {
            window.open(href, "_blank");
          }
        } else if (action === "open-messages") {
          const id = btn.getAttribute("data-id");
          // Placeholder – later this can open a dedicated CRM/messages view
          alert("Messages/CRM view coming soon for profile id: " + id);
        }
      });
    }

    // Init
    loadClients();
  });
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TradeBotPro — Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --primary-blue:#1f4e79;
      --light-bg:#f5f7fa;
      --dark-text:#1b1b1f;
      --card:#ffffff;
      --border:rgba(0,0,0,0.12);
      --shadow:0 8px 24px rgba(0,0,0,0.08);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;background:var(--light-bg);color:var(--dark-text);}
    header{padding:18px 16px;background:#fff;border-bottom:1px solid var(--border);}
    header .wrap{max-width:1200px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:12px;}
    .brand{font-weight:900;color:var(--primary-blue);letter-spacing:.2px;}
    main{max-width:1200px;margin:18px auto;padding:0 16px 40px;display:grid;grid-template-columns:360px 1fr;gap:16px;}
    @media (max-width:980px){main{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px;}
    .card h2{margin:0 0 10px;font-size:16px;color:var(--primary-blue);}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid var(--border);font-weight:800;font-size:12px;background:#fff;white-space:nowrap;}
    .status-boxes{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px;}
    .status-box{border:1px solid var(--border);border-radius:14px;padding:12px;background:#fff;cursor:pointer;}
    .status-box .row{display:flex;align-items:center;justify-content:space-between;gap:10px;}
    .status-box .name{font-weight:900;}
    .status-box .count{font-weight:900;padding:4px 10px;border-radius:999px;border:1px solid var(--border);}
    .status-box.active{outline:2px solid rgba(0,0,0,0.18);}
    .search{display:flex;gap:10px;margin:10px 0 0;}
    input{width:100%;padding:11px 12px;border-radius:12px;border:1px solid var(--border);background:#fff;outline:none;font-size:14px;}
    table{width:100%;border-collapse:separate;border-spacing:0;overflow:hidden;border-radius:14px;border:1px solid var(--border);background:#fff;}
    th,td{padding:12px 10px;border-bottom:1px solid rgba(0,0,0,0.08);font-size:14px;vertical-align:top;}
    th{text-align:left;font-size:12px;letter-spacing:.4px;text-transform:uppercase;color:rgba(0,0,0,0.6);background:#fafbfc;}
    tr:last-child td{border-bottom:none}
    .btn{border:none;border-radius:12px;padding:9px 12px;font-weight:900;cursor:pointer;font-size:13px;}
    .btn-primary{background:var(--primary-blue);color:#fff;}
    .muted{color:rgba(0,0,0,0.55);font-size:12px;line-height:1.5;margin:8px 0 0;}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="brand">TradeBotPro — Dashboard</div>
    <div class="pill" id="pillFilter">Filter: All</div>
  </div>
</header>

<main>
  <aside class="card">
    <h2>Onboarding stages</h2>
    <div class="status-boxes" id="statusBoxes"></div>
    <div class="search">
      <input id="search" placeholder="Search name, email, phone, postcode…" />
    </div>
    <p class="muted">Click a stage box to filter. Click again to clear.</p>
  </aside>

  <section class="card">
    <h2>Customers</h2>
    <div id="tableWrap"></div>
  </section>
</main>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  const SUPABASE_URL = "PASTE_YOUR_SUPABASE_URL_HERE";
  const SUPABASE_ANON_KEY = "PASTE_YOUR_SUPABASE_ANON_KEY_HERE";
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const ONBOARDING_STATUSES = [
    "New Signup",
    "Booked Demo",
    "Demo Completed",
    "WhatsApp Connected",
    "Flows Built",
    "Calendar Linked",
    "Live",
    "Paused"
  ];

  const statusBoxesEl = document.getElementById("statusBoxes");
  const tableWrap = document.getElementById("tableWrap");
  const pillFilter = document.getElementById("pillFilter");
  const searchEl = document.getElementById("search");

  let currentStatusFilter = null;
  let searchTerm = "";

  function esc(s){ return (s ?? "").toString().replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  function renderStatusBoxes(counts){
    statusBoxesEl.innerHTML = "";
    for (const status of ONBOARDING_STATUSES){
      const count = counts[status] || 0;
      const box = document.createElement("div");
      box.className = "status-box" + (currentStatusFilter === status ? " active" : "");
      box.innerHTML = `
        <div class="row">
          <div class="name">${esc(status)}</div>
          <div class="count">${count}</div>
        </div>
      `;
      box.addEventListener("click", () => {
        currentStatusFilter = (currentStatusFilter === status) ? null : status;
        pillFilter.textContent = "Filter: " + (currentStatusFilter || "All");
        loadAll();
      });
      statusBoxesEl.appendChild(box);
    }
  }

  function renderTable(rows){
    const html = `
      <table>
        <thead>
          <tr>
            <th>Business</th>
            <th>Contact</th>
            <th>Status</th>
            <th>Lead Source</th>
            <th>Updated</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          ${rows.map(r => `
            <tr>
              <td>
                <div style="font-weight:900">${esc(r.business_name || "—")}</div>
                <div class="muted">${esc(r.trade_type || "")}</div>
              </td>
              <td>
                <div>${esc(r.contact_name || r.owner_name || "—")}</div>
                <div class="muted">${esc(r.email || "")}</div>
                <div class="muted">${esc(r.phone || r.whatsapp_number || "")}</div>
                <div class="muted">${esc(r.base_postcode || "")}</div>
              </td>
              <td><span class="pill">${esc(r.onboarding_status || "New Signup")}</span></td>
              <td><span class="pill">${esc(r.lead_source || "—")}</span></td>
              <td class="muted">${esc(r.updated_at ? new Date(r.updated_at).toLocaleString() : "—")}</td>
              <td style="text-align:right">
                <button class="btn btn-primary" onclick="window.open('app.html?id=${esc(r.id)}','_blank')">Open in wizard</button>
              </td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    `;
    tableWrap.innerHTML = html;
  }

  async function loadCounts(){
    const { data, error } = await supabase.from("customers").select("onboarding_status");
    if (error){ console.error("Load counts error:", error); return {}; }

    const counts = {};
    for (const row of data){
      const s = row.onboarding_status || "New Signup";
      counts[s] = (counts[s] || 0) + 1;
    }
    return counts;
  }

  async function loadCustomers(){
    let q = supabase.from("customers").select("*").order("updated_at", { ascending: false });
    if (currentStatusFilter) q = q.eq("onboarding_status", currentStatusFilter);

    const { data, error } = await q;
    if (error){ console.error("Load customers error:", error); return []; }

    if (searchTerm){
      const t = searchTerm.toLowerCase();
      return data.filter(r => ([r.business_name,r.contact_name,r.owner_name,r.email,r.phone,r.whatsapp_number,r.base_postcode,r.trade_type,r.lead_source].join(" ").toLowerCase()).includes(t));
    }
    return data;
  }

  async function loadAll(){
    const [counts, customers] = await Promise.all([loadCounts(), loadCustomers()]);
    renderStatusBoxes(counts);
    renderTable(customers);
  }

  searchEl.addEventListener("input", () => {
    searchTerm = searchEl.value.trim();
    loadAll();
  });

  pillFilter.textContent = "Filter: All";
  loadAll();
</script>
</body>
</html>

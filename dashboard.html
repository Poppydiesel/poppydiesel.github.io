<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>TradeBotPro â€” Customers Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
:root{
  --primary-blue:#1f4e79;
  --accent-blue:#00a3ff;
  --dark-text:#151820;
  --muted-text:#6b7280;
  --border-subtle:rgba(15,23,42,0.12);
  --white:#ffffff;
  --danger-red:#b3261e;
  --amber:#b45309;
  --success:#0f7b46;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
  background:radial-gradient(circle at top left,#e0ebff 0,#f3f4f9 40%,#fdfdfd 100%);
  color:var(--dark-text);
}
header{background:#f8fafc;border-bottom:1px solid rgba(15,23,42,.08)}
.header-inner{
  max-width:1200px;margin:0 auto;padding:.7rem 1.25rem;
  display:flex;align-items:center;justify-content:space-between;gap:1rem;
}
.logo{font-weight:800;color:var(--primary-blue)}
main{max-width:1200px;margin:0 auto;padding:1.2rem}
.panel{
  background:#fff;border-radius:1.1rem;border:1px solid rgba(15,23,42,.08);
  padding:1.1rem;
}
.kicker{font-size:.72rem;letter-spacing:.12em;text-transform:uppercase;color:var(--accent-blue)}
h1{margin:.15rem 0 .35rem;color:var(--primary-blue)}
.subtitle{font-size:.9rem;color:var(--muted-text);margin:0 0 .9rem}

.status-strip{display:flex;gap:.55rem;flex-wrap:wrap;margin-bottom:.75rem}
.status-chip{
  padding:.45rem .8rem;border-radius:999px;border:1px solid rgba(15,23,42,.12);
  background:#fff;cursor:pointer;font-weight:650;font-size:.85rem;
}
.status-chip.is-active{background:#eef2ff;border-color:var(--primary-blue)}

.controls{
  display:flex;align-items:center;gap:.6rem;
  margin:.8rem 0 .9rem;flex-wrap:nowrap;
}
.search{
  flex:1;display:flex;align-items:center;gap:.45rem;
  padding:.55rem .65rem;border:1px solid var(--border-subtle);
  border-radius:999px;background:#fff;min-width:320px;
}
.search input{border:0;outline:0;width:100%;font-size:.9rem;background:transparent}
.btn{
  padding:.5rem 1rem;border-radius:999px;border:1px solid transparent;
  cursor:pointer;font-weight:650;font-size:.85rem;white-space:nowrap;
}
.btn-secondary{background:#f3f4f6;border-color:var(--border-subtle)}
.btn-primary{background:linear-gradient(135deg,var(--primary-blue),#163857);color:#fff}

@media(max-width:900px){
  .controls{flex-wrap:wrap}
  .search{order:10;width:100%;min-width:0}
}

.banner{
  display:none;margin:.6rem 0 .9rem;
  padding:.75rem .9rem;border-radius:.9rem;
  border:1px solid rgba(179,38,30,0.25);
  background:#fff1f2;color:#7f1d1d;font-size:.88rem;white-space:pre-wrap;
}
.banner.show{display:block}

.table-wrap{border-radius:.9rem;overflow:auto;border:1px solid rgba(15,23,42,.08)}
table{width:100%;border-collapse:collapse;min-width:1000px}
th,td{padding:.65rem .75rem;border-bottom:1px solid rgba(15,23,42,.06);font-size:.9rem;white-space:nowrap}
th{background:#f8fafc;font-size:.75rem;text-transform:uppercase;letter-spacing:.1em;color:var(--muted-text)}
tr:hover{background:#f7fbff;cursor:pointer}

.badge{padding:.2rem .55rem;border-radius:999px;font-size:.75rem;font-weight:750;display:inline-block}
.badge.new{background:#eef2ff;color:var(--primary-blue)}
.badge.demo{background:#fffbeb;color:var(--amber)}

/* BACKDROP + DRAWER */
.backdrop{
  position:fixed;inset:0;background:rgba(15,23,42,.38);
  opacity:0;pointer-events:none;transition:opacity .18s ease;z-index:998;
}
.backdrop.show{opacity:1;pointer-events:auto}

/* WIDER drawer (900px) */
.drawer{
  position:fixed;top:0;right:-900px;width:900px;max-width:98vw;height:100%;
  background:#fff;box-shadow:-20px 0 40px rgba(0,0,0,.15);
  transition:right .22s ease;z-index:999;display:flex;flex-direction:column;
}
.drawer.open{right:0}
.drawer-header{padding:1rem;border-bottom:1px solid var(--border-subtle);background:#f8fafc}
.drawer-title{font-weight:800;color:var(--primary-blue);font-size:1.05rem}
.drawer-sub{font-size:.85rem;color:var(--muted-text);margin-top:.25rem}
.drawer-body{padding:1rem;flex:1;overflow-y:auto}
.drawer-footer{
  padding:1rem;border-top:1px solid var(--border-subtle);
  display:flex;justify-content:space-between;align-items:center;gap:.6rem;flex-wrap:wrap;
}
.drawer-hint{font-size:.82rem;color:var(--muted-text)}

.section-title{font-weight:800;color:var(--primary-blue);font-size:.9rem;margin:.6rem 0 .4rem}
.chip-row{display:flex;flex-wrap:wrap;gap:8px}
.chip{
  padding:.45rem .8rem;border-radius:999px;border:1px solid rgba(15,23,42,.12);
  background:#fff;cursor:pointer;font-weight:650;font-size:.85rem;
}
.chip.is-active{background:#eef2ff;border-color:var(--primary-blue)}

.checklist{border:1px solid rgba(15,23,42,.08);border-radius:.9rem;padding:.65rem .75rem}
.check-item{
  display:flex;align-items:center;justify-content:space-between;gap:.6rem;
  padding:.55rem 0;cursor:pointer;
}
.check-item:not(:last-child){border-bottom:1px dashed rgba(148,163,184,.55)}
.check-left{display:flex;align-items:center;gap:.55rem;min-width:0}
.check-badge{
  width:22px;height:22px;border-radius:8px;display:inline-flex;align-items:center;justify-content:center;
  font-size:.85rem;border:1px solid rgba(148,163,184,0.55);background:#f1f5f9;color:#475569;flex:0 0 auto;
}
.check-badge.done{border-color:rgba(15,123,70,0.35);background:#ecfdf5;color:#14532d}
.check-name{font-weight:700;font-size:.9rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.check-state{font-size:.82rem;color:var(--muted-text);flex:0 0 auto}

.drawer-body label{display:block;font-size:.78rem;color:var(--muted-text);margin:.6rem 0 .25rem}
.drawer-body textarea{
  width:100%;min-height:110px;border-radius:.85rem;border:1px solid var(--border-subtle);
  padding:.6rem .7rem;font:inherit;outline:none;background:#fff;resize:vertical;
}
</style>
</head>

<body>
<header>
  <div class="header-inner">
    <div class="logo">TradeBotPro</div>
    <div style="font-size:.8rem;color:#6b7280;">Onboarding Dashboard</div>
  </div>
</header>

<main>
  <div class="panel">
    <div class="kicker">Customers</div>
    <h1>Customers by onboarding status (sales) + setup tasks (ops)</h1>
    <p class="subtitle">Clear filters, Search, Refresh, and New customer sit on one row.</p>

    <div class="status-strip" id="status-strip"></div>

    <div class="controls">
      <button class="btn btn-secondary" id="btn-clear-filter" type="button">Clear filters</button>

      <div class="search">
        <span style="opacity:.7">ðŸ”Ž</span>
        <input id="search" type="text" placeholder="Search business, contact, email, phoneâ€¦" />
      </div>

      <button class="btn btn-secondary" id="btn-refresh" type="button">â†» Refresh</button>
      <button class="btn btn-primary" id="btn-new" type="button">+ New customer</button>
    </div>

    <div id="banner" class="banner"></div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Attention</th>
            <th>Status</th>
            <th>Business</th>
            <th>Contact</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Updated</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="7">Loadingâ€¦</td></tr>
        </tbody>
      </table>
    </div>

    <div id="status-bar" style="margin-top:.6rem;font-size:.8rem;color:#6b7280"></div>
  </div>
</main>

<!-- Drawer UI -->
<div class="backdrop" id="backdrop" aria-hidden="true"></div>

<div class="drawer" id="drawer" aria-hidden="true">
  <div class="drawer-header">
    <div class="drawer-title" id="drawerTitle">Customer</div>
    <div class="drawer-sub" id="drawerSub">â€”</div>
  </div>

  <div class="drawer-body">
    <div class="section-title">Sales stage</div>
    <div class="chip-row" id="salesChips"></div>

    <div class="section-title">Setup tasks (ops)</div>
    <div class="checklist" id="opsChecklist"></div>

    <div class="section-title">Notes</div>
    <label for="drawerNotes">Internal notes (autosaves)</label>
    <textarea id="drawerNotes" placeholder="Sales notes / objections / follow-up planâ€¦"></textarea>
  </div>

  <div class="drawer-footer">
    <div class="drawer-hint" id="drawerHint">Autosaves</div>
    <div style="display:flex;gap:.5rem;flex-wrap:wrap;justify-content:flex-end">
      <button class="btn btn-secondary" id="btnOpenWizard" type="button">Open wizard</button>
      <button class="btn btn-secondary" id="btnCloseDrawer" type="button">Close</button>
    </div>
  </div>
</div>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  const SUPABASE_URL = "https://yaiutswdcbfwkxfqxkzy.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlhaXV0c3dkY2Jmd2t4ZnF4a3p5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1MDE2MDgsImV4cCI6MjA4MDA3NzYwOH0.HOLFxzjsZ5Ieqg0b-aTdP0hAdLsPVXL6Zjs-HgOHgc8";
  const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const tbody = document.getElementById("tbody");
  const statusStrip = document.getElementById("status-strip");
  const search = document.getElementById("search");
  const statusBar = document.getElementById("status-bar");
  const banner = document.getElementById("banner");

  const btnRefresh = document.getElementById("btn-refresh");
  const btnNew = document.getElementById("btn-new");
  const btnClear = document.getElementById("btn-clear-filter");

  // Drawer
  const drawer = document.getElementById("drawer");
  const backdrop = document.getElementById("backdrop");
  const drawerTitle = document.getElementById("drawerTitle");
  const drawerSub = document.getElementById("drawerSub");
  const salesChips = document.getElementById("salesChips");
  const opsChecklist = document.getElementById("opsChecklist");
  const drawerNotes = document.getElementById("drawerNotes");
  const drawerHint = document.getElementById("drawerHint");
  const btnCloseDrawer = document.getElementById("btnCloseDrawer");
  const btnOpenWizard = document.getElementById("btnOpenWizard");

  let rows = [];
  let activeStatus = null;
  let activeRow = null;
  let noteTimer = null;

  const SALES = ["New Signup","In Setup","Demo","Free Trial","Needs Convincing","Live"];

  function showError(msg){
    banner.textContent = msg;
    banner.classList.add("show");
  }
  function clearError(){
    banner.textContent = "";
    banner.classList.remove("show");
  }
  function safeText(v){ return (v ?? "").toString(); }
  function stageOf(r){ return safeText(r.onboarding_status).trim() || "New Signup"; }

  function badge(r){
    if(stageOf(r) === "Demo" && !r.wizard_completed) return `<span class="badge demo">Demo gap</span>`;
    if(stageOf(r) === "New Signup") return `<span class="badge new">New</span>`;
    return "â€”";
  }

  function opsTasks(r){
    return [
      { key:"wizard_completed", label:"Wizard submitted", done: !!r.wizard_completed },
      { key:"whatsapp_connected", label:"WhatsApp connected", done: !!r.whatsapp_connected },
      { key:"calendar_connected", label:"Calendar connected", done: !!r.calendar_connected },
      { key:"payments_connected", label:"Payments connected", done: !!r.payments_connected },
    ];
  }

  function renderStatuses(){
    statusStrip.innerHTML = "";

    const mk = (label, value) => {
      const el = document.createElement("div");
      el.className = "status-chip" + ((activeStatus===value) ? " is-active" : "");
      el.textContent = label;
      el.onclick = ()=>{ activeStatus=value; renderStatuses(); render(); };
      statusStrip.appendChild(el);
    };

    mk("All", null);
    SALES.forEach(s => mk(s, s));
  }

  function render(){
    const q = (search.value || "").trim().toLowerCase();

    const filtered = rows.filter(r=>{
      const stage = stageOf(r);
      if(activeStatus && stage !== activeStatus) return false;

      if(q){
        const hay = [r.business_name,r.contact_name,r.email,r.phone,r.base_postcode,stage]
          .map(safeText).join(" ").toLowerCase();
        if(!hay.includes(q)) return false;
      }
      return true;
    });

    tbody.innerHTML = "";
    if(!filtered.length){
      tbody.innerHTML = `<tr><td colspan="7">No matches.</td></tr>`;
      statusBar.textContent = `0 shown â€¢ ${rows.length} total`;
      return;
    }

    for(const r of filtered){
      const stage = stageOf(r);
      const upd = r.updated_at || r.created_at || null;
      const updTxt = upd ? new Date(upd).toLocaleString() : "â€”";

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${badge(r)}</td>
        <td>${stage}</td>
        <td>${safeText(r.business_name) || "â€”"}</td>
        <td>${safeText(r.contact_name) || "â€”"}</td>
        <td>${safeText(r.email) || "â€”"}</td>
        <td>${safeText(r.phone) || "â€”"}</td>
        <td>${updTxt}</td>
      `;
      tr.onclick = ()=> openDrawer(r);
      tbody.appendChild(tr);
    }

    statusBar.textContent = `${filtered.length} shown â€¢ ${rows.length} total` + (activeStatus ? ` â€¢ Stage: ${activeStatus}` : "");
  }

  function openDrawer(r){
    activeRow = r;
    drawerTitle.textContent = r.business_name || "Customer";
    drawerSub.textContent = [
      r.contact_name ? `Contact: ${r.contact_name}` : "",
      r.id ? `ID: ${r.id}` : ""
    ].filter(Boolean).join(" â€¢ ");

    // sales chips
    salesChips.innerHTML = "";
    SALES.forEach(stage=>{
      const b = document.createElement("button");
      b.type = "button";
      b.className = "chip" + (stageOf(r) === stage ? " is-active" : "");
      b.textContent = stage;
      b.onclick = async (e)=>{
        e.stopPropagation();
        if(!activeRow) return;
        if(stageOf(activeRow) === stage) return;

        const updated = await updateCustomer(activeRow.id, { onboarding_status: stage });
        if(updated){
          activeRow = updated;
          const idx = rows.findIndex(x=>x.id===updated.id);
          if(idx !== -1) rows[idx] = updated;
          renderStatuses();
          render();
          openDrawer(updated);
        }
      };
      salesChips.appendChild(b);
    });

    // ops checklist
    const items = opsTasks(r);
    opsChecklist.innerHTML = items.map(i=>{
      const badgeTxt = i.done ? "âœ“" : "";
      const badgeCls = i.done ? "check-badge done" : "check-badge";
      const state = i.done ? "Completed" : "Click to toggle";
      return `
        <div class="check-item" data-key="${i.key}">
          <div class="check-left">
            <div class="${badgeCls}">${badgeTxt}</div>
            <div class="check-name">${i.label}</div>
          </div>
          <div class="check-state">${state}</div>
        </div>
      `;
    }).join("");

    drawerNotes.value = r.notes || "";
    drawerHint.textContent = "Autosaves";

    drawer.classList.add("open");
    drawer.setAttribute("aria-hidden","false");
    backdrop.classList.add("show");
    backdrop.setAttribute("aria-hidden","false");
  }

  function closeDrawer(){
    drawer.classList.remove("open");
    drawer.setAttribute("aria-hidden","true");
    backdrop.classList.remove("show");
    backdrop.setAttribute("aria-hidden","true");
    activeRow = null;
  }

  async function updateCustomer(id, patch){
    clearError();
    const { data, error } = await sb.from("customers").update(patch).eq("id", id).select("*").single();
    if(error){
      console.error(error);
      showError("Save failed:\n\n" + (error.message || JSON.stringify(error)));
      return null;
    }
    return data;
  }

  async function saveNotesNow(){
    if(!activeRow) return;
    drawerHint.textContent = "Savingâ€¦";

    const patch = { notes: drawerNotes.value };
    const { error } = await sb.from("customers").update(patch).eq("id", activeRow.id);
    if(error){
      console.error(error);
      showError("Failed to save notes:\n\n" + (error.message || JSON.stringify(error)));
      drawerHint.textContent = "Save failed";
      return;
    }

    drawerHint.textContent = "Saved";

    // update local row cache
    activeRow.notes = patch.notes;
    const idx = rows.findIndex(x=>x.id===activeRow.id);
    if(idx !== -1) rows[idx].notes = patch.notes;
  }

  function queueNotesSave(){
    clearTimeout(noteTimer);
    noteTimer = setTimeout(saveNotesNow, 450);
  }

  // Click ops toggle
  document.addEventListener("click", async (e)=>{
    const item = e.target.closest(".check-item[data-key]");
    if(!item || !activeRow) return;

    const key = item.dataset.key;
    const patch = {};
    patch[key] = !activeRow[key];

    const updated = await updateCustomer(activeRow.id, patch);
    if(updated){
      activeRow = updated;
      const idx = rows.findIndex(x=>x.id===updated.id);
      if(idx !== -1) rows[idx] = updated;
      render();
      openDrawer(updated);
    }
  }, true);

  // Drawer controls
  btnCloseDrawer.onclick = closeDrawer;
  btnOpenWizard.onclick = (e)=>{
    e.stopPropagation();
    if(!activeRow) return;
    window.open(`app.html?id=${encodeURIComponent(activeRow.id)}`, "_blank", "noopener");
  };
  drawerNotes.addEventListener("input", queueNotesSave);

  // Close on backdrop + ESC
  backdrop.addEventListener("click", closeDrawer);
  document.addEventListener("keydown", (e)=>{
    if(e.key === "Escape" && drawer.classList.contains("open")){
      e.preventDefault();
      closeDrawer();
    }
  });

  async function load(){
    clearError();
    statusBar.textContent = "Loadingâ€¦";
    tbody.innerHTML = `<tr><td colspan="7">Loadingâ€¦</td></tr>`;

    // order newest first (prevents â€œlooks stuckâ€)
    const { data, error } = await sb.from("customers").select("*").order("updated_at", { ascending:false });

    if(error){
      console.error(error);
      showError("Failed to load customers:\n\n" + (error.message || JSON.stringify(error)));
      rows = [];
      render();
      return;
    }

    rows = Array.isArray(data) ? data : [];
    renderStatuses();
    render();
  }

  btnRefresh.onclick = load;
  btnNew.onclick = ()=> window.open("app.html", "_blank", "noopener");
  btnClear.onclick = ()=>{ activeStatus=null; search.value=""; renderStatuses(); render(); };
  search.oninput = render;

  // START
  renderStatuses();
  load();
</script>

</body>
</html>

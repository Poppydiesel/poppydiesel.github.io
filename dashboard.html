<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TradeBotPro ‚Äì Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="TradeBotPro customer onboarding dashboard." />

  <style>
    :root {
      --primary-blue: #1f4e79;
      --accent-blue: #00a3ff;
      --dark-text: #151820;
      --muted-text: #6b7280;
      --light-bg: #f3f4f9;
      --white: #ffffff;
      --border-subtle: rgba(15, 23, 42, 0.12);
      --success-green: #0f7b46;
      --error-red: #b3261e;
      --shadow: 0 24px 60px rgba(15, 23, 42, 0.15), 0 0 0 1px rgba(15, 23, 42, 0.03);
    }

    * { box-sizing: border-box; }
    html { scroll-behavior: smooth; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      background: radial-gradient(circle at top left, #e0ebff 0, #f3f4f9 40%, #fdfdfd 100%);
      color: var(--dark-text);
      line-height: 1.5;
    }
    a { color: inherit; text-decoration: none; }

    header {
      border-bottom: 1px solid rgba(15, 23, 42, 0.06);
      background: rgba(248, 250, 252, 0.96);
      backdrop-filter: blur(6px);
      position: sticky;
      top: 0;
      z-index: 20;
    }
    .header-inner {
      max-width: 1180px;
      margin: 0 auto;
      padding: 0.6rem 1.25rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
    }
    .logo-wrap { display: flex; align-items: center; gap: 0.6rem; }
    .logo-icon {
      width: 30px; height: 30px; border-radius: 9px;
      background: var(--primary-blue); position: relative;
    }
    .logo-icon::before, .logo-icon::after { content:""; position:absolute; background: var(--white); border-radius: 4px; }
    .logo-icon::before { width: 11px; height: 17px; left: 7px; top: 6px; }
    .logo-icon::after { width: 6px; height: 11px; right: 7px; top: 9px; }
    .logo-main { font-weight: 700; font-size: 1rem; color: var(--primary-blue); }
    .logo-tag { font-size: 0.75rem; color: var(--muted-text); }
    .header-note { font-size: 0.75rem; color: var(--muted-text); }
    .header-note strong { color: var(--primary-blue); font-weight: 600; }

    main {
      max-width: 1180px;
      margin: 0 auto;
      padding: 1.4rem 1.25rem 2.2rem;
    }

    .shell {
      width: 100%;
      display: grid;
      grid-template-columns: minmax(280px, 360px) minmax(0, 1fr);
      gap: 1.25rem;
      align-items: start;
    }

    .panel {
      border-radius: 1.2rem;
      background: rgba(255, 255, 255, 0.92);
      box-shadow: var(--shadow);
      padding: 1.1rem 1.1rem;
    }
    .panel.soft {
      background: rgba(248, 250, 252, 0.96);
      border: 1px solid rgba(148, 163, 184, 0.35);
      box-shadow: none;
    }

    .kicker {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--accent-blue);
      margin-bottom: 0.35rem;
    }
    .title {
      margin: 0 0 0.35rem;
      font-size: 1.35rem;
      color: var(--primary-blue);
    }
    .subtitle {
      margin: 0 0 0.85rem;
      font-size: 0.9rem;
      color: var(--muted-text);
    }

    .status-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 0.65rem;
      margin-top: 0.75rem;
    }
    .status-card {
      width: 100%;
      border-radius: 0.95rem;
      padding: 0.8rem 0.85rem;
      border: 1px solid rgba(15, 23, 42, 0.10);
      background: #ffffff;
      cursor: pointer;
      transition: transform 0.12s ease, box-shadow 0.12s ease, border-color 0.12s ease;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.8rem;
    }
    .status-card:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 26px rgba(15, 23, 42, 0.12);
      border-color: rgba(31, 78, 121, 0.35);
    }
    .status-card.is-active {
      border-color: rgba(31, 78, 121, 0.7);
      box-shadow: 0 0 0 2px rgba(31, 78, 121, 0.12);
      background: #f3f7ff;
    }
    .status-name { font-weight: 650; color: var(--dark-text); font-size: 0.92rem; }
    .status-meta { font-size: 0.76rem; color: var(--muted-text); margin-top: 0.12rem; }
    .status-count {
      min-width: 44px;
      text-align: center;
      padding: 0.25rem 0.55rem;
      border-radius: 999px;
      background: #eef2ff;
      border: 1px solid rgba(37, 99, 235, 0.22);
      color: var(--primary-blue);
      font-weight: 700;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 0.65rem;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.85rem;
    }
    .controls-left {
      display: flex;
      gap: 0.55rem;
      flex-wrap: wrap;
      align-items: center;
    }
    .search {
      width: min(420px, 100%);
      display: flex;
      gap: 0.5rem;
      align-items: center;
      padding: 0.6rem 0.7rem;
      border-radius: 0.75rem;
      border: 1px solid var(--border-subtle);
      background: var(--white);
    }
    .search input {
      border: 0;
      outline: 0;
      width: 100%;
      font: inherit;
      font-size: 0.92rem;
      background: transparent;
    }

    .btn {
      border-radius: 999px;
      border: 1px solid transparent;
      padding: 0.55rem 1.05rem;
      font-size: 0.86rem;
      font-weight: 550;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      background: transparent;
    }
    .btn:focus-visible { outline: 2px solid var(--accent-blue); outline-offset: 2px; }
    .btn-secondary { border-color: var(--border-subtle); background: #f9fafb; color: var(--dark-text); }
    .btn-secondary:hover { background: #e5e7eb; }
    .btn-primary {
      background: linear-gradient(135deg, var(--primary-blue), #163857);
      color: var(--white);
      border-color: transparent;
      box-shadow: 0 12px 28px rgba(15, 23, 42, 0.35);
    }
    .btn-primary:hover { filter: brightness(1.03); box-shadow: 0 16px 34px rgba(15, 23, 42, 0.4); }

    .table-wrap {
      overflow: auto;
      border-radius: 1rem;
      border: 1px solid rgba(15, 23, 42, 0.08);
      background: #fff;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 940px;
    }
    thead th {
      position: sticky;
      top: 0;
      background: #f8fafc;
      border-bottom: 1px solid rgba(15, 23, 42, 0.08);
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--muted-text);
      text-align: left;
      padding: 0.75rem 0.85rem;
      white-space: nowrap;
    }
    tbody td {
      border-bottom: 1px solid rgba(15, 23, 42, 0.06);
      padding: 0.75rem 0.85rem;
      font-size: 0.9rem;
      vertical-align: middle;
      white-space: nowrap;
    }
    tbody tr:hover { background: #f7fbff; }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.22rem 0.55rem;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.55);
      background: rgba(241, 245, 249, 0.9);
      font-size: 0.8rem;
      color: var(--dark-text);
    }
    .pill.ok { border-color: rgba(15, 123, 70, 0.45); background: #ecfdf5; color: #14532d; }
    .pill.no { border-color: rgba(179, 38, 30, 0.35); background: #fff1f2; color: #7f1d1d; }

    .row-actions {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      justify-content: flex-end;
    }

    .status-bar {
      margin-top: 0.8rem;
      font-size: 0.85rem;
      min-height: 1.2em;
    }
    .status-bar.success { color: var(--success-green); }
    .status-bar.error { color: var(--error-red); }
    .status-bar.muted { color: var(--muted-text); }

    @media (max-width: 980px) {
      .shell { grid-template-columns: 1fr; }
      table { min-width: 840px; }
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <div class="header-inner">
        <div class="logo-wrap">
          <div class="logo-icon" aria-hidden="true"></div>
          <div>
            <div class="logo-main">TradeBotPro</div>
            <div class="logo-tag">More jobs. Less admin. Powered by AI.</div>
          </div>
        </div>
        <div class="header-note">
          View: <strong>Onboarding Dashboard</strong>
        </div>
      </div>
    </header>

    <main>
      <div class="shell">
        <aside class="panel">
          <div class="kicker">Pipeline</div>
          <h1 class="title">Onboarding stages</h1>
          <p class="subtitle">Boxes are built from your real DB statuses.</p>

          <div class="status-grid" id="status-grid"></div>
          <div class="status-bar muted" id="left-hint"></div>
        </aside>

        <section class="panel soft">
          <div class="controls">
            <div class="controls-left">
              <div class="search">
                <span style="opacity:.7">üîé</span>
                <input id="search" type="text" placeholder="Search name, business, email, phone, postcode‚Ä¶" />
              </div>
              <button class="btn btn-secondary" id="btn-clear-filter" type="button">Clear filter</button>
            </div>

            <div class="controls-right">
              <button class="btn btn-secondary" id="btn-refresh" type="button">‚Üª Refresh</button>
              <button class="btn btn-primary" id="btn-new" type="button">+ New customer</button>
            </div>
          </div>

          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Status</th>
                  <th>Business</th>
                  <th>Contact</th>
                  <th>Email</th>
                  <th>Phone</th>
                  <th>Postcode</th>
                  <th>Wizard</th>
                  <th>Updated</th>
                  <th style="text-align:right;">Actions</th>
                </tr>
              </thead>
              <tbody id="tbody"></tbody>
            </table>
          </div>

          <div class="status-bar muted" id="status-bar">Loading‚Ä¶</div>
        </section>
      </div>
    </main>
  </div>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  const SUPABASE_URL = "https://yaiutswdcbfwkxfqxkzy.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlhaXV0c3dkY2Jmd2t4ZnF4a3p5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1MDE2MDgsImV4cCI6MjA4MDA3NzYwOH0.HOLFxzjsZ5Ieqg0b-aTdP0hAdLsPVXL6Zjs-HgOHgc8";
  const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  console.log("SCRIPT VERSION: DASHBOARD-REAL-STATUSES-2025-12-12");

  // DOM
  const statusGrid = document.getElementById("status-grid");
  const leftHint = document.getElementById("left-hint");
  const tbody = document.getElementById("tbody");
  const search = document.getElementById("search");
  const statusBar = document.getElementById("status-bar");

  const btnRefresh = document.getElementById("btn-refresh");
  const btnNew = document.getElementById("btn-new");
  const btnClearFilter = document.getElementById("btn-clear-filter");

  // State
  let allRows = [];
  let activeStatus = null; // string status or null for all
  let statusOrder = [];    // dynamic, pulled from DB rows

  function setStatusBar(text, kind = "muted") {
    statusBar.textContent = text || "";
    statusBar.className = "status-bar " + (kind || "muted");
  }

  function escapeHtml(s) {
    return String(s ?? "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function fmtDate(iso) {
    if (!iso) return "‚Äî";
    try {
      const d = new Date(iso);
      return d.toLocaleString(undefined, { year: "numeric", month: "short", day: "2-digit", hour: "2-digit", minute: "2-digit" });
    } catch { return "‚Äî"; }
  }

  // IMPORTANT: this is the status shown + counted
  // 1) if onboarding_status exists, we use it
  // 2) else: if wizard_completed => "Wizard Completed"
  // 3) else: if wizard_answers has any keys => "Wizard Started"
  // 4) else => "New Signup"
  function normalizeStatus(row) {
    const raw = (row?.onboarding_status ?? "").toString().trim();
    if (raw) return raw;

    if (row?.wizard_completed) return "Wizard Completed";

    const wa = row?.wizard_answers;
    const hasAnswers =
      wa && typeof wa === "object" && !Array.isArray(wa) && Object.keys(wa).length > 0;

    if (hasAnswers) return "Wizard Started";
    return "New Signup";
  }

  function rowMatchesSearch(row, q) {
    if (!q) return true;
    const hay = [
      row.business_name,
      row.contact_name,
      row.email,
      row.phone,
      row.base_postcode,
      normalizeStatus(row)
    ].join(" ").toLowerCase();
    return hay.includes(q.toLowerCase());
  }

  function makeCard(name, count, meta, value) {
    const card = document.createElement("button");
    card.type = "button";
    card.className = "status-card" + ((activeStatus === value) ? " is-active" : "");
    card.innerHTML = `
      <div>
        <div class="status-name">${escapeHtml(name)}</div>
        <div class="status-meta">${escapeHtml(meta || "")}</div>
      </div>
      <div class="status-count">${count}</div>
    `;
    card.addEventListener("click", () => {
      activeStatus = value; // null = all
      render();
    });
    return card;
  }

  function buildStatusCards(counts) {
    statusGrid.innerHTML = "";

    // All customers card
    statusGrid.appendChild(
      makeCard("All customers", allRows.length, "Show everyone", null)
    );

    // Dynamic cards from DB
    statusOrder.forEach((s) => {
      statusGrid.appendChild(
        makeCard(
          s,
          counts[s] || 0,
          s === "Live" ? "Already running" : "Needs action",
          s
        )
      );
    });

    leftHint.textContent = activeStatus ? `Filtering: ${activeStatus}` : `Showing: All customers`;
  }

  function computeStatusOrderAndCounts() {
    const counts = {};
    const set = new Set();

    for (const r of allRows) {
      const s = normalizeStatus(r);
      counts[s] = (counts[s] || 0) + 1;
      set.add(s);
    }

    // Make sure core fallbacks always appear (even if currently 0)
    set.add("New Signup");
    set.add("Wizard Started");
    set.add("Wizard Completed");

    // Sort with a sensible priority, then alpha for any unknowns
    const priority = [
      "New Signup",
      "Wizard Started",
      "Wizard Completed",
      "Demo Booked",
      "WhatsApp Connected",
      "Calendar Connected",
      "Live",
      "Paused / Not Proceeding"
    ];

    const all = Array.from(set);
    all.sort((a, b) => {
      const ia = priority.indexOf(a);
      const ib = priority.indexOf(b);
      if (ia !== -1 && ib !== -1) return ia - ib;
      if (ia !== -1) return -1;
      if (ib !== -1) return 1;
      return a.localeCompare(b);
    });

    statusOrder = all;
    return counts;
  }

  function render() {
    const counts = computeStatusOrderAndCounts();
    buildStatusCards(counts);

    const q = (search.value || "").trim();

    const rows = allRows
      .filter(r => (activeStatus ? normalizeStatus(r) === activeStatus : true))
      .filter(r => rowMatchesSearch(r, q))
      .sort((a, b) => new Date(b.updated_at || b.created_at || 0) - new Date(a.updated_at || a.created_at || 0));

    tbody.innerHTML = "";

    for (const r of rows) {
      const st = normalizeStatus(r);
      const wizardPill = r.wizard_completed
        ? `<span class="pill ok">‚úÖ Complete</span>`
        : `<span class="pill no">‚è≥ In progress</span>`;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><span class="pill">${escapeHtml(st)}</span></td>
        <td>${escapeHtml(r.business_name || "‚Äî")}</td>
        <td>${escapeHtml(r.contact_name || "‚Äî")}</td>
        <td>${escapeHtml(r.email || "‚Äî")}</td>
        <td>${escapeHtml(r.phone || "‚Äî")}</td>
        <td>${escapeHtml(r.base_postcode || "‚Äî")}</td>
        <td>${wizardPill}</td>
        <td>${escapeHtml(fmtDate(r.updated_at || r.created_at))}</td>
        <td>
          <div class="row-actions">
            <a class="btn btn-secondary" href="app.html?id=${encodeURIComponent(r.id)}" target="_blank" rel="noopener">Open in wizard</a>
          </div>
        </td>
      `;
      tbody.appendChild(tr);
    }

    setStatusBar(
      `${rows.length} shown ‚Ä¢ ${allRows.length} total` + (activeStatus ? ` ‚Ä¢ Filter: ${activeStatus}` : ""),
      "muted"
    );
  }

  async function loadCustomers() {
    setStatusBar("Loading customers‚Ä¶", "muted");

    const { data, error } = await sb
      .from("customers")
      .select("id, contact_name, business_name, email, phone, base_postcode, onboarding_status, wizard_completed, wizard_answers, created_at, updated_at")
      .order("updated_at", { ascending: false });

    if (error) {
      console.error("LOAD ERROR:", error);
      setStatusBar("Failed to load (check console).", "error");
      return;
    }

    allRows = data || [];
    render();
  }

  // Events
  btnRefresh.addEventListener("click", () => loadCustomers());
  btnClearFilter.addEventListener("click", () => { activeStatus = null; search.value = ""; render(); });
  search.addEventListener("input", () => render());
  btnNew.addEventListener("click", () => window.open("app.html", "_blank", "noopener"));

  // Init
  await loadCustomers();
</script>

</body>
</html>

<!-- SAME HEAD + STYLES AS BEFORE — unchanged -->
<!-- ONLY BODY TABLE + SCRIPT CHANGED -->

<!-- … keep everything above exactly as you already have … -->

<tbody id="tbody"></tbody>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const SUPABASE_URL = "https://yaiutswdcbfwkxfqxkzy.supabase.co";
const SUPABASE_ANON_KEY = "YOUR_KEY";
const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// ---------------- STATE ----------------
let allRows = [];
let activeStatus = null;
let statusOrder = [];
let leadOrder = [];

// ---------------- HELPERS ----------------
const qs = (s) => document.querySelector(s);

function normalizeStatus(r) {
  if (r.onboarding_status) return r.onboarding_status;
  if (r.wizard_completed) return "Wizard Completed";
  if (r.wizard_answers && Object.keys(r.wizard_answers).length) return "Wizard Started";
  return "New Signup";
}

function normalizeLead(r) {
  return r.lead_source?.trim() || "—";
}

function pillBool(v) {
  if (v === true) return `<span class="pill ok">Connected</span>`;
  if (v === false) return `<span class="pill no">Not yet</span>`;
  return `<span class="pill na">—</span>`;
}

// ---------------- SAVE HELPERS ----------------
async function updateRow(id, patch) {
  const { error } = await sb
    .from("customers")
    .update(patch)
    .eq("id", id);

  if (error) {
    console.error("UPDATE FAILED", error);
    alert("Save failed – see console");
    return false;
  }
  return true;
}

// ---------------- LOAD ----------------
async function loadCustomers() {
  const { data, error } = await sb
    .from("customers")
    .select("*")
    .order("updated_at", { ascending: false });

  if (error) {
    console.error(error);
    return;
  }

  allRows = data;
  render();
}

// ---------------- RENDER ----------------
function render() {
  const tbody = qs("#tbody");
  tbody.innerHTML = "";

  // collect dynamic statuses + leads
  const statusSet = new Set();
  const leadSet = new Set();

  allRows.forEach(r => {
    statusSet.add(normalizeStatus(r));
    if (r.lead_source) leadSet.add(r.lead_source);
  });

  statusOrder = Array.from(statusSet);
  leadOrder = Array.from(leadSet);

  allRows
    .filter(r => !activeStatus || normalizeStatus(r) === activeStatus)
    .forEach(r => {
      const tr = document.createElement("tr");

      tr.innerHTML = `
        <td>
          <select class="mini-select status-select" data-id="${r.id}">
            ${statusOrder.map(s => `
              <option ${normalizeStatus(r) === s ? "selected" : ""}>${s}</option>
            `).join("")}
          </select>
        </td>

        <td>
          <select class="mini-select lead-select" data-id="${r.id}">
            <option value="">—</option>
            ${leadOrder.map(l => `
              <option ${r.lead_source === l ? "selected" : ""}>${l}</option>
            `).join("")}
            <option value="__new__">+ Add new…</option>
          </select>
        </td>

        <td>${r.business_name || "—"}</td>
        <td>${r.contact_name || "—"}</td>
        <td>${r.email || "—"}</td>
        <td>${r.phone || "—"}</td>

        <td>${pillBool(r.whatsapp_connected)}</td>
        <td>${pillBool(r.calendar_connected)}</td>

        <td>
          <button class="btn btn-primary btn-live" data-id="${r.id}">
            Mark Live
          </button>
        </td>
      `;

      tbody.appendChild(tr);
    });

  bindRowEvents();
}

// ---------------- EVENTS ----------------
function bindRowEvents() {

  // STATUS CHANGE
  document.querySelectorAll(".status-select").forEach(sel => {
    sel.onchange = async (e) => {
      await updateRow(e.target.dataset.id, {
        onboarding_status: e.target.value
      });
      loadCustomers();
    };
  });

  // LEAD SOURCE CHANGE
  document.querySelectorAll(".lead-select").forEach(sel => {
    sel.onchange = async (e) => {
      const id = e.target.dataset.id;

      if (e.target.value === "__new__") {
        const val = prompt("Enter new lead source:");
        if (!val) return;
        await updateRow(id, { lead_source: val });
      } else {
        await updateRow(id, { lead_source: e.target.value || null });
      }
      loadCustomers();
    };
  });

  // MARK LIVE
  document.querySelectorAll(".btn-live").forEach(btn => {
    btn.onclick = async () => {
      const id = btn.dataset.id;

      await updateRow(id, {
        onboarding_status: "Live",
        whatsapp_connected: true,
        calendar_connected: true,
        live_at: new Date().toISOString()
      });

      loadCustomers();
    };
  });
}

// ---------------- INIT ----------------
loadCustomers();
</script>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TradeBotPro — Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      --primary-blue:#1f4e79;
      --accent-blue:#00a3ff;
      --light-bg:#f5f7fa;
      --dark-text:#1b1b1f;
      --card:#ffffff;
      --border:rgba(0,0,0,0.12);
      --shadow:0 8px 24px rgba(0,0,0,0.08);
      --radius:16px;
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      background:var(--light-bg);
      color:var(--dark-text);
    }

    header{
      padding:18px 16px;
      background:#fff;
      border-bottom:1px solid var(--border);
    }

    header .wrap{
      max-width:1200px;
      margin:0 auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }

    .brand{
      font-weight:900;
      color:var(--primary-blue);
      letter-spacing:.2px;
    }

    .pill{
      display:inline-block;
      padding:6px 12px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      font-weight:800;
      font-size:12px;
      white-space:nowrap;
    }

    main{
      max-width:1200px;
      margin:18px auto;
      padding:0 16px 40px;
      display:grid;
      grid-template-columns:360px 1fr;
      gap:16px;
    }

    @media (max-width:980px){
      main{ grid-template-columns:1fr; }
    }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
    }

    .card h2{
      margin:0 0 12px;
      font-size:16px;
      color:var(--primary-blue);
    }

    /* LEFT PANEL STATUS BOXES */
    .status-boxes{
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
    }

    .status-box{
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
      background:#fff;
      cursor:pointer;
      transition:transform .05s ease, box-shadow .05s ease;
    }

    .status-box:hover{
      box-shadow:0 6px 18px rgba(0,0,0,0.08);
      transform:translateY(-1px);
    }

    .status-box.active{
      outline:2px solid var(--primary-blue);
    }

    .status-box .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }

    .status-box .name{
      font-weight:900;
      font-size:14px;
    }

    .status-box .count{
      font-weight:900;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      font-size:13px;
    }

    /* SEARCH */
    .search{
      margin-top:12px;
    }

    input{
      width:100%;
      padding:11px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#fff;
      outline:none;
      font-size:14px;
    }

    /* TABLE */
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      border-radius:14px;
      overflow:hidden;
      border:1px solid var(--border);
      background:#fff;
    }

    th, td{
      padding:12px 10px;
      border-bottom:1px solid rgba(0,0,0,0.08);
      font-size:14px;
      vertical-align:top;
    }

    th{
      font-size:12px;
      letter-spacing:.4px;
      text-transform:uppercase;
      color:rgba(0,0,0,0.6);
      background:#fafbfc;
      text-align:left;
    }

    tr:last-child td{ border-bottom:none; }

    .btn{
      border:none;
      border-radius:12px;
      padding:9px 14px;
      font-weight:900;
      cursor:pointer;
      font-size:13px;
    }

    .btn-primary{
      background:var(--primary-blue);
      color:#fff;
    }

    .muted{
      color:rgba(0,0,0,0.55);
      font-size:12px;
      line-height:1.5;
      margin-top:4px;
    }
  </style>
</head>

<body>

<header>
  <div class="wrap">
    <div class="brand">TradeBotPro — Dashboard</div>
    <div class="pill" id="pillFilter">Filter: All</div>
  </div>
</header>

<main>
  <aside class="card">
    <h2>Onboarding stages</h2>
    <div class="status-boxes" id="statusBoxes"></div>

    <div class="search">
      <input id="search" placeholder="Search name, email, phone, postcode…" />
    </div>
  </aside>

  <section class="card">
    <h2>Customers</h2>
    <div id="tableWrap"></div>
  </section>
</main>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

 window.SUPABASE_URL = "https://yaiutswdcbfwkxfqxkzy.supabase.co";  // <--- YOUR URL in quotes
  window.SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlhaXV0c3dkY2Jmd2t4ZnF4a3p5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1MDE2MDgsImV4cCI6MjA4MDA3NzYwOH0.HOLFxzjsZ5Ieqg0b-aTdP0hAdLsPVXL6Zjs-HgOHgc8";  
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const ONBOARDING_STATUSES = [
    "New Signup",
    "Demo Booked",
    "Demo Completed",
    "WhatsApp Connected",
    "Flows Built",
    "Calendar Linked",
    "Payments Connected",
    "Live",
    "Paused",
    "Closed / Not Proceeding"
  ];

  const statusBoxesEl = document.getElementById("statusBoxes");
  const tableWrap = document.getElementById("tableWrap");
  const pillFilter = document.getElementById("pillFilter");
  const searchEl = document.getElementById("search");

  let currentStatusFilter = null;
  let searchTerm = "";

  function esc(s){
    return (s ?? "").toString().replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }

  function renderStatusBoxes(counts){
    statusBoxesEl.innerHTML = "";
    for (const status of ONBOARDING_STATUSES){
      const count = counts[status] || 0;
      const box = document.createElement("div");
      box.className = "status-box" + (currentStatusFilter === status ? " active" : "");
      box.innerHTML = `
        <div class="row">
          <div class="name">${esc(status)}</div>
          <div class="count">${count}</div>
        </div>
      `;
      box.onclick = () => {
        currentStatusFilter = (currentStatusFilter === status) ? null : status;
        pillFilter.textContent = "Filter: " + (currentStatusFilter || "All");
        loadAll();
      };
      statusBoxesEl.appendChild(box);
    }
  }

  function renderTable(rows){
    tableWrap.innerHTML = `
      <table>
        <thead>
          <tr>
            <th>Business</th>
            <th>Contact</th>
            <th>Status</th>
            <th>Lead Source</th>
            <th>Updated</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          ${rows.map(r => `
            <tr>
              <td>
                <strong>${esc(r.business_name || "—")}</strong>
                <div class="muted">${esc(r.trade_type || "")}</div>
              </td>
              <td>
                ${esc(r.contact_name || r.owner_name || "—")}
                <div class="muted">${esc(r.email || "")}</div>
                <div class="muted">${esc(r.phone || r.whatsapp_number || "")}</div>
              </td>
              <td><span class="pill">${esc(r.onboarding_status || "New Signup")}</span></td>
              <td><span class="pill">${esc(r.lead_source || "—")}</span></td>
              <td class="muted">${r.updated_at ? new Date(r.updated_at).toLocaleString() : "—"}</td>
              <td style="text-align:right">
                <button class="btn btn-primary" onclick="window.open('app.html?id=${r.id}','_blank')">
                  Open in wizard
                </button>
              </td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    `;
  }

  async function loadCounts(){
    const { data } = await supabase.from("customers").select("onboarding_status");
    const counts = {};
    data?.forEach(r => counts[r.onboarding_status || "New Signup"] = (counts[r.onboarding_status || "New Signup"] || 0) + 1);
    ONBOARDING_STATUSES.forEach(s => counts[s] ||= 0);
    return counts;
  }

  async function loadCustomers(){
    let q = supabase.from("customers").select("*").order("updated_at", { ascending:false });
    if (currentStatusFilter) q = q.eq("onboarding_status", currentStatusFilter);
    const { data } = await q;
    if (!searchTerm) return data || [];
    const t = searchTerm.toLowerCase();
    return (data || []).filter(r =>
      [r.business_name,r.contact_name,r.owner_name,r.email,r.phone,r.whatsapp_number,r.trade_type,r.base_postcode].join(" ").toLowerCase().includes(t)
    );
  }

  async function loadAll(){
    const [counts, rows] = await Promise.all([loadCounts(), loadCustomers()]);
    renderStatusBoxes(counts);
    renderTable(rows);
  }

  searchEl.oninput = () => { searchTerm = searchEl.value.trim(); loadAll(); };
  loadAll();
</script>

</body>
</html>

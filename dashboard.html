<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>TradeBotPro – Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
:root {
  --primary-blue:#1f4e79;
  --accent-blue:#00a3ff;
  --bg:#f3f4f9;
  --white:#fff;
  --border:rgba(15,23,42,.12);
}
body {
  margin:0;
  font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
  background:radial-gradient(circle at top left,#e0ebff 0,#f3f4f9 40%,#fff 100%);
}
header {
  background:#f8fafc;
  border-bottom:1px solid var(--border);
  padding:.75rem 1.25rem;
}
h1 {
  margin:.25rem 0;
  color:var(--primary-blue);
}
.status-strip {
  display:flex;
  flex-wrap:wrap;
  gap:.5rem;
  margin:1rem 0;
}
.status-chip {
  padding:.5rem .9rem;
  border-radius:999px;
  border:1px solid var(--border);
  background:#fff;
  cursor:pointer;
  display:flex;
  gap:.4rem;
  align-items:center;
}
.status-chip.is-active {
  background:#eef4ff;
  border-color:var(--primary-blue);
}
.status-count {
  background:#dbeafe;
  color:#1e3a8a;
  border-radius:999px;
  padding:.1rem .5rem;
  font-weight:700;
}
.panel {
  padding:1rem 1.25rem;
}
table {
  width:100%;
  border-collapse:collapse;
}
th,td {
  padding:.6rem;
  border-bottom:1px solid var(--border);
}
tbody tr {
  cursor:pointer;
}
tbody tr:hover {
  background:#f1f5f9;
}
.drawer {
  position:fixed;
  right:-460px;
  top:0;
  height:100%;
  width:460px;
  background:#fff;
  border-left:1px solid var(--border);
  box-shadow:-10px 0 25px rgba(0,0,0,.15);
  transition:right .25s ease;
  padding:1rem;
  z-index:99;
}
.drawer.open { right:0; }
.drawer label {
  font-size:.75rem;
  color:#475569;
}
.drawer textarea, .drawer select {
  width:100%;
  margin-bottom:.75rem;
  padding:.5rem;
}
.btn {
  padding:.4rem .8rem;
  border-radius:999px;
  border:1px solid var(--border);
  cursor:pointer;
}
.btn-primary {
  background:var(--primary-blue);
  color:#fff;
}
</style>
</head>

<body>

<header>
  <h1>TradeBotPro — Onboarding Dashboard</h1>
</header>

<div class="panel">

  <div class="status-strip" id="statusStrip"></div>

  <table>
    <thead>
      <tr>
        <th>Status</th>
        <th>Business</th>
        <th>Contact</th>
        <th>Email</th>
        <th>Phone</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

</div>

<!-- DRAWER -->
<div class="drawer" id="drawer">
  <h3 id="drawerTitle">Customer</h3>

  <label>Status</label>
  <select id="drawerStatus"></select>

  <label>Internal notes</label>
  <textarea id="drawerNotes"></textarea>

  <label>Lead notes</label>
  <textarea id="drawerLeadNotes"></textarea>

  <button class="btn btn-primary" id="closeDrawer">Close</button>
</div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const sb = createClient(
  "https://yaiutswdcbfwkxfqxkzy.supabase.co",
  "YOUR_ANON_KEY"
);

const DEFAULT_STATUSES = [
  "New Signup",
  "In Setup",
  "Wizard Started",
  "Wizard Completed",
  "Demo",
  "Free Trial",
  "Needs Convincing",
  "Live",
  "Paused / Not Proceeding"
];

const tbody = document.getElementById("tbody");
const statusStrip = document.getElementById("statusStrip");

const drawer = document.getElementById("drawer");
const drawerTitle = document.getElementById("drawerTitle");
const drawerStatus = document.getElementById("drawerStatus");
const drawerNotes = document.getElementById("drawerNotes");
const drawerLeadNotes = document.getElementById("drawerLeadNotes");

let customers = [];
let activeStatus = null;
let activeCustomer = null;
let saveTimer = null;

function normalizeStatus(row){
  return row.onboarding_status || "New Signup";
}

function buildStatusStrip(){
  statusStrip.innerHTML = "";
  const counts = {};
  customers.forEach(c=>{
    const s = normalizeStatus(c);
    counts[s] = (counts[s]||0)+1;
  });

  const add = (label,val) => {
    const el = document.createElement("div");
    el.className = "status-chip" + (activeStatus===val ? " is-active":"");
    el.innerHTML = `<span>${label}</span><span class="status-count">${counts[label]||0}</span>`;
    el.onclick = ()=>{ activeStatus = val; render(); };
    statusStrip.appendChild(el);
  };

  add("All",null);
  DEFAULT_STATUSES.forEach(s=>add(s,s));
}

function render(){
  buildStatusStrip();
  tbody.innerHTML = "";
  customers
    .filter(c=>!activeStatus || normalizeStatus(c)===activeStatus)
    .forEach(c=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${normalizeStatus(c)}</td>
        <td>${c.business_name||"—"}</td>
        <td>${c.contact_name||"—"}</td>
        <td>${c.email||"—"}</td>
        <td>${c.phone||"—"}</td>
      `;
      tr.onclick = ()=>openDrawer(c);
      tbody.appendChild(tr);
    });
}

function openDrawer(c){
  activeCustomer = c;
  drawerTitle.textContent = c.business_name || "Customer";

  const statuses = [...new Set([...DEFAULT_STATUSES, normalizeStatus(c)])];
  drawerStatus.innerHTML = statuses.map(s=>
    `<option ${s===normalizeStatus(c)?"selected":""}>${s}</option>`
  ).join("");

  drawerNotes.value = c.notes || "";
  drawerLeadNotes.value = c.lead_notes || "";

  drawer.classList.add("open");
}

function autosave(){
  clearTimeout(saveTimer);
  saveTimer = setTimeout(async()=>{
    if(!activeCustomer) return;
    await sb.from("customers").update({
      onboarding_status: drawerStatus.value,
      notes: drawerNotes.value,
      lead_notes: drawerLeadNotes.value
    }).eq("id", activeCustomer.id);
  },400);
}

drawerStatus.onchange = autosave;
drawerNotes.oninput = autosave;
drawerLeadNotes.oninput = autosave;

document.getElementById("closeDrawer").onclick = ()=>{
  drawer.classList.remove("open");
};

async function load(){
  const { data } = await sb.from("customers").select("*");
  customers = data || [];
  render();
}

load();
</script>

</body>
</html>

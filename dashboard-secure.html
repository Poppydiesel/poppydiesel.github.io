<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>TradeBotPro — Secure Admin Dashboard</title>
  <style>
    :root{
      --primary:#1f4e79;
      --accent:#00a3ff;
      --bg:#f3f4f9;
      --text:#151820;
      --muted:#6b7280;
      --border:rgba(15,23,42,.12);
      --ok:#0f7b46;
      --err:#b3261e;
      --white:#ffffff;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:radial-gradient(circle at top left,#e0ebff 0,#f3f4f9 45%,#ffffff 100%);
      color:var(--text);
    }
    header{
      background:rgba(255,255,255,.96);
      backdrop-filter:blur(8px);
      border-bottom:1px solid var(--border);
      position:sticky; top:0; z-index:10;
    }
    .inner{
      max-width:1300px;
      margin:0 auto;
      padding:14px 18px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
    }
    .brand{font-weight:900;color:var(--primary)}
    .muted{color:var(--muted)}
    .btn{
      border-radius:999px;
      padding:10px 14px;
      border:1px solid var(--border);
      background:#fff;
      font-weight:900;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .btnPrimary{background:var(--primary);color:#fff;border-color:transparent}
    main{max-width:1300px;margin:0 auto;padding:18px}
    .card{
      background:#fff;
      border:1px solid var(--border);
      border-radius:18px;
      padding:16px;
      box-shadow:0 20px 50px rgba(15,23,42,.10);
    }
    .row{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .search{
      width:320px; max-width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      font:inherit;
    }
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:10px 8px;border-bottom:1px solid rgba(15,23,42,.08);vertical-align:top}
    th{font-size:.75rem;text-transform:uppercase;letter-spacing:.12em;color:var(--muted);text-align:left}
    td{font-size:.92rem}
    .pill{
      display:inline-flex;align-items:center;
      padding:6px 10px;border-radius:999px;
      border:1px solid var(--border);
      font-weight:900;font-size:.82rem;background:#fff
    }
    .pill.ok{border-color:rgba(15,123,70,.35); background:#ecfdf5; color:var(--ok)}
    .pill.warn{border-color:rgba(245,158,11,.35); background:#fffbeb; color:#92400e}
    .pill.neutral{border-color:rgba(148,163,184,.5); background:#f1f5f9; color:#334155}
    select{
      padding:8px 10px;border-radius:12px;border:1px solid var(--border);font:inherit;
      background:#fff;
    }
    .status{margin-top:10px;font-weight:900;white-space:pre-wrap}
    .status.ok{color:var(--ok)}
    .status.err{color:var(--err)}
    a.link{color:var(--primary);font-weight:900;text-decoration:none}
    a.link:hover{text-decoration:underline}
  </style>
</head>

<body>
<header>
  <div class="inner">
    <div>
      <div class="brand">TradeBotPro</div>
      <div class="muted">Secure Admin Dashboard</div>
    </div>
    <div style="display:flex;gap:10px;flex-wrap:wrap">
      <button id="btnReload" class="btn" type="button">Reload</button>
      <button id="btnLogout" class="btn" type="button">Logout</button>
    </div>
  </div>
</header>

<main>
  <div class="card">
    <div class="row">
      <div>
        <div style="font-weight:900;color:var(--primary);font-size:1.05rem">Customers</div>
        <div class="muted">Admin-only view. You can update onboarding + plan fields here.</div>
      </div>
      <input id="q" class="search" placeholder="Search name, business, email, postcode…" />
    </div>

    <div id="msg" class="status"></div>

    <div style="overflow:auto">
      <table>
        <thead>
          <tr>
            <th>Business</th>
            <th>Contact</th>
            <th>Trade / Postcode</th>
            <th>Onboarding</th>
            <th>Plan</th>
            <th>Links</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
  </div>
</main>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  const SUPABASE_URL = "https://yaiutswdcbfwkxfqxkzy.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlhaXV0c3dkY2Jmd2t4ZnF4a3p5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1MDE2MDgsImV4cCI6MjA4MDA3NzYwOH0.HOLFxzjsZ5Ieqg0b-aTdP0hAdLsPVXL6Zjs-HgOHgc8";
  const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const el = (id) => document.getElementById(id);

  function setMsg(text, ok=false){
    el("msg").textContent = text || "";
    el("msg").className = "status " + (ok ? "ok" : (text ? "err" : ""));
  }

  function pillFor(status){
    const s = (status || "—").toString();
    const low = s.toLowerCase();
    const kind = low.includes("live") ? "ok" : (low.includes("trial") || low.includes("demo") ? "warn" : "neutral");
    return `<span class="pill ${kind}">${escapeHtml(s)}</span>`;
  }

  function escapeHtml(str){
    return (str||"").toString().replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  async function requireAdmin(){
    // Must be logged in
    const { data:{ user } } = await sb.auth.getUser();
    if(!user){
      setMsg("Not logged in. Use Admin Login first.", false);
      // Your login.html should handle auth; we bounce there.
      location.href = "login.html";
      return null;
    }

    // Verify they are in tbp_admins (RLS will also enforce this on select)
    const check = await sb.from("tbp_admins").select("auth_user_id").eq("auth_user_id", user.id).maybeSingle();
    if(check.error){
      // If RLS blocks tbp_admins too, that's fine, but then customers select will fail anyway.
      console.error(check.error);
    }
    if(!check.data){
      setMsg("You are logged in but NOT authorised as admin. Add your auth user id to tbp_admins.", false);
      return null;
    }
    return user;
  }

  async function loadCustomers(){
    setMsg("Loading customers…", true);

    const { data, error } = await sb
      .from("customers")
      .select("*")
      .order("created_at", { ascending: false })
      .limit(200);

    if(error){
      console.error("[TBP] admin load error:", error);
      setMsg("ADMIN LOAD ERROR:\n" + (error.message || "Failed"), false);
      return [];
    }

    setMsg("", true);
    return data || [];
  }

  function matches(c, q){
    if(!q) return true;
    const s = q.toLowerCase();
    const hay = [
      c.business_name, c.contact_name, c.email, c.trade_type, c.base_postcode,
      c.phone, c.whatsapp_number, c.signup_status, c.onboarding_status
    ].filter(Boolean).join(" ").toLowerCase();
    return hay.includes(s);
  }

  function wizardLink(c){
    if(!c?.id) return "";
    const u = new URL("app.html", location.origin);
    u.searchParams.set("customer_id", c.id);
    if(c.setup_token) u.searchParams.set("setup_token", c.setup_token);
    return u.toString();
  }

  function clientDashLink(c){
    if(!c?.id) return "";
    const u = new URL("client-dashboard.html", location.origin);
    u.searchParams.set("customer_id", c.id);
    if(c.setup_token) u.searchParams.set("setup_token", c.setup_token);
    return u.toString();
  }

  async function updateCustomer(id, patch){
    const { error } = await sb.from("customers").update(patch).eq("id", id);
    if(error) throw error;
  }

  function render(customers){
    const tbody = el("rows");
    const q = el("q").value.trim();

    const list = (customers || []).filter(c => matches(c, q));
    tbody.innerHTML = list.map(c => {
      const onboard = c.signup_status || c.onboarding_status || "";
      const plan = c.plan_name || c.plan_status || "";

      return `
        <tr data-id="${c.id}">
          <td>
            <div style="font-weight:900">${escapeHtml(c.business_name || "—")}</div>
            <div class="muted" style="font-size:.85rem">${escapeHtml(c.created_at || "")}</div>
          </td>
          <td>
            <div>${escapeHtml(c.contact_name || "—")}</div>
            <div class="muted" style="font-size:.85rem">${escapeHtml(c.email || "—")}</div>
          </td>
          <td>
            <div>${escapeHtml(c.trade_type || "—")}</div>
            <div class="muted" style="font-size:.85rem">${escapeHtml(c.base_postcode || "—")}</div>
          </td>
          <td>
            ${pillFor(onboard)}
            <div style="margin-top:8px">
              <select class="sel-onboard">
                <option value="">—</option>
                <option ${onboard==="New"?"selected":""}>New</option>
                <option ${onboard==="Wizard complete"?"selected":""}>Wizard complete</option>
                <option ${onboard==="Demo"?"selected":""}>Demo</option>
                <option ${onboard==="Free Trial"?"selected":""}>Free Trial</option>
                <option ${onboard==="Live"?"selected":""}>Live</option>
              </select>
            </div>
          </td>
          <td>
            ${pillFor(plan)}
            <div style="margin-top:8px">
              <select class="sel-plan">
                <option value="">—</option>
                <option ${plan==="Starter"?"selected":""}>Starter</option>
                <option ${plan==="Pro"?"selected":""}>Pro</option>
                <option ${plan==="Elite"?"selected":""}>Elite</option>
              </select>
            </div>
          </td>
          <td style="white-space:nowrap">
            <a class="link" href="${wizardLink(c)}" target="_blank">Open wizard</a><br/>
            <a class="link" href="${clientDashLink(c)}" target="_blank">Client dashboard</a>
          </td>
        </tr>
      `;
    }).join("");

    // Attach change handlers
    tbody.querySelectorAll("tr").forEach(tr => {
      const id = tr.getAttribute("data-id");
      const selOn = tr.querySelector(".sel-onboard");
      const selPlan = tr.querySelector(".sel-plan");

      if(selOn){
        selOn.addEventListener("change", async () => {
          try{
            setMsg("Saving onboarding status…", true);
            await updateCustomer(id, { signup_status: selOn.value || null });
            setMsg("Saved ✔", true);
          }catch(e){
            console.error(e);
            setMsg("SAVE ERROR:\n" + (e?.message || "Failed"), false);
          }
        });
      }

      if(selPlan){
        selPlan.addEventListener("change", async () => {
          try{
            setMsg("Saving plan…", true);
            await updateCustomer(id, { plan_name: selPlan.value || null });
            setMsg("Saved ✔", true);
          }catch(e){
            console.error(e);
            setMsg("SAVE ERROR:\n" + (e?.message || "Failed"), false);
          }
        });
      }
    });
  }

  let cache = [];

  el("btnLogout").onclick = async () => {
    await sb.auth.signOut();
    location.href = "login.html";
  };

  el("btnReload").onclick = async () => {
    cache = await loadCustomers();
    render(cache);
  };

  el("q").addEventListener("input", () => render(cache));

  (async () => {
    const user = await requireAdmin();
    if(!user) return;
    cache = await loadCustomers();
    render(cache);
  })();
</script>
</body>
</html>

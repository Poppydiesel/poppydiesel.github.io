<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TradeBotPro â€“ Secure Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      --primary-blue:#1f4e79;
      --accent-blue:#00a3ff;
      --dark-text:#151820;
      --muted-text:#6b7280;
      --light-bg:#f3f4f9;
      --white:#ffffff;
      --border-subtle:rgba(15,23,42,0.12);
      --success-green:#0f7b46;
      --error-red:#b3261e;
    }

    *{box-sizing:border-box}
    html{scroll-behavior:smooth}
    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      background:radial-gradient(circle at top left,#e0ebff 0,#f3f4f9 40%,#fdfdfd 100%);
      color:var(--dark-text);
      line-height:1.5;
    }

    header{
      border-bottom:1px solid rgba(15,23,42,0.06);
      background:rgba(248,250,252,0.96);
      backdrop-filter:blur(6px);
      position:sticky;top:0;z-index:20;
    }
    .header-inner{
      max-width:1180px;margin:0 auto;
      padding:.6rem 1.25rem;
      display:flex;align-items:center;justify-content:space-between;gap:.75rem;
    }
    .logo-wrap{display:flex;align-items:center;gap:.6rem}
    .logo-icon{width:30px;height:30px;border-radius:9px;background:var(--primary-blue);position:relative}
    .logo-icon::before,.logo-icon::after{content:"";position:absolute;background:var(--white);border-radius:4px}
    .logo-icon::before{width:11px;height:17px;left:7px;top:6px}
    .logo-icon::after{width:6px;height:11px;right:7px;top:9px}
    .logo-main{font-weight:700;font-size:1rem;color:var(--primary-blue)}
    .logo-tag{font-size:.75rem;color:var(--muted-text)}

    .header-right{
      display:flex; align-items:center; gap:.75rem; flex-wrap:wrap; justify-content:flex-end;
    }
    .header-note{font-size:.75rem;color:var(--muted-text);white-space:nowrap}
    .header-note strong{color:var(--primary-blue);font-weight:650}

    main{max-width:1180px;margin:0 auto;padding:1.2rem 1.25rem 2.2rem}

    .panel{
      border-radius:1.2rem;
      background:rgba(248,250,252,0.96);
      border:1px solid rgba(148,163,184,0.35);
      padding:1.1rem 1.1rem;
    }
    .kicker{
      font-size:.75rem;text-transform:uppercase;letter-spacing:.12em;
      color:var(--accent-blue);margin-bottom:.35rem;
    }
    .title{margin:0 0 .35rem;font-size:1.35rem;color:var(--primary-blue)}
    .subtitle{margin:0 0 .85rem;font-size:.9rem;color:var(--muted-text)}

    .status-strip{display:flex;flex-wrap:wrap;gap:.65rem;margin-bottom:.95rem}
    .status-chip{
      border-radius:999px;padding:.55rem .85rem;
      border:1px solid rgba(15,23,42,0.10);
      background:#fff;cursor:pointer;
      display:inline-flex;align-items:center;gap:.5rem;
      transition:transform .12s ease,box-shadow .12s ease,border-color .12s ease;
      user-select:none;
    }
    .status-chip:hover{transform:translateY(-1px);box-shadow:0 12px 26px rgba(15,23,42,0.12);border-color:rgba(31,78,121,0.35)}
    .status-chip.is-active{border-color:rgba(31,78,121,0.8);box-shadow:0 0 0 2px rgba(31,78,121,0.12);background:#f3f7ff}
    .status-chip-name{font-weight:650;font-size:.9rem}
    .status-chip-count{
      min-width:38px;text-align:center;
      padding:.15rem .45rem;border-radius:999px;
      background:#eef2ff;border:1px solid rgba(37,99,235,0.22);
      color:var(--primary-blue);font-weight:800;font-size:.85rem;
    }

    .controls{
      display:flex;
      align-items:center;
      gap:.65rem;
      margin-bottom:.85rem;
      flex-wrap:nowrap;
    }
    .controls-left,
    .controls-right{
      display:flex;
      align-items:center;
      gap:.55rem;
      flex-wrap:nowrap;
    }
    .controls-left{flex:1; min-width:0;}
    .search{
      flex:1;
      min-width:260px;
      display:flex;gap:.5rem;align-items:center;
      padding:.6rem .7rem;border-radius:.75rem;
      border:1px solid var(--border-subtle);background:var(--white);
    }
    .search input{border:0;outline:0;width:100%;font:inherit;font-size:.92rem;background:transparent}

    .btn{
      border-radius:999px;border:1px solid transparent;
      padding:.55rem 1.05rem;font-size:.86rem;font-weight:550;
      cursor:pointer;display:inline-flex;align-items:center;gap:.35rem;
      background:transparent;
      user-select:none;
      white-space:nowrap;
    }
    .btn-secondary{border-color:var(--border-subtle);background:#f9fafb;color:var(--dark-text)}
    .btn-secondary:hover{background:#e5e7eb}
    .btn-primary{
      background:linear-gradient(135deg,var(--primary-blue),#163857);
      color:var(--white);
      box-shadow:0 12px 28px rgba(15,23,42,0.35);
    }
    .btn-primary:hover{filter:brightness(1.03);box-shadow:0 16px 34px rgba(15,23,42,0.4)}
    .btn-danger{
      border-color:rgba(179,38,30,0.25);
      background:#fff1f2;
      color:#7f1d1d;
    }
    .btn-danger:hover{background:#ffe4e6}

    @media (max-width: 900px){
      .controls{flex-wrap:wrap;}
      .controls-left{flex:1 1 100%;}
      .controls-right{width:100%; justify-content:flex-end;}
      .search{min-width:0;}
    }

    .banner{
      display:none;margin:0 0 .85rem;
      padding:.75rem .85rem;border-radius:.9rem;
      border:1px solid rgba(179,38,30,0.25);
      background:#fff1f2;color:#7f1d1d;
      font-size:.88rem;white-space:pre-wrap;
    }
    .banner.show{display:block}

    .table-wrap{
      width:100%;
      overflow:auto;
      border-radius:1rem;
      border:1px solid rgba(15,23,42,0.08);
      background:#fff;
    }
    table{
      width:100%;
      border-collapse:collapse;
      min-width: 1060px;
    }
    thead th{
      position:sticky;top:0;
      background:#f8fafc;
      border-bottom:1px solid rgba(15,23,42,0.08);
      font-size:.78rem;text-transform:uppercase;letter-spacing:.12em;
      color:var(--muted-text);
      text-align:left;
      padding:.75rem .85rem;
      white-space:nowrap;
    }
    tbody td{
      border-bottom:1px solid rgba(15,23,42,0.06);
      padding:.75rem .85rem;
      font-size:.9rem;
      vertical-align:middle;
      white-space:nowrap;
    }
    tbody tr{cursor:pointer}
    tbody tr:hover{background:#f7fbff}

    .pipe{display:inline-flex;align-items:center;gap:6px}
    .dot{
      width:10px;height:10px;border-radius:999px;
      border:2px solid rgba(148,163,184,0.9);
      background:#fff;
      cursor:pointer;
    }
    .dot.done{border-color:rgba(15,123,70,0.65);background:#dcfce7}
    .dot.need{border-color:rgba(179,38,30,0.45);background:#fff1f2}
    .dot.readonly{cursor:default; opacity:.85}
    .dot-label{font-size:.75rem;color:var(--muted-text);margin-left:6px;white-space:nowrap}

    .badge{
      display:inline-flex;align-items:center;gap:.35rem;
      padding:.25rem .6rem;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.45);
      background:#f8fafc;
      font-size:.82rem;
      font-weight:750;
      color:#334155;
    }
    .badge.ok{
      border-color:rgba(15,123,70,0.35);
      background:#ecfdf5;
      color:#065f46;
    }
    .badge.no{
      border-color:rgba(179,38,30,0.25);
      background:#fff1f2;
      color:#7f1d1d;
    }

    .drawer-overlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.25);
      backdrop-filter:blur(1px);
      opacity:0; pointer-events:none;
      transition:opacity .18s ease;
      z-index:998;
    }
    .drawer-overlay.open{
      opacity:1;
      pointer-events:auto;
    }

    .drawer{
      position:fixed;top:0;right:-860px;
      width:860px; max-width:96vw; height:100%;
      background:#fff;
      box-shadow:-20px 0 40px rgba(0,0,0,.15);
      transition:right .22s ease;
      z-index:999;
      display:flex;flex-direction:column;
    }
    .drawer.open{right:0}
    .drawer-header{padding:1rem;border-bottom:1px solid var(--border-subtle);background:#f8fafc}
    .drawer-title{font-weight:750;color:var(--primary-blue);font-size:1.05rem}
    .drawer-sub{margin-top:.25rem;font-size:.85rem;color:var(--muted-text)}
    .drawer-body{padding:1rem;flex:1;overflow:auto}

    .drawer-row{display:grid;grid-template-columns:1fr 1fr;gap:.7rem;margin-bottom:.9rem}
    .drawer-field label{display:block;font-size:.78rem;color:var(--muted-text);margin:0 0 .25rem}
    .drawer-field input,.drawer-body textarea{
      width:100%;padding:.6rem .7rem;border-radius:.85rem;
      border:1px solid var(--border-subtle);font:inherit;outline:none;background:#fff;
    }
    .drawer-body textarea{min-height:110px;resize:vertical}

    .drawer-section-title{
      margin:.8rem 0 .35rem;
      font-weight:750;color:var(--primary-blue);font-size:.92rem;
    }

    .checklist{
      border:1px solid rgba(15,23,42,0.08);
      border-radius:.9rem;background:#fff;
      padding:.75rem .8rem;margin-bottom:.9rem;
    }
    .check-item{
      display:flex;align-items:center;justify-content:space-between;gap:.6rem;
      padding:.45rem 0;border-bottom:1px dashed rgba(148,163,184,0.55);
      cursor:pointer;
    }
    .check-item:last-child{border-bottom:0}
    .check-left{display:flex;align-items:center;gap:.55rem;min-width:0}
    .check-badge{
      width:22px;height:22px;border-radius:8px;
      display:inline-flex;align-items:center;justify-content:center;
      font-size:.85rem;
      border:1px solid rgba(148,163,184,0.55);
      background:#f1f5f9;color:#475569;flex:0 0 auto;
    }
    .check-badge.done{border-color:rgba(15,123,70,0.35);background:#ecfdf5;color:#14532d}
    .check-name{
      font-weight:650;font-size:.9rem;color:var(--dark-text);
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .check-state{font-size:.82rem;color:var(--muted-text);flex:0 0 auto}

    .action-grid{
      display:flex;flex-wrap:wrap;gap:.5rem;
      margin:.4rem 0 .2rem;
    }
    .action-grid .btn{padding:.48rem .85rem;font-size:.84rem}

    .drawer-footer{
      padding:1rem;border-top:1px solid var(--border-subtle);
      display:flex;justify-content:space-between;align-items:center;gap:.6rem;
      background:#fff;
    }
    .drawer-hint{font-size:.82rem;color:var(--muted-text)}

    @media (max-width: 900px){
      .drawer-row{grid-template-columns:1fr}
      table{min-width:980px}
      .drawer{right:-96vw;}
    }
  </style>
</head>

<body>


<style>
  .tbp-nav {
    display: flex;
    gap: 14px;
    padding: 10px 16px;
    font-size: 14px;
  }
  .tbp-nav a {
    text-decoration: none;
    font-weight: 600;
  }
</style>


<style>
  .tbp-nav {
    display: flex;
    gap: 14px;
    padding: 10px 16px;
    font-size: 14px;
  }
  .tbp-nav a {
    text-decoration: none;
    font-weight: 600;
  }
</style>

<header>
  <div class="header-inner">
    <div class="logo-wrap">
      <div class="logo-icon" aria-hidden="true"></div>
      <div>
        <div class="logo-main">TradeBotPro</div>
        <div class="logo-tag">More jobs. Less admin. Powered by AI.</div>
      </div>
    </div>

    <div class="header-right">
      <div class="header-note">View: <strong>Secure Admin Dashboard</strong></div>
      <button class="btn btn-secondary" id="btnLogout" type="button">Log out</button>
    </div>
  </div>
</header>

<main>
  <section class="panel">
    <div class="kicker">Sales stage</div>
    <h1 class="title">Customers by onboarding status (sales) + setup tasks (ops)</h1>
    <p class="subtitle">Wizard is controlled by the setup wizard (read-only here). Onboarding actions work via buttons or by clicking the rows.</p>

    <div class="status-strip" id="status-strip"></div>

    <div class="controls">
      <div class="controls-left">
        <button class="btn btn-secondary" id="btn-clear-filter" type="button">Clear filters</button>

        <div class="search">
          <span style="opacity:.7">ðŸ”Ž</span>
          <input id="search" type="text" placeholder="Search name, business, email, phone, postcodeâ€¦" />
        </div>
      </div>

      <div class="controls-right">
        <button class="btn btn-secondary" id="btn-refresh" type="button">â†» Refresh</button>
        <button class="btn btn-primary" id="btn-new" type="button">+ New customer</button>
      </div>
    </div>

    <div id="banner" class="banner"></div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Onboarding status (sales)</th>
            <th>Wizard</th>
            <th>Setup tasks (ops)</th>
            <th>Business</th>
            <th>Contact</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Postcode</th>
            <th>Updated</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="logo-tag" id="status-bar" style="margin-top:.75rem;">Loadingâ€¦</div>
  </section>
</main>

<div class="drawer-overlay" id="drawerOverlay" aria-hidden="true"></div>

<div class="drawer" id="drawer" aria-hidden="true">
  <div class="drawer-header">
    <div class="drawer-title" id="drawerTitle">Customer</div>
    <div class="drawer-sub" id="drawerSub">â€”</div>
  </div>

  <div class="drawer-body">
    <div class="drawer-row">
      <div>
        <div class="drawer-section-title">Sales stage</div>
        <div class="checklist" id="salesChecklist"></div>
      </div>

      <div>
        <div class="drawer-section-title">Actions</div>
        <div class="action-grid">
          <button class="btn btn-secondary" id="btnOpenWizard" type="button">Open wizard</button>
        </div>
      </div>
    </div>

    <div class="drawer-section-title">Onboarding actions (one-click)</div>
    <div class="checklist" id="onboardingChecklist"></div>
    <div class="action-grid" id="onboardingButtons"></div>

    <div class="drawer-section-title">Setup tasks (ops)</div>
    <div class="checklist" id="tasksChecklist"></div>

    <div class="drawer-section-title">Setup tasks (one-click actions)</div>
    <div class="action-grid" id="opsButtons"></div>

    <div class="drawer-row" style="margin-top:.8rem;">
      <div class="drawer-field">
        <label for="drawer_business">Business name</label>
        <input id="drawer_business" type="text" disabled />
      </div>
      <div class="drawer-field">
        <label for="drawer_contact">Contact name</label>
        <input id="drawer_contact" type="text" disabled />
      </div>
    </div>

    <div class="drawer-field" style="margin-bottom:.9rem;">
      <label for="drawer_email">Email</label>
      <input id="drawer_email" type="text" disabled />
    </div>

    <div class="drawer-field" style="margin-bottom:.9rem;">
      <label for="drawer_phone">Phone</label>
      <input id="drawer_phone" type="text" disabled />
    </div>

    <div class="drawer-field" style="margin-bottom:.9rem;">
      <label for="drawer_notes">Internal notes</label>
      <textarea id="drawer_notes" placeholder="Sales notes / setup notes / follow-upsâ€¦"></textarea>
    </div>

    <div class="drawer-field">
      <label for="drawer_lead_notes">Lead notes</label>
      <textarea id="drawer_lead_notes" placeholder="Lead context, objections, remindersâ€¦"></textarea>
    </div>
  </div>

  <div class="drawer-footer">
    <div class="drawer-hint" id="drawerHint">Autosaves</div>
    <div>
      <button class="btn btn-secondary" id="btnCloseDrawer" type="button">Close</button>
    </div>
  </div>
</div>
<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  const SUPABASE_URL = "https://yaiutswdcbfwkxfqxkzy.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlhaXV0c3dkY2Jmd2t4ZnF4a3p5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1MDE2MDgsImV4cCI6MjA4MDA3NzYwOH0.HOLFxzjsZ5Ieqg0b-aTdP0hAdLsPVXL6Zjs-HgOHgc8";
  const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const qs = new URLSearchParams(location.search);
  const customer_id = qs.get("customer_id") || qs.get("user_id") || qs.get("signup_id") || "";
  const setup_token = qs.get("setup_token") || qs.get("token") || "";

  const el = (id) => document.getElementById(id);

  // OPTIONAL if your admin page has these IDs; if not, weâ€™ll still work with chips + status-msg
  const statusMsg = el("status-msg") || el("status") || null;

  function setStatus(text, kind=""){
    if (!statusMsg) {
      console.log("[TBP] STATUS:", text);
      return;
    }
    statusMsg.textContent = text || "";
    statusMsg.className = "status" + (kind ? " " + kind : "");
  }

  function logSupabaseError(context, error){
    console.error(`[TBP] ${context}`, {
      message: error?.message,
      details: error?.details,
      hint: error?.hint,
      code: error?.code,
      status: error?.status,
      raw: error
    });
  }

  // Chip selections we will save
  const selections = {};

  function initChips(){
    document.querySelectorAll(".chip-row").forEach(row => {
      const col = row.getAttribute("data-col");
      const mode = row.getAttribute("data-select") || "single";
      const chips = Array.from(row.querySelectorAll(".chip"));

      chips.forEach(chip => {
        chip.addEventListener("click", () => {
          if (!col) return;

          if (mode === "single"){
            chips.forEach(c => c.classList.remove("is-selected"));
            chip.classList.add("is-selected");
            selections[col] = chip.textContent.trim();
          }

          setStatus("");
        });
      });
    });
  }

  function applyChipSelection(col, value){
    if (!value) return;
    const row = document.querySelector(`.chip-row[data-col="${CSS.escape(col)}"]`);
    if (!row) return;
    const chips = Array.from(row.querySelectorAll(".chip"));
    chips.forEach(c => c.classList.toggle("is-selected", c.textContent.trim() === value));
    selections[col] = value;
  }

  async function loadCustomer(){
    try{
      if (!customer_id || !setup_token) throw new Error("Missing customer_id or setup_token in URL.");

      setStatus("Loadingâ€¦");

      const { data, error } = await sb
        .from("customers")
        .select("*")
        .eq("id", customer_id)
        .eq("setup_token", setup_token)
        .single();

      if (error) {
        logSupabaseError("admin loadCustomer failed", error);
        throw new Error(error.message || "Load failed");
      }

      console.log("[TBP] Admin loaded customer:", data);

      // Paint current statuses into chips so admin sees current state
      applyChipSelection("signup_status", data.signup_status || "");
      applyChipSelection("demo_status", data.demo_status || "");
      applyChipSelection("trial_status", data.trial_status || "");
      applyChipSelection("plan_status", data.plan_status || "");
      applyChipSelection("plan_term", data.plan_term || "");

      setStatus("");
      return data;
    } catch(err){
      console.error("[TBP] admin loadCustomer error:", err);
      setStatus(err?.message || "Failed to load", "err");
      return null;
    }
  }

  async function saveStatuses(){
    try{
      if (!customer_id || !setup_token) throw new Error("Missing customer_id or setup_token.");

      setStatus("Savingâ€¦");

      // Only save known admin-controlled columns
      const payload = {
        signup_status: selections.signup_status ?? null,
        demo_status: selections.demo_status ?? null,
        trial_status: selections.trial_status ?? null,
        plan_status: selections.plan_status ?? null,
        plan_term: selections.plan_term ?? null,
        updated_at: new Date().toISOString()
      };

      const { error } = await sb
        .from("customers")
        .update(payload)
        .eq("id", customer_id)
        .eq("setup_token", setup_token);

      if (error) {
        logSupabaseError("admin saveStatuses failed", error);
        throw new Error(error.message || "Save failed");
      }

      setStatus("Saved âœ”", "ok");
      setTimeout(() => setStatus(""), 1200);
    } catch(err){
      console.error("[TBP] admin save error:", err);
      setStatus(err?.message || "Save failed", "err");
    }
  }

  // Wire your admin Save button if it exists, otherwise create one so it always works.
  function ensureAdminSaveButton(){
    let btn = document.getElementById("btn-save");
    if (!btn) {
      btn = document.createElement("button");
      btn.id = "btn-save";
      btn.type = "button";
      btn.textContent = "Save statuses";
      btn.style.cssText = "position:fixed;right:18px;bottom:18px;padding:12px 16px;border-radius:999px;border:0;background:#1f4e79;color:#fff;font-weight:800;cursor:pointer;box-shadow:0 18px 40px rgba(15,23,42,.25)";
      document.body.appendChild(btn);
    }
    btn.addEventListener("click", saveStatuses);
  }

  initChips();
  ensureAdminSaveButton();
  loadCustomer();
</script>
</body>
</html>


</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TradeBotPro — Admin Dashboard (Secure)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      --primary-blue:#1f4e79;
      --accent-blue:#00a3ff;
      --dark-text:#151820;
      --muted-text:#6b7280;
      --light-bg:#f3f4f9;
      --white:#ffffff;
      --border-subtle:rgba(15,23,42,0.12);
      --success-green:#0f7b46;
      --error-red:#b3261e;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      background: radial-gradient(circle at top left, #e0ebff 0, #f3f4f9 40%, #fdfdfd 100%);
      color:var(--dark-text);
      min-height:100vh;
    }
    header{
      position:sticky; top:0; z-index:10;
      background:rgba(248,250,252,0.96);
      backdrop-filter: blur(6px);
      border-bottom:1px solid rgba(15,23,42,0.06);
    }
    .inner{max-width:1120px;margin:0 auto;padding:0 1.25rem}
    .nav{
      display:flex; align-items:center; justify-content:space-between; gap:1rem;
      padding:.75rem 0;
    }
    .brand{display:flex; align-items:center; gap:.65rem}
    .logo-icon{width:32px;height:32px;border-radius:9px;background:var(--primary-blue);position:relative}
    .logo-icon::before,.logo-icon::after{content:"";position:absolute;background:var(--white);border-radius:4px}
    .logo-icon::before{width:12px;height:18px;left:7px;top:7px}
    .logo-icon::after{width:6px;height:12px;right:7px;top:10px}
    .logo-main{font-weight:800;color:var(--primary-blue);line-height:1}
    .logo-tag{font-size:.78rem;color:var(--muted-text);margin-top:.15rem}
    .actions{display:flex; gap:.6rem; align-items:center; flex-wrap:wrap}
    .pill{
      font-size:.82rem; color:var(--muted-text);
      background:rgba(255,255,255,0.9);
      border:1px solid var(--border-subtle);
      padding:.35rem .7rem; border-radius:999px;
    }
    .btn{
      border-radius:999px;
      border:1px solid transparent;
      padding:.55rem .95rem;
      cursor:pointer;
      font-weight:700;
      font-size:.9rem;
      display:inline-flex; align-items:center; gap:.35rem;
      background:transparent;
    }
    .btn-primary{
      background:linear-gradient(135deg,var(--primary-blue),#163857);
      color:var(--white);
      box-shadow:0 12px 28px rgba(15,23,42,.22);
    }
    .btn-secondary{
      background:#f9fafb;
      border-color:var(--border-subtle);
      color:var(--dark-text);
    }
    .btn-secondary:hover{background:#e5e7eb}
    main{padding:1.25rem 0 2.5rem}
    .card{
      background:rgba(255,255,255,0.95);
      border-radius:1.1rem;
      padding:1.1rem 1.2rem;
      box-shadow: 0 18px 46px rgba(15, 23, 42, 0.12), 0 0 0 1px rgba(15, 23, 42, 0.03);
      margin-bottom:1rem;
    }
    .row{display:flex; gap:.8rem; flex-wrap:wrap; align-items:center; justify-content:space-between}
    .h1{margin:0; font-size:1.25rem; color:var(--primary-blue)}
    .muted{color:var(--muted-text); font-size:.9rem; margin:.25rem 0 0}
    .search{
      display:flex; gap:.6rem; flex-wrap:wrap; align-items:center;
      margin-top:.9rem;
    }
    input[type="text"]{
      padding:.6rem .7rem;
      border-radius:.6rem;
      border:1px solid var(--border-subtle);
      background:var(--white);
      min-width:260px;
      font:inherit;
    }
    .status{margin-top:.8rem; font-size:.9rem; min-height:1.2em}
    .ok{color:var(--success-green)}
    .err{color:var(--error-red)}
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      margin-top:.85rem;
      overflow:hidden;
      border-radius:.9rem;
      border:1px solid rgba(15,23,42,0.08);
      background:var(--white);
    }
    th, td{
      text-align:left;
      padding:.65rem .7rem;
      border-bottom:1px solid rgba(15,23,42,0.06);
      font-size:.9rem;
      vertical-align:top;
    }
    th{font-size:.78rem; color:var(--muted-text); text-transform:uppercase; letter-spacing:.12em}
    tr:last-child td{border-bottom:none}
    .badge{
      display:inline-flex;
      padding:.2rem .55rem;
      border-radius:999px;
      font-size:.78rem;
      font-weight:700;
      border:1px solid rgba(15,23,42,0.12);
      background:#f9fafb;
      color:var(--dark-text);
      white-space:nowrap;
    }
    .badge.ok{background:#ecfdf5;border-color:rgba(22,163,74,.35);color:#14532d}
    .badge.no{background:#fef2f2;border-color:rgba(220,38,38,.28);color:#7f1d1d}
    .link{
      color:var(--primary-blue);
      text-decoration:underline;
      cursor:pointer;
    }
  </style>
</head>

<body>
  <header>
    <div class="inner">
      <div class="nav">
        <div class="brand">
          <div class="logo-icon" aria-hidden="true"></div>
          <div>
            <div class="logo-main">TradeBotPro</div>
            <div class="logo-tag">Admin dashboard (secure)</div>
          </div>
        </div>

        <div class="actions">
          <div class="pill" id="whoami">Checking session…</div>
          <button class="btn btn-secondary" id="btnRefresh">Refresh</button>
          <button class="btn btn-secondary" id="btnLogout">Log out</button>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="inner">
      <div class="card">
        <div class="row">
          <div>
            <div class="h1">Customers</div>
            <div class="muted">Secure view. Requires login + admin email allowlist.</div>
          </div>
        </div>

        <div class="search">
          <input id="q" type="text" placeholder="Search name / email / postcode…" />
          <label class="pill" style="display:flex;gap:.45rem;align-items:center;">
            <input id="onlyIncomplete" type="checkbox" />
            Show only wizard incomplete
          </label>
        </div>

        <div id="status" class="status" aria-live="polite"></div>

        <div style="overflow:auto;">
          <table>
            <thead>
              <tr>
                <th>Business</th>
                <th>Contact</th>
                <th>Email / Phone</th>
                <th>Wizard</th>
                <th>Created</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="rows">
              <tr><td colspan="6">Loading…</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="card" style="font-size:.9rem;color:var(--muted-text)">
        <strong style="color:var(--primary-blue)">Note:</strong>
        This page is “secure UI”. For real security you’ll add Supabase RLS next (so anon users can’t read customers at all).
      </div>
    </div>
  </main>

  <!-- Supabase UMD -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.48.0/dist/umd/supabase.min.js"></script>

  <script>
  (function(){
    const SUPABASE_URL = "https://yaiutswdcbfwkxfqxkzy.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlhaXV0c3dkY2Jmd2t4ZnF4a3p5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1MDE2MDgsImV4cCI6MjA4MDA3NzYwOH0.HOLFxzjsZ5Ieqg0b-aTdP0hAdLsPVXL6Zjs-HgOHgc8";
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ✅ Admin allowlist: only these emails can see this dashboard
    const ADMIN_EMAILS = "hello@tradebotpro.co.uk"
    ];

    const whoami = document.getElementById("whoami");
    const status = document.getElementById("status");
    const rowsEl = document.getElementById("rows");
    const qEl = document.getElementById("q");
    const onlyIncompleteEl = document.getElementById("onlyIncomplete");

    const btnLogout = document.getElementById("btnLogout");
    const btnRefresh = document.getElementById("btnRefresh");

    let customers = [];

    function setStatus(msg, kind){
      status.textContent = msg || "";
      status.className = "status " + (kind || "");
    }
    function esc(s){
      return (s ?? "").toString()
        .replaceAll("&","&amp;").replaceAll("<","&lt;")
        .replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }
    function fmtDate(iso){
      if(!iso) return "";
      try{
        const d = new Date(iso);
        return d.toISOString().slice(0,10);
      }catch{ return ""; }
    }

    function render(){
      const q = (qEl.value || "").trim().toLowerCase();
      const onlyIncomplete = !!onlyIncompleteEl.checked;

      const filtered = customers.filter(c => {
        if (onlyIncomplete && c.wizard_completed === true) return false;
        if (!q) return true;

        const hay = [
          c.business_name, c.contact_name, c.email, c.phone, c.whatsapp_number,
          c.base_postcode, c.onboarding_status
        ].join(" ").toLowerCase();

        return hay.includes(q);
      });

      if (!filtered.length){
        rowsEl.innerHTML = `<tr><td colspan="6">No results.</td></tr>`;
        return;
      }

      rowsEl.innerHTML = filtered.map(c => {
        const wizardBadge = c.wizard_completed
          ? `<span class="badge ok">Complete</span>`
          : `<span class="badge no">Incomplete</span>`;

        const action = `<a class="link" href="/app.html?customer_id=${encodeURIComponent(c.id)}">Open wizard</a>`;

        return `
          <tr>
            <td>
              <div style="font-weight:800;color:var(--primary-blue)">${esc(c.business_name || "(no business name)")}</div>
              <div style="font-size:.82rem;color:var(--muted-text)">${esc(c.base_postcode || "")}</div>
            </td>
            <td>${esc(c.contact_name || "")}</td>
            <td>
              <div>${esc(c.email || "")}</div>
              <div style="font-size:.82rem;color:var(--muted-text)">${esc(c.phone || c.whatsapp_number || "")}</div>
            </td>
            <td>${wizardBadge}</td>
            <td>${fmtDate(c.created_at)}</td>
            <td>${action}</td>
          </tr>
        `;
      }).join("");
    }

    async function requireAdminSession(){
      const { data } = await sb.auth.getSession();
      const session = data?.session;

      if(!session){
        // Redirect to login with return path
        location.href = `/login.html?next=${encodeURIComponent("/dashboard-secure.html")}`;
        return null;
      }

      const email = session.user?.email || "";
      whoami.textContent = email ? `Signed in: ${email}` : "Signed in";

      // Admin allowlist check
      if (!ADMIN_EMAILS.map(x => x.toLowerCase()).includes(email.toLowerCase())) {
        setStatus("Not authorised for admin dashboard.", "err");
        rowsEl.innerHTML = `<tr><td colspan="6">Not authorised.</td></tr>`;
        return null;
      }

      return session;
    }

    async function loadCustomers(){
      setStatus("Loading customers…");
      rowsEl.innerHTML = `<tr><td colspan="6">Loading…</td></tr>`;

      const { data, error } = await sb
        .from("customers")
        .select("id, business_name, contact_name, email, phone, whatsapp_number, base_postcode, onboarding_status, wizard_completed, created_at")
        .order("created_at", { ascending: false })
        .limit(500);

      if (error){
        console.error(error);
        setStatus("Could not load customers (RLS may block this later — which is good).", "err");
        rowsEl.innerHTML = `<tr><td colspan="6">Failed to load.</td></tr>`;
        return;
      }

      customers = data || [];
      setStatus(`Loaded ${customers.length} customers.`, "ok");
      render();
    }

    qEl.addEventListener("input", render);
    onlyIncompleteEl.addEventListener("change", render);
    btnRefresh.addEventListener("click", loadCustomers);

    btnLogout.addEventListener("click", async () => {
      await sb.auth.signOut();
      location.href = "/login.html";
    });

    (async function boot(){
      const ok = await requireAdminSession();
      if(!ok) return;
      await loadCustomers();
    })();
  })();
  </script>
</body>
</html>

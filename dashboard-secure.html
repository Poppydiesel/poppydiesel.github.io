<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TradeBotPro ‚Äì Dashboard (Secure)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      --primary-blue:#1f4e79;
      --accent-blue:#00a3ff;
      --dark-text:#151820;
      --muted-text:#6b7280;
      --light-bg:#f3f4f9;
      --white:#ffffff;
      --border-subtle:rgba(15,23,42,0.12);
      --success-green:#0f7b46;
      --error-red:#b3261e;
    }

    *{box-sizing:border-box}
    html{scroll-behavior:smooth}
    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      background:radial-gradient(circle at top left,#e0ebff 0,#f3f4f9 40%,#fdfdfd 100%);
      color:var(--dark-text);
      line-height:1.5;
    }

    header{
      border-bottom:1px solid rgba(15,23,42,0.06);
      background:rgba(248,250,252,0.96);
      backdrop-filter:blur(6px);
      position:sticky;top:0;z-index:20;
    }
    .header-inner{
      max-width:1180px;margin:0 auto;
      padding:.6rem 1.25rem;
      display:flex;align-items:center;justify-content:space-between;gap:.75rem;
    }
    .logo-wrap{display:flex;align-items:center;gap:.6rem}
    .logo-icon{width:30px;height:30px;border-radius:9px;background:var(--primary-blue);position:relative}
    .logo-icon::before,.logo-icon::after{content:"";position:absolute;background:var(--white);border-radius:4px}
    .logo-icon::before{width:11px;height:17px;left:7px;top:6px}
    .logo-icon::after{width:6px;height:11px;right:7px;top:9px}
    .logo-main{font-weight:700;font-size:1rem;color:var(--primary-blue)}
    .logo-tag{font-size:.75rem;color:var(--muted-text)}
    .header-note{font-size:.75rem;color:var(--muted-text)}
    .header-note strong{color:var(--primary-blue);font-weight:600}

    main{max-width:1180px;margin:0 auto;padding:1.2rem 1.25rem 2.2rem}

    .panel{
      border-radius:1.2rem;
      background:rgba(248,250,252,0.96);
      border:1px solid rgba(148,163,184,0.35);
      padding:1.1rem 1.1rem;
    }
    .kicker{
      font-size:.75rem;text-transform:uppercase;letter-spacing:.12em;
      color:var(--accent-blue);margin-bottom:.35rem;
    }
    .title{margin:0 0 .35rem;font-size:1.35rem;color:var(--primary-blue)}
    .subtitle{margin:0 0 .85rem;font-size:.9rem;color:var(--muted-text)}

    .status-strip{display:flex;flex-wrap:wrap;gap:.65rem;margin-bottom:.95rem}
    .status-chip{
      border-radius:999px;padding:.55rem .85rem;
      border:1px solid rgba(15,23,42,0.10);
      background:#fff;cursor:pointer;
      display:inline-flex;align-items:center;gap:.5rem;
      transition:transform .12s ease,box-shadow .12s ease,border-color .12s ease;
      user-select:none;
    }
    .status-chip:hover{transform:translateY(-1px);box-shadow:0 12px 26px rgba(15,23,42,0.12);border-color:rgba(31,78,121,0.35)}
    .status-chip.is-active{border-color:rgba(31,78,121,0.8);box-shadow:0 0 0 2px rgba(31,78,121,0.12);background:#f3f7ff}
    .status-chip-name{font-weight:650;font-size:.9rem}
    .status-chip-count{
      min-width:38px;text-align:center;
      padding:.15rem .45rem;border-radius:999px;
      background:#eef2ff;border:1px solid rgba(37,99,235,0.22);
      color:var(--primary-blue);font-weight:800;font-size:.85rem;
    }

    .controls{
      display:flex;
      align-items:center;
      gap:.65rem;
      margin-bottom:.85rem;
      flex-wrap:nowrap;
    }
    .controls-left,
    .controls-right{
      display:flex;
      align-items:center;
      gap:.55rem;
      flex-wrap:nowrap;
    }
    .controls-left{flex:1; min-width:0;}
    .search{
      flex:1;
      min-width:260px;
      display:flex;gap:.5rem;align-items:center;
      padding:.6rem .7rem;border-radius:.75rem;
      border:1px solid var(--border-subtle);background:var(--white);
    }
    .search input{border:0;outline:0;width:100%;font:inherit;font-size:.92rem;background:transparent}

    .btn{
      border-radius:999px;border:1px solid transparent;
      padding:.55rem 1.05rem;font-size:.86rem;font-weight:550;
      cursor:pointer;display:inline-flex;align-items:center;gap:.35rem;
      background:transparent;
      user-select:none;
      white-space:nowrap;
    }
    .btn-secondary{border-color:var(--border-subtle);background:#f9fafb;color:var(--dark-text)}
    .btn-secondary:hover{background:#e5e7eb}
    .btn-primary{
      background:linear-gradient(135deg,var(--primary-blue),#163857);
      color:var(--white);
      box-shadow:0 12px 28px rgba(15,23,42,0.35);
    }
    .btn-primary:hover{filter:brightness(1.03);box-shadow:0 16px 34px rgba(15,23,42,0.4)}
    .btn-danger{
      border-color:rgba(179,38,30,0.25);
      background:#fff1f2;
      color:#7f1d1d;
    }
    .btn-danger:hover{background:#ffe4e6}

    @media (max-width: 900px){
      .controls{flex-wrap:wrap;}
      .controls-left{flex:1 1 100%;}
      .controls-right{width:100%; justify-content:flex-end;}
      .search{min-width:0;}
    }

    .banner{
      display:none;margin:0 0 .85rem;
      padding:.75rem .85rem;border-radius:.9rem;
      border:1px solid rgba(179,38,30,0.25);
      background:#fff1f2;color:#7f1d1d;
      font-size:.88rem;white-space:pre-wrap;
    }
    .banner.show{display:block}

    .table-wrap{
      width:100%;
      overflow:auto;
      border-radius:1rem;
      border:1px solid rgba(15,23,42,0.08);
      background:#fff;
    }
    table{
      width:100%;
      border-collapse:collapse;
      min-width: 1060px;
    }
    thead th{
      position:sticky;top:0;
      background:#f8fafc;
      border-bottom:1px solid rgba(15,23,42,0.08);
      font-size:.78rem;text-transform:uppercase;letter-spacing:.12em;
      color:var(--muted-text);
      text-align:left;
      padding:.75rem .85rem;
      white-space:nowrap;
    }
    tbody td{
      border-bottom:1px solid rgba(15,23,42,0.06);
      padding:.75rem .85rem;
      font-size:.9rem;
      vertical-align:middle;
      white-space:nowrap;
    }
    tbody tr{cursor:pointer}
    tbody tr:hover{background:#f7fbff}

    .badge{
      display:inline-flex;align-items:center;gap:.35rem;
      padding:.25rem .6rem;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.45);
      background:#f8fafc;
      font-size:.82rem;
      font-weight:750;
      color:#334155;
    }
    .badge.ok{
      border-color:rgba(15,123,70,0.35);
      background:#ecfdf5;
      color:#065f46;
    }
    .badge.no{
      border-color:rgba(179,38,30,0.25);
      background:#fff1f2;
      color:#7f1d1d;
    }
  </style>
</head>

<body>
<header>
  <div class="header-inner">
    <div class="logo-wrap">
      <div class="logo-icon" aria-hidden="true"></div>
      <div>
        <div class="logo-main">TradeBotPro</div>
        <div class="logo-tag">More jobs. Less admin. Powered by AI.</div>
      </div>
    </div>

    <div style="display:flex; align-items:center; gap:.6rem;">
      <div class="header-note">View: <strong>Onboarding Dashboard (Secure)</strong></div>
      <!-- MUST exist for script -->
      <button class="btn btn-secondary" id="btnLogout" type="button">Log out</button>
    </div>
  </div>
</header>

<main>
  <section class="panel">
    <div class="kicker">Sales stage</div>
    <h1 class="title">Customers by onboarding status (sales) + setup tasks (ops)</h1>
    <p class="subtitle">Wizard is controlled by the setup wizard (read-only here). Onboarding actions work via buttons or by clicking the rows.</p>

    <div class="status-strip" id="status-strip"></div>

    <div class="controls">
      <div class="controls-left">
        <!-- MUST match script -->
        <button class="btn btn-secondary" id="btn-clear-filter" type="button">Clear filters</button>

        <div class="search">
          <span style="opacity:.7">üîé</span>
          <!-- MUST match script -->
          <input id="search" type="text" placeholder="Search name, business, email, phone, postcode‚Ä¶" />
        </div>
      </div>

      <div class="controls-right">
        <!-- MUST match script -->
        <button class="btn btn-secondary" id="btn-refresh" type="button">‚Üª Refresh</button>
        <!-- MUST match script -->
        <button class="btn btn-primary" id="btn-new" type="button">+ New customer</button>
      </div>
    </div>

    <div id="banner" class="banner"></div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Onboarding status (sales)</th>
            <th>Wizard</th>
            <th>Business</th>
            <th>Contact</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Postcode</th>
            <th>Updated</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="logo-tag" id="status-bar" style="margin-top:.75rem;">Loading‚Ä¶</div>
  </section>
</main>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  const SUPABASE_URL = "https://yaiutswdcbfwkxfqxkzy.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlhaXV0c3dkY2Jmd2t4ZnF4a3p5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1MDE2MDgsImV4cCI6MjA4MDA3NzYwOH0.HOLFxzjsZ5Ieqg0b-aTdP0hAdLsPVXL6Zjs-HgOHgc8";

  const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
  });

  // DOM (safe lookup)
  const byId = (id) => document.getElementById(id);

  const statusStrip = byId("status-strip");
  const tbody = byId("tbody");
  const banner = byId("banner");
  const search = byId("search");
  const statusBar = byId("status-bar");
  const btnRefresh = byId("btn-refresh");
  const btnNew = byId("btn-new");
  const btnClear = byId("btn-clear-filter");
  const btnLogout = byId("btnLogout");

  function setBanner(msg){
    if(!banner) return;
    if(!msg){ banner.textContent=""; banner.classList.remove("show"); return; }
    banner.textContent = msg;
    banner.classList.add("show");
  }

  // Prevent the null addEventListener crash ‚Äî and tell you exactly what's missing
  const missing = [];
  if(!statusStrip) missing.push("status-strip");
  if(!tbody) missing.push("tbody");
  if(!banner) missing.push("banner");
  if(!search) missing.push("search");
  if(!statusBar) missing.push("status-bar");
  if(!btnRefresh) missing.push("btn-refresh");
  if(!btnNew) missing.push("btn-new");
  if(!btnClear) missing.push("btn-clear-filter");
  if(!btnLogout) missing.push("btnLogout");

  if(missing.length){
    setBanner(
      "Dashboard HTML is missing required elements (IDs):\n\n" +
      missing.map(x => "‚Ä¢ " + x).join("\n") +
      "\n\nFix: make sure those IDs exist exactly, or paste this full file as-is."
    );
    // Stop boot so we don't crash
    console.error("[TBP] Missing DOM IDs:", missing);
  }

  let allRows = [];
  let activeStatus = null;

  const SALES_STAGES = ["New Signup","In Setup","Demo","Free Trial","Needs Convincing","Live"];

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function fmtDate(iso){
    if(!iso) return "‚Äî";
    try{
      const d = new Date(iso);
      return d.toLocaleString(undefined,{year:"numeric",month:"short",day:"2-digit",hour:"2-digit",minute:"2-digit"});
    }catch{ return "‚Äî"; }
  }

  function salesStatus(row){
    const raw = (row?.onboarding_status ?? "").toString().trim();
    return raw || "New Signup";
  }

  function wizardIsComplete(row){
    return !!row?.wizard_completed || !!row?.setup_complete;
  }

  function wizardBadgeHTML(row){
    const ok = wizardIsComplete(row);
    return ok
      ? `<span class="badge ok">‚úÖ Complete</span>`
      : `<span class="badge no">‚è≥ Incomplete</span>`;
  }

  function rowMatchesSearch(row,q){
    if(!q) return true;
    const hay = [
      row.business_name,row.contact_name,row.email,row.phone,row.base_postcode,salesStatus(row)
    ].join(" ").toLowerCase();
    return hay.includes(q.toLowerCase());
  }

  function computeCounts(){
    const counts = {};
    for(const r of allRows){
      const s = salesStatus(r);
      counts[s] = (counts[s] || 0) + 1;
    }
    return counts;
  }

  function buildStatusStrip(){
    if(!statusStrip) return;
    const counts = computeCounts();
    statusStrip.innerHTML = "";

    const addChip = (label, count, value) => {
      const el = document.createElement("div");
      el.className = "status-chip" + ((activeStatus===value) ? " is-active" : "");
      el.innerHTML = `<span class="status-chip-name">${escapeHtml(label)}</span><span class="status-chip-count">${count}</span>`;
      el.addEventListener("click", ()=>{ activeStatus=value; render(); });
      statusStrip.appendChild(el);
    };

    addChip("All", allRows.length, null);

    const extras = Array.from(new Set(allRows.map(r => salesStatus(r)))).filter(s => !SALES_STAGES.includes(s));
    const order = [...SALES_STAGES, ...extras.sort((a,b)=>a.localeCompare(b))];

    order.forEach(s => addChip(s, counts[s] || 0, s));
  }

  function render(){
    buildStatusStrip();

    const q = (search?.value || "").trim();
    const rows = allRows
      .filter(r => (activeStatus ? salesStatus(r)===activeStatus : true))
      .filter(r => rowMatchesSearch(r,q))
      .sort((a,b)=>{
        const ta = new Date(a.updated_at || a.created_at || 0).getTime();
        const tb = new Date(b.updated_at || b.created_at || 0).getTime();
        return tb - ta;
      });

    if(!tbody) return;
    tbody.innerHTML = "";

    if(!rows.length){
      tbody.innerHTML = `<tr><td colspan="8">No matches.</td></tr>`;
      if(statusBar) statusBar.textContent = `0 shown ‚Ä¢ ${allRows.length} total`;
      return;
    }

    for(const r of rows){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHtml(salesStatus(r))}</td>
        <td>${wizardBadgeHTML(r)}</td>
        <td>${escapeHtml(r.business_name || "‚Äî")}</td>
        <td>${escapeHtml(r.contact_name || "‚Äî")}</td>
        <td>${escapeHtml(r.email || "‚Äî")}</td>
        <td>${escapeHtml(r.phone || "‚Äî")}</td>
        <td>${escapeHtml(r.base_postcode || "‚Äî")}</td>
        <td>${escapeHtml(fmtDate(r.updated_at || r.created_at))}</td>
      `;
    tbody.addEventListener("click", (e) => {
  const tr = e.target.closest("tr");
  if (!tr) return;

  // ignore clicks on buttons/links inside a row (if any)
  if (e.target.closest("button,a,input,select,textarea,label")) return;

  const id = tr.dataset.id;
  if (!id) return;

  const row = allRows.find(r => r.id === id);
  if (!row) return;

  openDrawer(row);
});


    if(statusBar){
      statusBar.textContent =
        `${rows.length} shown ‚Ä¢ ${allRows.length} total` +
        (activeStatus ? ` ‚Ä¢ Stage: ${activeStatus}` : "");
    }
  }

  async function requireAuth(){
    const { data, error } = await sb.auth.getSession();
    if(error){
      setBanner("Auth error:\n\n" + (error.message || JSON.stringify(error)));
      return false;
    }
    if(!data?.session){
      window.location.href = "login.html";
      return false;
    }
    return true;
  }

  async function loadCustomers(){
    setBanner("");
    if(statusBar) statusBar.textContent = "Loading‚Ä¶";
    if(tbody) tbody.innerHTML = `<tr><td colspan="8">Loading‚Ä¶</td></tr>`;

    const { data, error } = await sb.from("customers").select("*");

    if(error){
      console.error("LOAD ERROR:", error);
      setBanner("Failed to load customers:\n\n" + (error.message || JSON.stringify(error)));
      allRows = [];
      if(tbody) tbody.innerHTML = `<tr><td colspan="8">No data loaded.</td></tr>`;
      if(statusBar) statusBar.textContent = "Load failed.";
      return;
    }

    allRows = Array.isArray(data) ? data : [];
    render();
  }

  // Only attach listeners if elements exist (prevents your crash)
  if(btnRefresh) btnRefresh.addEventListener("click", loadCustomers);
  if(btnNew) btnNew.addEventListener("click", ()=>window.open("app.html", "_blank", "noopener"));
  if(btnClear) btnClear.addEventListener("click", ()=>{ activeStatus=null; if(search) search.value=""; render(); });
  if(search) search.addEventListener("input", render);

  if(btnLogout) btnLogout.addEventListener("click", async ()=>{
    await sb.auth.signOut();
    window.location.href = "login.html";
  });

  // Boot
  (async ()=>{
    if(missing.length) return; // don‚Äôt boot if HTML is incomplete
    const ok = await requireAuth();
    if(!ok) return;
    await loadCustomers();
  })();
</script>
</body>
</html>

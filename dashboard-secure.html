<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TradeBotPro ‚Äì Secure Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      --primary-blue:#1f4e79;
      --accent-blue:#00a3ff;
      --dark-text:#151820;
      --muted-text:#6b7280;
      --light-bg:#f3f4f9;
      --white:#ffffff;
      --border-subtle:rgba(15,23,42,0.12);
      --success-green:#0f7b46;
      --error-red:#b3261e;
    }

    *{box-sizing:border-box}
    html{scroll-behavior:smooth}
    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      background:radial-gradient(circle at top left,#e0ebff 0,#f3f4f9 40%,#fdfdfd 100%);
      color:var(--dark-text);
      line-height:1.5;
    }

    header{
      border-bottom:1px solid rgba(15,23,42,0.06);
      background:rgba(248,250,252,0.96);
      backdrop-filter:blur(6px);
      position:sticky;top:0;z-index:20;
    }
    .header-inner{
      max-width:1180px;margin:0 auto;
      padding:.6rem 1.25rem;
      display:flex;align-items:center;justify-content:space-between;gap:.75rem;
    }
    .logo-wrap{display:flex;align-items:center;gap:.6rem}
    .logo-icon{width:30px;height:30px;border-radius:9px;background:var(--primary-blue);position:relative}
    .logo-icon::before,.logo-icon::after{content:"";position:absolute;background:var(--white);border-radius:4px}
    .logo-icon::before{width:11px;height:17px;left:7px;top:6px}
    .logo-icon::after{width:6px;height:11px;right:7px;top:9px}
    .logo-main{font-weight:700;font-size:1rem;color:var(--primary-blue)}
    .logo-tag{font-size:.75rem;color:var(--muted-text)}

    .header-right{
      display:flex; align-items:center; gap:.75rem; flex-wrap:wrap; justify-content:flex-end;
    }
    .header-note{font-size:.75rem;color:var(--muted-text);white-space:nowrap}
    .header-note strong{color:var(--primary-blue);font-weight:650}

    main{max-width:1180px;margin:0 auto;padding:1.2rem 1.25rem 2.2rem}

    .panel{
      border-radius:1.2rem;
      background:rgba(248,250,252,0.96);
      border:1px solid rgba(148,163,184,0.35);
      padding:1.1rem 1.1rem;
    }
    .kicker{
      font-size:.75rem;text-transform:uppercase;letter-spacing:.12em;
      color:var(--accent-blue);margin-bottom:.35rem;
    }
    .title{margin:0 0 .35rem;font-size:1.35rem;color:var(--primary-blue)}
    .subtitle{margin:0 0 .85rem;font-size:.9rem;color:var(--muted-text)}

    .status-strip{display:flex;flex-wrap:wrap;gap:.65rem;margin-bottom:.95rem}
    .status-chip{
      border-radius:999px;padding:.55rem .85rem;
      border:1px solid rgba(15,23,42,0.10);
      background:#fff;cursor:pointer;
      display:inline-flex;align-items:center;gap:.5rem;
      transition:transform .12s ease,box-shadow .12s ease,border-color .12s ease;
      user-select:none;
    }
    .status-chip:hover{transform:translateY(-1px);box-shadow:0 12px 26px rgba(15,23,42,0.12);border-color:rgba(31,78,121,0.35)}
    .status-chip.is-active{border-color:rgba(31,78,121,0.8);box-shadow:0 0 0 2px rgba(31,78,121,0.12);background:#f3f7ff}
    .status-chip-name{font-weight:650;font-size:.9rem}
    .status-chip-count{
      min-width:38px;text-align:center;
      padding:.15rem .45rem;border-radius:999px;
      background:#eef2ff;border:1px solid rgba(37,99,235,0.22);
      color:var(--primary-blue);font-weight:800;font-size:.85rem;
    }

    .controls{
      display:flex;
      align-items:center;
      gap:.65rem;
      margin-bottom:.85rem;
      flex-wrap:nowrap;
    }
    .controls-left,
    .controls-right{
      display:flex;
      align-items:center;
      gap:.55rem;
      flex-wrap:nowrap;
    }
    .controls-left{flex:1; min-width:0;}
    .search{
      flex:1;
      min-width:260px;
      display:flex;gap:.5rem;align-items:center;
      padding:.6rem .7rem;border-radius:.75rem;
      border:1px solid var(--border-subtle);background:var(--white);
    }
    .search input{border:0;outline:0;width:100%;font:inherit;font-size:.92rem;background:transparent}

    .btn{
      border-radius:999px;border:1px solid transparent;
      padding:.55rem 1.05rem;font-size:.86rem;font-weight:550;
      cursor:pointer;display:inline-flex;align-items:center;gap:.35rem;
      background:transparent;
      user-select:none;
      white-space:nowrap;
    }
    .btn-secondary{border-color:var(--border-subtle);background:#f9fafb;color:var(--dark-text)}
    .btn-secondary:hover{background:#e5e7eb}
    .btn-primary{
      background:linear-gradient(135deg,var(--primary-blue),#163857);
      color:var(--white);
      box-shadow:0 12px 28px rgba(15,23,42,0.35);
    }
    .btn-primary:hover{filter:brightness(1.03);box-shadow:0 16px 34px rgba(15,23,42,0.4)}
    .btn-danger{
      border-color:rgba(179,38,30,0.25);
      background:#fff1f2;
      color:#7f1d1d;
    }
    .btn-danger:hover{background:#ffe4e6}

    @media (max-width: 900px){
      .controls{flex-wrap:wrap;}
      .controls-left{flex:1 1 100%;}
      .controls-right{width:100%; justify-content:flex-end;}
      .search{min-width:0;}
    }

    .banner{
      display:none;margin:0 0 .85rem;
      padding:.75rem .85rem;border-radius:.9rem;
      border:1px solid rgba(179,38,30,0.25);
      background:#fff1f2;color:#7f1d1d;
      font-size:.88rem;white-space:pre-wrap;
    }
    .banner.show{display:block}

    .table-wrap{
      width:100%;
      overflow:auto;
      border-radius:1rem;
      border:1px solid rgba(15,23,42,0.08);
      background:#fff;
    }
    table{
      width:100%;
      border-collapse:collapse;
      min-width: 1060px;
    }
    thead th{
      position:sticky;top:0;
      background:#f8fafc;
      border-bottom:1px solid rgba(15,23,42,0.08);
      font-size:.78rem;text-transform:uppercase;letter-spacing:.12em;
      color:var(--muted-text);
      text-align:left;
      padding:.75rem .85rem;
      white-space:nowrap;
    }
    tbody td{
      border-bottom:1px solid rgba(15,23,42,0.06);
      padding:.75rem .85rem;
      font-size:.9rem;
      vertical-align:middle;
      white-space:nowrap;
    }
    tbody tr{cursor:pointer}
    tbody tr:hover{background:#f7fbff}

    .pipe{display:inline-flex;align-items:center;gap:6px}
    .dot{
      width:10px;height:10px;border-radius:999px;
      border:2px solid rgba(148,163,184,0.9);
      background:#fff;
      cursor:pointer;
    }
    .dot.done{border-color:rgba(15,123,70,0.65);background:#dcfce7}
    .dot.need{border-color:rgba(179,38,30,0.45);background:#fff1f2}
    .dot.readonly{cursor:default; opacity:.85}
    .dot-label{font-size:.75rem;color:var(--muted-text);margin-left:6px;white-space:nowrap}

    .badge{
      display:inline-flex;align-items:center;gap:.35rem;
      padding:.25rem .6rem;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.45);
      background:#f8fafc;
      font-size:.82rem;
      font-weight:750;
      color:#334155;
    }
    .badge.ok{
      border-color:rgba(15,123,70,0.35);
      background:#ecfdf5;
      color:#065f46;
    }
    .badge.no{
      border-color:rgba(179,38,30,0.25);
      background:#fff1f2;
      color:#7f1d1d;
    }

    .drawer-overlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.25);
      backdrop-filter:blur(1px);
      opacity:0; pointer-events:none;
      transition:opacity .18s ease;
      z-index:998;
    }
    .drawer-overlay.open{
      opacity:1;
      pointer-events:auto;
    }

    .drawer{
      position:fixed;top:0;right:-860px;
      width:860px; max-width:96vw; height:100%;
      background:#fff;
      box-shadow:-20px 0 40px rgba(0,0,0,.15);
      transition:right .22s ease;
      z-index:999;
      display:flex;flex-direction:column;
    }
    .drawer.open{right:0}
    .drawer-header{padding:1rem;border-bottom:1px solid var(--border-subtle);background:#f8fafc}
    .drawer-title{font-weight:750;color:var(--primary-blue);font-size:1.05rem}
    .drawer-sub{margin-top:.25rem;font-size:.85rem;color:var(--muted-text)}
    .drawer-body{padding:1rem;flex:1;overflow:auto}

    .drawer-row{display:grid;grid-template-columns:1fr 1fr;gap:.7rem;margin-bottom:.9rem}
    .drawer-field label{display:block;font-size:.78rem;color:var(--muted-text);margin:0 0 .25rem}
    .drawer-field input,.drawer-body textarea{
      width:100%;padding:.6rem .7rem;border-radius:.85rem;
      border:1px solid var(--border-subtle);font:inherit;outline:none;background:#fff;
    }
    .drawer-body textarea{min-height:110px;resize:vertical}

    .drawer-section-title{
      margin:.8rem 0 .35rem;
      font-weight:750;color:var(--primary-blue);font-size:.92rem;
    }

    .checklist{
      border:1px solid rgba(15,23,42,0.08);
      border-radius:.9rem;background:#fff;
      padding:.75rem .8rem;margin-bottom:.9rem;
    }
    .check-item{
      display:flex;align-items:center;justify-content:space-between;gap:.6rem;
      padding:.45rem 0;border-bottom:1px dashed rgba(148,163,184,0.55);
      cursor:pointer;
    }
    .check-item:last-child{border-bottom:0}
    .check-left{display:flex;align-items:center;gap:.55rem;min-width:0}
    .check-badge{
      width:22px;height:22px;border-radius:8px;
      display:inline-flex;align-items:center;justify-content:center;
      font-size:.85rem;
      border:1px solid rgba(148,163,184,0.55);
      background:#f1f5f9;color:#475569;flex:0 0 auto;
    }
    .check-badge.done{border-color:rgba(15,123,70,0.35);background:#ecfdf5;color:#14532d}
    .check-name{
      font-weight:650;font-size:.9rem;color:var(--dark-text);
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .check-state{font-size:.82rem;color:var(--muted-text);flex:0 0 auto}

    .action-grid{
      display:flex;flex-wrap:wrap;gap:.5rem;
      margin:.4rem 0 .2rem;
    }
    .action-grid .btn{padding:.48rem .85rem;font-size:.84rem}

    .drawer-footer{
      padding:1rem;border-top:1px solid var(--border-subtle);
      display:flex;justify-content:space-between;align-items:center;gap:.6rem;
      background:#fff;
    }
    .drawer-hint{font-size:.82rem;color:var(--muted-text)}

    @media (max-width: 900px){
      .drawer-row{grid-template-columns:1fr}
      table{min-width:980px}
      .drawer{right:-96vw;}
    }
  </style>
</head>

<body>
 <nav class="tbp-nav">
  <a href="./index.html">Home</a>
  <a href="./signup.html">Sign up</a>
  <a href="./login.html">Admin login</a>
</nav>

<style>
  .tbp-nav {
    display: flex;
    gap: 14px;
    padding: 10px 16px;
    font-size: 14px;
  }
  .tbp-nav a {
    text-decoration: none;
    font-weight: 600;
  }
</style>


<style>
  .tbp-nav {
    display: flex;
    gap: 14px;
    padding: 10px 16px;
    font-size: 14px;
  }
  .tbp-nav a {
    text-decoration: none;
    font-weight: 600;
  }
</style>

<header>
  <div class="header-inner">
    <div class="logo-wrap">
      <div class="logo-icon" aria-hidden="true"></div>
      <div>
        <div class="logo-main">TradeBotPro</div>
        <div class="logo-tag">More jobs. Less admin. Powered by AI.</div>
      </div>
    </div>

    <div class="header-right">
      <div class="header-note">View: <strong>Secure Admin Dashboard</strong></div>
      <button class="btn btn-secondary" id="btnLogout" type="button">Log out</button>
    </div>
  </div>
</header>

<main>
  <section class="panel">
    <div class="kicker">Sales stage</div>
    <h1 class="title">Customers by onboarding status (sales) + setup tasks (ops)</h1>
    <p class="subtitle">Wizard is controlled by the setup wizard (read-only here). Onboarding actions work via buttons or by clicking the rows.</p>

    <div class="status-strip" id="status-strip"></div>

    <div class="controls">
      <div class="controls-left">
        <button class="btn btn-secondary" id="btn-clear-filter" type="button">Clear filters</button>

        <div class="search">
          <span style="opacity:.7">üîé</span>
          <input id="search" type="text" placeholder="Search name, business, email, phone, postcode‚Ä¶" />
        </div>
      </div>

      <div class="controls-right">
        <button class="btn btn-secondary" id="btn-refresh" type="button">‚Üª Refresh</button>
        <button class="btn btn-primary" id="btn-new" type="button">+ New customer</button>
      </div>
    </div>

    <div id="banner" class="banner"></div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Onboarding status (sales)</th>
            <th>Wizard</th>
            <th>Setup tasks (ops)</th>
            <th>Business</th>
            <th>Contact</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Postcode</th>
            <th>Updated</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="logo-tag" id="status-bar" style="margin-top:.75rem;">Loading‚Ä¶</div>
  </section>
</main>

<div class="drawer-overlay" id="drawerOverlay" aria-hidden="true"></div>

<div class="drawer" id="drawer" aria-hidden="true">
  <div class="drawer-header">
    <div class="drawer-title" id="drawerTitle">Customer</div>
    <div class="drawer-sub" id="drawerSub">‚Äî</div>
  </div>

  <div class="drawer-body">
    <div class="drawer-row">
      <div>
        <div class="drawer-section-title">Sales stage</div>
        <div class="checklist" id="salesChecklist"></div>
      </div>

      <div>
        <div class="drawer-section-title">Actions</div>
        <div class="action-grid">
          <button class="btn btn-secondary" id="btnOpenWizard" type="button">Open wizard</button>
        </div>
      </div>
    </div>

    <div class="drawer-section-title">Onboarding actions (one-click)</div>
    <div class="checklist" id="onboardingChecklist"></div>
    <div class="action-grid" id="onboardingButtons"></div>

    <div class="drawer-section-title">Setup tasks (ops)</div>
    <div class="checklist" id="tasksChecklist"></div>

    <div class="drawer-section-title">Setup tasks (one-click actions)</div>
    <div class="action-grid" id="opsButtons"></div>

    <div class="drawer-row" style="margin-top:.8rem;">
      <div class="drawer-field">
        <label for="drawer_business">Business name</label>
        <input id="drawer_business" type="text" disabled />
      </div>
      <div class="drawer-field">
        <label for="drawer_contact">Contact name</label>
        <input id="drawer_contact" type="text" disabled />
      </div>
    </div>

    <div class="drawer-field" style="margin-bottom:.9rem;">
      <label for="drawer_email">Email</label>
      <input id="drawer_email" type="text" disabled />
    </div>

    <div class="drawer-field" style="margin-bottom:.9rem;">
      <label for="drawer_phone">Phone</label>
      <input id="drawer_phone" type="text" disabled />
    </div>

    <div class="drawer-field" style="margin-bottom:.9rem;">
      <label for="drawer_notes">Internal notes</label>
      <textarea id="drawer_notes" placeholder="Sales notes / setup notes / follow-ups‚Ä¶"></textarea>
    </div>

    <div class="drawer-field">
      <label for="drawer_lead_notes">Lead notes</label>
      <textarea id="drawer_lead_notes" placeholder="Lead context, objections, reminders‚Ä¶"></textarea>
    </div>
  </div>

  <div class="drawer-footer">
    <div class="drawer-hint" id="drawerHint">Autosaves</div>
    <div>
      <button class="btn btn-secondary" id="btnCloseDrawer" type="button">Close</button>
    </div>
  </div>
</div>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  const SUPABASE_URL = "https://yaiutswdcbfwkxfqxkzy.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlhaXV0c3dkY2Jmd2t4ZnF4a3p5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1MDE2MDgsImV4cCI6MjA4MDA3NzYwOH0.HOLFxzjsZ5Ieqg0b-aTdP0hAdLsPVXL6Zjs-HgOHgc8";

  const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
  });

  // ‚úÖ Demo calendar link (change to your real booking page)
  const DEMO_CALENDAR_URL = "https://calendly.com/tradebotpro/demo";

  // DOM
  const statusStrip = document.getElementById("status-strip");
  const tbody = document.getElementById("tbody");
  const banner = document.getElementById("banner");
  const search = document.getElementById("search");
  const statusBar = document.getElementById("status-bar");
  const btnRefresh = document.getElementById("btn-refresh");
  const btnNew = document.getElementById("btn-new");
  const btnClear = document.getElementById("btn-clear-filter");
  const btnLogout = document.getElementById("btnLogout");

  // Drawer + overlay
  const drawer = document.getElementById("drawer");
  const drawerOverlay = document.getElementById("drawerOverlay");
  const drawerTitle = document.getElementById("drawerTitle");
  const drawerSub = document.getElementById("drawerSub");
  const drawerBusiness = document.getElementById("drawer_business");
  const drawerContact = document.getElementById("drawer_contact");
  const drawerEmail = document.getElementById("drawer_email");
  const drawerPhone = document.getElementById("drawer_phone");
  const drawerNotes = document.getElementById("drawer_notes");
  const drawerLeadNotes = document.getElementById("drawer_lead_notes");
  const drawerHint = document.getElementById("drawerHint");
  const tasksChecklist = document.getElementById("tasksChecklist");
  const opsButtons = document.getElementById("opsButtons");
  const salesChecklist = document.getElementById("salesChecklist");
  const onboardingChecklist = document.getElementById("onboardingChecklist");
  const onboardingButtons = document.getElementById("onboardingButtons");

  const btnCloseDrawer = document.getElementById("btnCloseDrawer");
  const btnOpenWizard = document.getElementById("btnOpenWizard");

  // State
  let allRows = [];
  let activeStatus = null;
  let statusOrder = [];
  let activeRow = null;
  let noteTimer = null;

  const SALES_STAGES = ["New Signup","In Setup","Demo","Free Trial","Needs Convincing","Live"];

  function setBanner(msg){
    if(!msg){ banner.textContent=""; banner.classList.remove("show"); return; }
    banner.textContent = msg;
    banner.classList.add("show");
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function fmtDate(iso){
    if(!iso) return "‚Äî";
    try{
      const d = new Date(iso);
      return d.toLocaleString(undefined,{year:"numeric",month:"short",day:"2-digit",hour:"2-digit",minute:"2-digit"});
    }catch{ return "‚Äî"; }
  }

  function salesStatus(row){
    const raw = (row?.onboarding_status ?? "").toString().trim();
    return raw || "New Signup";
  }

  function wizardIsComplete(row){
    return !!row?.wizard_completed || !!row?.setup_complete;
  }

  function wizardBadgeHTML(row){
    const ok = wizardIsComplete(row);
    return ok
      ? `<span class="badge ok">‚úÖ Complete</span>`
      : `<span class="badge no">‚è≥ Incomplete</span>`;
  }

  function rowMatchesSearch(row,q){
    if(!q) return true;
    const hay = [
      row.business_name,row.contact_name,row.email,row.phone,row.base_postcode,salesStatus(row)
    ].join(" ").toLowerCase();
    return hay.includes(q.toLowerCase());
  }

  async function loadDistinctStatuses(){
    const { data, error } = await sb.from("customers").select("onboarding_status");
    if(error) return null;
    const set = new Set();
    for(const r of (data||[])){
      const s = (r.onboarding_status ?? "").toString().trim();
      if(s) set.add(s);
    }
    return Array.from(set);
  }

  function computeStatusOrder(distinctFromDb){
    const set = new Set(SALES_STAGES);
    (distinctFromDb||[]).forEach(s=>set.add(s));
    const all = Array.from(set);
    all.sort((a,b)=>{
      const ia = SALES_STAGES.indexOf(a);
      const ib = SALES_STAGES.indexOf(b);
      if(ia!==-1 && ib!==-1) return ia-ib;
      if(ia!==-1) return -1;
      if(ib!==-1) return 1;
      return a.localeCompare(b);
    });
    return all;
  }

  function computeCounts(){
    const counts = {};
    for(const r of allRows){
      const s = salesStatus(r);
      counts[s] = (counts[s] || 0) + 1;
    }
    return counts;
  }

  function buildStatusStrip(){
    const counts = computeCounts();
    statusStrip.innerHTML = "";

    const addChip = (label, count, value) => {
      const el = document.createElement("div");
      el.className = "status-chip" + ((activeStatus===value) ? " is-active" : "");
      el.innerHTML = `<span class="status-chip-name">${escapeHtml(label)}</span><span class="status-chip-count">${count}</span>`;
      el.addEventListener("click", ()=>{ activeStatus=value; render(); });
      statusStrip.appendChild(el);
    };

    addChip("All", allRows.length, null);
    statusOrder.forEach(s => addChip(s, counts[s] || 0, s));
  }

  // OPS tasks (Wizard read-only)
  function setupTasks(row){
    return [
      { key:"wizard",   label:"Wizard complete",    done: wizardIsComplete(row), readonly:true },
      { key:"whatsapp", label:"WhatsApp connected", done: !!row?.whatsapp_connected, readonly:false },
      { key:"calendar", label:"Calendar connected", done: !!row?.calendar_connected, readonly:false },
      { key:"payments", label:"Payments connected", done: !!row?.payments_connected, readonly:false },
    ];
  }

  function tasksDotsHTML(row){
    const items = setupTasks(row);
    const dots = items.map(i=>{
      const cls = `dot ${i.done ? "done" : "need"} ${i.readonly ? "readonly" : ""}`;
      const attrs = i.readonly ? "" : `data-task="${i.key}" data-id="${row.id}"`;
      const hint = i.readonly ? "" : " ‚Äî click to toggle";
      return `<span class="${cls}" ${attrs} title="${escapeHtml(i.label)}${hint}"></span>`;
    }).join("");

    const doneCount = items.filter(i => i.done).length;
    return `<span class="pipe">${dots}<span class="dot-label">${doneCount}/${items.length}</span></span>`;
  }

  function renderTasksChecklist(row){
    const items = setupTasks(row);
    tasksChecklist.innerHTML = items.map(i=>{
      const badge = i.done ? "‚úì" : "";
      const badgeCls = i.done ? "check-badge done" : "check-badge";
      const state =
        i.key === "wizard"
          ? (i.done ? "Completed" : "Incomplete")
          : (i.done ? "Completed" : "Click to toggle");
      const cursor = i.key === "wizard" ? "cursor:default;" : "";
      return `
        <div class="check-item" data-task="${i.key}" style="${cursor}">
          <div class="check-left">
            <div class="${badgeCls}">${badge}</div>
            <div class="check-name">${escapeHtml(i.label)}</div>
          </div>
          <div class="check-state">${escapeHtml(state)}</div>
        </div>`;
    }).join("");
  }

  function renderSalesChecklist(row){
    const current = salesStatus(row);
    salesChecklist.innerHTML = SALES_STAGES.map(stage=>{
      const done = current === stage;
      const badgeCls = done ? "check-badge done" : "check-badge";
      const state = done ? "Current" : "Click to set";
      return `
        <div class="check-item" data-sales="${escapeHtml(stage)}">
          <div class="check-left">
            <div class="${badgeCls}">${done ? "‚úì" : ""}</div>
            <div class="check-name">${escapeHtml(stage)}</div>
          </div>
          <div class="check-state">${state}</div>
        </div>`;
    }).join("");
  }

  function onboardingItems(row){
    return [
      { key:"demo_booked",    label:"Demo booked",       done: !!row?.demo_booked,    value: row?.demo_datetime ? fmtDate(row.demo_datetime) : "Click to set (opens calendar)" },
      { key:"demo_completed", label:"Demo completed",    done: !!row?.demo_completed, value: row?.demo_completed ? "Completed" : "Click to mark" },
      { key:"trial_active",   label:"Free trial active", done: !!row?.trial_active,   value: row?.trial_active ? (row?.trial_end ? ("Ends: " + fmtDate(row.trial_end)) : "Active") : "Click to start" },
      { key:"is_live",        label:"Live",             done: !!row?.is_live,        value: row?.is_live ? (row?.go_live_date ? fmtDate(row.go_live_date) : "Live") : "Click to go live" },
    ];
  }

  function renderOnboardingChecklist(row){
    const items = onboardingItems(row);
    onboardingChecklist.innerHTML = items.map(i=>{
      const badge = i.done ? "‚úì" : "";
      const badgeCls = i.done ? "check-badge done" : "check-badge";
      return `
        <div class="check-item" data-onb="${i.key}">
          <div class="check-left">
            <div class="${badgeCls}">${badge}</div>
            <div class="check-name">${escapeHtml(i.label)}</div>
          </div>
          <div class="check-state">${escapeHtml(i.value)}</div>
        </div>`;
    }).join("");
  }

  async function updateCustomer(id, patch){
    setBanner("");
    const { data, error } = await sb.from("customers").update(patch).eq("id", id).select("*").single();
    if(error){
      console.error("UPDATE ERROR:", error);
      setBanner("Save failed:\n\n" + (error.message || JSON.stringify(error)));
      return null;
    }
    const idx = allRows.findIndex(r=>r.id===id);
    if(idx !== -1) allRows[idx] = data;
    if(activeRow && activeRow.id===id) activeRow = data;
    return data;
  }

  async function doOnboardingAction(key){
    if(!activeRow) return;

    if(key === "demo_booked"){
      try{ window.open(DEMO_CALENDAR_URL, "_blank", "noopener"); }catch{}
      const ok = window.confirm("Calendar opened.\n\nOnce you‚Äôve booked the demo, click OK to mark it as booked.\nClick Cancel if you haven‚Äôt booked yet.");
      if(!ok) return;

      const current = activeRow.demo_datetime
        ? new Date(activeRow.demo_datetime).toISOString().slice(0,16)
        : "";

      const input = window.prompt(
        "Optional: enter the demo date/time to store on the customer.\n\nFormat: 2025-12-20T19:30\nLeave blank if you don‚Äôt want to store a time.",
        current
      );
      if(input === null) return;

      let demoIso = null;
      const trimmed = String(input).trim();
      if(trimmed){
        const parsed = new Date(trimmed);
        if(Number.isNaN(parsed.getTime())){
          setBanner("Invalid date/time.\nTry: 2025-12-20T19:30");
          return;
        }
        demoIso = parsed.toISOString();
      }

      const patch = { demo_booked:true, demo_datetime:demoIso, onboarding_status:"Demo" };
      const updated = await updateCustomer(activeRow.id, patch);
      if(updated){ render(); openDrawer(updated); }
      return;
    }

    if(key === "demo_completed"){
      if(!window.confirm("Mark demo as completed?")) return;
      const updated = await updateCustomer(activeRow.id, { demo_completed:true });
      if(updated){ render(); openDrawer(updated); }
      return;
    }

    if(key === "trial_active"){
      const daysRaw = window.prompt("Free trial length in days? (default 7)", "7");
      if(daysRaw === null) return;

      const days = Math.max(1, Math.min(60, parseInt(daysRaw, 10) || 7));
      const start = new Date();
      const end = new Date(start.getTime() + days * 24 * 60 * 60 * 1000);

      const patch = { trial_active:true, trial_start:start.toISOString(), trial_end:end.toISOString(), onboarding_status:"Free Trial" };
      const updated = await updateCustomer(activeRow.id, patch);
      if(updated){ render(); openDrawer(updated); }
      return;
    }

    if(key === "is_live"){
      if(!window.confirm("Go live now?\n\nThis marks the customer as Live.")) return;
      const now = new Date();
      const patch = { is_live:true, go_live_date:now.toISOString(), trial_active:false, onboarding_status:"Live" };
      const updated = await updateCustomer(activeRow.id, patch);
      if(updated){ render(); openDrawer(updated); }
      return;
    }
  }

  function renderOnboardingButtons(row){
    onboardingButtons.innerHTML = "";

    const mk = (label, cls, onClick) => {
      const b = document.createElement("button");
      b.type = "button";
      b.className = `btn ${cls || "btn-secondary"}`;
      b.textContent = label;
      b.addEventListener("click", (e)=>{ e.stopPropagation(); onClick(); });
      onboardingButtons.appendChild(b);
    };

    mk("üìÖ Open demo calendar", "btn-primary", ()=>window.open(DEMO_CALENDAR_URL, "_blank", "noopener"));
    mk(row.demo_booked ? "Update demo booked" : "Book demo (after calendar)", "btn-secondary", ()=>doOnboardingAction("demo_booked"));
    mk(row.demo_completed ? "Demo completed ‚úÖ" : "Mark demo completed", row.demo_completed ? "btn-secondary" : "btn-primary", ()=>doOnboardingAction("demo_completed"));
    mk(row.trial_active ? "Trial active ‚úÖ" : "Start free trial", row.trial_active ? "btn-secondary" : "btn-primary", ()=>doOnboardingAction("trial_active"));
    mk(row.is_live ? "Live ‚úÖ" : "Go live", row.is_live ? "btn-secondary" : "btn-primary", ()=>doOnboardingAction("is_live"));

    mk("Reset onboarding (careful)", "btn-danger", async ()=>{
      if(!activeRow) return;
      if(!window.confirm("Reset onboarding flags for this customer?\n\nThis will NOT delete the customer, but will clear demo/trial/live.")) return;

      const patch = {
        demo_booked:false, demo_datetime:null, demo_completed:false,
        trial_active:false, trial_start:null, trial_end:null,
        is_live:false, go_live_date:null,
        onboarding_status:"In Setup"
      };

      const updated = await updateCustomer(activeRow.id, patch);
      if(updated){ render(); openDrawer(updated); }
    });
  }

  function renderOpsButtons(row){
    opsButtons.innerHTML = "";
    const mk = (label, onClick) => {
      const b = document.createElement("button");
      b.type = "button";
      b.className = "btn btn-secondary";
      b.textContent = label;
      b.addEventListener("click", (e)=>{ e.stopPropagation(); onClick(); });
      opsButtons.appendChild(b);
    };

    mk(row.whatsapp_connected ? "WhatsApp ‚úÖ (toggle)" : "WhatsApp ‚ùå (toggle)", async ()=>{
      const updated = await updateCustomer(row.id, { whatsapp_connected: !row.whatsapp_connected });
      if(updated){ render(); openDrawer(updated); }
    });

    mk(row.calendar_connected ? "Calendar ‚úÖ (toggle)" : "Calendar ‚ùå (toggle)", async ()=>{
      const updated = await updateCustomer(row.id, { calendar_connected: !row.calendar_connected });
      if(updated){ render(); openDrawer(updated); }
    });

    mk(row.payments_connected ? "Payments ‚úÖ (toggle)" : "Payments ‚ùå (toggle)", async ()=>{
      const updated = await updateCustomer(row.id, { payments_connected: !row.payments_connected });
      if(updated){ render(); openDrawer(updated); }
    });
  }

  function openDrawer(row){
    activeRow = row;

    drawerTitle.textContent = row.business_name || "Customer";
    drawerSub.textContent = [
      row.contact_name ? `Contact: ${row.contact_name}` : "",
      row.base_postcode ? `Postcode: ${row.base_postcode}` : "",
      row.id ? `ID: ${row.id}` : ""
    ].filter(Boolean).join(" ‚Ä¢ ");

    drawerBusiness.value = row.business_name || "";
    drawerContact.value = row.contact_name || "";
    drawerEmail.value = row.email || "";
    drawerPhone.value = row.phone || "";
    drawerNotes.value = row.notes || "";
    drawerLeadNotes.value = row.lead_notes || "";

    renderSalesChecklist(row);
    renderOnboardingChecklist(row);
    renderOnboardingButtons(row);
    renderTasksChecklist(row);
    renderOpsButtons(row);

    drawerHint.textContent = "Autosaves";

    drawer.classList.add("open");
    drawer.setAttribute("aria-hidden","false");

    drawerOverlay.classList.add("open");
    drawerOverlay.setAttribute("aria-hidden","false");
  }

  function closeDrawer(){
    drawer.classList.remove("open");
    drawer.setAttribute("aria-hidden","true");
    drawerOverlay.classList.remove("open");
    drawerOverlay.setAttribute("aria-hidden","true");
    activeRow = null;
  }

  async function saveNotesNow(){
    if(!activeRow) return;
    drawerHint.textContent = "Saving‚Ä¶";
    const id = activeRow.id;
    const patch = { notes: drawerNotes.value, lead_notes: drawerLeadNotes.value };
    const { error } = await sb.from("customers").update(patch).eq("id", id);
    if(error){
      console.error("NOTES SAVE ERROR:", error);
      setBanner("Failed to save notes:\n\n" + (error.message || JSON.stringify(error)));
      drawerHint.textContent = "Save failed";
      return;
    }
    drawerHint.textContent = "Saved";
    const idx = allRows.findIndex(r=>r.id===id);
    if(idx !== -1){
      allRows[idx].notes = patch.notes;
      allRows[idx].lead_notes = patch.lead_notes;
    }
    activeRow.notes = patch.notes;
    activeRow.lead_notes = patch.lead_notes;
  }

  function queueNotesSave(){
    clearTimeout(noteTimer);
    noteTimer = setTimeout(saveNotesNow, 450);
  }

  function render(){
    buildStatusStrip();

    const q = (search.value || "").trim();
    const rows = allRows
      .filter(r => (activeStatus ? salesStatus(r)===activeStatus : true))
      .filter(r => rowMatchesSearch(r,q))
      .sort((a,b)=>{
        const ta = new Date(a.updated_at || a.created_at || 0).getTime();
        const tb = new Date(b.updated_at || b.created_at || 0).getTime();
        return tb - ta;
      });

    tbody.innerHTML = "";

    if(!rows.length){
      tbody.innerHTML = `<tr><td colspan="9">No matches.</td></tr>`;
      statusBar.textContent = `0 shown ‚Ä¢ ${allRows.length} total`;
      return;
    }

    for(const r of rows){
      const tr = document.createElement("tr");
      tr.dataset.id = r.id; // ‚úÖ IMPORTANT: used by delegated click handler
      tr.innerHTML = `
        <td>${escapeHtml(salesStatus(r))}</td>
        <td>${wizardBadgeHTML(r)}</td>
        <td>${tasksDotsHTML(r)}</td>
        <td>${escapeHtml(r.business_name || "‚Äî")}</td>
        <td>${escapeHtml(r.contact_name || "‚Äî")}</td>
        <td>${escapeHtml(r.email || "‚Äî")}</td>
        <td>${escapeHtml(r.phone || "‚Äî")}</td>
        <td>${escapeHtml(r.base_postcode || "‚Äî")}</td>
        <td>${escapeHtml(fmtDate(r.updated_at || r.created_at))}</td>
      `;
      tbody.appendChild(tr);
    }

    statusBar.textContent =
      `${rows.length} shown ‚Ä¢ ${allRows.length} total` +
      (activeStatus ? ` ‚Ä¢ Stage: ${activeStatus}` : "");
  }

  async function loadCustomersAndStatuses(){
    setBanner("");
    statusBar.textContent = "Loading‚Ä¶";
    tbody.innerHTML = `<tr><td colspan="9">Loading‚Ä¶</td></tr>`;

    const { data, error } = await sb.from("customers").select("*");
    if(error){
      console.error("LOAD ERROR:", error);
      setBanner("Failed to load customers:\n\n" + (error.message || JSON.stringify(error)));
      allRows = [];
      tbody.innerHTML = `<tr><td colspan="9">No data loaded.</td></tr>`;
      statusBar.textContent = "Load failed.";
      return;
    }

    allRows = Array.isArray(data) ? data : [];

    const distinct = await loadDistinctStatuses();
    statusOrder = computeStatusOrder(distinct);

    render();
  }

  // ‚úÖ AUTH + ADMIN CHECK
  async function requireAdmin(){
    const { data: sess } = await sb.auth.getSession();
    const session = sess?.session;
    if(!session){
      window.location.href = "/login.html?next=" + encodeURIComponent("/dashboard-secure.html");
      return false;
    }

    const uid = session.user.id;
    const { data, error } = await sb.from("admin_users").select("user_id").eq("user_id", uid).maybeSingle();

    if(error){
      console.error("admin_users check failed:", error);
      setBanner("Admin check failed:\n\n" + (error.message || JSON.stringify(error)));
      return false;
    }

    if(!data){
      setBanner("Access denied.\n\nYour login is valid, but you are not on the admin_users allow-list.");
      return false;
    }
    return true;
  }

  // Controls
  btnRefresh.addEventListener("click", loadCustomersAndStatuses);
  btnNew.addEventListener("click", (e)=>{ e.preventDefault(); window.open("app.html", "_blank", "noopener"); });
  btnClear.addEventListener("click", ()=>{ activeStatus=null; search.value=""; render(); });
  search.addEventListener("input", render);

  // ‚úÖ Delegated row click (fixes ‚Äúrows don‚Äôt click / drawer doesn‚Äôt open‚Äù)
  tbody.addEventListener("click", (e) => {
    const tr = e.target.closest("tr");
    if(!tr) return;
    if(e.target.closest("button,a,input,select,textarea,label")) return;

    const id = tr.dataset.id;
    if(!id) return;

    const row = allRows.find(r => r.id === id);
    if(!row) return;

    openDrawer(row);
  });

  // Drawer autosave notes
  drawerNotes.addEventListener("input", queueNotesSave);
  drawerLeadNotes.addEventListener("input", queueNotesSave);

  // Close drawer always works
  btnCloseDrawer.addEventListener("click", (e)=>{
    e.preventDefault();
    e.stopPropagation();
    closeDrawer();
  }, true);

  drawerOverlay.addEventListener("click", (e)=>{
    e.preventDefault();
    closeDrawer();
  });

  document.addEventListener("keydown", (e)=>{
    if(e.key === "Escape" && drawer.classList.contains("open")){
      closeDrawer();
    }
  });

  // Open wizard (customer_id) ‚Äî only when button clicked
  btnOpenWizard.addEventListener("click", (e)=>{
    e.stopPropagation();
    if(!activeRow) return;
    window.open(`app.html?customer_id=${encodeURIComponent(activeRow.id)}`, "_blank", "noopener");
  });

  // Sales checklist to set stage
  document.addEventListener("click", async (e)=>{
    const item = e.target.closest(".check-item[data-sales]");
    if(!item || !activeRow) return;
    e.stopPropagation();

    const stage = item.dataset.sales;
    if(salesStatus(activeRow) === stage) return;

    const updated = await updateCustomer(activeRow.id, { onboarding_status: stage });
    if(updated){ render(); openDrawer(updated); }
  }, true);

  // Onboarding checklist rows click = action
  document.addEventListener("click", async (e)=>{
    const item = e.target.closest(".check-item[data-onb]");
    if(!item || !activeRow) return;
    e.stopPropagation();
    await doOnboardingAction(item.dataset.onb);
  }, true);

  // Toggle ops dots in table (Wizard ignored)
  document.addEventListener("click", async (e)=>{
    const dot = e.target.closest(".dot[data-task][data-id]");
    if(!dot) return;

    e.stopPropagation();

    const id = dot.dataset.id;
    const key = dot.dataset.task;
    const row = allRows.find(r => r.id === id);
    if(!row) return;

    const patch = {};
    if(key === "whatsapp") patch.whatsapp_connected = !row.whatsapp_connected;
    if(key === "calendar") patch.calendar_connected = !row.calendar_connected;
    if(key === "payments") patch.payments_connected = !row.payments_connected;

    if(Object.keys(patch).length === 0) return;

    const updated = await updateCustomer(id, patch);
    if(updated){
      render();
      if(activeRow && activeRow.id === id) openDrawer(updated);
    }
  }, true);

  // Toggle ops checklist in drawer (Wizard ignored)
  document.addEventListener("click", async (e)=>{
    const item = e.target.closest(".check-item[data-task]");
    if(!item || !activeRow) return;

    const key = item.dataset.task;
    if(key === "wizard") return;

    e.stopPropagation();

    const patch = {};
    if(key === "whatsapp") patch.whatsapp_connected = !activeRow.whatsapp_connected;
    if(key === "calendar") patch.calendar_connected = !activeRow.calendar_connected;
    if(key === "payments") patch.payments_connected = !activeRow.payments_connected;

    const updated = await updateCustomer(activeRow.id, patch);
    if(updated){ render(); openDrawer(updated); }
  }, true);

  // Logout
  btnLogout.addEventListener("click", async ()=>{
    try{ await sb.auth.signOut(); }catch{}
    window.location.href = "/login.html?next=" + encodeURIComponent("/dashboard-secure.html");
  });

  // Init
  (async ()=>{
    const ok = await requireAdmin();
    if(!ok) return;
    await loadCustomersAndStatuses();
  })();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TradeBotPro — Your Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --primary-blue:#1f4e79;
      --accent-blue:#00a3ff;
      --dark-text:#151820;
      --muted-text:#6b7280;
      --light-bg:#f3f4f9;
      --white:#ffffff;
      --border-subtle:rgba(15,23,42,0.12);
      --success-green:#0f7b46;
      --error-red:#b3261e;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      background:radial-gradient(circle at top left,#e0ebff 0,#f3f4f9 40%,#fdfdfd 100%);
      color:var(--dark-text);
      line-height:1.5;
    }
    header{
      border-bottom:1px solid rgba(15,23,42,0.06);
      background:rgba(248,250,252,0.96);
      backdrop-filter:blur(6px);
      position:sticky; top:0; z-index:20;
    }
    .header-inner{
      max-width:1100px; margin:0 auto; padding:0.6rem 1.25rem;
      display:flex; align-items:center; justify-content:space-between; gap:0.75rem; flex-wrap:wrap;
    }
    .logo-wrap{display:flex;align-items:center;gap:0.6rem}
    .logo-icon{width:30px;height:30px;border-radius:9px;background:var(--primary-blue);position:relative}
    .logo-icon::before,.logo-icon::after{content:"";position:absolute;background:var(--white);border-radius:4px}
    .logo-icon::before{width:11px;height:17px;left:7px;top:6px}
    .logo-icon::after{width:6px;height:11px;right:7px;top:9px}
    .logo-main{font-weight:700;font-size:1rem;color:var(--primary-blue)}
    .logo-tag{font-size:0.75rem;color:var(--muted-text)}
    .wrap{max-width:1100px;margin:0 auto;padding:1.25rem}
    .grid{display:grid;grid-template-columns:minmax(0,1.2fr) minmax(0,0.8fr);gap:1.25rem;align-items:start}
    .card{
      background:rgba(255,255,255,0.92);
      border-radius:1.2rem;
      padding:1.2rem 1.25rem;
      box-shadow:0 24px 60px rgba(15,23,42,0.12),0 0 0 1px rgba(15,23,42,0.03);
    }
    .card h2{margin:0 0 0.4rem;color:var(--primary-blue);font-size:1.15rem}
    .sub{margin:0 0 0.9rem;color:var(--muted-text);font-size:0.9rem}
    .kv{display:grid;grid-template-columns:160px 1fr;gap:0.55rem 0.8rem;font-size:0.92rem}
    .k{color:var(--muted-text)}
    .v{font-weight:700}
    .pill{display:inline-flex;align-items:center;padding:0.25rem 0.7rem;border-radius:999px;border:1px solid rgba(0,0,0,0.08);background:#fff;font-size:0.82rem;font-weight:700}
    .pill.ok{border-color:rgba(15,123,70,0.35); background:#ecfdf5; color:#14532d}
    .pill.warn{border-color:rgba(179,38,30,0.25); background:#fff1f2; color:#7f1d1d}
    .btnrow{display:flex;gap:0.6rem;flex-wrap:wrap;margin-top:1rem}
    .btn{
      border-radius:999px;border:1px solid transparent;padding:0.55rem 1.1rem;
      font-size:0.9rem;font-weight:800;cursor:pointer;display:inline-flex;align-items:center;gap:0.35rem;
      background:transparent;text-decoration:none;
    }
    .btn-primary{background:linear-gradient(135deg,var(--primary-blue),#163857);color:var(--white);box-shadow:0 12px 28px rgba(15,23,42,0.28)}
    .btn-secondary{border-color:var(--border-subtle);background:#f9fafb;color:var(--dark-text)}
    .status{margin-top:0.75rem;font-size:0.9rem;min-height:1.2em}
    .status.error{color:var(--error-red)}
    .status.success{color:var(--success-green)}
    @media (max-width: 900px){.grid{grid-template-columns:1fr}.kv{grid-template-columns:140px 1fr}}
  </style>
</head>
<body>
  <nav class="tbp-nav">
  <a href="./index.html">Home</a>
  <a href="#" id="tbpEditSetup">Edit setup</a>
</nav>

<style>
  .tbp-nav {
    display: flex;
    gap: 14px;
    padding: 10px 16px;
    font-size: 14px;
  }
  .tbp-nav a {
    text-decoration: none;
    font-weight: 600;
  }
</style>

<header>
  <div class="header-inner">
    <div class="logo-wrap">
      <div class="logo-icon" aria-hidden="true"></div>
      <div>
        <div class="logo-main">TradeBotPro</div>
        <div class="logo-tag">Client dashboard</div>
      </div>
    </div>
    <div class="logo-tag" id="header-business"></div>
  </div>
</header>

<div class="wrap">
  <div class="grid">
    <section class="card">
      <h2>Your account</h2>
      <p class="sub">Only you can see this data (secure login + database rules).</p>

      <div class="kv" id="kv"></div>

      <div class="btnrow">
        <a class="btn btn-primary" id="btn-open-wizard" href="#">Open setup wizard</a>
        <button class="btn btn-secondary" id="btn-logout" type="button">Log out</button>
      </div>

      <div class="status" id="status"></div>
    </section>

    <aside class="card">
      <h2>Setup status</h2>
      <p class="sub">Quick view of what’s done so far.</p>
      <div id="setup-badges"></div>
    </aside>
  </div>
</div>

<!-- Supabase UMD (single include) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.48.0/dist/umd/supabase.min.js"></script>

<script>
(function () {
  window.addEventListener("error", (e) => {
    console.error("[TBP] JS Error:", e.message, "at", e.filename, "line", e.lineno);
  });
  window.addEventListener("unhandledrejection", (e) => {
    console.error("[TBP] Unhandled Promise:", e.reason);
  });

  function bootWhenSupabaseReady() {
    if (typeof window.supabase === "undefined") {
      console.error("[TBP] Supabase UMD not loaded yet. Retrying...");
      return setTimeout(bootWhenSupabaseReady, 50);
    }
    boot();
  }

  function boot() {
    // ==== CONFIG (YOUR KEYS) ====
    const SUPABASE_URL = "https://yaiutswdcbfwkxfqxkzy.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlhaXV0c3dkY2Jmd2t4ZnF4a3p5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1MDE2MDgsImV4cCI6MjA4MDA3NzYwOH0.HOLFxzjsZ5Ieqg0b-aTdP0hAdLsPVXL6Zjs-HgOHgc8";
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ✅ ROLE-BASED REDIRECT (clients → client dashboard, admins → secure admin dashboard)
    async function redirectAfterWizard() {
      const { data: { session } } = await sb.auth.getSession();

      if (!session) {
        window.location.href = "/login.html";
        return;
      }

      const { data: admin, error } = await sb
        .from("admin_users")
        .select("user_id")
        .eq("user_id", session.user.id)
        .maybeSingle();

      if (error) {
        console.error("[TBP] Role check failed:", error);
        window.location.href = "/login.html";
        return;
      }

      window.location.href = admin ? "/dashboard-secure.html" : "/client-dashboard.html";
    }

    const params = new URLSearchParams(location.search);
    const customer_id = (params.get("customer_id") || "").trim();

    // ==== ELEMENTS ====
    const panels = Array.from(document.querySelectorAll(".step-panel"));
    const stepDots = Array.from(document.querySelectorAll(".step-dot"));
    const progressInner = document.getElementById("progress-bar-inner");
    const progressText = document.getElementById("progress-percent");

    const wizardStepLabel = document.getElementById("wizard-step-label");
    const wizardStepTitle = document.getElementById("wizard-step-title");
    const wizardStepSubtitle = document.getElementById("wizard-step-subtitle");
    const footerText = document.getElementById("wizard-footer-text");
    const statusEl = document.getElementById("wizard-status-message");

    const btnBack = document.getElementById("btn-back");
    const btnNext = document.getElementById("btn-next");
    const btnSaveDraft = document.getElementById("btn-save-draft");
    const btnDashboard = document.getElementById("btn-dashboard");

    const summaryBoxEl = document.getElementById("summary-box");

    // Ensure chip buttons can never submit anything (safe)
    document.querySelectorAll(".chip-row .chip").forEach(b => {
      if (b.tagName === "BUTTON") b.type = "button";
      b.setAttribute("aria-pressed", "false");
    });

    let currentStep = 1;
    const totalSteps = 4;

    const answers = {
      contact_name: "",
      business_name: "",
      email: "",
      phone: "",
      base_postcode: "",
      review_link: "",
      ai_avoid: "",
      extra_notes: "",
      main_trade: null,
      business_stage: null,
      coverage_radius: null,
      callout_style: null,
      callout_band: null,
      preferred_jobs: [],
      tone_of_voice: null,
      channels: [],
      review_platforms: [],
      review_push_level: null,
      demo_style: [],
      demo_slot: null,
      golive_timing: null
    };

    function setStatus(msg, type) {
      statusEl.textContent = msg || "";
      statusEl.className = "wizard-status-message" + (type ? ` wizard-status-message--${type}` : "");
    }

    function stepMeta(step) {
      if (step === 1) return {
        label: "Step 1",
        title: "Business basics",
        subtitle: "Who are you, what do you do and how do you like to run things?"
      };
      if (step === 2) return {
        label: "Step 2",
        title: "Area & pricing",
        subtitle: "Where you cover and how you like to charge."
      };
      if (step === 3) return {
        label: "Step 3",
        title: "Messaging & reviews",
        subtitle: "How the AI should talk and where reviews should go."
      };
      return {
        label: "Step 4",
        title: "Demo & go-live",
        subtitle: "How you want to test it and when you’d like to go live."
      };
    }

    function renderStep() {
      panels.forEach(p => p.classList.remove("is-active"));
      const active = document.querySelector(`.step-panel[data-step="${currentStep}"]`);
      if (active) active.classList.add("is-active");

      stepDots.forEach(d => {
        const n = parseInt(d.getAttribute("data-step-dot"), 10);
        d.classList.toggle("is-active", n === currentStep);
        d.classList.toggle("is-complete", n < currentStep);
      });

      const pct = Math.round(((currentStep - 1) / (totalSteps - 1)) * 100);
      progressInner.style.width = `${pct}%`;
      progressText.textContent = `Step ${currentStep} of ${totalSteps}`;

      const meta = stepMeta(currentStep);
      wizardStepLabel.textContent = meta.label;
      wizardStepTitle.textContent = meta.title;
      wizardStepSubtitle.textContent = meta.subtitle;

      footerText.innerHTML = `Step <strong>${currentStep}</strong> of <strong>${totalSteps}</strong>. You can tweak anything later.`;

      btnBack.disabled = currentStep === 1;

      btnNext.textContent = (currentStep === totalSteps) ? "Finish →" : "Next step →";
    }

    function readInputsIntoAnswers() {
      const v = (x) => (x ?? "").toString().trim();
      answers.contact_name = v(document.getElementById("contact_name")?.value);
      answers.business_name = v(document.getElementById("business_name")?.value);
      answers.email = v(document.getElementById("contact_email")?.value);
      answers.phone = v(document.getElementById("contact_mobile")?.value);
      answers.base_postcode = v(document.getElementById("base_postcode")?.value);
      answers.review_link = v(document.getElementById("review_link")?.value);
      answers.ai_avoid = v(document.getElementById("ai_avoid")?.value);
      answers.extra_notes = v(document.getElementById("extra_notes")?.value);
    }

    function applyChipVisualsFromAnswers() {
      document.querySelectorAll(".chip-row").forEach(row => {
        const field = row.getAttribute("data-field");
        const mode = row.getAttribute("data-select");
        if (!field || !mode) return;

        const chips = Array.from(row.querySelectorAll(".chip"));
        chips.forEach(ch => {
          const label = (ch.textContent || "").trim();
          let selected = false;

          if (mode === "single") selected = answers[field] === label;
          else selected = (Array.isArray(answers[field]) ? answers[field] : []).includes(label);

          ch.classList.toggle("is-selected", selected);
          ch.setAttribute("aria-pressed", selected ? "true" : "false");
        });
      });
    }

    document.addEventListener("click", (e) => {
      const chip = e.target.closest(".chip-row .chip");
      if (!chip) return;

      const row = chip.closest(".chip-row");
      if (!row) return;

      const field = row.getAttribute("data-field");
      const mode = row.getAttribute("data-select");
      if (!field || !mode) return;

      const label = (chip.textContent || "").trim();

      if (mode === "single") {
        answers[field] = label;
      } else {
        if (!Array.isArray(answers[field])) answers[field] = [];
        const idx = answers[field].indexOf(label);
        if (idx >= 0) answers[field].splice(idx, 1);
        else answers[field].push(label);
      }

      applyChipVisualsFromAnswers();
    }, true);

    // Save draft to localStorage (browser only)
    btnSaveDraft.addEventListener("click", () => {
      readInputsIntoAnswers();
      localStorage.setItem("tbp_wizard_draft", JSON.stringify({ answers, customer_id, ts: Date.now() }));
      setStatus("Draft saved in this browser.", "success");
    });

    // Back / Next navigation
    btnBack.addEventListener("click", () => {
      setStatus("");
      if (currentStep > 1) {
        currentStep -= 1;
        renderStep();
      }
    });

    btnNext.addEventListener("click", async () => {
      setStatus("");
      readInputsIntoAnswers();

      if (currentStep === 1) {
        if (!answers.contact_name || !answers.business_name) {
          setStatus("Please enter contact name and business name.", "error");
          return;
        }
        if (!answers.email && !answers.phone) {
          setStatus("Please enter an email or a mobile number.", "error");
          return;
        }
      }

      if (currentStep < totalSteps) {
        currentStep += 1;
        renderStep();
        return;
      }

      if (!customer_id) {
        setStatus("Missing customer_id in the URL. Please start from the signup form link.", "error");
        return;
      }

      btnNext.disabled = true;
      setStatus("Saving…");

      try {
        const patch = {
          contact_name: answers.contact_name || null,
          business_name: answers.business_name || null,
          email: answers.email || null,
          phone: answers.phone || null,
          base_postcode: answers.base_postcode || null,

          wizard_answers: answers,
          wizard_completed: true,
          wizard_completed_at: new Date().toISOString()
        };

        const { error } = await sb
          .from("customers")
          .update(patch)
          .eq("id", customer_id);

        if (error) throw error;

        setStatus("Saved. Wizard complete ✅", "success");
        if (summaryBoxEl) summaryBoxEl.hidden = false;

        btnNext.style.display = "none";
        btnDashboard.style.display = "inline-flex";

        window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
      } catch (err) {
        console.error("[TBP] Finish save error:", err);
        setStatus("Couldn’t save right now. Please try again.", "error");
        btnNext.disabled = false;
      }
    });

    // ✅ REPLACED: Back to dashboard now sends admins to secure admin dashboard + clients to client dashboard
    btnDashboard.addEventListener("click", (e) => {
      e.preventDefault();
      redirectAfterWizard();
    });

    // Prefill from customers row
    async function prefillFromCustomer() {
      if (!customer_id) return;

      try {
        const { data, error } = await sb
          .from("customers")
          .select("id, contact_name, business_name, email, phone, whatsapp_number, base_postcode, wizard_answers")
          .eq("id", customer_id)
          .single();

        if (error) throw error;

        if (data?.contact_name) document.getElementById("contact_name").value = data.contact_name;
        if (data?.business_name) document.getElementById("business_name").value = data.business_name;
        if (data?.email) document.getElementById("contact_email").value = data.email;

        const phone = data?.phone || data?.whatsapp_number || "";
        if (phone) document.getElementById("contact_mobile").value = phone;

        if (data?.base_postcode) document.getElementById("base_postcode").value = data.base_postcode;

        if (data?.wizard_answers && typeof data.wizard_answers === "object") {
          Object.assign(answers, data.wizard_answers);
        }

        readInputsIntoAnswers();
        applyChipVisualsFromAnswers();
      } catch (err) {
        console.error("[TBP] Prefill failed:", err);
      }
    }

    renderStep();
    prefillFromCustomer();

    window.TBP = { sb, customer_id, answers, redirectAfterWizard };
  }

  bootWhenSupabaseReady();
})();
</script>

</body>
</html>

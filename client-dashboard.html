<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TradeBotPro — Client Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --primary-blue:#1f4e79;
      --accent-blue:#00a3ff;
      --dark-text:#151820;
      --muted-text:#6b7280;
      --light-bg:#f3f4f9;
      --white:#ffffff;
      --border-subtle:rgba(15,23,42,0.12);
      --success-green:#0f7b46;
      --error-red:#b3261e;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      background:radial-gradient(circle at top left,#e0ebff 0,#f3f4f9 40%,#fdfdfd 100%);
      color:var(--dark-text);
      line-height:1.5;
    }
    header{
      border-bottom:1px solid rgba(15,23,42,0.06);
      background:rgba(248,250,252,0.96);
      backdrop-filter:blur(6px);
      position:sticky; top:0; z-index:20;
    }
    .header-inner{
      max-width:1100px;
      margin:0 auto;
      padding:0.7rem 1.25rem;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:1rem;
      flex-wrap:wrap;
    }
    .brand{display:flex; align-items:center; gap:.6rem;}
    .logo-icon{width:30px;height:30px;border-radius:9px;background:var(--primary-blue);position:relative;}
    .logo-icon:before,.logo-icon:after{content:"";position:absolute;background:var(--white);border-radius:4px;}
    .logo-icon:before{width:11px;height:17px;left:7px;top:6px}
    .logo-icon:after{width:6px;height:11px;right:7px;top:9px}
    .brand-title{font-weight:800;color:var(--primary-blue);line-height:1.1}
    .brand-sub{font-size:.78rem;color:var(--muted-text)}
    .header-actions{display:flex; gap:.6rem; flex-wrap:wrap}
    .btn{
      border-radius:999px;
      border:1px solid transparent;
      padding:.55rem 1rem;
      font-size:.88rem;
      font-weight:600;
      cursor:pointer;
      background:transparent;
      display:inline-flex;
      align-items:center;
      gap:.35rem;
    }
    .btn-primary{
      background:linear-gradient(135deg,var(--primary-blue),#163857);
      color:var(--white);
      box-shadow:0 12px 28px rgba(15,23,42,0.25);
    }
    .btn-secondary{
      border-color:var(--border-subtle);
      background:#f9fafb;
      color:var(--dark-text);
    }
    .btn:disabled{opacity:.6; cursor:default; box-shadow:none}
    main{
      max-width:1100px;
      margin:0 auto;
      padding:1.2rem 1.25rem 2.5rem;
    }
    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:1rem;
      align-items:start;
    }
    @media (max-width: 900px){ .grid{grid-template-columns:1fr} }
    .card{
      background:rgba(255,255,255,.92);
      border:1px solid rgba(15,23,42,0.06);
      border-radius:18px;
      box-shadow:0 24px 60px rgba(15,23,42,0.10);
      padding:1rem 1.05rem;
    }
    .card h2{
      margin:0 0 .4rem;
      font-size:1.05rem;
      color:var(--primary-blue);
    }
    .muted{color:var(--muted-text)}
    .row{display:flex; gap:.7rem; flex-wrap:wrap; align-items:center; justify-content:space-between;}
    .kvs{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:.6rem;
      margin-top:.6rem;
    }
    @media (max-width: 600px){ .kvs{grid-template-columns:1fr} }
    .kv{
      border:1px solid rgba(15,23,42,0.08);
      background:#f8fafc;
      border-radius:14px;
      padding:.65rem .75rem;
    }
    .kv .k{font-size:.72rem; text-transform:uppercase; letter-spacing:.12em; color:var(--muted-text)}
    .kv .v{font-weight:800; margin-top:.15rem}
    .pill{
      display:inline-flex;
      align-items:center;
      padding:.32rem .65rem;
      border-radius:999px;
      border:1px solid rgba(15,23,42,0.12);
      font-size:.82rem;
      font-weight:800;
      background:#fff;
    }
    .pill.success{border-color:rgba(15,123,70,.35); background:#ecfdf5; color:#0f7b46}
    .pill.warn{border-color:rgba(245,158,11,.35); background:#fffbeb; color:#92400e}
    .pill.neutral{border-color:rgba(148,163,184,.5); background:#f1f5f9; color:#334155}

    .chip-row{display:flex; flex-wrap:wrap; gap:8px; margin-top:.6rem;}
    .chip{
      border-radius:999px;
      border:1px solid rgba(0,0,0,0.12);
      background:#fff;
      padding:.4rem .85rem;
      font-size:.86rem;
      cursor:pointer;
      user-select:none;
      font-weight:700;
    }
    .chip.is-selected{
      outline:2px solid rgba(31,78,121,0.45);
      background:rgba(31,78,121,0.08);
      border-color:#1f4e79;
      color:#1f4e79;
    }
    .status{margin-top:.8rem; min-height:1.2em; font-size:.85rem;}
    .status.ok{color:var(--success-green)}
    .status.err{color:var(--error-red)}
  </style>
</head>

<body>
  <nav class="tbp-nav">
  <a href="./index.html">Home</a>
  <a href="./signup.html">Sign up</a>
  <a href="./login.html">Admin login</a>
</nav>

<style>
  .tbp-nav {
    display: flex;
    gap: 14px;
    padding: 10px 16px;
    font-size: 14px;
  }
  .tbp-nav a {
    text-decoration: none;
    font-weight: 600;
  }
</style>

  <header>
    <div class="header-inner">
      <div class="brand">
        <div class="logo-icon" aria-hidden="true"></div>
        <div>
          <div class="brand-title">TradeBotPro</div>
          <div class="brand-sub">Client Dashboard</div>
        </div>
      </div>

      <div class="header-actions">
        <button class="btn btn-secondary" id="btn-verify-email" style="display:none">Verify email</button>
        <button class="btn btn-secondary" id="btn-edit-setup">Edit setup</button>
        <button class="btn btn-primary" id="btn-save">Save changes</button>
      </div>
    </div>
  </header>

  <main>
    <div class="grid">
      <section class="card">
        <div class="row">
          <div>
            <h2 id="h-business">Loading…</h2>
            <div class="muted" id="h-contact"></div>
          </div>
          <div id="pill-wizard" class="pill neutral">Wizard: Unknown</div>
        </div>

        <!-- Business summary -->
        <div class="kvs">
          <div class="kv"><div class="k">Base Postcode</div><div class="v" id="v-postcode">—</div></div>
          <div class="kv"><div class="k">Trade</div><div class="v" id="v-trade">—</div></div>
          <div class="kv"><div class="k">Coverage</div><div class="v" id="v-coverage">—</div></div>
          <div class="kv"><div class="k">Call-out Style</div><div class="v" id="v-callout">—</div></div>
        </div>

        <div class="kvs" style="margin-top:.8rem">
          <div class="kv"><div class="k">Tone</div><div class="v" id="v-tone">—</div></div>
          <div class="kv"><div class="k">Channels</div><div class="v" id="v-channels">—</div></div>
          <div class="kv"><div class="k">Reviews</div><div class="v" id="v-reviews">—</div></div>
          <div class="kv"><div class="k">Demo slot</div><div class="v" id="v-demo-slot">—</div></div>
        </div>

        <!-- Lifecycle summary (REAL COLUMNS) -->
        <div class="kvs" style="margin-top:.8rem">
          <div class="kv"><div class="k">Signup status</div><div class="v" id="v-signup-status">—</div></div>
          <div class="kv"><div class="k">Demo</div><div class="v" id="v-demo-status">—</div></div>
          <div class="kv"><div class="k">Free trial</div><div class="v" id="v-trial-status">—</div></div>
          <div class="kv"><div class="k">Plan</div><div class="v" id="v-plan-status">—</div></div>
        </div>

        <div class="status" id="status-msg"></div>
      </section>

      <aside class="card">
        <h2>Onboarding status</h2>
        <div class="muted">This saves to your customer record.</div>

        <div class="chip-row" data-col="signup_status" data-select="single">
          <button type="button" class="chip">New</button>
          <button type="button" class="chip">Wizard complete</button>
          <button type="button" class="chip">Demo</button>
          <button type="button" class="chip">Free Trial</button>
          <button type="button" class="chip">Live</button>
        </div>

        <div style="height:.8rem"></div>

        <h2>Demo status</h2>
        <div class="muted">Quick internal tracking.</div>

        <div class="chip-row" data-col="demo_status" data-select="single">
          <button type="button" class="chip">Not booked</button>
          <button type="button" class="chip">Booked</button>
          <button type="button" class="chip">Completed</button>
        </div>

        <div style="height:.8rem"></div>

        <h2>Trial status</h2>
        <div class="muted">Optional trial after demo.</div>

        <div class="chip-row" data-col="trial_status" data-select="single">
          <button type="button" class="chip">Not started</button>
          <button type="button" class="chip">Active</button>
          <button type="button" class="chip">Ended</button>
        </div>

        <div style="height:.8rem"></div>

        <h2>Subscription</h2>
        <div class="muted">Pick your plan (can change later).</div>

        <div class="chip-row" data-col="plan_status" data-select="single">
          <button type="button" class="chip">No plan chosen</button>
          <button type="button" class="chip">Starter</button>
          <button type="button" class="chip">Pro</button>
          <button type="button" class="chip">Elite</button>
        </div>

        <div class="chip-row" data-col="plan_term" data-select="single" style="margin-top:.5rem">
          <button type="button" class="chip">Monthly</button>
          <button type="button" class="chip">Yearly</button>
        </div>

        <div style="height:.9rem"></div>

        <h2>Quick actions</h2>
        <div class="muted">Takes you to the right pages.</div>

        <div class="chip-row" style="margin-top:.6rem">
          <button type="button" class="btn btn-secondary" id="btn-open-secure">Open secure dashboard</button>
        </div>
      </aside>
    </div>
  </main>

 
</body><script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  const SUPABASE_URL = "https://yaiutswdcbfwkxfqxkzy.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlhaXV0c3dkY2Jmd2t4ZnF4a3p5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1MDE2MDgsImV4cCI6MjA4MDA3NzYwOH0.HOLFxzjsZ5Ieqg0b-aTdP0hAdLsPVXL6Zjs-HgOHgc8";
  const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const qs = new URLSearchParams(location.search);

  // Support both new + legacy param names
  const customer_id =
    qs.get("customer_id") || qs.get("user_id") || qs.get("signup_id") || "";

  const setup_token =
    qs.get("setup_token") || qs.get("token") || "";

  // IMPORTANT: make sure you have somewhere to render errors
  const statusEl = document.getElementById("status") || null;

  function setStatus(msg, isError=false){
    if (!statusEl) return;
    statusEl.textContent = msg;
    statusEl.style.color = isError ? "#b3261e" : "";
  }

  function logSupabaseError(context, error){
    // This will show the REAL reason in Console
    console.error(`[TBP] ${context}`, {
      message: error?.message,
      details: error?.details,
      hint: error?.hint,
      code: error?.code,
      status: error?.status,
      raw: error
    });
  }

  async function loadCustomerAndWizard(){
    try {
      if (!customer_id) throw new Error("Missing customer_id in the URL.");
      if (!setup_token) throw new Error("Missing setup_token in the URL.");

      setStatus("Loading your settings…");

      // 1) Load customer
      const { data: customer, error: cErr } = await sb
        .from("customers")
        .select("id, email, business_name, contact_name, trade_type, base_postcode, wizard_completed, setup_complete, wizard_answers, setup_token")
        .eq("id", customer_id)
        .eq("setup_token", setup_token)
        .single();

      if (cErr) {
        logSupabaseError("loadCustomer query failed", cErr);
        throw new Error(cErr.message || "Could not load customer (customers query failed).");
      }
      if (!customer) throw new Error("No customer returned.");

      // 2) Wizard answers can be stored either:
      // A) as customers.wizard_answers (json/jsonb)
      // or B) in a separate wizard_answers table keyed by customer_id
      let wizard = customer.wizard_answers || null;

      if (!wizard) {
        const { data: wa, error: wErr } = await sb
          .from("wizard_answers")
          .select("answers")
          .eq("customer_id", customer_id)
          .single();

        if (wErr && wErr.code !== "PGRST116") { // PGRST116 = no rows
          logSupabaseError("load wizard_answers table failed", wErr);
          // don’t hard-fail; dashboard can still show basic customer info
        } else {
          wizard = wa?.answers || null;
        }
      }

      // ✅ At this point you have:
      // - customer (basic info)
      // - wizard (object or null)

      // Example: show something obvious so you know it loaded
      console.log("[TBP] Loaded customer:", customer);
      console.log("[TBP] Loaded wizard answers:", wizard);

      setStatus("");

      // TODO: wire into your UI:
      // document.getElementById("bizName").textContent = customer.business_name || "—";
      // document.getElementById("tradeType").textContent = customer.trade_type || "—";
      // etc.
      // For wizard values, use wizard?.fieldName

      return { customer, wizard };

    } catch (err) {
      console.error("[TBP] loadCustomer error:", err);
      setStatus(err.message || "Failed to load settings.", true);
      return null;
    }
  }

  // run
  loadCustomerAndWizard();
</script>

</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TradeBotPro ‚Äì Step 1 ¬∑ Business profile</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --primary-blue: #1f4e79;
      --accent-blue: #00a3ff;
      --dark-text: #1b1b1f;
      --light-bg: #f5f7fa;
      --white: #ffffff;
      --border-subtle: rgba(0,0,0,0.12);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      background: var(--light-bg);
      color: var(--dark-text);
      line-height: 1.6;
    }

    a { color: inherit; text-decoration: none; }

    .page {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: var(--white);
      border-bottom: 1px solid rgba(0,0,0,0.06);
    }

    .inner {
      max-width: 1100px;
      margin: 0 auto;
      padding: 0 1.25rem;
    }

    .nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      padding: 0.75rem 0;
      font-size: 0.9rem;
    }

    .logo-wrap {
      display: flex;
      align-items: center;
      gap: 0.6rem;
    }

    .logo-icon {
      width: 32px;
      height: 32px;
      border-radius: 9px;
      background: var(--primary-blue);
      position: relative;
    }

    .logo-icon::before,
    .logo-icon::after {
      content: "";
      position: absolute;
      background: var(--white);
      border-radius: 4px;
    }

    .logo-icon::before {
      width: 12px;
      height: 18px;
      left: 7px;
      top: 7px;
    }

    .logo-icon::after {
      width: 6px;
      height: 12px;
      right: 7px;
      top: 10px;
    }

    .logo-main {
      font-weight: 700;
      font-size: 1.05rem;
      color: var(--primary-blue);
    }

    .logo-tag {
      font-size: 0.7rem;
      opacity: 0.7;
    }

    .muted {
      font-size: 0.8rem;
      opacity: 0.75;
    }

    main {
      padding: 2rem 0 3rem;
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.1fr);
      gap: 2rem;
      align-items: flex-start;
    }

    /* INTRO SIDE */

    .intro-kicker {
      font-size: 0.8rem;
      font-weight: 600;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--accent-blue);
      margin-bottom: 0.25rem;
    }

    .intro h1 {
      margin: 0 0 0.4rem;
      font-size: 1.9rem;
      color: var(--primary-blue);
    }

    .intro p {
      margin: 0.2rem 0 0.8rem;
      font-size: 0.95rem;
    }

    .pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      margin-top: 0.6rem;
    }

    .pill {
      padding: 0.25rem 0.7rem;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.1);
      font-size: 0.75rem;
      background: var(--white);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.15rem 0.55rem;
      border-radius: 999px;
      font-size: 0.75rem;
      background: #e4eef8;
      color: var(--primary-blue);
      margin-top: 1rem;
    }

    .status-line {
      margin-top: 0.4rem;
      font-size: 0.82rem;
    }

    .status-ok { color: #137333; }
    .status-error { color: #b31412; }
    .status-neutral { color: #5f6368; }

    .info-block {
      margin-top: 1.4rem;
      padding: 0.9rem 1rem;
      border-radius: 0.8rem;
      border: 1px dashed rgba(0,0,0,0.12);
      background: var(--white);
      font-size: 0.85rem;
    }

    .info-block h3 {
      margin: 0 0 0.4rem;
      font-size: 0.9rem;
      color: var(--primary-blue);
    }

    /* FORM CARD */

    .card {
      background: var(--white);
      border-radius: 1rem;
      padding: 1.25rem 1.4rem;
      box-shadow: 0 10px 24px rgba(0,0,0,0.06);
      font-size: 0.9rem;
    }

    .card h2 {
      margin: 0 0 0.8rem;
      font-size: 1.25rem;
      color: var(--primary-blue);
    }

    .section-label {
      font-size: 0.78rem;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--accent-blue);
      margin-top: 1.1rem;
      margin-bottom: 0.35rem;
    }

    form {
      margin-top: 0.3rem;
    }

    .field-group {
      margin-bottom: 0.9rem;
    }

    .field-row {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.9rem;
    }

    .field-group label {
      display: block;
      font-size: 0.78rem;
      font-weight: 500;
      margin-bottom: 0.25rem;
    }

    .field-group input,
    .field-group select,
    .field-group textarea {
      width: 100%;
      padding: 0.55rem 0.65rem;
      border-radius: 0.45rem;
      border: 1px solid var(--border-subtle);
      font: inherit;
    }

    .field-group input:focus,
    .field-group select:focus,
    .field-group textarea:focus {
      outline: 2px solid rgba(31,78,121,0.4);
      border-color: transparent;
    }

    textarea {
      min-height: 80px;
      resize: vertical;
    }

    /* QUICK PICK CHIPS */

    .chips-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      margin-bottom: 0.5rem;
    }

    .chip {
      padding: 0.3rem 0.75rem;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.18);
      font-size: 0.78rem;
      background: #ffffff;
      cursor: pointer;
      user-select: none;
    }

    .chip.selected {
      background: #e4eef8;
      border-color: var(--primary-blue);
      color: var(--primary-blue);
      font-weight: 600;
    }

    .helper-text {
      font-size: 0.78rem;
      opacity: 0.8;
      margin-top: 0.1rem;
    }

    /* ACTIONS */

    .actions {
      margin-top: 1.1rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.7rem;
      align-items: center;
    }

    .btn-primary {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.7rem 1.4rem;
      border-radius: 999px;
      border: none;
      background: var(--primary-blue);
      color: var(--white);
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
    }

    .btn-primary:hover {
      background: #163857;
    }

    .btn-ghost {
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.12);
      background: var(--white);
      padding: 0.55rem 1.1rem;
      font-size: 0.85rem;
      cursor: pointer;
    }

    .small-note {
      font-size: 0.78rem;
      opacity: 0.8;
    }

    footer {
      margin-top: auto;
      border-top: 1px solid rgba(0,0,0,0.06);
      background: var(--white);
      font-size: 0.8rem;
    }

    .footer-inner {
      padding: 1rem 1.25rem 1.2rem;
      display: flex;
      justify-content: space-between;
      gap: 1rem;
      flex-wrap: wrap;
      align-items: center;
    }

    @media (max-width: 860px) {
      .layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    @media (max-width: 520px) {
      .field-row { grid-template-columns: minmax(0, 1fr); }
    }
  </style>
</head>
<body>
<div class="page">

  <header>
    <div class="inner">
      <div class="nav">
        <div class="logo-wrap">
          <div class="logo-icon" aria-hidden="true"></div>
          <div>
            <div class="logo-main">TradeBotPro</div>
            <div class="logo-tag">AI office assistant for trades.</div>
          </div>
        </div>
        <div class="muted">
          Step 1 ¬∑ Business profile
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="inner">
      <div class="layout">
        <!-- LEFT / INTRO -->
        <section class="intro">
          <div class="intro-kicker">Step 1 ¬∑ Business profile</div>
          <h1>Tell TradeBotPro how your business runs</h1>
          <p>
            This page lets you update the key details your AI office will use for quoting,
            call-outs and messages. You can change this any time.
          </p>
          <p class="muted">
            The link you clicked is unique to your signup. If you lose it, just ask us to resend your secure profile link.
          </p>

          <div class="pill-row">
            <div class="pill">Reply with the right prices &amp; areas</div>
            <div class="pill">Decide which jobs to prioritise</div>
            <div class="pill">Sound like a real member of your team</div>
          </div>

          <div>
            <div class="badge" id="link-status">
              <span>‚óè</span>
              <span>Loading your details‚Ä¶</span>
            </div>
            <div class="status-line status-neutral" id="status-line">
              Please wait while we load your profile.
            </div>
          </div>

          <div class="info-block">
            <h3>What this page controls</h3>
            <p>
              Your answers here tell TradeBotPro how to:
            </p>
            <ul style="margin:0.3rem 0 0.6rem 1.05rem;padding:0;">
              <li>Reply to customers with the right prices and areas.</li>
              <li>Decide which jobs to prioritise or turn away.</li>
              <li>Sound like a real member of your team.</li>
            </ul>
            <p class="small-note" style="margin:0.4rem 0 0;">
              If you‚Äôre not sure on any numbers yet, leave them blank or rough ‚Äì we can tidy them up with you later.
            </p>
          </div>

          <div style="margin-top:1.2rem;" class="small-note">
            <strong>Need help?</strong><br />
            If anything on this page doesn‚Äôt make sense or doesn‚Äôt save properly,
            just email <a href="mailto:hello@tradebotpro.co.uk">hello@tradebotpro.co.uk</a>
            with your business name and we‚Äôll sort it.<br /><br />
            Tip: keep this page open while you test WhatsApp or web chat so you can
            tweak wording and prices as you go.
          </div>
        </section>

        <!-- RIGHT / FORM -->
        <section class="card">
          <h2>Business &amp; contact details</h2>
          <p class="muted" style="margin-top:0;">
            Make changes and hit ‚ÄúSave my settings‚Äù. Your TradeBotPro profile updates instantly.
          </p>

          <form id="profile-form">
            <!-- Business & contact details -->
            <div class="field-group">
              <div class="field-row">
                <div class="field-group">
                  <label for="business_name">Business name</label>
                  <input id="business_name" name="business_name" type="text" autocomplete="organization">
                </div>
                <div class="field-group">
                  <label for="contact_name">Main contact name</label>
                  <input id="contact_name" name="contact_name" type="text" autocomplete="name">
                </div>
              </div>
            </div>

            <div class="field-row">
              <div class="field-group">
                <label for="email">Email</label>
                <input id="email" name="email" type="email" autocomplete="email">
              </div>
              <div class="field-group">
                <label for="whatsapp_number">Mobile / WhatsApp</label>
                <input id="whatsapp_number" name="whatsapp_number" type="tel" autocomplete="tel">
              </div>
            </div>

            <div class="field-row">
              <div class="field-group">
                <label for="phone">Optional landline</label>
                <input id="phone" name="phone" type="tel" autocomplete="tel">
              </div>
              <div class="field-group">
                <label for="trade_type">Trade</label>
                <select id="trade_type" name="trade_type">
                  <option value="">Select your trade‚Ä¶</option>
                  <option>Plumber</option>
                  <option>Heating Engineer</option>
                  <option>Gas Engineer</option>
                  <option>Electrician</option>
                  <option>Builder</option>
                  <option>Handyman</option>
                  <option>Landscaper / Gardener</option>
                  <option>Cleaner / Carpet Cleaner</option>
                  <option>Pest Control</option>
                  <option>Other</option>
                </select>
              </div>
            </div>

            <div class="field-row">
              <div class="field-group">
                <label for="base_postcode">Base postcode</label>
                <input id="base_postcode" name="base_postcode" type="text" placeholder="e.g. OX2 7AA">
              </div>
              <div class="field-group">
                <label for="website_url">Website (if you have one)</label>
                <input id="website_url" name="website_url" type="url" placeholder="https://">
              </div>
            </div>

            <div class="field-row">
              <div class="field-group">
                <label for="service_radius">Service radius (e.g. ‚Äú15 miles from OX2‚Äù)</label>
                <input id="service_radius" name="service_radius" type="text">
              </div>
              <div class="field-group">
                <label for="callout_from">Call-out from (usual starting town / depot)</label>
                <input id="callout_from" name="callout_from" type="text" placeholder="e.g. Oxford, Reading‚Ä¶">
              </div>
            </div>

            <!-- Pricing basics -->
            <div class="section-label">Pricing basics</div>

            <div class="field-row">
              <div class="field-group">
                <label for="callout_fee">Standard call-out fee (¬£)</label>
                <input id="callout_fee" name="callout_fee" type="number" min="0" step="1">
              </div>
              <div class="field-group">
                <label for="first_hour_rate">First hour rate (¬£)</label>
                <input id="first_hour_rate" name="first_hour_rate" type="number" min="0" step="1">
              </div>
            </div>

            <div class="field-row">
              <div class="field-group">
                <label for="hourly_rate">Hourly rate after first hour (¬£)</label>
                <input id="hourly_rate" name="hourly_rate" type="number" min="0" step="1">
              </div>
              <div class="field-group">
                <label for="boiler_service_from">Boiler service from (¬£)</label>
                <input id="boiler_service_from" name="boiler_service_from" type="number" min="0" step="1">
              </div>
            </div>

            <div class="field-group">
              <label for="quote_minimum">Minimum job value / quote (¬£)</label>
              <input id="quote_minimum" name="quote_minimum" type="number" min="0" step="1">
            </div>

            <div class="field-group">
              <label for="pricing_notes">Pricing notes (anything your AI should know about evenings, weekends, emergencies)</label>
              <textarea id="pricing_notes" name="pricing_notes"></textarea>
            </div>

            <!-- AI focus -->
            <div class="section-label">What should your AI office focus on?</div>

            <div class="field-group">
              <label>Quick picks (choose as many as you like)</label>
              <div class="chips-row" id="ai-focus-chips">
                <div class="chip" data-value="New enquiries & first response">New enquiries &amp; first response</div>
                <div class="chip" data-value="Quoting & rough estimates">Quoting &amp; rough estimates</div>
                <div class="chip" data-value="Booking jobs into the diary">Booking jobs into the diary</div>
                <div class="chip" data-value="Out-of-hours & weekend cover">Out-of-hours &amp; weekend cover</div>
                <div class="chip" data-value="Chasing reviews & follow-ups">Chasing reviews &amp; follow-ups</div>
                <div class="chip" data-value="Filtering time-wasters / bad jobs">Filtering time-wasters / bad jobs</div>
              </div>
            </div>

            <div class="field-group">
              <label for="ai_focus_notes">In your own words (a sentence or two is fine)</label>
              <textarea id="ai_focus_notes" name="ai_focus_notes"
                placeholder="e.g. ‚ÄúPrioritise emergency leaks and boiler breakdowns in OX postcodes. Keep quotes sensible so I don‚Äôt work for free.‚Äù"></textarea>
            </div>

            <!-- Tone of voice -->
            <div class="section-label">Tone of voice &amp; other notes</div>

            <div class="field-group">
              <label for="ai_style_notes">How should TradeBotPro sound? (tone of voice, things to avoid, etc.)</label>
              <textarea id="ai_style_notes" name="ai_style_notes"
                placeholder="Friendly but professional, no slang, don‚Äôt promise exact arrival times, always confirm if it‚Äôs an emergency."></textarea>
            </div>

            <div class="field-group">
              <label for="callout_notes">Any other important notes? (parking, access, pets, special jobs you do or don‚Äôt do)</label>
              <textarea id="callout_notes" name="callout_notes"></textarea>
            </div>

            <div class="actions">
              <button type="submit" class="btn-primary">Save my settings</button>
              <button type="button" class="btn-ghost" id="refresh-btn">Reload from server</button>
              <span class="small-note" id="last-saved"></span>
            </div>

            <div class="status-line status-neutral" id="form-status" style="margin-top:0.7rem;">
              Waiting to load profile‚Ä¶
            </div>
          </form>
        </section>
      </div>
    </div>
  </main>

  <footer>
    <div class="inner footer-inner">
      <div>&copy; <span id="year"></span> TradeBotPro.</div>
      <div class="muted">
        If anything looks wrong, just email <a href="mailto:hello@tradebotpro.co.uk">hello@tradebotpro.co.uk</a>.
      </div>
    </div>
  </footer>
</div>

<script>
  // üî¥üî¥üî¥ SUPABASE DETAILS (already filled in with your project) üî¥üî¥üî¥
  //
  // If you ever rotate keys:
  // 1) Supabase ‚Üí Project Settings ‚Üí API
  // 2) Copy "Project URL" into SUPABASE_URL
  // 3) Copy "anon public" key into SUPABASE_ANON_KEY

  const SUPABASE_URL = "https://yaiutswdcbfwkxfqxkzy.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlhaXV0c3dkY2Jmd2t4ZnF4a3p5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1MDE2MDgsImV4cCI6MjA4MDA3NzYwOH0.HOLFxzjsZ5Ieqg0b-aTdP0hAdLsPVXL6Zjs-HgOHgc8";

  // ------------------------------------------------------------------//
  // DOM HOOKS
  // ------------------------------------------------------------------//

  const yearSpan = document.getElementById('year');
  if (yearSpan) yearSpan.textContent = new Date().getFullYear();

  const linkStatusEl = document.getElementById('link-status');
  const statusLineEl = document.getElementById('status-line');
  const formStatusEl = document.getElementById('form-status');
  const lastSavedEl = document.getElementById('last-saved');
  const profileForm = document.getElementById('profile-form');
  const refreshBtn = document.getElementById('refresh-btn');
  const chipsContainer = document.getElementById('ai-focus-chips');

  // ------------------------------------------------------------------//
  // HELPERS
  // ------------------------------------------------------------------//

  function setLinkStatus(text, type = 'neutral') {
    if (!linkStatusEl) return;
    const dot = linkStatusEl.querySelector('span');
    const label = linkStatusEl.querySelectorAll('span')[1];
    if (label) label.textContent = text;

    if (type === 'ok') {
      linkStatusEl.style.background = '#e6f4ea';
      linkStatusEl.style.color = '#137333';
      if (dot) dot.textContent = '‚óè';
    } else if (type === 'error') {
      linkStatusEl.style.background = '#fce8e6';
      linkStatusEl.style.color = '#b31412';
      if (dot) dot.textContent = '‚óè';
    } else {
      linkStatusEl.style.background = '#e4eef8';
      linkStatusEl.style.color = '#1f4e79';
      if (dot) dot.textContent = '‚óè';
    }
  }

  function setFormStatus(msg, type = 'neutral') {
    if (!formStatusEl) return;
    formStatusEl.textContent = msg;
    formStatusEl.classList.remove('status-ok', 'status-error', 'status-neutral');
    if (type === 'ok') formStatusEl.classList.add('status-ok');
    else if (type === 'error') formStatusEl.classList.add('status-error');
    else formStatusEl.classList.add('status-neutral');
  }

  function getUserIdFromUrl() {
    const params = new URLSearchParams(window.location.search);
    return params.get('user_id') || '';
  }

  function getSupabaseHeaders() {
    return {
      'apikey': SUPABASE_ANON_KEY,
      'Authorization': 'Bearer ' + SUPABASE_ANON_KEY,
      'Content-Type': 'application/json',
      'Accept': 'application/json'
    };
  }

  async function supabaseFetch(path, options = {}) {
    const url = `${SUPABASE_URL}/rest/v1/${path}`;
    const headers = {
      ...getSupabaseHeaders(),
      ...(options.headers || {})
    };

    const res = await fetch(url, { ...options, headers });

    let data = null;
    try {
      data = await res.json();
    } catch (e) {
      // no JSON body
    }

    if (!res.ok) {
      console.error('Fetch failed:', res.status, data || res.statusText);
      const err = new Error(`Fetch failed: ${res.status} ${res.statusText}`);
      err.status = res.status;
      err.details = data;
      throw err;
    }

    return data;
  }

  // ------------------------------------------------------------------//
  // QUICK PICK CHIPS
  // ------------------------------------------------------------------//

  function initChips() {
    if (!chipsContainer) return;
    chipsContainer.addEventListener('click', (e) => {
      const chip = e.target.closest('.chip');
      if (!chip) return;
      chip.classList.toggle('selected');
    });
  }

  function getSelectedChips() {
    if (!chipsContainer) return [];
    return Array.from(chipsContainer.querySelectorAll('.chip.selected'))
      .map(el => el.getAttribute('data-value') || el.textContent.trim());
  }

  // ------------------------------------------------------------------//
  // LOAD + SAVE PROFILE
  // ------------------------------------------------------------------//

  let signupRow = null;
  let profileRow = null;
  let signupId = null; // from ?user_id=

  function fillFormFromProfile() {
    const p = profileRow || {};
    const s = signupRow || {};

    function setVal(id, value) {
      const el = document.getElementById(id);
      if (el) el.value = value ?? '';
    }

    setVal('business_name', p.business_name ?? s.business_name ?? '');
    setVal('contact_name', p.contact_name ?? s.contact_name ?? '');
    setVal('email', p.email ?? s.email ?? '');
    setVal('whatsapp_number', p.whatsapp_number ?? s.whatsapp_number ?? '');
    setVal('phone', p.phone ?? s.phone ?? '');
    setVal('trade_type', p.trade_type ?? s.trade_type ?? '');
    setVal('base_postcode', p.base_postcode ?? s.base_postcode ?? s.service_area ?? '');
    setVal('website_url', p.website_url ?? s.website_url ?? '');
    setVal('service_radius', p.service_radius ?? (s.service_radius ?? ''));
    setVal('callout_from', p.callout_from ?? s.callout_from ?? '');

    setVal('callout_fee', p.callout_fee ?? '');
    setVal('first_hour_rate', p.first_hour_rate ?? '');
    setVal('hourly_rate', p.hourly_rate ?? '');
    setVal('boiler_service_from', p.boiler_service_from ?? '');
    setVal('quote_minimum', p.quote_minimum ?? '');
    setVal('pricing_notes', p.pricing_notes ?? '');

    // For AI focus, we just drop the existing services_summary into the free-text box.
    setVal('ai_focus_notes', p.services_summary ?? s.services_summary ?? '');

    setVal('ai_style_notes', p.ai_style_notes ?? s.ai_style_notes ?? '');
    setVal('callout_notes', p.callout_notes ?? s.callout_notes ?? '');
  }

  async function loadProfile() {
    signupId = getUserIdFromUrl();

    if (!signupId) {
      setLinkStatus('This link is missing a user_id.', 'error');
      if (statusLineEl) statusLineEl.textContent = 'Ask TradeBotPro to resend your secure profile link.';
      setFormStatus('Cannot load profile without a valid link.', 'error');
      if (profileForm) profileForm.style.display = 'none';
      return;
    }

    setLinkStatus('Link looks valid. Loading your details‚Ä¶', 'neutral');
    setFormStatus('Loading from Supabase‚Ä¶', 'neutral');

    try {
      // 1) Get signup row (id = user_id from URL)
      const signups = await supabaseFetch(
        `tradebotpro_signups?id=eq.${encodeURIComponent(signupId)}&select=*`
      );

      if (!Array.isArray(signups) || !signups.length) {
        setLinkStatus('We could not find a signup for this link.', 'error');
        setFormStatus('No signup found. Please contact support.', 'error');
        return;
      }

      signupRow = signups[0];

      // 2) Get or create business_profile row for this signup_id
      const profiles = await supabaseFetch(
        `business_profiles?signup_id=eq.${encodeURIComponent(signupId)}&select=*`
      );

      if (Array.isArray(profiles) && profiles.length) {
        profileRow = profiles[0];
      } else {
        const payload = {
          signup_id: signupId,
          contact_name: signupRow.contact_name || '',
          business_name: signupRow.business_name || '',
          email: signupRow.email || '',
          whatsapp_number: signupRow.whatsapp_number || '',
          phone: signupRow.phone || '',
          trade_type: signupRow.trade_type || '',
          base_postcode: signupRow.base_postcode || signupRow.service_area || '',
          website_url: signupRow.website_url || '',
          callout_from: signupRow.callout_from || '',
          service_radius: signupRow.service_radius || null,
          callout_fee: signupRow.callout_fee || null,
          first_hour_rate: signupRow.first_hour_rate || null,
          hourly_rate: signupRow.hourly_rate || null,
          boiler_service_from: signupRow.boiler_service_from || null,
          quote_minimum: signupRow.quote_minimum || null,
          pricing_notes: signupRow.pricing_notes || '',
          services_summary: signupRow.services_summary || '',
          ai_style_notes: signupRow.ai_style_notes || '',
          callout_notes: signupRow.callout_notes || '',
          plan_status: signupRow.plan_status || 'Lead only',
          pending_setup: signupRow.pending_setup ?? true,
          is_active: signupRow.is_active ?? false,
          account_status: signupRow.account_status || '',
          account_status_reason: signupRow.account_status_reason || ''
        };

        const created = await supabaseFetch(
          'business_profiles',
          {
            method: 'POST',
            body: JSON.stringify(payload),
            headers: {
              Prefer: 'return=representation'
            }
          }
        );

        profileRow = Array.isArray(created) && created.length ? created[0] : null;
      }

      fillFormFromProfile();

      setLinkStatus('Profile loaded for your signup.', 'ok');
      setFormStatus('Profile loaded. Make changes and click ‚ÄúSave my settings‚Äù.', 'ok');
      if (statusLineEl) {
        statusLineEl.textContent = 'Your link is working. You can update your business profile below.';
        statusLineEl.classList.remove('status-neutral');
        statusLineEl.classList.add('status-ok');
      }

    } catch (err) {
      console.error('Fetch profile error:', err);
      setLinkStatus('Error loading your profile.', 'error');
      setFormStatus('Something went wrong loading from Supabase.', 'error');
    }
  }

  async function saveProfile(event) {
    event.preventDefault();
    if (!signupId) {
      setFormStatus('Missing signup id in the URL ‚Äì cannot save.', 'error');
      return;
    }

    setFormStatus('Saving to Supabase‚Ä¶', 'neutral');

    const chipValues = getSelectedChips();
    const focusFreeText = (document.getElementById('ai_focus_notes').value || '').trim();

    let servicesSummary = '';
    if (chipValues.length) {
      servicesSummary += 'Quick picks: ' + chipValues.join(', ');
    }
    if (focusFreeText) {
      servicesSummary += (servicesSummary ? '\n\n' : '') + focusFreeText;
    }

    const payload = {
      signup_id: signupId,
      business_name: document.getElementById('business_name').value.trim(),
      contact_name: document.getElementById('contact_name').value.trim(),
      email: document.getElementById('email').value.trim(),
      whatsapp_number: document.getElementById('whatsapp_number').value.trim(),
      phone: document.getElementById('phone').value.trim(),
      trade_type: document.getElementById('trade_type').value,
      base_postcode: document.getElementById('base_postcode').value.trim(),
      website_url: document.getElementById('website_url').value.trim(),
      service_radius: document.getElementById('service_radius').value.trim() || null,
      callout_from: document.getElementById('callout_from').value.trim(),

      callout_fee: document.getElementById('callout_fee').value || null,
      first_hour_rate: document.getElementById('first_hour_rate').value || null,
      hourly_rate: document.getElementById('hourly_rate').value || null,
      boiler_service_from: document.getElementById('boiler_service_from').value || null,
      quote_minimum: document.getElementById('quote_minimum').value || null,
      pricing_notes: document.getElementById('pricing_notes').value.trim(),

      services_summary: servicesSummary,
      ai_style_notes: document.getElementById('ai_style_notes').value.trim(),
      callout_notes: document.getElementById('callout_notes').value.trim()
      // plan_status / account_status / pending_setup / is_active left as-is on this page
    };

    try {
      await supabaseFetch(
        `business_profiles?signup_id=eq.${encodeURIComponent(signupId)}`,
        {
          method: 'PATCH',
          body: JSON.stringify(payload),
          headers: {
            Prefer: 'return=minimal'
          }
        }
      );

      setFormStatus('Saved. Your AI will use these details going forward.', 'ok');
      const now = new Date();
      if (lastSavedEl) {
        lastSavedEl.textContent = 'Last saved at ' +
          now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      }

    } catch (err) {
      console.error('Save profile error:', err);
      setFormStatus('Error saving profile to Supabase. Check console for details.', 'error');
    }
  }

  // ------------------------------------------------------------------//
  // INIT
  // ------------------------------------------------------------------//

  async function initialise() {
    if (!SUPABASE_URL || !SUPABASE_ANON_KEY ||
        SUPABASE_URL.includes('PASTE') || SUPABASE_ANON_KEY.includes('PASTE')) {
      setLinkStatus('Supabase keys not configured.', 'error');
      setFormStatus('Please paste SUPABASE_URL and SUPABASE_ANON_KEY at the top of this file.', 'error');
      return;
    }

    initChips();
    await loadProfile();
  }

  if (profileForm) {
    profileForm.addEventListener('submit', saveProfile);
  }
  if (refreshBtn) {
    refreshBtn.addEventListener('click', function () {
      setFormStatus('Reloading from server‚Ä¶', 'neutral');
      loadProfile();
    });
  }

  window.addEventListener('DOMContentLoaded', initialise);
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TradeBotPro ‚Äî Your AI Office Assistant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta
    name="description"
    content="TradeBotPro is your 24/7 AI office assistant for trades and home services. More jobs, less admin."
  />

  <style>
    :root {
      --primary-blue: #1f4e79;
      --accent-blue: #00a3ff;
      --dark-text: #1b1b1f;
      --light-bg: #f5f7fa;
      --white: #ffffff;
      --border-soft: #dde3ee;
      --muted-text: #6c7280;
      --success: #1c8c4c;
      --error: #c0392b;
    }

    * {
      box-sizing: border-box;
    }

    html {
      scroll-behavior: smooth;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      background: var(--light-bg);
      color: var(--dark-text);
      line-height: 1.6;
    }

    header {
      background: var(--white);
      border-bottom: 1px solid var(--border-soft);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .header-inner {
      max-width: 1100px;
      margin: 0 auto;
      padding: 0.75rem 1.25rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1.5rem;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .brand-logo {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      background: linear-gradient(135deg, var(--primary-blue), var(--accent-blue));
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      color: white;
      letter-spacing: 0.03em;
      font-size: 0.9rem;
    }

    .brand-text {
      display: flex;
      flex-direction: column;
    }

    .brand-text span:first-child {
      font-weight: 700;
      font-size: 1.05rem;
    }

    .brand-text span:last-child {
      font-size: 0.8rem;
      color: var(--muted-text);
    }

    .header-meta {
      font-size: 0.85rem;
      color: var(--muted-text);
      text-align: right;
    }

    main {
      max-width: 1100px;
      margin: 1.5rem auto 2rem auto;
      padding: 0 1.25rem;
    }

    .page-layout {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.2fr);
      gap: 1.75rem;
      align-items: flex-start;
    }

    @media (max-width: 900px) {
      .page-layout {
        grid-template-columns: minmax(0, 1fr);
      }
      .header-inner {
        flex-direction: column;
        align-items: flex-start;
      }
      .header-meta {
        text-align: left;
      }
    }

    .intro-card {
      background: var(--white);
      border-radius: 18px;
      padding: 1.5rem 1.75rem;
      border: 1px solid var(--border-soft);
      box-shadow: 0 12px 30px rgba(15, 35, 75, 0.07);
    }

    .intro-chip {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.1rem 0.6rem;
      border-radius: 999px;
      background: rgba(31, 78, 121, 0.06);
      color: var(--primary-blue);
      font-size: 0.78rem;
      font-weight: 600;
      margin-bottom: 0.6rem;
    }

    .intro-chip span {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 16px;
      height: 16px;
      border-radius: 999px;
      background: var(--primary-blue);
      color: white;
      font-size: 0.7rem;
      font-weight: 700;
    }

    .intro-title {
      font-size: 1.6rem;
      margin: 0.2rem 0 0.5rem 0;
    }

    .intro-subtitle {
      font-size: 0.95rem;
      color: var(--muted-text);
      margin-bottom: 1rem;
    }

    .pill-list {
      list-style: none;
      padding: 0;
      margin: 0 0 1.25rem 0;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .pill-list li {
      font-size: 0.8rem;
      padding: 0.35rem 0.7rem;
      border-radius: 999px;
      background: #ecf3ff;
      color: #14345d;
      border: 1px solid rgba(31, 78, 121, 0.18);
      white-space: nowrap;
    }

    .steps {
      margin-top: 1rem;
      display: grid;
      gap: 0.75rem;
    }

    .step {
      display: flex;
      gap: 0.75rem;
      align-items: flex-start;
    }

    .step-badge {
      min-width: 26px;
      height: 26px;
      border-radius: 999px;
      background: rgba(31, 78, 121, 0.09);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.82rem;
      font-weight: 600;
      color: var(--primary-blue);
    }

    .step-body {
      font-size: 0.86rem;
    }

    .step-body strong {
      display: block;
      margin-bottom: 0.1rem;
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.2rem 0.5rem;
      border-radius: 999px;
      background: #eefaf3;
      color: var(--success);
      font-size: 0.78rem;
      font-weight: 600;
      margin-top: 0.75rem;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--success);
    }

    /* FORM CARD */

    .form-card {
      background: var(--white);
      border-radius: 18px;
      padding: 1.5rem 1.75rem 1.75rem;
      border: 1px solid var(--border-soft);
      box-shadow: 0 12px 30px rgba(15, 35, 75, 0.07);
    }

    .form-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }

    .form-header h2 {
      margin: 0;
      font-size: 1.3rem;
    }

    .form-header p {
      margin: 0;
      font-size: 0.85rem;
      color: var(--muted-text);
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.85rem 1rem;
    }

    @media (max-width: 720px) {
      .form-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    label {
      display: block;
      font-size: 0.78rem;
      font-weight: 600;
      margin-bottom: 0.25rem;
      color: #34394a;
    }

    label span.sub {
      font-weight: 400;
      font-size: 0.7rem;
      color: var(--muted-text);
      display: block;
      margin-top: 0.05rem;
    }

    input[type="text"],
    input[type="email"],
    input[type="tel"],
    input[type="number"],
    select,
    textarea {
      width: 100%;
      font-size: 0.86rem;
      padding: 0.5rem 0.55rem;
      border-radius: 8px;
      border: 1px solid #ccd3e3;
      background: #f9fafc;
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    }

    input:focus,
    select:focus,
    textarea:focus {
      border-color: var(--accent-blue);
      box-shadow: 0 0 0 1px rgba(0, 163, 255, 0.18);
      background: #ffffff;
    }

    textarea {
      resize: vertical;
      min-height: 60px;
      max-height: 180px;
    }

    .field-row {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .field-row span.inline-label {
      font-size: 0.8rem;
      color: var(--muted-text);
      white-space: nowrap;
    }

    .full-width {
      grid-column: 1 / -1;
    }

    .switch-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
      margin-top: 0.25rem;
    }

    .switch-row small {
      font-size: 0.75rem;
      color: var(--muted-text);
    }

    .checkbox-inline {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      font-size: 0.8rem;
    }

    .form-footer {
      margin-top: 1.1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .save-button {
      border: none;
      border-radius: 999px;
      padding: 0.55rem 1.2rem;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      background: linear-gradient(135deg, var(--primary-blue), var(--accent-blue));
      color: white;
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      box-shadow: 0 8px 18px rgba(15, 35, 75, 0.25);
    }

    .save-button span.icon {
      font-size: 1rem;
    }

    .helper-text {
      font-size: 0.78rem;
      color: var(--muted-text);
    }

    .status-banner {
      margin-top: 0.6rem;
      font-size: 0.8rem;
      padding: 0.45rem 0.7rem;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
    }

    .status-banner.success {
      background: #e7f7ef;
      color: var(--success);
      border: 1px solid rgba(28, 140, 76, 0.5);
    }

    .status-banner.error {
      background: #fdecea;
      color: var(--error);
      border: 1px solid rgba(192, 57, 43, 0.6);
    }

    .status-dot-inline {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: currentColor;
    }

    .small-muted {
      font-size: 0.75rem;
      color: var(--muted-text);
    }

    .badge-chip {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      font-size: 0.72rem;
      padding: 0.18rem 0.55rem;
      border-radius: 999px;
      background: rgba(31, 78, 121, 0.04);
      color: var(--primary-blue);
      border: 1px dashed rgba(31, 78, 121, 0.35);
    }
  </style>
</head>
<body>
  <header>
    <div class="header-inner">
      <div class="brand">
        <div class="brand-logo">TB</div>
        <div class="brand-text">
          <span>TradeBotPro</span>
          <span>AI office assistant for trades</span>
        </div>
      </div>
      <div class="header-meta">
        <div id="user-meta-line">Setting up your account‚Ä¶</div>
        <div class="small-muted">
          This page keeps your <strong>profile</strong> in sync between
          <span class="badge-chip">business_profiles</span> and
          <span class="badge-chip">tradebotpro_signups</span>.
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="page-layout">
      <!-- LEFT: Intro / ‚ÄúHomepage‚Äù content -->
      <section class="intro-card">
        <div class="intro-chip">
          <span>‚ö°</span> Step 1 ‚Äî Tell us about your business
        </div>
        <h1 class="intro-title">More jobs. Less admin. Powered by AI.</h1>
        <p class="intro-subtitle">
          TradeBotPro acts like a 24/7 office assistant: answering messages, qualifying leads,
          booking appointments and chasing payments ‚Äî while you‚Äôre on the tools.
        </p>

        <ul class="pill-list">
          <li>WhatsApp assistant</li>
          <li>Automatic quotes &amp; follow-ups</li>
          <li>Job pipeline &amp; reminders</li>
          <li>Invoices &amp; payment chasing</li>
        </ul>

        <div class="steps">
          <div class="step">
            <div class="step-badge">1</div>
            <div class="step-body">
              <strong>Tell us about your business</strong>
              <span>These details train your AI assistant to sound like you and quote correctly.</span>
            </div>
          </div>
          <div class="step">
            <div class="step-badge">2</div>
            <div class="step-body">
              <strong>Connect WhatsApp &amp; your area</strong>
              <span>We‚Äôll set up your TradeBotPro number and service radius around your base postcode.</span>
            </div>
          </div>
          <div class="step">
            <div class="step-badge">3</div>
            <div class="step-body">
              <strong>Go live</strong>
              <span>Leads drop straight into your AI assistant ‚Äî you get more jobs with less admin.</span>
            </div>
          </div>
        </div>

        <div class="status-pill" id="profile-status-pill">
          <span class="status-dot"></span>
          Profile not loaded yet
        </div>
      </section>

      <!-- RIGHT: Profile form -->
      <section class="form-card">
        <div class="form-header">
          <div>
            <h2>Tell us about your business</h2>
            <p>
              We‚Äôll use this to keep your <strong>business_profiles</strong> and
              <strong>tradebotpro_signups</strong> rows in sync for this account.
            </p>
          </div>
          <div class="small-muted" id="plan-status-label"></div>
        </div>

        <form id="profile-form" autocomplete="on">
          <div class="form-grid">
            <!-- Business name -->
            <div class="full-width">
              <label for="business_name">
                Business name
                <span class="sub">How should customers see your name?</span>
              </label>
              <input type="text" id="business_name" name="business_name" placeholder="e.g. A Gifford Heating & Plumbing" />
            </div>

            <!-- Contact name -->
            <div>
              <label for="contact_name">
                Your name
                <span class="sub">Used in messages &amp; quotes.</span>
              </label>
              <input type="text" id="contact_name" name="contact_name" placeholder="e.g. Andy" />
            </div>

            <!-- Trade type -->
            <div>
              <label for="trade_type">
                Trade
                <span class="sub">What work do you mainly do?</span>
              </label>
              <select id="trade_type" name="trade_type">
                <option value="">Select trade‚Ä¶</option>
                <option value="Plumbing & Heating">Plumbing &amp; Heating</option>
                <option value="Gas & Boilers">Gas &amp; Boilers</option>
                <option value="Electrical">Electrical</option>
                <option value="Roofing">Roofing</option>
                <option value="Landscaping">Landscaping</option>
                <option value="General Building">General Building</option>
                <option value="Other">Other</option>
              </select>
            </div>

            <!-- Email -->
            <div>
              <label for="email">
                Email
                <span class="sub">For quotes and notifications.</span>
              </label>
              <input type="email" id="email" name="email" placeholder="you@yourbusiness.co.uk" />
            </div>

            <!-- Phone -->
            <div>
              <label for="phone">
                Main phone number
                <span class="sub">Shown on quotes &amp; invoices.</span>
              </label>
              <input type="tel" id="phone" name="phone" placeholder="07..." />
            </div>

            <!-- WhatsApp -->
            <div>
              <label for="whatsapp_number">
                WhatsApp number
                <span class="sub">Where your assistant will chat to customers.</span>
              </label>
              <input type="tel" id="whatsapp_number" name="whatsapp_number" placeholder="07..." />
            </div>

            <!-- Base postcode -->
            <div>
              <label for="base_postcode">
                Base postcode
                <span class="sub">We‚Äôll build your service radius from here.</span>
              </label>
              <input type="text" id="base_postcode" name="base_postcode" placeholder="e.g. HP14 3QF" />
            </div>

            <!-- Service radius -->
            <div>
              <label for="service_radius">
                Service radius (miles)
                <span class="sub">Rough radius you‚Äôre happy to travel.</span>
              </label>
              <input type="number" id="service_radius" name="service_radius" min="1" max="60" step="1" placeholder="e.g. 15" />
            </div>

            <!-- Callout fee -->
            <div>
              <label for="callout_fee">
                Call-out fee (¬£)
                <span class="sub">What you normally charge to attend.</span>
              </label>
              <input type="number" id="callout_fee" name="callout_fee" min="0" step="1" placeholder="e.g. 75" />
            </div>

            <!-- First hour rate -->
            <div>
              <label for="first_hour_rate">
                First hour rate (¬£)
                <span class="sub">Typical first hour on site.</span>
              </label>
              <input type="number" id="first_hour_rate" name="first_hour_rate" min="0" step="1" placeholder="e.g. 95" />
            </div>

            <!-- Hourly rate -->
            <div>
              <label for="hourly_rate">
                Hourly rate after first hour (¬£)
              </label>
              <input type="number" id="hourly_rate" name="hourly_rate" min="0" step="1" placeholder="e.g. 65" />
            </div>

            <!-- Website -->
            <div>
              <label for="website_url">
                Website (optional)
              </label>
              <input type="text" id="website_url" name="website_url" placeholder="https://yourbusiness.co.uk" />
            </div>

            <!-- Services summary -->
            <div class="full-width">
              <label for="services_summary">
                What services do you offer?
                <span class="sub">Short bullet-point style description. We‚Äôll feed this into the assistant.</span>
              </label>
              <textarea id="services_summary" name="services_summary" placeholder="e.g. Boiler installs &amp; swaps, breakdowns, landlord gas safety, full heating systems, bathrooms‚Ä¶"></textarea>
            </div>

            <!-- Pricing notes -->
            <div class="full-width">
              <label for="pricing_notes">
                Pricing notes
                <span class="sub">Anything your assistant should know about minimum charges, weekend work, parking, congestion, etc.</span>
              </label>
              <textarea id="pricing_notes" name="pricing_notes" placeholder="e.g. No weekend callouts unless emergency. Parking &amp; congestion charged at cost. Minimum charge 1 hour."></textarea>
            </div>

            <!-- AI style notes -->
            <div class="full-width">
              <label for="ai_style_notes">
                How should your AI assistant sound?
                <span class="sub">Tone of voice, phrases to use/avoid, anything that makes it sound like you.</span>
              </label>
              <textarea id="ai_style_notes" name="ai_style_notes" placeholder="e.g. Friendly, no hard-selling, always offer to send a quote by WhatsApp, avoid emojis, sign off as 'Andy at A Gifford Heating &amp; Plumbing'."></textarea>
            </div>

            <!-- Plan / account flags (hidden-ish but still editable if you want) -->
            <div class="full-width">
              <div class="switch-row">
                <div>
                  <label for="is_active">
                    Account status
                    <span class="sub">You can leave this as-is; we‚Äôll adjust during onboarding.</span>
                  </label>
                  <small>
                    <strong>plan_status</strong> and <strong>account_status</strong> are stored in both tables so everything stays joined up.
                  </small>
                </div>
                <div style="text-align:right">
                  <div class="checkbox-inline">
                    <input type="checkbox" id="is_active" name="is_active" />
                    <span>Active</span>
                  </div>
                  <div style="margin-top:0.15rem;">
                    <input type="text" id="plan_status" name="plan_status" placeholder="e.g. Trial, Onboarding, Live" style="width: 160px; font-size: 0.75rem; padding: 0.3rem 0.4rem;" />
                  </div>
                </div>
              </div>
            </div>

            <div class="full-width">
              <label for="account_status_reason">
                Internal notes (not shown to customers)
                <span class="sub">Why this account is paused / special instructions etc.</span>
              </label>
              <textarea id="account_status_reason" name="account_status_reason" placeholder="Internal notes only."></textarea>
            </div>
          </div>

          <div class="form-footer">
            <button type="submit" class="save-button">
              <span class="icon">üíæ</span>
              <span>Save details</span>
            </button>
            <div>
              <div class="helper-text">
                We‚Äôll update both <strong>business_profiles</strong> and <strong>tradebotpro_signups</strong> for this user.
              </div>
              <div id="save-status" class="status-banner" style="display:none;"></div>
            </div>
          </div>
        </form>
      </section>
    </div>
  </main>

  <!-- Supabase + app logic -->
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // üîë TODO: drop in your own Supabase details here (use the *anon* key, not the service key)
    const SUPABASE_URL = "https://yaiutswdcbfwkxfqxkzy.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlhaXV0c3dkY2Jmd2t4ZnF4a3p5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1MDE2MDgsImV4cCI6MjA4MDA3NzYwOH0.HOLFxzjsZ5Ieqg0b-aTdP0hAdLsPVXL6Zjs-HgOHgc8";

    if (!supabaseUrl || supabaseUrl.includes("YOUR-PROJECT")) {
      console.error("Please set supabaseUrl and supabaseAnonKey at the bottom of app.html");
    }

    const supabase = createClient(supabaseUrl, supabaseAnonKey);

    const userMetaLine = document.getElementById("user-meta-line");
    const profileStatus = document.getElementById("profile-status-pill");
    const planStatusLabel = document.getElementById("plan-status-label");
    const saveStatus = document.getElementById("save-status");
    const form = document.getElementById("profile-form");

    function getUserIdFromUrl() {
      const params = new URLSearchParams(window.location.search);
      return (
        params.get("user_id") ||
        params.get("userId") ||
        params.get("uid") ||
        params.get("id")
      );
    }

    function setStatusBanner(type, message) {
      if (!saveStatus) return;
      saveStatus.style.display = "inline-flex";
      saveStatus.classList.remove("success", "error");

      if (type === "success") {
        saveStatus.classList.add("success");
      } else if (type === "error") {
        saveStatus.classList.add("error");
      }
      saveStatus.innerHTML = `
        <span class="status-dot-inline"></span>
        <span>${message}</span>
      `;
    }

    function hydrateFormFromRow(row) {
      if (!row) return;

      const safe = (v) => (v === null || v === undefined ? "" : v);

      document.getElementById("business_name").value = safe(row.business_name);
      document.getElementById("contact_name").value = safe(row.contact_name);
      document.getElementById("trade_type").value = safe(row.trade_type);
      document.getElementById("email").value = safe(row.email);
      document.getElementById("phone").value = safe(row.phone);
      document.getElementById("whatsapp_number").value = safe(row.whatsapp_number);
      document.getElementById("base_postcode").value = safe(row.base_postcode);
      document.getElementById("service_radius").value = safe(row.service_radius);
      document.getElementById("callout_fee").value = safe(row.callout_fee);
      document.getElementById("first_hour_rate").value = safe(row.first_hour_rate);
      document.getElementById("hourly_rate").value = safe(row.hourly_rate);
      document.getElementById("website_url").value = safe(row.website_url);
      document.getElementById("services_summary").value = safe(row.services_summary);
      document.getElementById("pricing_notes").value = safe(row.pricing_notes);
      document.getElementById("ai_style_notes").value = safe(row.ai_style_notes);
      document.getElementById("account_status_reason").value = safe(row.account_status_reason);

      const isActive = row.is_active === true || row.is_active === "true";
      document.getElementById("is_active").checked = isActive;

      document.getElementById("plan_status").value = safe(row.plan_status);

      if (planStatusLabel) {
        const plan = safe(row.plan_status) || "Not set";
        const acc = safe(row.account_status) || (isActive ? "Active" : "Pending");
        planStatusLabel.textContent = `Plan: ${plan} ¬∑ Account: ${acc}`;
      }
    }

    function collectFormValues(userId) {
      const nowIso = new Date().toISOString();
      const isActive = document.getElementById("is_active").checked;

      return {
        user_id: userId,
        business_name: document.getElementById("business_name").value.trim() || null,
        contact_name: document.getElementById("contact_name").value.trim() || null,
        trade_type: document.getElementById("trade_type").value || null,
        email: document.getElementById("email").value.trim() || null,
        phone: document.getElementById("phone").value.trim() || null,
        whatsapp_number: document.getElementById("whatsapp_number").value.trim() || null,
        base_postcode: document.getElementById("base_postcode").value.trim() || null,
        service_radius: document.getElementById("service_radius").value || null,
        callout_fee: document.getElementById("callout_fee").value || null,
        first_hour_rate: document.getElementById("first_hour_rate").value || null,
        hourly_rate: document.getElementById("hourly_rate").value || null,
        website_url: document.getElementById("website_url").value.trim() || null,
        services_summary: document.getElementById("services_summary").value.trim() || null,
        pricing_notes: document.getElementById("pricing_notes").value.trim() || null,
        ai_style_notes: document.getElementById("ai_style_notes").value.trim() || null,

        // sync-friendly flags
        is_active: isActive,
        plan_status: document.getElementById("plan_status").value.trim() || null,
        account_status: isActive ? "Active" : "Pending",
        account_status_reason: document.getElementById("account_status_reason").value.trim() || null,

        // keep these in both tables
        updated_at: nowIso
      };
    }

    async function safeSelectFirst(table, userId) {
      const { data, error } = await supabase
        .from(table)
        .select("*")
        .eq("user_id", userId);

      if (error) {
        console.error(`Error loading ${table}:`, error);
        throw error;
      }

      if (Array.isArray(data) && data.length > 0) {
        return data[0];
      }
      return null;
    }

    async function upsertViaUpdateOrInsert(table, userId, payload) {
      // 1) Check if row exists
      const { data: existing, error: selectError } = await supabase
        .from(table)
        .select("user_id")
        .eq("user_id", userId);

      if (selectError) {
        console.error(`Select error on ${table}:`, selectError);
        throw selectError;
      }

      if (existing && existing.length > 0) {
        const { error: updateError } = await supabase
          .from(table)
          .update(payload)
          .eq("user_id", userId);

        if (updateError) {
          console.error(`Update error on ${table}:`, updateError);
          throw updateError;
        }
      } else {
        const { error: insertError } = await supabase
          .from(table)
          .insert(payload);

        if (insertError) {
          console.error(`Insert error on ${table}:`, insertError);
          throw insertError;
        }
      }
    }

    async function loadProfileForUser(userId) {
      try {
        // Try business_profiles first ‚Äì this is our ‚Äúsource of truth‚Äù for the form
        let mainRow = null;
        try {
          mainRow = await safeSelectFirst("business_profiles", userId);
        } catch (err) {
          // If table misbehaves, still try signups so the page doesn't totally die
          console.warn("business_profiles load failed; trying tradebotpro_signups as fallback", err);
        }

        if (!mainRow) {
          try {
            const fallback = await safeSelectFirst("tradebotpro_signups", userId);
            if (fallback) {
              mainRow = fallback;
            }
          } catch (err) {
            console.warn("tradebotpro_signups load failed as well", err);
          }
        }

        if (!mainRow) {
          profileStatus.innerHTML = '<span class="status-dot"></span> New profile ‚Äî nothing saved yet';
          userMetaLine.textContent = `User ID: ${userId} ¬∑ New TradeBotPro signup`;
          return;
        }

        hydrateFormFromRow(mainRow);
        profileStatus.innerHTML = '<span class="status-dot"></span> Profile loaded from Supabase';
        userMetaLine.textContent = `User ID: ${userId} ¬∑ Profile synced`;
      } catch (err) {
        profileStatus.innerHTML = '<span class="status-dot"></span> Error loading profile';
        console.error("Error loading profile:", err);
      }
    }

    document.addEventListener("DOMContentLoaded", async () => {
      const userId = getUserIdFromUrl();

      if (!userId) {
        userMetaLine.textContent = "Missing user_id in URL (e.g. app.html?user_id=YOUR_UUID_HERE)";
        profileStatus.innerHTML = '<span class="status-dot"></span> No user_id in URL';
        setStatusBanner("error", "No user_id found in URL ‚Äî we can‚Äôt load or save your profile.");
        return;
      }

      userMetaLine.textContent = `User ID: ${userId} ¬∑ Loading profile‚Ä¶`;

      await loadProfileForUser(userId);

      form.addEventListener("submit", async (event) => {
        event.preventDefault();

        const payload = collectFormValues(userId);

        setStatusBanner("success", "Saving‚Ä¶");
        try {
          // Keep both tables in sync, one after the other
          await upsertViaUpdateOrInsert("business_profiles", userId, payload);
          await upsertViaUpdateOrInsert("tradebotpro_signups", userId, payload);

          setStatusBanner("success", "Saved to business_profiles and tradebotpro_signups.");
          await loadProfileForUser(userId); // refresh view from DB
        } catch (err) {
          console.error("Save error:", err);
          setStatusBanner("error", "There was a problem saving your details. Check the console for more info.");
        }
      });
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TradeBotPro — Setup Wizard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta
    name="description"
    content="TradeBotPro business profile setup wizard."
  />

  <style>
    :root {
      --primary-blue: #1f4e79;
      --accent-blue: #00a3ff;
      --dark-text: #1b1b1f;
      --light-bg: #f5f7fa;
      --white: #ffffff;
      --error-red: #b3261e;
      --success-green: #0f7b46;
      --muted: #8a8a96;
      --border-soft: rgba(0, 0, 0, 0.08);
    }

    * {
      box-sizing: border-box;
    }

    html {
      scroll-behavior: smooth;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      background: var(--light-bg);
      color: var(--dark-text);
      line-height: 1.6;
    }

    a {
      color: inherit;
      text-decoration: none;
    }

    .page {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .inner {
      max-width: 1080px;
      margin: 0 auto;
      padding: 0 1.25rem;
    }

    /* HEADER */
    header {
      background: var(--white);
      border-bottom: 1px solid rgba(0,0,0,0.06);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      padding: 0.75rem 0;
      font-size: 0.9rem;
    }

    .logo-wrap {
      display: flex;
      align-items: center;
      gap: 0.6rem;
    }

    .logo-icon {
      width: 32px;
      height: 32px;
      border-radius: 9px;
      background: var(--primary-blue);
      position: relative;
    }

    .logo-icon::before,
    .logo-icon::after {
      content: "";
      position: absolute;
      background: var(--white);
      border-radius: 4px;
    }

    .logo-icon::before {
      width: 12px;
      height: 18px;
      left: 7px;
      top: 7px;
    }

    .logo-icon::after {
      width: 6px;
      height: 12px;
      right: 7px;
      top: 10px;
    }

    .logo-main {
      font-weight: 700;
      font-size: 1.05rem;
      color: var(--primary-blue);
    }

    .logo-tag {
      font-size: 0.7rem;
      opacity: 0.7;
    }

    .header-right {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 0.15rem;
      font-size: 0.8rem;
    }

    .user-id-pill {
      padding: 0.15rem 0.5rem;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.08);
      background: #f5f7fb;
      max-width: 260px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* MAIN LAYOUT */
    main {
      flex: 1;
      padding: 1.8rem 0 2.4rem;
    }

    .wizard-layout {
      display: grid;
      grid-template-columns: minmax(0, 2.1fr) minmax(0, 1.3fr);
      gap: 1.6rem;
      align-items: flex-start;
    }

    @media (max-width: 860px) {
      .wizard-layout {
        grid-template-columns: minmax(0, 1fr);
      }
      .header-right {
        align-items: flex-start;
      }
    }

    /* STEP HEADER + PROGRESS */
    .wizard-header {
      margin-bottom: 1.2rem;
    }

    .wizard-title {
      font-size: 1.4rem;
      font-weight: 650;
      margin: 0 0 0.3rem;
      color: var(--primary-blue);
    }

    .wizard-subtitle {
      margin: 0;
      font-size: 0.9rem;
      color: var(--muted);
    }

    .step-pills {
      display: flex;
      flex-wrap: wrap;
      gap: 0.45rem;
      margin-top: 0.9rem;
    }

    .step-pill {
      padding: 0.25rem 0.7rem;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.08);
      background: #f6f7fb;
      font-size: 0.78rem;
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
    }

    .step-pill span.step-number {
      display: inline-flex;
      width: 18px;
      height: 18px;
      border-radius: 999px;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      background: rgba(0,0,0,0.05);
    }

    .step-pill.active {
      border-color: var(--primary-blue);
      background: #e4eef8;
      color: var(--primary-blue);
    }

    .step-pill.completed {
      border-color: var(--success-green);
      background: #e4f6ee;
      color: var(--success-green);
    }

    .progress-bar-wrap {
      margin-top: 0.9rem;
      width: 100%;
      background: #e0e4ee;
      border-radius: 999px;
      overflow: hidden;
      height: 6px;
    }

    .progress-bar-fill {
      height: 100%;
      width: 0%;
      border-radius: 999px;
      background: linear-gradient(90deg, var(--primary-blue), var(--accent-blue));
      transition: width 0.25s ease;
    }

    /* FORM CARD */
    .card {
      background: var(--white);
      border-radius: 1rem;
      padding: 1.3rem 1.4rem;
      box-shadow: 0 12px 26px rgba(0, 0, 0, 0.05);
    }

    .card h2 {
      margin: 0 0 0.5rem;
      font-size: 1.1rem;
      color: var(--primary-blue);
    }

    .card p.lead {
      margin: 0 0 1.1rem;
      font-size: 0.9rem;
      color: var(--muted);
    }

    .step {
      display: none;
    }

    .step.active {
      display: block;
    }

    .field-row {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.9rem;
    }

    @media (max-width: 640px) {
      .field-row {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .field {
      margin-bottom: 0.85rem;
    }

    .field label {
      display: block;
      font-size: 0.8rem;
      margin-bottom: 0.25rem;
      font-weight: 500;
    }

    .field small {
      display: block;
      font-size: 0.7rem;
      color: var(--muted);
      margin-top: 0.1rem;
    }

    .field input,
    .field select,
    .field textarea {
      width: 100%;
      padding: 0.55rem 0.65rem;
      border-radius: 0.5rem;
      border: 1px solid rgba(0,0,0,0.16);
      font: inherit;
      resize: vertical;
      min-height: 2.4rem;
    }

    .field textarea {
      min-height: 4.2rem;
    }

    .field input:focus,
    .field select:focus,
    .field textarea:focus {
      outline: 2px solid rgba(31, 78, 121, 0.4);
      border-color: transparent;
    }

    .field.error input,
    .field.error select,
    .field.error textarea {
      border-color: var(--error-red);
    }

    .field-error-text {
      font-size: 0.72rem;
      color: var(--error-red);
      margin-top: 0.2rem;
    }

    .toggle-row {
      display: flex;
      gap: 0.7rem;
      align-items: center;
      margin-top: 0.5rem;
    }

    .toggle-row input[type="checkbox"] {
      width: auto;
    }

    /* SUMMARY */
    .summary-list {
      list-style: none;
      margin: 0.4rem 0 0;
      padding: 0;
      font-size: 0.87rem;
    }

    .summary-list li {
      padding: 0.18rem 0;
      border-bottom: 1px dashed rgba(0,0,0,0.06);
    }

    .summary-label {
      font-weight: 500;
      margin-right: 0.25rem;
    }

    /* BUTTONS */
    .wizard-buttons {
      margin-top: 1.1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .button-group {
      display: flex;
      gap: 0.6rem;
      flex-wrap: wrap;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.25rem;
      padding: 0.6rem 1.1rem;
      border-radius: 999px;
      border: none;
      font-size: 0.9rem;
      cursor: pointer;
    }

    .btn-primary {
      background: var(--primary-blue);
      color: var(--white);
      font-weight: 600;
    }

    .btn-primary:hover {
      background: #163857;
    }

    .btn-outline {
      background: var(--white);
      border: 1px solid rgba(0,0,0,0.16);
      color: var(--primary-blue);
    }

    .btn-outline:hover {
      background: #f4f6fb;
    }

    .btn-ghost {
      background: transparent;
      border: none;
      color: var(--muted);
      padding-left: 0;
    }

    .btn[disabled] {
      opacity: 0.6;
      cursor: default;
    }

    /* STATUS / SIDE PANEL */
    .status-panel {
      position: sticky;
      top: 5rem;
      display: flex;
      flex-direction: column;
      gap: 0.85rem;
    }

    .status-card {
      background: var(--white);
      border-radius: 0.9rem;
      padding: 1rem 1.1rem;
      box-shadow: 0 10px 24px rgba(0,0,0,0.04);
      font-size: 0.86rem;
    }

    .status-title {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--primary-blue);
      margin-bottom: 0.35rem;
    }

    .status-text {
      font-size: 0.8rem;
      color: var(--muted);
    }

    .badge {
      display: inline-flex;
      padding: 0.15rem 0.5rem;
      border-radius: 999px;
      font-size: 0.72rem;
      align-items: center;
      gap: 0.2rem;
      margin-top: 0.4rem;
    }

    .badge-pill {
      background: #e4eef8;
      color: var(--primary-blue);
    }

    .badge-success {
      background: #e4f6ee;
      color: var(--success-green);
    }

    .badge-error {
      background: #fbe9e7;
      color: var(--error-red);
    }

    .status-message {
      font-size: 0.82rem;
      margin-top: 0.35rem;
    }

    .status-message.success {
      color: var(--success-green);
    }

    .status-message.error {
      color: var(--error-red);
    }

    .status-message.info {
      color: var(--muted);
    }

    .mini-list {
      list-style: none;
      padding: 0;
      margin: 0.4rem 0 0;
      font-size: 0.8rem;
    }

    .mini-list li {
      padding: 0.15rem 0;
    }

    code {
      font-size: 0.78rem;
      background: #f0f2f8;
      padding: 0.12rem 0.35rem;
      border-radius: 4px;
    }
  </style>
</head>
<body>
<div class="page">
  <!-- HEADER -->
  <header>
    <div class="inner">
      <div class="nav">
        <div class="logo-wrap">
          <div class="logo-icon" aria-hidden="true"></div>
          <div>
            <div class="logo-main">TradeBotPro</div>
            <div class="logo-tag">Business setup wizard</div>
          </div>
        </div>
        <div class="header-right">
          <div id="user-id-pill" class="user-id-pill" title="Signup ID from URL">
            No user_id in URL
          </div>
          <div style="font-size:0.78rem;color:var(--muted);">
            This page is for <strong>you</strong> to set up how the AI should behave.
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <main>
    <div class="inner wizard-layout">
      <section>
        <div class="wizard-header">
          <h1 class="wizard-title">Set up your TradeBotPro profile</h1>
          <p class="wizard-subtitle">
            Work through the 4 short steps. You can change anything later.  
            This version is front-end only — we’ll plug in Supabase once you’re happy with the flow.
          </p>

          <div class="step-pills" id="step-pills">
            <div class="step-pill active" data-step-pill="1">
              <span class="step-number">1</span> Business basics
            </div>
            <div class="step-pill" data-step-pill="2">
              <span class="step-number">2</span> Services &amp; pricing
            </div>
            <div class="step-pill" data-step-pill="3">
              <span class="step-number">3</span> Messaging &amp; style
            </div>
            <div class="step-pill" data-step-pill="4">
              <span class="step-number">4</span> Review &amp; finish
            </div>
          </div>

          <div class="progress-bar-wrap">
            <div class="progress-bar-fill" id="progress-bar-fill"></div>
          </div>
        </div>

        <div class="card">
          <!-- STEP 1 -->
          <div class="step active" data-step="1">
            <h2>Step 1 — Business basics</h2>
            <p class="lead">
              Start with the core details TradeBotPro needs to introduce your business properly.
            </p>

            <div class="field-row">
              <div class="field" data-required>
                <label for="business_name">Business name</label>
                <input id="business_name" name="business_name" type="text" autocomplete="organization" />
                <small>How you want customers to see your name.</small>
              </div>
              <div class="field" data-required>
                <label for="contact_name">Main contact name</label>
                <input id="contact_name" name="contact_name" type="text" autocomplete="name" />
                <small>The person TradeBotPro will say is “in the team”.</small>
              </div>
            </div>

            <div class="field-row">
              <div class="field" data-required>
                <label for="email">Booking / office email</label>
                <input id="email" name="email" type="email" autocomplete="email" />
              </div>
              <div class="field" data-required>
                <label for="phone">Mobile / WhatsApp number</label>
                <input id="phone" name="phone" type="tel" autocomplete="tel" />
              </div>
            </div>

            <div class="field-row">
              <div class="field" data-required>
                <label for="trade_type">Trade type</label>
                <select id="trade_type" name="trade_type">
                  <option value="">Select your trade…</option>
                  <option>Plumber</option>
                  <option>Heating Engineer</option>
                  <option>Gas Engineer</option>
                  <option>Electrician</option>
                  <option>Builder</option>
                  <option>Handyman</option>
                  <option>Landscaper / Gardener</option>
                  <option>Cleaner / Carpet Cleaner</option>
                  <option>Pest Control</option>
                  <option>Other</option>
                </select>
              </div>
              <div class="field" data-required>
                <label for="base_postcode">Base postcode / town</label>
                <input id="base_postcode" name="base_postcode" type="text" autocomplete="postal-code" />
                <small>e.g. OX5, HP14, MK4</small>
              </div>
            </div>

            <div class="field">
              <label for="services_summary">Quick summary of what you do</label>
              <textarea id="services_summary" name="services_summary" placeholder="e.g. Boiler repairs, servicing, landlord safety certificates and general plumbing."></textarea>
            </div>
          </div>

          <!-- STEP 2 -->
          <div class="step" data-step="2">
            <h2>Step 2 — Service area & basic pricing</h2>
            <p class="lead">
              This is not your full price list — it’s just enough to let the AI give a sensible rough estimate.
            </p>

            <div class="field-row">
              <div class="field">
                <label for="service_radius">Typical service radius (miles)</label>
                <input id="service_radius" name="service_radius" type="number" min="1" step="1" />
                <small>Roughly how far from your base you normally travel.</small>
              </div>
              <div class="field">
                <label for="callout_from">Call-out fee (from)</label>
                <input id="callout_from" name="callout_from" type="number" min="0" step="1" />
                <small>e.g. 90 for a typical daytime call-out.</small>
              </div>
            </div>

            <div class="field-row">
              <div class="field">
                <label for="first_hour_rate">First hour (from)</label>
                <input id="first_hour_rate" name="first_hour_rate" type="number" min="0" step="1" />
              </div>
              <div class="field">
                <label for="hourly_rate">Hourly rate after first hour</label>
                <input id="hourly_rate" name="hourly_rate" type="number" min="0" step="1" />
              </div>
            </div>

            <div class="field">
              <label for="pricing_notes">Pricing notes (optional)</label>
              <textarea id="pricing_notes" name="pricing_notes" placeholder="Anything important about how you price jobs — overtime rates, minimum charges, parts on top, etc."></textarea>
            </div>
          </div>

          <!-- STEP 3 -->
          <div class="step" data-step="3">
            <h2>Step 3 — Messaging & style</h2>
            <p class="lead">
              Tell TradeBotPro how you like to speak to customers and any rules it must always follow.
            </p>

            <div class="field">
              <label for="ai_style_notes">Tone & style</label>
              <textarea id="ai_style_notes" name="ai_style_notes" placeholder="e.g. Friendly, plain English, no jargon. Never pressure customers. Always be honest about availability."></textarea>
              <small>We’ll use this like a “house style” for all your messages.</small>
            </div>

            <div class="field">
              <label for="callout_notes">Call-out & job rules</label>
              <textarea id="callout_notes" name="callout_notes" placeholder="e.g. We don’t give exact arrival times, only windows. Always ask for photos before quoting. For out-of-hours emergencies, call this number: …"></textarea>
            </div>

            <div class="field">
              <label for="review_prompt">Reviews & follow-up</label>
              <textarea id="review_prompt" name="review_prompt" placeholder="e.g. After each job, ask for a Google review with this link. If it was a boiler service, remind them 11 months later."></textarea>
            </div>

            <div class="field">
              <label for="plan_status">Plan</label>
              <select id="plan_status" name="plan_status">
                <option value="">Select a plan…</option>
                <option value="starter-monthly">Starter – Monthly</option>
                <option value="starter-yearly">Starter – Yearly</option>
                <option value="pro-monthly">Pro – Monthly</option>
                <option value="pro-yearly">Pro – Yearly</option>
                <option value="premium-monthly">Premium – Monthly</option>
              </select>
            </div>

            <div class="toggle-row">
              <label style="font-size:0.8rem;">
                <input type="checkbox" id="is_active" name="is_active" />
                Ready to go live (AI can start replying to real customers)
              </label>
            </div>
          </div>

          <!-- STEP 4 -->
          <div class="step" data-step="4">
            <h2>Step 4 — Review & finish</h2>
            <p class="lead">
              Check everything looks right. When you click “Save profile” we’ll keep this in your browser for now and show a success message. Backend wiring comes next.
            </p>

            <div id="review-summary">
              <!-- Filled in by JS -->
            </div>

            <div class="wizard-buttons">
              <button type="button" class="btn-ghost" id="edit-from-start">
                ← Start again from Step 1
              </button>
              <div class="button-group">
                <button type="button" class="btn-outline" id="back-from-step4">
                  Back
                </button>
                <button type="button" class="btn-primary" id="save-profile-btn">
                  Save profile
                </button>
              </div>
            </div>
          </div>

          <!-- Wizard navigation for Steps 1–3 -->
          <div class="wizard-buttons" id="wizard-buttons-main">
            <button type="button" class="btn-ghost" id="discard-btn">
              Discard changes
            </button>
            <div class="button-group">
              <button type="button" class="btn-outline" id="back-btn">
                Back
              </button>
              <button type="button" class="btn-primary" id="next-btn">
                Next
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- SIDE PANEL -->
      <aside class="status-panel">
        <div class="status-card">
          <div class="status-title">Profile status</div>
          <div id="status-message" class="status-message info">
            Not saved yet. Work through the steps and click “Save profile”.
          </div>
          <div id="status-badge" class="badge badge-pill">
            Draft profile
          </div>
        </div>

        <div class="status-card">
          <div class="status-title">What happens after this?</div>
          <p class="status-text">
            This version is <strong>front-end only</strong>. When you’re happy with the layout and flow we’ll:
          </p>
          <ul class="mini-list">
            <li>Link the wizard to your existing <code>business_profiles</code> row.</li>
            <li>Keep <code>tradebotpro_signups</code> and <code>business_profiles</code> in sync.</li>
            <li>Show “Information successfully updated” after a real Supabase update.</li>
          </ul>
        </div>

        <div class="status-card">
          <div class="status-title">Supabase (later)</div>
          <p class="status-text">
            When we’re ready to wire it up, we’ll:
          </p>
          <ul class="mini-list">
            <li>Use <code>?user_id=…</code> from the URL as your <code>signup_id</code>.</li>
            <li>Load existing values into these fields.</li>
            <li>PATCH both tables in one go without breaking RLS.</li>
          </ul>
        </div>
      </aside>
    </div>
  </main>
</div>

<!-- OPTIONAL: Supabase CDN (for later wiring; safe to leave here for now) -->
<script src="https://unpkg.com/@supabase/supabase-js@2.48.0/dist/umd/supabase.js"></script>
<script>
  // -------------------------------
  // CONFIG: Supabase (future wiring)
  // -------------------------------
  // For NOW the wizard works entirely in the browser.
  // When we move to real saving, we will:
  //   1) Paste the real SUPABASE_URL + SUPABASE_ANON_KEY below
  //   2) Flip ENABLE_SUPABASE_SAVE to true
  //   3) Implement loadProfileFromSupabase + saveProfileToSupabase
  //
  const ENABLE_SUPABASE_SAVE = false; // keep false for now

  const SUPABASE_URL = "https://yaiutswdcbfwkxfqxkzy.supabase.co";
  const SUPABASE_ANON_KEY = "PASTE_YOUR_ANON_KEY_IF_NEEDED";

  let supabaseClient = null;
  if (ENABLE_SUPABASE_SAVE) {
    supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  }

  // -------------------------------
  // Wizard state
  // -------------------------------
  const TOTAL_STEPS = 4;
  let currentStep = 1;

  function getField(id) {
    return document.getElementById(id);
  }

  function getValue(id) {
    const el = getField(id);
    if (!el) return "";
    if (el.type === "checkbox") return el.checked;
    return (el.value || "").trim();
  }

  function setValue(id, value) {
    const el = getField(id);
    if (!el) return;
    if (el.type === "checkbox") {
      el.checked = !!value;
    } else {
      el.value = value ?? "";
    }
  }

  function updateProgress() {
    const fill = document.getElementById("progress-bar-fill");
    const pills = document.querySelectorAll("[data-step-pill]");
    const percentage = (currentStep - 1) / (TOTAL_STEPS - 1) * 100;
    if (fill) fill.style.width = percentage + "%";

    pills.forEach(pill => {
      const step = Number(pill.getAttribute("data-step-pill"));
      pill.classList.remove("active", "completed");
      if (step === currentStep) {
        pill.classList.add("active");
      } else if (step < currentStep) {
        pill.classList.add("completed");
      }
    });
  }

  function showStep(stepNumber) {
    currentStep = stepNumber;
    document.querySelectorAll(".step").forEach(stepEl => {
      const s = Number(stepEl.getAttribute("data-step"));
      stepEl.classList.toggle("active", s === currentStep);
    });

    // Main buttons only visible on steps 1–3
    const mainButtons = document.getElementById("wizard-buttons-main");
    if (mainButtons) {
      mainButtons.style.display = currentStep === 4 ? "none" : "flex";
    }

    // Separate buttons on step 4
    const backFromStep4 = document.getElementById("back-from-step4");
    if (backFromStep4) {
      backFromStep4.style.display = currentStep === 4 ? "inline-flex" : "none";
    }

    // Update progress
    updateProgress();

    // On step 4, regenerate summary
    if (currentStep === 4) {
      buildReviewSummary();
    }
  }

  function validateCurrentStep() {
    let valid = true;
    const currentStepEl = document.querySelector('.step[data-step="' + currentStep + '"]');
    if (!currentStepEl) return true;

    // Clear previous errors
    currentStepEl.querySelectorAll(".field").forEach(field => {
      field.classList.remove("error");
      const err = field.querySelector(".field-error-text");
      if (err) err.remove();
    });

    currentStepEl.querySelectorAll("[data-required]").forEach(field => {
      const input = field.querySelector("input, select, textarea");
      if (!input) return;
      const value = (input.value || "").trim();
      if (!value) {
        valid = false;
        field.classList.add("error");
        const span = document.createElement("div");
        span.className = "field-error-text";
        span.textContent = "This field is required.";
        field.appendChild(span);
      }
    });

    return valid;
  }

  function buildReviewSummary() {
    const summaryEl = document.getElementById("review-summary");
    if (!summaryEl) return;

    const data = {
      "Business name": getValue("business_name"),
      "Main contact": getValue("contact_name"),
      "Email": getValue("email"),
      "Mobile / WhatsApp": getValue("phone"),
      "Trade type": getValue("trade_type"),
      "Base postcode / town": getValue("base_postcode"),
      "Services summary": getValue("services_summary"),
      "Service radius (miles)": getValue("service_radius"),
      "Call-out fee (from)": getValue("callout_from"),
      "First hour (from)": getValue("first_hour_rate"),
      "Hourly rate after first hour": getValue("hourly_rate"),
      "Pricing notes": getValue("pricing_notes"),
      "Tone & style": getValue("ai_style_notes"),
      "Call-out & job rules": getValue("callout_notes"),
      "Review / follow-up rules": getValue("review_prompt"),
      "Plan": getValue("plan_status"),
      "Ready to go live": getValue("is_active") ? "Yes" : "No"
    };

    let html = '<ul class="summary-list">';
    for (const [label, value] of Object.entries(data)) {
      if (!value) continue;
      html += `<li><span class="summary-label">${label}:</span> <span>${value}</span></li>`;
    }
    html += "</ul>";

    if (html === '<ul class="summary-list"></ul>') {
      html = "<p>No details filled in yet.</p>";
    }

    summaryEl.innerHTML = html;
  }

  function setStatus(message, type) {
    const statusMsg = document.getElementById("status-message");
    const badge = document.getElementById("status-badge");
    if (!statusMsg || !badge) return;

    statusMsg.textContent = message || "";

    statusMsg.classList.remove("success", "error", "info");
    badge.classList.remove("badge-pill", "badge-success", "badge-error");

    if (type === "success") {
      statusMsg.classList.add("success");
      badge.classList.add("badge-success");
      badge.textContent = "Profile saved (local)";
    } else if (type === "error") {
      statusMsg.classList.add("error");
      badge.classList.add("badge-error");
      badge.textContent = "Error";
    } else {
      statusMsg.classList.add("info");
      badge.classList.add("badge-pill");
      badge.textContent = "Draft profile";
    }
  }

  // -------------------------------
  // Local save (front-end only)
  // -------------------------------
  function buildProfileObject() {
    return {
      business_name: getValue("business_name"),
      contact_name: getValue("contact_name"),
      email: getValue("email"),
      phone: getValue("phone"),
      trade_type: getValue("trade_type"),
      base_postcode: getValue("base_postcode"),
      services_summary: getValue("services_summary"),
      service_radius: getValue("service_radius"),
      callout_from: getValue("callout_from"),
      first_hour_rate: getValue("first_hour_rate"),
      hourly_rate: getValue("hourly_rate"),
      pricing_notes: getValue("pricing_notes"),
      ai_style_notes: getValue("ai_style_notes"),
      callout_notes: getValue("callout_notes"),
      review_prompt: getValue("review_prompt"),
      plan_status: getValue("plan_status"),
      is_active: getValue("is_active")
    };
  }

  function saveProfileLocally() {
    const profile = buildProfileObject();
    try {
      localStorage.setItem("tradebotpro_profile_wizard", JSON.stringify(profile));
      setStatus("Information successfully updated (saved in this browser). Supabase wiring is the next step.", "success");
    } catch (err) {
      console.error("Local save failed:", err);
      setStatus("Couldn't save locally. Please copy any important text before refreshing.", "error");
    }
  }

  function loadProfileFromLocal() {
    try {
      const raw = localStorage.getItem("tradebotpro_profile_wizard");
      if (!raw) return;
      const profile = JSON.parse(raw);

      setValue("business_name", profile.business_name);
      setValue("contact_name", profile.contact_name);
      setValue("email", profile.email);
      setValue("phone", profile.phone);
      setValue("trade_type", profile.trade_type);
      setValue("base_postcode", profile.base_postcode);
      setValue("services_summary", profile.services_summary);
      setValue("service_radius", profile.service_radius);
      setValue("callout_from", profile.callout_from);
      setValue("first_hour_rate", profile.first_hour_rate);
      setValue("hourly_rate", profile.hourly_rate);
      setValue("pricing_notes", profile.pricing_notes);
      setValue("ai_style_notes", profile.ai_style_notes);
      setValue("callout_notes", profile.callout_notes);
      setValue("review_prompt", profile.review_prompt);
      setValue("plan_status", profile.plan_status);
      setValue("is_active", profile.is_active);

      setStatus("Draft from this browser loaded. When we connect Supabase we'll sync it properly.", "info");
    } catch (err) {
      console.warn("No valid local profile:", err);
    }
  }

  // Placeholder for future Supabase load / save
  async function loadProfileFromSupabaseIfEnabled() {
    if (!ENABLE_SUPABASE_SAVE || !supabaseClient) return;
    // later:
    // 1) read user_id from URL
    // 2) select * from business_profiles where signup_id = user_id
    // 3) populate fields
  }

  async function saveProfileToSupabaseIfEnabled() {
    if (!ENABLE_SUPABASE_SAVE || !supabaseClient) return;
    // later:
    // upsert into tradebotpro_signups + business_profiles using a safe RPC or trigger
  }

  // -------------------------------
  // URL user_id handling
  // -------------------------------
  function getUserIdFromUrl() {
    const params = new URLSearchParams(window.location.search);
    return params.get("user_id");
  }

  function updateUserIdPill() {
    const pill = document.getElementById("user-id-pill");
    if (!pill) return;
    const uid = getUserIdFromUrl();
    if (uid) {
      pill.textContent = uid;
      pill.title = "Signup ID from URL (?user_id=…)";
    } else {
      pill.textContent = "No user_id in URL";
      pill.title = "Add ?user_id=YOUR_SIGNUP_ID to this URL later";
    }
  }

  // -------------------------------
  // Event wiring
  // -------------------------------
  function initWizard() {
    updateUserIdPill();
    loadProfileFromLocal();
    loadProfileFromSupabaseIfEnabled(); // does nothing for now
    updateProgress();

    const nextBtn = document.getElementById("next-btn");
    const backBtn = document.getElementById("back-btn");
    const discardBtn = document.getElementById("discard-btn");
    const saveProfileBtn = document.getElementById("save-profile-btn");
    const backFromStep4 = document.getElementById("back-from-step4");
    const editFromStart = document.getElementById("edit-from-start");

    if (nextBtn) {
      nextBtn.addEventListener("click", () => {
        if (!validateCurrentStep()) return;
        if (currentStep < TOTAL_STEPS) {
          showStep(currentStep + 1);
        }
      });
    }

    if (backBtn) {
      backBtn.addEventListener("click", () => {
        if (currentStep > 1) {
          showStep(currentStep - 1);
        }
      });
    }

    if (discardBtn) {
      discardBtn.addEventListener("click", () => {
        if (confirm("Discard all changes in this wizard (local only)?")) {
          localStorage.removeItem("tradebotpro_profile_wizard");
          window.location.reload();
        }
      });
    }

    if (saveProfileBtn) {
      saveProfileBtn.addEventListener("click", async () => {
        // In future: validate everything again + call Supabase
        saveProfileLocally();
        await saveProfileToSupabaseIfEnabled();
      });
    }

    if (backFromStep4) {
      backFromStep4.addEventListener("click", () => {
        showStep(3);
      });
    }

    if (editFromStart) {
      editFromStart.addEventListener("click", () => {
        showStep(1);
        window.scrollTo({ top: 0, behavior: "smooth" });
      });
    }
  }

  window.addEventListener("DOMContentLoaded", initWizard);
</script>
</body>
</html>

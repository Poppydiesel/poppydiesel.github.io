<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TradeBotPro ‚Äî Your AI Office Profile</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta
    name="description"
    content="Update your TradeBotPro AI office profile so enquiries, pricing and messages are set up correctly for your business."
  />
  <style>
    :root {
      --primary-blue: #1f4e79;
      --accent-blue: #00a3ff;
      --dark-text: #1b1b1f;
      --light-bg: #f5f7fa;
      --white: #ffffff;
      --danger: #b3261e;
      --success: #146c2e;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      background: var(--light-bg);
      color: var(--dark-text);
      line-height: 1.6;
    }

    a {
      color: inherit;
      text-decoration: none;
    }

    .page {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: #ffffff;
      border-bottom: 1px solid rgba(0,0,0,0.05);
      padding: 0.8rem 1.25rem;
    }

    .header-inner {
      max-width: 960px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
    }

    .logo-wrap {
      display: flex;
      align-items: center;
      gap: 0.6rem;
    }

    .logo-icon {
      width: 28px;
      height: 28px;
      border-radius: 9px;
      background: var(--primary-blue);
      position: relative;
    }

    .logo-icon::before,
    .logo-icon::after {
      content: "";
      position: absolute;
      background: var(--white);
      border-radius: 3px;
    }

    .logo-icon::before {
      width: 10px;
      height: 15px;
      left: 6px;
      top: 6px;
    }

    .logo-icon::after {
      width: 5px;
      height: 10px;
      right: 6px;
      top: 9px;
    }

    .logo-main {
      font-weight: 700;
      color: var(--primary-blue);
      font-size: 1rem;
    }

    .logo-tag {
      font-size: 0.72rem;
      opacity: 0.7;
    }

    main {
      flex: 1;
      padding: 2.5rem 1.25rem 3rem;
    }

    .inner {
      max-width: 960px;
      margin: 0 auto;
    }

    h1 {
      margin: 0 0 0.4rem;
      font-size: 1.7rem;
      color: var(--primary-blue);
    }

    .lead {
      margin: 0 0 1.4rem;
      font-size: 0.98rem;
      max-width: 40rem;
    }

    .card {
      background: #ffffff;
      border-radius: 1rem;
      padding: 1.4rem 1.5rem 1.6rem;
      box-shadow: 0 10px 26px rgba(0,0,0,0.05);
      font-size: 0.9rem;
    }

    .small {
      font-size: 0.8rem;
      opacity: 0.8;
    }

    .status {
      margin-bottom: 1rem;
      padding: 0.55rem 0.7rem;
      border-radius: 0.5rem;
      font-size: 0.85rem;
      display: none;
    }

    .status--error {
      display: block;
      background: #fbeaea;
      color: var(--danger);
      border: 1px solid rgba(179,38,30,0.3);
    }

    .status--success {
      display: block;
      background: #e7f3ea;
      color: var(--success);
      border: 1px solid rgba(20,108,46,0.3);
    }

    .status--info {
      display: block;
      background: #e7f0fb;
      color: #1f4e79;
      border: 1px solid rgba(31,78,121,0.35);
    }

    .two-col {
      display: grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 0.9rem 1.2rem;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 0.2rem;
    }

    .field label {
      font-size: 0.78rem;
      font-weight: 500;
    }

    .field span.hint {
      font-size: 0.75rem;
      opacity: 0.75;
    }

    input, select, textarea {
      border-radius: 0.5rem;
      border: 1px solid rgba(0,0,0,0.16);
      padding: 0.5rem 0.6rem;
      font: inherit;
      width: 100%;
    }

    textarea {
      min-height: 90px;
      resize: vertical;
    }

    input:focus, select:focus, textarea:focus {
      outline: 2px solid rgba(31,78,121,0.45);
      border-color: transparent;
    }

    .field--full {
      grid-column: 1 / -1;
    }

    .actions {
      margin-top: 1.2rem;
      display: flex;
      gap: 0.7rem;
      align-items: center;
      flex-wrap: wrap;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 0.7rem 1.4rem;
      cursor: pointer;
      font: inherit;
    }

    .btn-primary {
      background: var(--primary-blue);
      color: #ffffff;
      font-weight: 600;
    }

    .btn-primary:hover {
      background: #163857;
    }

    .btn-outline {
      background: #ffffff;
      border: 1px solid rgba(0,0,0,0.18);
      color: var(--primary-blue);
      font-size: 0.85rem;
    }

    .muted {
      font-size: 0.8rem;
      opacity: 0.75;
    }

    @media (max-width: 720px) {
      main { padding-top: 2rem; }
      .two-col {
        grid-template-columns: minmax(0,1fr);
      }
    }
  </style>
</head>
<body>
<div class="page">
  <header>
    <div class="header-inner">
      <div class="logo-wrap">
        <div class="logo-icon" aria-hidden="true"></div>
        <div>
          <div class="logo-main">TradeBotPro</div>
          <div class="logo-tag">AI office assistant for trades</div>
        </div>
      </div>
      <div class="small">
        Business profile portal
      </div>
    </div>
  </header>

  <main>
    <div class="inner">
      <h1>Your AI Office Profile</h1>
      <p class="lead">
        This page lets you update the key details TradeBotPro uses when handling your enquiries
        ‚Äî contact details, pricing and how you like to work.
      </p>

      <div id="status" class="status"></div>

      <div class="card">
        <form id="profile-form">
          <div class="two-col">
            <div class="field">
              <label for="business_name">Business name</label>
              <input id="business_name" name="business_name" type="text" autocomplete="organization" />
            </div>

            <div class="field">
              <label for="contact_name">Main contact name</label>
              <input id="contact_name" name="contact_name" type="text" autocomplete="name" />
            </div>

            <div class="field">
              <label for="email">Email</label>
              <input id="email" name="email" type="email" autocomplete="email" />
            </div>

            <div class="field">
              <label for="whatsapp_number">Mobile / WhatsApp number</label>
              <span class="hint">This is the main number TradeBotPro will use.</span>
              <input id="whatsapp_number" name="whatsapp_number" type="tel" />
            </div>

            <div class="field">
              <label for="phone">Optional landline</label>
              <span class="hint">Shown on messages and quotes if you want.</span>
              <input id="phone" name="phone" type="tel" />
            </div>

            <div class="field">
              <label for="trade_type">Trade</label>
              <select id="trade_type" name="trade_type">
                <option value="">Select your trade‚Ä¶</option>
                <option>Plumber</option>
                <option>Heating Engineer</option>
                <option>Gas Engineer</option>
                <option>Electrician</option>
                <option>Builder</option>
                <option>Handyman</option>
                <option>Landscaper / Gardener</option>
                <option>Cleaner / Carpet Cleaner</option>
                <option>Pest Control</option>
                <option>Other</option>
              </select>
            </div>

            <div class="field">
              <label for="base_postcode">Base postcode</label>
              <input id="base_postcode" name="base_postcode" type="text" />
            </div>

            <div class="field">
              <label for="service_radius">Service radius (miles)</label>
              <input id="service_radius" name="service_radius" type="number" min="0" step="1" />
            </div>

            <div class="field field--full">
              <label for="website_url">Website (optional)</label>
              <input id="website_url" name="website_url" type="url" placeholder="https://‚Ä¶" />
            </div>

            <div class="field">
              <label for="callout_fee">Call-out fee (¬£)</label>
              <input id="callout_fee" name="callout_fee" type="number" min="0" step="1" />
            </div>

            <div class="field">
              <label for="first_hour_rate">First hour rate (¬£)</label>
              <input id="first_hour_rate" name="first_hour_rate" type="number" min="0" step="1" />
            </div>

            <div class="field">
              <label for="hourly_rate">Hourly rate after first hour (¬£)</label>
              <input id="hourly_rate" name="hourly_rate" type="number" min="0" step="1" />
            </div>

            <div class="field">
              <label for="boiler_service_from">Boiler service from (¬£)</label>
              <input id="boiler_service_from" name="boiler_service_from" type="number" min="0" step="1" />
            </div>

            <div class="field">
              <label for="quote_minimum">Minimum job / quote value (¬£)</label>
              <input id="quote_minimum" name="quote_minimum" type="number" min="0" step="1" />
            </div>

            <div class="field field--full">
              <label for="services_summary">What services do you offer?</label>
              <span class="hint">Short bullets are fine ‚Äî e.g. boiler installs, repairs, landlord certs.</span>
              <textarea id="services_summary" name="services_summary"></textarea>
            </div>

            <div class="field field--full">
              <label for="ai_style_notes">How should your AI office speak to customers?</label>
              <span class="hint">
                E.g. ‚ÄúFriendly but professional, no jargon, don‚Äôt give fixed prices without photos, 
                always check parking / access.‚Äù
              </span>
              <textarea id="ai_style_notes" name="ai_style_notes"></textarea>
            </div>
          </div>

          <div class="actions">
            <button type="submit" class="btn-primary">Save changes</button>
            <button type="button" id="reset-btn" class="btn-outline">Reset back to last saved</button>
            <span class="muted" id="last-saved"></span>
          </div>
        </form>
      </div>
    </div>
  </main>
</div>

<script>
  // üëáüëáüëá IMPORTANT: SET THESE TWO VALUES üëáüëáüëá
  const SUPABASE_URL = "https://yaiutswdcbfwkxfqxkzy.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlhaXV0c3dkY2Jmd2t4ZnF4a3p5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1MDE2MDgsImV4cCI6MjA4MDA3NzYwOH0.HOLFxzjsZ5Ieqg0b-aTdP0hAdLsPVXL6Zjs-HgOHgc8";
    // ---------- helper: read user_id from URL ----------
  function getUserIdFromUrl() {
    const params = new URLSearchParams(window.location.search);
    return params.get('user_id');
  }

  // ---------- small helpers for status messages ----------
  const statusBox = document.getElementById('status');
  const lastSavedSpan = document.getElementById('last-saved');

  function setStatus(type, message) {
    statusBox.className = 'status';
    if (!message) {
      statusBox.style.display = 'none';
      return;
    }
    if (type === 'error') {
      statusBox.classList.add('status--error');
    } else if (type === 'success') {
      statusBox.classList.add('status--success');
    } else {
      statusBox.classList.add('status--info');
    }
    statusBox.textContent = message;
    statusBox.style.display = 'block';
  }

  function updateLastSaved() {
    lastSavedSpan.textContent = 'Last saved: ' + new Date().toLocaleString();
  }

  // ---------- Supabase REST calls ----------
  async function fetchProfile(userId) {
    if (!supabaseUrl || !supabaseAnonKey) {
      throw new Error('Supabase URL / anon key not set in app.html');
    }

    const url = supabaseUrl + '/rest/v1/business_profiles'
      + '?user_id=eq.' + encodeURIComponent(userId)
      + '&select=*';

    const res = await fetch(url, {
      method: 'GET',
      headers: {
        'apikey': supabaseAnonKey,
        'Authorization': 'Bearer ' + supabaseAnonKey
      }
    });

    if (!res.ok) {
      const text = await res.text().catch(() => '');
      console.error('Fetch profile error', res.status, text);
      throw new Error('Failed to load profile (HTTP ' + res.status + ').');
    }

    const rows = await res.json();
    if (!Array.isArray(rows) || rows.length === 0) {
      throw new Error('No profile found for this link. Please contact support.');
    }

    return rows[0];
  }

  async function saveProfile(userId, payload) {
    const url = supabaseUrl + '/rest/v1/business_profiles'
      + '?user_id=eq.' + encodeURIComponent(userId);

    const res = await fetch(url, {
      method: 'PATCH',
      headers: {
        'apikey': supabaseAnonKey,
        'Authorization': 'Bearer ' + supabaseAnonKey,
        'Content-Type': 'application/json',
        'Prefer': 'return=representation'
      },
      body: JSON.stringify(payload)
    });

    if (!res.ok) {
      const text = await res.text().catch(() => '');
      console.error('Save profile error', res.status, text);
      throw new Error('Could not save your changes (HTTP ' + res.status + ').');
    }

    const rows = await res.json();
    return rows[0] || null;
  }

  // ---------- form wiring ----------
  const form = document.getElementById('profile-form');
  const resetBtn = document.getElementById('reset-btn');

  let currentUserId = null;
  let lastLoadedProfile = null;

  async function initialise() {
    try {
      const userId = getUserIdFromUrl();
      currentUserId = userId;

      if (!userId) {
        setStatus('error', 'This link is missing a user id. Please open the full link we sent you, or contact support.');
        form.style.display = 'none';
        return;
      }

      setStatus('info', 'Loading your profile‚Ä¶');

      const profile = await fetchProfile(userId);
      lastLoadedProfile = profile;
      populateForm(profile);

      setStatus('info', 'Profile loaded. Update any details below and click ‚ÄúSave changes‚Äù.');
    } catch (err) {
      console.error(err);
      setStatus('error', err.message || 'Something went wrong loading your profile.');
    }
  }

  function populateForm(p) {
    const fields = [
      'business_name',
      'contact_name',
      'email',
      'whatsapp_number',
      'phone',
      'trade_type',
      'base_postcode',
      'service_radius',
      'website_url',
      'callout_fee',
      'first_hour_rate',
      'hourly_rate',
      'boiler_service_from',
      'quote_minimum',
      'services_summary',
      'ai_style_notes'
    ];

    fields.forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;
      const val = p[id];

      if (el.tagName === 'SELECT') {
        el.value = val ?? '';
      } else if (el.tagName === 'TEXTAREA') {
        el.value = val ?? '';
      } else {
        el.value = val ?? '';
      }
    });

    updateLastSaved();
  }

  function getFormPayload() {
    const payload = {};

    function val(id) {
      const el = document.getElementById(id);
      if (!el) return '';
      return el.value.trim();
    }

    payload.business_name     = val('business_name') || null;
    payload.contact_name      = val('contact_name')  || null;
    payload.email             = val('email')         || null;
    payload.whatsapp_number   = val('whatsapp_number') || null;
    payload.phone             = val('phone')         || null;
    payload.trade_type        = val('trade_type')    || null;
    payload.base_postcode     = val('base_postcode') || null;
    payload.service_radius    = val('service_radius') ? Number(val('service_radius')) : null;
    payload.website_url       = val('website_url')   || null;
    payload.callout_fee       = val('callout_fee') ? Number(val('callout_fee')) : null;
    payload.first_hour_rate   = val('first_hour_rate') ? Number(val('first_hour_rate')) : null;
    payload.hourly_rate       = val('hourly_rate') ? Number(val('hourly_rate')) : null;
    payload.boiler_service_from = val('boiler_service_from') ? Number(val('boiler_service_from')) : null;
    payload.quote_minimum     = val('quote_minimum') ? Number(val('quote_minimum')) : null;
    payload.services_summary  = val('services_summary') || null;
    payload.ai_style_notes    = val('ai_style_notes') || null;

    return payload;
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!currentUserId) return;

    try {
      setStatus('info', 'Saving your changes‚Ä¶');
      const payload = getFormPayload();
      const updated = await saveProfile(currentUserId, payload);
      if (updated) {
        lastLoadedProfile = updated;
        populateForm(updated);
      }
      setStatus('success', 'All saved. Your AI office will now use these details.');
    } catch (err) {
      console.error(err);
      setStatus('error', err.message || 'Something went wrong saving your details.');
    }
  });

  resetBtn.addEventListener('click', () => {
    if (!lastLoadedProfile) return;
    populateForm(lastLoadedProfile);
    setStatus('info', 'Reverted back to last saved values.');
  });

  // kick-off
  initialise();
</script>
</body>
</html>

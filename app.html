<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TradeBotPro — Set up your AI office</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta
    name="description"
    content="TradeBotPro — quick setup form so we can tune your AI office assistant to your business."
  />

  <style>
    :root {
      --primary-blue: #1f4e79;
      --accent-blue: #00a3ff;
      --dark-text: #1b1b1f;
      --light-bg: #f5f7fa;
      --white: #ffffff;
      --border-subtle: rgba(0, 0, 0, 0.08);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      background: var(--light-bg);
      color: var(--dark-text);
      line-height: 1.5;
    }

    a {
      color: inherit;
      text-decoration: none;
    }

    .page {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: var(--white);
      border-bottom: 1px solid var(--border-subtle);
    }

    .inner {
      max-width: 960px;
      margin: 0 auto;
      padding: 0 1.25rem;
    }

    .nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      padding: 0.75rem 0;
    }

    .logo-wrap {
      display: flex;
      align-items: center;
      gap: 0.6rem;
    }

    .logo-icon {
      width: 32px;
      height: 32px;
      border-radius: 9px;
      background: var(--primary-blue);
      position: relative;
    }

    .logo-icon::before,
    .logo-icon::after {
      content: "";
      position: absolute;
      background: var(--white);
      border-radius: 4px;
    }

    .logo-icon::before {
      width: 12px;
      height: 18px;
      left: 7px;
      top: 7px;
    }

    .logo-icon::after {
      width: 6px;
      height: 12px;
      right: 7px;
      top: 10px;
    }

    .logo-main {
      font-weight: 700;
      font-size: 1.05rem;
      color: var(--primary-blue);
    }

    .logo-tag {
      font-size: 0.7rem;
      opacity: 0.75;
    }

    main {
      flex: 1;
      padding: 2rem 0 2.5rem;
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1fr);
      gap: 2rem;
      align-items: flex-start;
    }

    .intro h1 {
      margin: 0 0 0.4rem;
      font-size: clamp(1.8rem, 3vw, 2.2rem);
      color: var(--primary-blue);
    }

    .intro p {
      margin: 0.4rem 0;
      font-size: 0.95rem;
    }

    .intro ul {
      margin: 0.8rem 0 0;
      padding-left: 1.1rem;
      font-size: 0.9rem;
    }

    .card {
      background: var(--white);
      border-radius: 1rem;
      padding: 1.4rem 1.5rem;
      box-shadow: 0 10px 26px rgba(0, 0, 0, 0.05);
      font-size: 0.9rem;
    }

    .card h2 {
      margin: 0 0 0.6rem;
      font-size: 1.2rem;
      color: var(--primary-blue);
    }

    .status-banner {
      margin-bottom: 0.7rem;
      padding: 0.5rem 0.7rem;
      border-radius: 0.6rem;
      font-size: 0.8rem;
      background: #f1f5ff;
      border: 1px solid rgba(31, 78, 121, 0.15);
      display: none;
    }

    .status-banner--error {
      background: #fff4f2;
      border-color: #f3b0a4;
    }

    form {
      margin-top: 0.3rem;
    }

    .field-group {
      margin-bottom: 0.9rem;
    }

    .field-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 0.75rem;
    }

    label {
      display: block;
      font-size: 0.8rem;
      font-weight: 500;
      margin-bottom: 0.25rem;
    }

    input,
    select,
    textarea {
      width: 100%;
      padding: 0.55rem 0.65rem;
      border-radius: 0.5rem;
      border: 1px solid rgba(0, 0, 0, 0.18);
      font: inherit;
    }

    textarea {
      min-height: 70px;
      resize: vertical;
    }

    input:focus,
    select:focus,
    textarea:focus {
      outline: 2px solid rgba(31, 78, 121, 0.4);
      border-color: transparent;
    }

    .help-text {
      font-size: 0.78rem;
      opacity: 0.75;
      margin-top: 0.2rem;
    }

    .actions {
      margin-top: 1rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .btn-primary {
      border: none;
      border-radius: 999px;
      padding: 0.75rem 1.4rem;
      background: var(--primary-blue);
      color: var(--white);
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
    }

    .btn-primary:hover {
      background: #163857;
    }

    .small-note {
      font-size: 0.8rem;
      opacity: 0.75;
    }

    footer {
      background: var(--white);
      border-top: 1px solid var(--border-subtle);
      font-size: 0.8rem;
    }

    .footer-inner {
      padding: 1rem 1.25rem 1.2rem;
      display: flex;
      justify-content: space-between;
      gap: 1rem;
      flex-wrap: wrap;
      align-items: center;
    }

    @media (max-width: 780px) {
      .layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }
  </style>
</head>
<body>
<div class="page">
  <header>
    <div class="inner">
      <div class="nav">
        <div class="logo-wrap">
          <div class="logo-icon" aria-hidden="true"></div>
          <div>
            <div class="logo-main">TradeBotPro</div>
            <div class="logo-tag">More jobs. Less admin. Powered by AI.</div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="inner">
      <div class="layout">
        <section class="intro">
          <h1>Set up your AI office</h1>
          <p>
            This quick form tells us how your business works so we can tune your
            TradeBotPro assistant to sound like you and quote correctly.
          </p>
          <p>
            It should take <strong>2–3 minutes</strong>. You can always tweak it later.
          </p>
          <ul>
            <li>We’ll use this for your quotes, replies and booking scripts.</li>
            <li>Nothing here changes your public website.</li>
            <li>If you’re not sure on exact prices, rough ranges are fine.</li>
          </ul>
        </section>

        <section class="card">
          <h2>Your business details</h2>

          <div id="status" class="status-banner"></div>

          <form id="profile-form">
            <!-- BASIC CONTACT -->
            <div class="field-group">
              <div class="field-row">
                <div>
                  <label for="contact_name">Contact name</label>
                  <input id="contact_name" name="contact_name" type="text" autocomplete="name" />
                </div>
                <div>
                  <label for="owner_name">Owner name (if different)</label>
                  <input id="owner_name" name="owner_name" type="text" />
                </div>
              </div>
            </div>

            <div class="field-group">
              <label for="business_name">Business name</label>
              <input id="business_name" name="business_name" type="text" />
            </div>

            <div class="field-group">
              <div class="field-row">
                <div>
                  <label for="email">Contact email</label>
                  <input id="email" name="email" type="email" autocomplete="email" />
                </div>
                <div>
                  <label for="phone">Mobile / WhatsApp</label>
                  <input id="phone" name="phone" type="tel" autocomplete="tel" />
                  <div class="help-text">The main number your customers message.</div>
                </div>
              </div>
            </div>

            <!-- TRADE + AREA -->
            <div class="field-group">
              <div class="field-row">
                <div>
                  <label for="trade_type">Trade</label>
                  <select id="trade_type" name="trade_type">
                    <option value="">Select your trade…</option>
                    <option>Plumber</option>
                    <option>Heating Engineer</option>
                    <option>Gas Engineer</option>
                    <option>Electrician</option>
                    <option>Builder</option>
                    <option>Handyman</option>
                    <option>Landscaper / Gardener</option>
                    <option>Cleaner / Carpet Cleaner</option>
                    <option>Pest Control</option>
                    <option>Other</option>
                  </select>
                </div>
                <div>
                  <label for="base_postcode">Base postcode / main area</label>
                  <input id="base_postcode" name="base_postcode" type="text" />
                </div>
              </div>
            </div>

            <div class="field-group">
              <label for="website_url">Website (if you have one)</label>
              <input id="website_url" name="website_url" type="url" placeholder="https://…" />
            </div>

            <!-- PRICING -->
            <hr style="border:none;border-top:1px solid rgba(0,0,0,0.06);margin:1.1rem 0;" />

            <div class="field-group">
              <div class="field-row">
                <div>
                  <label for="callout_fee">Call-out fee (£)</label>
                  <input id="callout_fee" name="callout_fee" type="text" />
                </div>
                <div>
                  <label for="first_hour_rate">First hour rate (£)</label>
                  <input id="first_hour_rate" name="first_hour_rate" type="text" />
                </div>
                <div>
                  <label for="hourly_rate">Hourly rate after first hour (£)</label>
                  <input id="hourly_rate" name="hourly_rate" type="text" />
                </div>
              </div>
              <div class="help-text">
                Rough figures are fine — we use these for estimated price ranges in chats.
              </div>
            </div>

            <div class="field-group">
              <div class="field-row">
                <div>
                  <label for="boiler_service_from">Boiler service from (£)</label>
                  <input id="boiler_service_from" name="boiler_service_from" type="text" />
                </div>
                <div>
                  <label for="quote_minimum">Minimum quote / small job minimum (£)</label>
                  <input id="quote_minimum" name="quote_minimum" type="text" />
                </div>
              </div>
            </div>

            <!-- COPY / STYLE -->
            <hr style="border:none;border-top:1px solid rgba(0,0,0,0.06);margin:1.1rem 0;" />

            <div class="field-group">
              <label for="services_summary">What services do you want us to talk about?</label>
              <textarea
                id="services_summary"
                name="services_summary"
                placeholder="E.g. boiler breakdowns, boiler installs, annual servicing, landlord gas safety, power flushing…"
              ></textarea>
              <div class="help-text">
                Short list is fine. This powers your “We can help with…” sentences.
              </div>
            </div>

            <div class="field-group">
              <label for="ai_style_notes">How should your AI office sound?</label>
              <textarea
                id="ai_style_notes"
                name="ai_style_notes"
                placeholder="E.g. friendly and down-to-earth, no hard selling, keep it short and clear, always mention we’re Gas Safe registered…"
              ></textarea>
              <div class="help-text">
                Anything about tone of voice, things to always mention, or things to avoid.
              </div>
            </div>

            <div class="actions">
              <button type="submit" class="btn-primary">Save my setup</button>
              <div class="small-note">
                We’ll confirm once everything is saved. You can close this page afterwards.
              </div>
            </div>
          </form>
        </section>
      </div>
    </div>
  </main>

  <footer>
    <div class="inner footer-inner">
      <div>&copy; <span id="year"></span> TradeBotPro.</div>
      <div>Built for trades &amp; home services.</div>
    </div>
  </footer>
</div>

<script>
  // ----------------------------------------------------
  // 1. SUPABASE SETTINGS – EDIT THESE TWO LINES ONLY
  // ----------------------------------------------------
  const SUPABASE_URL = 'https://yaiutswdcbfwkxfqxkzy.supabase.co';
  const SUPABASE_ANON_KEY = 'PASTE_YOUR_ANON_KEY_HERE';
  // (Find this in Supabase: Project Settings → API → anon public key)

  const TABLE_NAME = 'business_profiles';

  // ----------------------------------------------------
  // 2. FIELD LIST – IDs MUST MATCH YOUR INPUT IDs
  //    (Only include fields that really exist in the DB)
  // ----------------------------------------------------
  const FIELD_IDS = [
    'business_name',
    'contact_name',
    'owner_name',
    'email',
    'phone',
    'whatsapp_number',
    'trade_type',
    'base_postcode',
    'service_radius',
    'website_url',
    'callout_from',
    'callout_fee',
    'first_hour_rate',
    'hourly_rate_from',
    'hourly_rate',
    'boiler_service_from',
    'quote_minimum',
    'services_summary',
    'pricing_notes',
    'ai_style_notes',
    'plan_status',
    'pending_setup',
    'is_active',
    'account_status',
    'account_status_reason',
    'callout_notes'
  ];

  // ----------------------------------------------------
  // 3. SMALL HELPERS
  // ----------------------------------------------------
  function getUserIdFromUrl() {
    var params = new URLSearchParams(window.location.search);
    return params.get('user_id');
  }

  function getElement(id) {
    return document.getElementById(id);
  }

  function showError(message) {
    var box = getElement('app-error');
    if (box) {
      box.textContent = message;
      box.style.display = 'block';
    } else {
      alert(message);
    }
  }

  function showSuccess(message) {
    var box = getElement('app-success');
    if (box) {
      box.textContent = message;
      box.style.display = 'block';
    } else {
      alert(message);
    }
  }

  function clearMessages() {
    var err = getElement('app-error');
    var ok = getElement('app-success');
    if (err) err.style.display = 'none';
    if (ok) ok.style.display = 'none';
  }

  // Fill form fields from a row object
  function setFormValues(row) {
    for (var i = 0; i < FIELD_IDS.length; i++) {
      var field = FIELD_IDS[i];
      var el = getElement(field);
      if (!el) continue;
      if (!row.hasOwnProperty(field)) continue;

      if (el.type === 'checkbox') {
        el.checked = !!row[field];
      } else {
        el.value = row[field] == null ? '' : String(row[field]);
      }
    }
  }

  // Collect form values into a payload object
  function getFormValues() {
    var payload = {};
    for (var i = 0; i < FIELD_IDS.length; i++) {
      var field = FIELD_IDS[i];
      var el = getElement(field);
      if (!el) continue;

      if (el.type === 'checkbox') {
        payload[field] = el.checked;
      } else {
        payload[field] = el.value.trim();
      }
    }
    return payload;
  }

  // ----------------------------------------------------
  // 4. SUPABASE FETCH HELPERS (REST API)
  // ----------------------------------------------------
  function supabaseHeaders(json) {
    var headers = {
      apikey: SUPABASE_ANON_KEY,
      Authorization: 'Bearer ' + SUPABASE_ANON_KEY
    };
    if (json) {
      headers['Content-Type'] = 'application/json';
      headers['Prefer'] = 'return=representation';
    }
    return headers;
  }

  async function fetchProfile(userId) {
    var url =
      SUPABASE_URL +
      '/rest/v1/' +
      TABLE_NAME +
      '?id=eq.' +
      encodeURIComponent(userId) +
      '&select=*';

    var res = await fetch(url, {
      headers: supabaseHeaders(false)
    });

    if (!res.ok) {
      var text = await res.text();
      console.error('Fetch profile failed:', res.status, text);
      throw new Error('Fetch failed: ' + res.status + ' ' + text);
    }

    var rows = await res.json();
    if (!rows || rows.length === 0) {
      throw new Error('No profile found for this link.');
    }

    return rows[0];
  }

  async function saveProfile(userId, payload) {
    var url =
      SUPABASE_URL +
      '/rest/v1/' +
      TABLE_NAME +
      '?id=eq.' +
      encodeURIComponent(userId);

    var res = await fetch(url, {
      method: 'PATCH',
      headers: supabaseHeaders(true),
      body: JSON.stringify(payload)
    });

    if (!res.ok) {
      var text = await res.text();
      console.error('Save profile failed:', res.status, text);
      throw new Error('Save failed: ' + res.status + ' ' + text);
    }

    var rows = await res.json();
    return rows && rows[0] ? rows[0] : null;
  }

  // ----------------------------------------------------
  // 5. INITIALISE PAGE
  // ----------------------------------------------------
  async function initialise() {
    var form = getElement('profile-form'); // your main form element
    clearMessages();

    var userId = getUserIdFromUrl();
    if (!userId) {
      showError('This link is missing a user ID. Please use the link we sent you.');
      if (form) form.style.display = 'none';
      return;
    }

    try {
      var row = await fetchProfile(userId);
      setFormValues(row);
    } catch (err) {
      console.error('Fetch profile error:', err);
      showError(err.message || 'Could not load your profile from TradeBotPro.');
    }

    if (!form) return;

    form.addEventListener('submit', async function (event) {
      event.preventDefault();
      clearMessages();

      var payload = getFormValues();

      try {
        await saveProfile(userId, payload);
        showSuccess('Thanks – your details have been updated.');
      } catch (err) {
        console.error('Save profile error:', err);
        showError('There was a problem saving your changes. Please try again.');
      }
    });
  }

  document.addEventListener('DOMContentLoaded', initialise);
</script>

</body>
</html>

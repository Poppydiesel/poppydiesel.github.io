<!DOCTYPE html> 
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TradeBotPro ‚Äì Setup Wizard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta
    name="description"
    content="TradeBotPro setup wizard for new trade accounts."
  />

  <style>
    :root {
      --primary-blue: #1f4e79;
      --accent-blue: #00a3ff;
      --dark-text: #151820;
      --muted-text: #6b7280;
      --light-bg: #f3f4f9;
      --white: #ffffff;
      --border-subtle: rgba(15, 23, 42, 0.12);
      --chip-bg: #eef2ff;
      --chip-border: rgba(37, 99, 235, 0.3);
      --chip-bg-muted: #f3f4f6;
      --chip-border-muted: rgba(148, 163, 184, 0.6);
      --success-green: #0f7b46;
      --error-red: #b3261e;
    }

    * {
      box-sizing: border-box;
    }

    html {
      scroll-behavior: smooth;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      background: radial-gradient(circle at top left, #e0ebff 0, #f3f4f9 40%, #fdfdfd 100%);
      color: var(--dark-text);
      line-height: 1.5;
    }

    a {
      color: inherit;
      text-decoration: none;
    }

    /* PAGE LAYOUT */

    .page {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      border-bottom: 1px solid rgba(15, 23, 42, 0.06);
      background: rgba(248, 250, 252, 0.96);
      backdrop-filter: blur(6px);
      position: sticky;
      top: 0;
      z-index: 20;
    }

    .header-inner {
      max-width: 1100px;
      margin: 0 auto;
      padding: 0.6rem 1.25rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
    }

    .logo-wrap {
      display: flex;
      align-items: center;
      gap: 0.6rem;
    }

    .logo-icon {
      width: 30px;
      height: 30px;
      border-radius: 9px;
      background: var(--primary-blue);
      position: relative;
    }

    .logo-icon::before,
    .logo-icon::after {
      content: "";
      position: absolute;
      background: var(--white);
      border-radius: 4px;
    }

    .logo-icon::before {
      width: 11px;
      height: 17px;
      left: 7px;
      top: 6px;
    }

    .logo-icon::after {
      width: 6px;
      height: 11px;
      right: 7px;
      top: 9px;
    }

    .logo-main {
      font-weight: 700;
      font-size: 1rem;
      color: var(--primary-blue);
    }

    .logo-tag {
      font-size: 0.75rem;
      color: var(--muted-text);
    }

    .header-note {
      font-size: 0.75rem;
      color: var(--muted-text);
    }

    .header-note strong {
      color: var(--primary-blue);
      font-weight: 600;
    }

    main {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2.5rem 1.25rem 3rem;
    }

    .wizard-shell {
      width: 100%;
      max-width: 1100px;
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1.4fr);
      gap: 1.75rem;
      align-items: flex-start;
    }

    .wizard-left {
      padding: 1.5rem 1.6rem;
      border-radius: 1.2rem;
      background: rgba(255, 255, 255, 0.92);
      box-shadow:
        0 24px 60px rgba(15, 23, 42, 0.15),
        0 0 0 1px rgba(15, 23, 42, 0.03);
    }

    .wizard-right {
      padding: 1.5rem 1.6rem;
      border-radius: 1.2rem;
      background: rgba(248, 250, 252, 0.96);
      border: 1px solid rgba(148, 163, 184, 0.35);
      backdrop-filter: blur(4px);
    }

    /* PROGRESS BAR */

    .wizard-progress-wrap {
      margin-bottom: 1.4rem;
    }

    .progress-label-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
      margin-bottom: 0.35rem;
      font-size: 0.75rem;
      color: var(--muted-text);
    }

    .progress-label-row span strong {
      color: var(--primary-blue);
    }

    .progress-bar-outer {
      position: relative;
      height: 6px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.3);
      overflow: hidden;
    }

    .progress-bar-inner {
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 0%;
      background: linear-gradient(90deg, var(--primary-blue), var(--accent-blue));
      border-radius: inherit;
      transition: width 0.25s ease;
    }

    .step-dots {
      margin-top: 0.35rem;
      display: flex;
      justify-content: space-between;
      gap: 0.5rem;
      font-size: 0.7rem;
      color: var(--muted-text);
    }

    .step-dot {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      white-space: nowrap;
    }

    .step-dot-circle {
      width: 14px;
      height: 14px;
      border-radius: 999px;
      border: 2px solid rgba(148, 163, 184, 0.7);
      background: var(--white);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.6rem;
      color: rgba(148, 163, 184, 0.8);
    }

    .step-dot.is-active .step-dot-circle {
      border-color: var(--primary-blue);
      color: var(--primary-blue);
      background: #e0ecff;
    }

    .step-dot.is-complete .step-dot-circle {
      border-color: var(--success-green);
      background: #dcfce7;
      color: var(--success-green);
    }

    .step-dot-label {
      opacity: 0.9;
    }

    /* LEFT PANEL CONTENT */

    .wizard-title-kicker {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--accent-blue);
      margin-bottom: 0.35rem;
    }

    .wizard-title {
      margin: 0 0 0.4rem;
      font-size: 1.6rem;
      color: var(--primary-blue);
    }

    .wizard-subtitle {
      margin: 0 0 0.85rem;
      font-size: 0.92rem;
      color: var(--muted-text);
    }

    .wizard-benefits {
      margin: 0 0 1rem;
      padding: 0;
      list-style: none;
      font-size: 0.86rem;
      color: var(--dark-text);
    }

    .wizard-benefits li {
      display: flex;
      gap: 0.4rem;
      margin-bottom: 0.35rem;
    }

    .wizard-benefits li span:first-child {
      font-size: 0.9rem;
    }

    .wizard-note {
      margin-top: 0.9rem;
      font-size: 0.8rem;
      color: var(--muted-text);
      border-radius: 0.7rem;
      padding: 0.7rem 0.8rem;
      background: #f1f5f9;
    }

    .wizard-note strong {
      color: var(--primary-blue);
      font-weight: 600;
    }

    /* FORM / STEPS */

    .wizard-right-header {
      margin-bottom: 1rem;
    }

    .wizard-step-label {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--accent-blue);
      margin-bottom: 0.25rem;
    }

    .wizard-step-title {
      margin: 0 0 0.25rem;
      font-size: 1.2rem;
      color: var(--primary-blue);
    }

    .wizard-step-subtitle {
      margin: 0;
      font-size: 0.88rem;
      color: var(--muted-text);
    }

    .step-panel {
      display: none;
      margin-top: 0.9rem;
    }

    .step-panel.is-active {
      display: block;
    }

    .field-group {
      margin-bottom: 1rem;
    }

    .field-label-row {
      display: flex;
      justify-content: space-between;
      gap: 0.5rem;
      margin-bottom: 0.25rem;
    }

    label {
      font-size: 0.8rem;
      font-weight: 500;
      color: var(--dark-text);
    }

    .field-hint {
      font-size: 0.75rem;
      color: var(--muted-text);
    }

    input[type="text"],
    input[type="tel"],
    input[type="email"],
    textarea,
    select {
      width: 100%;
      padding: 0.6rem 0.7rem;
      border-radius: 0.55rem;
      border: 1px solid var(--border-subtle);
      font: inherit;
      font-size: 0.9rem;
      background: var(--white);
    }

    textarea {
      min-height: 80px;
      resize: vertical;
    }

    input:focus,
    textarea:focus,
    select:focus {
      outline: 0;
      border-color: rgba(37, 99, 235, 0.7);
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.4);
    }

    /* CHIPS */

    .chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.25rem;
    }

    /* -------------------------------------------------- */
    /* CHIP SYSTEM ‚Äî FULL RESET + ACTIVE STATE FIX        */
    /* -------------------------------------------------- */

    .chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 14px;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.4rem 0.9rem;
      border-radius: 999px;
      border: 1px solid rgba(0, 0, 0, 0.12);
      background: #ffffff;
      font-size: 0.85rem;
      line-height: 1.2;
      cursor: pointer;
      user-select: none;
      white-space: nowrap;
      transition: 
        background 0.15s ease,
        border-color 0.15s ease,
        color 0.15s ease,
        box-shadow 0.15s ease;
    }

    .chip.is-active {
      background: #e8f0fa;                  /* soft light blue highlight */
      border-color: #1f4e79;                /* strong navy border */
      color: #1f4e79;                       /* navy text */
      box-shadow: 0 0 0 2px rgba(31, 78, 121, 0.15);
      font-weight: 600;
    }

    .chip:hover {
      border-color: #1f4e79;
      background: rgba(31, 78, 121, 0.06);
    }

    .chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 14px;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.4rem 0.9rem;
      border-radius: 999px;
      border: 1px solid rgba(0, 0, 0, 0.12);
      background: #ffffff;
      font-size: 0.85rem;
      line-height: 1.2;
      cursor: pointer;
      user-select: none;
      white-space: nowrap;
      transition:
        background 0.15s ease,
        border-color 0.15s ease,
        color 0.15s ease,
        box-shadow 0.15s ease;
    }

    .chip.is-active {
      background: #e8f0fa;
      border-color: #1f4e79;
      color: #1f4e79;
      box-shadow: 0 0 0 2px rgba(31, 78, 121, 0.2);
      font-weight: 600;
    }

    /* FOOTER ACTIONS */

    .wizard-footer {
      margin-top: 1.1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
      flex-wrap: wrap;
      border-top: 1px dashed rgba(148, 163, 184, 0.7);
      padding-top: 0.8rem;
    }

    .wizard-footer-left {
      font-size: 0.78rem;
      color: var(--muted-text);
    }

    .wizard-footer-left strong {
      color: var(--primary-blue);
    }

    .wizard-footer-right {
      display: flex;
      gap: 0.6rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .btn {
      border-radius: 999px;
      border: 1px solid transparent;
      padding: 0.55rem 1.1rem;
      font-size: 0.86rem;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      background: transparent;
    }

    .btn:focus-visible {
      outline: 2px solid var(--accent-blue);
      outline-offset: 2px;
    }

    .btn-secondary {
      border-color: var(--border-subtle);
      background: #f9fafb;
      color: var(--dark-text);
    }

    .btn-secondary:hover {
      background: #e5e7eb;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary-blue), #163857);
      color: var(--white);
      border-color: transparent;
      box-shadow: 0 12px 28px rgba(15, 23, 42, 0.35);
    }

    .btn-primary:hover {
      filter: brightness(1.03);
      box-shadow: 0 16px 34px rgba(15, 23, 42, 0.4);
    }

    .btn-primary:disabled {
      opacity: 0.6;
      cursor: default;
      box-shadow: none;
    }

    .btn-ghost {
      border-color: transparent;
      background: transparent;
      color: var(--muted-text);
    }

    .btn-ghost:hover {
      color: var(--primary-blue);
    }

    .wizard-status-message {
      margin-top: 0.7rem;
      font-size: 0.8rem;
      min-height: 1.2em;
    }

    .wizard-status-message--success {
      color: var(--success-green);
    }

    .wizard-status-message--error {
      color: var(--error-red);
    }

    /* SUMMARY BOX (end of step 4) */

    .summary-box {
      margin-top: 0.9rem;
      padding: 0.8rem 0.9rem;
      border-radius: 0.7rem;
      background: #ecfdf5;
      border: 1px solid rgba(22, 163, 74, 0.45);
      font-size: 0.8rem;
      color: #14532d;
    }

    .summary-box strong {
      font-weight: 600;
    }

    /* RESPONSIVE */

    @media (max-width: 900px) {
      main {
        padding-top: 1.5rem;
      }

      .wizard-shell {
        grid-template-columns: minmax(0, 1fr);
      }

      .wizard-left {
        order: -1;
      }
    }

    @media (max-width: 600px) {
      .header-inner {
        flex-direction: column;
        align-items: flex-start;
      }

      .wizard-left,
      .wizard-right {
        padding: 1.1rem 1.1rem;
      }

      .step-dots {
        font-size: 0.65rem;
      }
    }

    .chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 14px;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.4rem 0.9rem;
      border-radius: 999px;
      border: 1px solid rgba(0, 0, 0, 0.12);
      background: #ffffff;
      font-size: 0.85rem;
      line-height: 1.2;
      cursor: pointer;
      user-select: none;
      white-space: nowrap;
      transition:
        background 0.15s ease,
        border-color 0.15s ease,
        color 0.15s ease,
        box-shadow 0.15s ease;
    }

    .chip.is-active {
      background: #e8f0fa !important;
      border-color: #1f4e79 !important;
      color: #1f4e79 !important;
      box-shadow: 0 0 0 2px rgba(31, 78, 121, 0.2) !important;
      font-weight: 600;
    }
  </style>
</head>
<body>
<div class="page">
  <!-- HEADER -->
  <header>
    <div class="header-inner">
      <div class="logo-wrap">
        <div class="logo-icon" aria-hidden="true"></div>
        <div>
          <div class="logo-main">TradeBotPro</div>
          <div class="logo-tag">More jobs. Less admin. Powered by AI.</div>
        </div>
      </div>
      <div class="header-note">
        Goal: make you <strong>wish you had signed up years ago</strong> in the first month.
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <main>
    <div class="wizard-shell">

      <!-- LEFT PANEL: OVERVIEW -->
      <aside class="wizard-left">
        <div class="wizard-progress-wrap">
          <div class="progress-label-row">
            <span><strong>Setup progress</strong></span>
            <span id="progress-percent">Step 1 of 4</span>
          </div>
          <div class="progress-bar-outer">
            <div id="progress-bar-inner" class="progress-bar-inner"></div>
          </div>
          <div class="step-dots">
            <div class="step-dot is-active" data-step-dot="1">
              <div class="step-dot-circle">1</div>
              <div class="step-dot-label">Business basics</div>
            </div>
            <div class="step-dot" data-step-dot="2">
              <div class="step-dot-circle">2</div>
              <div class="step-dot-label">Area &amp; pricing</div>
            </div>
            <div class="step-dot" data-step-dot="3">
              <div class="step-dot-circle">3</div>
              <div class="step-dot-label">Messaging &amp; reviews</div>
            </div>
            <div class="step-dot" data-step-dot="4">
              <div class="step-dot-circle">4</div>
              <div class="step-dot-label">Demo &amp; go-live</div>
            </div>
          </div>
        </div>

        <div class="wizard-title-kicker">Setup wizard</div>
        <h1 class="wizard-title">Let‚Äôs tune TradeBotPro to your business</h1>
        <p class="wizard-subtitle">
          This takes around 5‚Äì10 minutes. Your answers help us configure how TradeBotPro
          talks to customers, where it books jobs and which enquiries it chases hardest.
        </p>

        <ul class="wizard-benefits">
          <li>
            <span>‚ö°</span>
            <span><strong>Instant replies</strong> that feel like a real member of your team.</span>
          </li>
          <li>
            <span>üìç</span>
            <span><strong>Postcode-based coverage</strong> so you only quote in the areas you want.</span>
          </li>
          <li>
            <span>‚≠ê</span>
            <span><strong>Review follow-ups</strong> tuned to your preferred platform.</span>
          </li>
          <li>
            <span>üìÖ</span>
            <span><strong>Calendar-ready</strong> so confirmed jobs can drop straight into your diary.</span>
          </li>
        </ul>

        <div class="wizard-note">
          <strong>Important:</strong> This page is your setup wizard only ‚Äì nothing goes live
          to customers until you give the go-ahead. You‚Äôll get a full demo evening to test
          everything from your own phones first.
        </div>

        <div class="wizard-note">
          <strong>What happens next?</strong><br />
          Once this wizard is complete, we‚Äôll plug in your WhatsApp, build your first flows
          and set up your calendar links behind the scenes.
          <br /><br />
          During your demo evening:
          <ul>
            <li>You‚Äôll message yourself from a partner‚Äôs phone.</li>
            <li>TradeBotPro will reply like a real customer conversation.</li>
            <li>You‚Äôll even be able to book a test job into your diary.</li>
          </ul>
          <strong>Free trial offer:</strong><br />
          We can offer a short free trial after the demo for anyone who isn‚Äôt fully convinced
          yet ‚Äî your setup stays in place so it‚Äôs easy to switch on.
        </div>
      </aside>

      <!-- RIGHT PANEL: WIZARD STEPS -->
      <section class="wizard-right" aria-live="polite">
        <div class="wizard-right-header">
          <div id="wizard-step-label" class="wizard-step-label">Step 1</div>
          <h2 id="wizard-step-title" class="wizard-step-title">Business basics</h2>
          <p id="wizard-step-subtitle" class="wizard-step-subtitle">
            Who are you, what do you do and how do you like to run things?
          </p>
        </div>

        <!-- Step 1: Business basics -->
        <div class="step-panel is-active" data-step="1">
          <div class="field-group">
            <div class="field-label-row">
              <label for="contact_name">Main contact name</label>
              <span class="field-hint">Who TradeBotPro should refer to by name.</span>
            </div>
            <input id="contact_name" name="contact_name" type="text" autocomplete="name" />

          </div>

          <div class="field-group">
            <div class="field-label-row">
              <label for="business_name">Business name</label>
              <span class="field-hint">Exactly as you want it shown to customers.</span>
            </div>
            <input id="business_name" name="business_name" placeholder="Business name">

          </div>

          <div class="field-group">
            <div class="field-label-row">
              <label>What trade are you?</label>
              <span class="field-hint">Pick the closest match ‚Äì we‚Äôll fine-tune later.</span>
            </div>
            <div class="chip-row" data-field="main_trade" data-select="single">
              <button type="button" class="chip"><span>Plumbing &amp; heating</span></button>
              <button type="button" class="chip"><span>Heating only</span></button>
              <button type="button" class="chip"><span>Gas engineer</span></button>
              <button type="button" class="chip"><span>Electrician</span></button>
              <button type="button" class="chip"><span>Roofing &amp; guttering</span></button>
              <button type="button" class="chip"><span>Landscaping / gardening</span></button>
              <button type="button" class="chip"><span>Window cleaning</span></button>
              <button type="button" class="chip"><span>Cleaning / carpet cleaning</span></button>
              <button type="button" class="chip"><span>Builder</span></button>
              <button type="button" class="chip"><span>Handyman</span></button>
              <button type="button" class="chip"><span>Pest control</span></button>
              <button type="button" class="chip"><span>Home repairs &amp; maintenance</span></button>
              <button type="button" class="chip"><span>Other</span></button>
            </div>
          </div>

          <div class="field-group">
            <div class="field-label-row">
              <label>Where are you as a business?</label>
              <span class="field-hint">This just helps us set expectations on go-live.</span>
            </div>
            <div class="chip-row" data-field="business_stage" data-select="single">
              <button type="button" class="chip"><span>Already trading</span></button>
              <button type="button" class="chip"><span>Launching in next 3 months</span></button>
              <button type="button" class="chip"><span>Just exploring options</span></button>
            </div>
          </div>

          <div class="field-group">
            <div class="field-label-row">
              <label for="contact_email">Best email for setup &amp; reports</label>
              <span class="field-hint">We‚Äôll send onboarding details and monthly stats here.</span>
            </div>
            <input id="contact_email" name="email" type="email" autocomplete="email" />

          </div>

          <div class="field-group">
            <div class="field-label-row">
              <label for="contact_mobile">Mobile / WhatsApp number</label>
              <span class="field-hint">The main number customers currently use.</span>
            </div>
            <input id="contact_mobile" name="phone" type="tel" autocomplete="tel" />

          </div>
        </div>

        <!-- Step 2: Area & pricing -->
        <div class="step-panel" data-step="2">
          <div class="field-group">
            <div class="field-label-row">
              <label for="base_postcode">Base postcode</label>
              <span class="field-hint">We always work from postcode, not town.</span>
            </div>
           <input id="base_postcode" name="base_postcode" type="text" ... />

          </div>

          <div class="field-group">
            <div class="field-label-row">
              <label>Where do you want TradeBotPro to quote?</label>
              <span class="field-hint">We‚Äôll filter enquiries outside your preferred area.</span>
            </div>
            <div class="chip-row" data-field="coverage_radius" data-select="single">
              <button type="button" class="chip"><span>Just my town / city</span></button>
              <button type="button" class="chip"><span>Up to ~10 miles from base</span></button>
              <button type="button" class="chip"><span>Up to ~20 miles from base</span></button>
              <button type="button" class="chip"><span>City-wide / multiple postcodes</span></button>
              <button type="button" class="chip"><span>Custom list (we‚Äôll import later)</span></button>
            </div>
          </div>

          <div class="field-group">
            <div class="field-label-row">
              <label>How do you usually charge call-outs?</label>
              <span class="field-hint">Helps the AI give sensible ballpark prices.</span>
            </div>
            <div class="chip-row" data-field="callout_style" data-select="single">
              <button type="button" class="chip"><span>Free estimates (no call-out fee)</span></button>
              <button type="button" class="chip"><span>Paid call-out, deducted from job</span></button>
              <button type="button" class="chip"><span>Fixed call-out fee</span></button>
              <button type="button" class="chip"><span>No emergency call-outs</span></button>
            </div>
          </div>

          <div class="field-group">
            <div class="field-label-row">
              <label>Typical call-out fee band</label>
              <span class="field-hint">We can refine by job type later.</span>
            </div>
            <div class="chip-row" data-field="callout_band" data-select="single">
              <button type="button" class="chip"><span>Up to ¬£79</span></button>
              <button type="button" class="chip"><span>¬£80‚Äì¬£119</span></button>
              <button type="button" class="chip"><span>¬£120‚Äì¬£179</span></button>
              <button type="button" class="chip"><span>¬£180+</span></button>
              <button type="button" class="chip"><span>Varies ‚Äì discuss with us</span></button>
            </div>
          </div>

          <div class="field-group">
            <div class="field-label-row">
              <label>Which jobs do you want more of?</label>
              <span class="field-hint">TradeBotPro can prioritise the work you enjoy.</span>
            </div>
            <div class="chip-row" data-field="preferred_jobs" data-select="multi">
              <button type="button" class="chip chip-multi"><span>Emergency / urgent jobs</span></button>
              <button type="button" class="chip chip-multi"><span>Small jobs / quick wins</span></button>
              <button type="button" class="chip chip-multi"><span>Bigger projects / installs</span></button>
              <button type="button" class="chip chip-multi"><span>Maintenance / servicing</span></button>
              <button type="button" class="chip chip-multi"><span>Landlords / repeat clients</span></button>
            </div>
          </div>
        </div>

        <!-- Step 3: Messaging & reviews -->
        <div class="step-panel" data-step="3">
          <div class="field-group">
            <div class="field-label-row">
              <label>How should TradeBotPro sound?</label>
              <span class="field-hint">We‚Äôll match your tone of voice.</span>
            </div>
            <div class="chip-row" data-field="tone_of_voice" data-select="single">
              <button type="button" class="chip"><span>Friendly &amp; informal</span></button>
              <button type="button" class="chip"><span>Professional &amp; straight to the point</span></button>
              <button type="button" class="chip"><span>Premium / high-end feel</span></button>
              <button type="button" class="chip"><span>Very short &amp; efficient</span></button>
              <button type="button" class="chip"><span>We‚Äôll decide together</span></button>
            </div>
          </div>

          <div class="field-group">
            <div class="field-label-row">
              <label>Which channels should we start with?</label>
              <span class="field-hint">You can add more later.</span>
            </div>
            <div class="chip-row" data-field="channels" data-select="multi">
              <button type="button" class="chip chip-multi"><span>WhatsApp</span></button>
              <button type="button" class="chip chip-multi"><span>SMS / text messages</span></button>
              <button type="button" class="chip chip-multi"><span>Facebook Messenger</span></button>
              <button type="button" class="chip chip-multi"><span>Website chat widget</span></button>
              <button type="button" class="chip chip-multi"><span>Instagram DMs</span></button>
            </div>
          </div>

          <div class="field-group">
            <div class="field-label-row">
              <label>Which review platform do you use or want to use?</label>
              <span class="field-hint">We‚Äôll send customers there automatically after jobs.</span>
            </div>
            <div class="chip-row" data-field="review_platforms" data-select="multi">
              <button type="button" class="chip chip-multi"><span>Google Reviews</span></button>
              <button type="button" class="chip chip-multi"><span>Trustpilot</span></button>
              <button type="button" class="chip chip-multi"><span>Facebook page reviews</span></button>
              <button type="button" class="chip chip-multi"><span>Yell / similar directories</span></button>
              <button type="button" class="chip chip-multi"><span>Checkatrade / trade portals</span></button>
            </div>
          </div>

          <div class="field-group">
            <div class="field-label-row">
              <label for="review_link">Paste your main review link (optional)</label>
              <span class="field-hint">We‚Äôll wire this into your follow-up messages.</span>
            </div>
            <input id="review_link" name="review_link" type="text" ... />

          </div>

          <div class="field-group">
            <div class="field-label-row">
              <label>How hard should we push for reviews?</label>
              <span class="field-hint">You stay in control ‚Äì no over-the-top nagging.</span>
            </div>
            <div class="chip-row" data-field="review_push_level" data-select="single">
              <button type="button" class="chip"><span>Very gentle reminder only</span></button>
              <button type="button" class="chip"><span>Standard follow-up &amp; one reminder</span></button>
              <button type="button" class="chip"><span>Quite proactive (several reminders)</span></button>
            </div>
          </div>

          <div class="field-group">
            <div class="field-label-row">
              <label for="ai_avoid">Anything you never want the AI to say?</label>
              <span class="field-hint">Phrases, promises or situations to avoid.</span>
            </div>
           <textarea id="ai_avoid" name="ai_avoid" ...></textarea>

          </div>
        </div>

        <!-- Step 4: Demo & go-live -->
        <div class="step-panel" data-step="4">
          <div class="field-group">
            <div class="field-label-row">
              <label>How would you like to run your demo?</label>
              <span class="field-hint">We‚Äôll set up a ‚Äútest evening‚Äù for you and your partner/team.</span>
            </div>
            <div class="chip-row" data-field="demo_style" data-select="multi">
              <button type="button" class="chip chip-multi"><span>Test from our own phones first</span></button>
              <button type="button" class="chip chip-multi"><span>Test with a few real customers</span></button>
              <button type="button" class="chip chip-multi"><span>Test calendar bookings</span></button>
              <button type="button" class="chip chip-multi"><span>Test review follow-up flow</span></button>
            </div>
          </div>

          <div class="field-group">
            <div class="field-label-row">
              <label>Preferred evening to test from your own phones</label>
              <span class="field-hint">So you can send messages from one phone to the other and see it in action.</span>
            </div>
            <div class="chip-row" data-field="demo_slot" data-select="single">
              <button type="button" class="chip"><span>Weekday ‚Äì 6‚Äì8pm</span></button>
              <button type="button" class="chip"><span>Weekday ‚Äì 8‚Äì10pm</span></button>
              <button type="button" class="chip"><span>Weekend evening</span></button>
              <button type="button" class="chip"><span>Daytime (I‚Äôm flexible)</span></button>
            </div>
          </div>

          <div class="field-group">
            <div class="field-label-row">
              <label>Roughly when do you want to go fully live?</label>
              <span class="field-hint">Purely for planning ‚Äì nothing switches on without your say-so.</span>
            </div>
            <div class="chip-row" data-field="golive_timing" data-select="single">
              <button type="button" class="chip"><span>Within 1 week of the demo</span></button>
              <button type="button" class="chip"><span>Within 1 month</span></button>
              <button type="button" class="chip"><span>Later ‚Äì just getting ready</span></button>
            </div>
          </div>

          <div class="field-group">
            <div class="field-label-row">
              <label for="extra_notes">Anything else we should know before we build your setup?</label>
              <span class="field-hint">Special rules, pricing quirks, calendars you use, etc.</span>
            </div>
            <textarea id="extra_notes" name="extra_notes" ...></textarea>

          </div>

          <div class="summary-box" id="summary-box" hidden>
            <strong>Nice work ‚Äì that‚Äôs your wizard complete.</strong><br />
            Your answers will be saved to your TradeBotPro profile and used to configure
            your AI assistant, calendar connection and review follow-ups. We‚Äôll confirm
            your demo evening and go-live plan with you before anything switches on.
          </div>
        </div>

        <!-- FOOTER ACTIONS -->
        <div class="wizard-footer">
          <div class="wizard-footer-left">
            <span id="wizard-footer-text">
              Step <strong>1</strong> of <strong>4</strong>. You can tweak anything later.
            </span>
          </div>
          <div class="wizard-footer-right">
            <button type="button" class="btn btn-ghost" id="btn-save-draft">
              Save draft (browser only for now)
            </button>
            <button type="button" class="btn btn-secondary" id="btn-back" disabled>
              ‚Üê Back
            </button>
            <button type="button" class="btn btn-primary" id="btn-next">
              Next step ‚Üí</button>
          </div>
        </div>

        <div id="wizard-status-message" class="wizard-status-message"></div>
      </section>
    </div>
  </main>
</div>
<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

/* ================= CONFIG ================= */
const SUPABASE_URL = "https://yaiutswdcbfwkxfqxkzy.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlhaXV0c3dkY2Jmd2t4ZnF4a3p5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1MDE2MDgsImV4cCI6MjA4MDA3NzYwOH0.HOLFxzjsZ5Ieqg0b-aTdP0hAdLsPVXL6Zjs-HgOHgc8"; // <-- put your anon key
const TABLE = "customers";
const DASHBOARD_URL = "dashboard.html"; // <-- change if needed
const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ================= HELPERS ================= */
const $ = (s, r=document) => r.querySelector(s);
const $$ = (s, r=document) => [...r.querySelectorAll(s)];
const esc = (s)=>{ try{ return CSS.escape(s); }catch{ return s; } };
const qp = (n)=> new URLSearchParams(location.search).get(n);

function logErr(...a){ console.error(...a); }
function status(msg, kind="info"){
  const el = $("#wizard-status-message");
  if(el){
    el.textContent = msg;
    el.dataset.kind = kind;
  }
  console.log(`[Wizard] ${msg}`);
}

/* ================= STATE ================= */
let CUSTOMER_ID = qp("customer_id");
let LOCKED = false;        // read-only view mode when complete
let EDIT_MODE = false;     // true only after Unlock
let ORIGINAL = null;
let saving = false;
let dirty = false;

/* ================= ROOT ================= */
function getRoot(){
  return $(".wizard-shell") || document.body;
}

/* ================= EXIT BUTTON ================= */
function ensureExitButton(){
  // Adds button without changing your HTML layout
  if($("#btn-exit-wizard")) return;

  // best place: wizard footer right side (beside Next)
  const footerRight = $(".wizard-footer-right");
  const footer = $(".wizard-footer");
  const host = footerRight || footer || getRoot();

  const btn = document.createElement("button");
  btn.type = "button";
  btn.id = "btn-exit-wizard";
  btn.className = "btn btn-ghost";
  btn.textContent = "Back to dashboard";
  btn.style.marginLeft = "10px";

  // place it after Next if possible
  if(footerRight){
    footerRight.appendChild(btn);
  }else{
    host.appendChild(btn);
  }

  btn.addEventListener("click", ()=>{
    // If user is editing and has unsaved changes, warn
    if((EDIT_MODE || !LOCKED) && dirty){
      const ok = confirm("Leave wizard without saving your latest changes?");
      if(!ok) return;
    }
    window.location.href = DASHBOARD_URL;
  });
}

/* ================= FORM / DIRTY TRACKING ================= */
function markDirty(){ dirty = true; }

function bindDirtyTracking(){
  const root = getRoot();

  // mark dirty on any input/textarea/select change
  root.addEventListener("input", (e)=>{
    const el = e.target;
    if(!el) return;
    // ignore hidden
    if(el.type === "hidden") return;
    markDirty();
  }, true);

  root.addEventListener("change", (e)=>{
    const el = e.target;
    if(!el) return;
    if(el.type === "hidden") return;
    markDirty();
  }, true);
}

/* ================= FIELD SNAPSHOT ================= */
function findNamedFields(){
  const root = getRoot();
  const fields = [];

  $$("[name]", root).forEach(el=>{
    if(el.tagName === "BUTTON") return;
    fields.push(el);
  });

  $$("input[id],textarea[id],select[id]", root).forEach(el=>{
    if(el.name) return;
    fields.push(el);
  });

  return fields;
}
function snapshot(){
  const root = getRoot();
  const o = {};

  $$("input[name],textarea[name],select[name]", root).forEach(el=>{
    if(el.type === "button") return;
    o[el.name] = el.value ?? "";
  });

  $$('input[type="hidden"][name]', root).forEach(el=>{
    o[el.name] = el.value ?? "";
  });

  $$("input[id],textarea[id],select[id]", root).forEach(el=>{
    if(el.name) return;
    const key = el.id;
    if(!key) return;
    if(o[key] === undefined) o[key] = el.value ?? "";
  });

  return o;
}

/* ================= CHIPS ================= */
function ensureChipHiddens(){
  const root = getRoot();
  $$(".chip-row[data-field]", root).forEach(row=>{
    const field = row.dataset.field;
    if(!field) return;
    const existing = $(`input[type="hidden"][name="${esc(field)}"]`, root);
    if(existing) return;
    const h = document.createElement("input");
    h.type = "hidden";
    h.name = field;
    row.insertAdjacentElement("afterend", h);
  });
}
function syncChipRow(row){
  const root = getRoot();
  const field = row.dataset.field;
  const hidden = $(`input[type="hidden"][name="${esc(field)}"]`, root);
  if(!hidden) return;

  const selected = $$(".chip.is-selected,.chip.is-active", row)
    .map(b=>b.textContent.trim())
    .filter(Boolean);

  const mode = (row.dataset.select || "single").toLowerCase();
  hidden.value = (mode === "multi") ? JSON.stringify(selected) : (selected[0] || "");
}
function syncAllChips(){
  const root = getRoot();
  $$(".chip-row[data-field]", root).forEach(syncChipRow);
}
function wireChipClicks(){
  document.addEventListener("click", (e)=>{
    const chip = e.target.closest(".chip");
    if(!chip) return;

    const row = chip.closest(".chip-row[data-field]");
    if(!row) return;

    e.preventDefault();

    // locked view mode blocks selection unless unlocked
    if(LOCKED && !EDIT_MODE) return;

    const mode = (row.dataset.select || "single").toLowerCase();

    if(mode === "single"){
      $$(".chip", row).forEach(b=>{
        b.classList.remove("is-selected","is-active");
        b.setAttribute("aria-pressed","false");
      });
      chip.classList.add("is-selected","is-active");
      chip.setAttribute("aria-pressed","true");
    }else{
      const on = chip.classList.toggle("is-selected");
      chip.classList.toggle("is-active", on);
      chip.setAttribute("aria-pressed", on ? "true" : "false");
    }

    syncChipRow(row);
    markDirty();
  });
}
function loadChips(data){
  const root = getRoot();
  $$(".chip-row[data-field]", root).forEach(row=>{
    const field = row.dataset.field;
    const hidden = $(`input[type="hidden"][name="${esc(field)}"]`, root);
    if(!hidden) return;

    const raw = (data?.[field] ?? "").toString().trim();
    hidden.value = raw;

    let vals = [];
    if(raw.startsWith("[")){
      try { vals = JSON.parse(raw) || []; } catch { vals = []; }
    } else if(raw) vals = [raw];

    $$(".chip", row).forEach(b=>{
      const on = vals.includes(b.textContent.trim());
      b.classList.toggle("is-selected", on);
      b.classList.toggle("is-active", on);
      b.setAttribute("aria-pressed", on ? "true" : "false");
    });
  });
}

/* ================= LOCK / UNLOCK ================= */
function setReadOnly(on){
  const root = getRoot();
  $$("input,textarea", root).forEach(el=>{
    if(el.type === "hidden") return;
    el.readOnly = !!on;
  });
  $$("select", root).forEach(el=> el.disabled = !!on);
}

function ensureUnlockUI(){
  if($("#btn-unlock")) return;

  const host = $("#wizard-status-message")?.parentElement || getRoot();
  const bar = document.createElement("div");
  bar.style.display = "flex";
  bar.style.gap = "10px";
  bar.style.marginTop = "12px";
  bar.innerHTML = `
    <button id="btn-unlock" type="button" class="btn btn-secondary">Unlock to edit</button>
    <button id="btn-relock" type="button" class="btn btn-ghost">Re-lock</button>
    <button id="btn-cancel" type="button" class="btn btn-ghost">Cancel edits</button>
  `;
  host.insertAdjacentElement("afterend", bar);

  $("#btn-unlock").addEventListener("click", ()=>{
    EDIT_MODE = true;
    setReadOnly(false);
    showSave(true);
    updateUnlockUI();
    status("Unlocked ‚Äî editable.", "info");
  });

  $("#btn-relock").addEventListener("click", ()=>{
    EDIT_MODE = false;
    if(LOCKED){
      setReadOnly(true);
      showSave(false);
      status("Locked ‚Äî read-only.", "info");
    }else{
      setReadOnly(false);
      showSave(true);
      status("Still incomplete ‚Äî editable.", "info");
    }
    updateUnlockUI();
  });

  $("#btn-cancel").addEventListener("click", ()=>{
    if(!ORIGINAL) return;
    const root = getRoot();

    Object.entries(ORIGINAL).forEach(([k,v])=>{
      const el = $(`[name="${esc(k)}"],#${esc(k)}`, root);
      if(el && el.type !== "hidden") el.value = v ?? "";
    });

    loadChips(ORIGINAL);

    dirty = false;
    EDIT_MODE = false;
    if(LOCKED){
      setReadOnly(true);
      showSave(false);
      status("Changes discarded (read-only).", "info");
    }else{
      setReadOnly(false);
      showSave(true);
      status("Changes discarded.", "info");
    }
    updateUnlockUI();
  });
}

function updateUnlockUI(){
  const u = $("#btn-unlock");
  const r = $("#btn-relock");
  const c = $("#btn-cancel");
  if(!u || !r || !c) return;

  if(LOCKED && !EDIT_MODE){
    u.style.display = "";
    r.style.display = "none";
    c.style.display = "none";
  }else{
    u.style.display = "none";
    r.style.display = "";
    c.style.display = "";
  }
}

/* ================= SAVE BUTTON LABEL ================= */
function showSave(on){
  const b = $("#btn-save-draft");
  if(!b) return;
  b.style.display = on ? "" : "none";
  b.textContent = "Save";
}
function setSaveState(state){
  const b = $("#btn-save-draft");
  if(!b) return;

  if(state === "saving"){
    b.disabled = true;
    b.textContent = "Saving‚Ä¶";
  }else if(state === "saved"){
    b.disabled = true;
    b.textContent = "Saved ‚úì";
    setTimeout(()=>{ b.disabled = false; b.textContent = "Save"; }, 800);
  }else{
    b.disabled = false;
    b.textContent = "Save";
  }
}

/* ================= COMPLETION RULE ================= */
function isWizardComplete(data){
  const business = String(data.business_name || data.business || "").trim();
  const email = String(data.email || data.contact_email || "").trim();
  const trade = String(data.main_trade || "").trim();
  return !!(business && email && trade);
}

/* ================= PATCH BUILDER (AUTO OPS FLAGS) ================= */
function buildCustomerPatchFromForm(){
  syncAllChips();
  const data = snapshot();

  if(data.contact_mobile && !data.phone) data.phone = data.contact_mobile;
  if(data.contact_email && !data.email) data.email = data.contact_email;

  const complete = isWizardComplete(data);

  data.setup_complete = complete;
  data.pending_setup = !complete;
  data.wizard_completed = complete;

  const currentStage = String(data.onboarding_status || "").trim();
  if(complete){
    if(!currentStage || currentStage === "New Signup"){
      data.onboarding_status = "In Setup";
    }
    if(!data.setup_completed_at) data.setup_completed_at = new Date().toISOString();
  }else{
    if(!currentStage) data.onboarding_status = "New Signup";
  }

  data.updated_at = new Date().toISOString();
  return { data, complete };
}

/* ================= LOAD + PREFILL ================= */
async function loadCustomer(id){
  const { data, error } = await sb.from(TABLE).select("*").eq("id", id).maybeSingle();
  if(error){
    logErr("[Wizard] Load error:", error);
    status(`Load failed: ${error.message}`, "error");
    return null;
  }
  if(!data){
    status("Customer not found.", "error");
    return null;
  }

  const root = getRoot();
  Object.entries(data).forEach(([k,v])=>{
    const el = $(`[name="${esc(k)}"],#${esc(k)}`, root);
    if(el && el.type !== "hidden") el.value = v ?? "";
  });

  loadChips(data);
  ORIGINAL = { ...data, ...snapshot() };
  dirty = false;
  return data;
}

/* ================= 2.1 BACKFILL ON LOAD ================= */
async function backfillWizardFlagsOnLoad(row){
  if(!row || !CUSTOMER_ID) return row;

  const setupComplete = !!row.setup_complete;
  const wizardCompleted = !!row.wizard_completed;
  const pendingSetup = !!row.pending_setup;
  const stage = String(row.onboarding_status || "").trim();

  const shouldBeComplete = setupComplete || wizardCompleted;
  const shouldPending = !shouldBeComplete;

  const patch = {};

  if(shouldBeComplete && (!setupComplete || !wizardCompleted)){
    patch.setup_complete = true;
    patch.wizard_completed = true;
  }
  if(!shouldBeComplete && (setupComplete || wizardCompleted)){
    patch.setup_complete = false;
    patch.wizard_completed = false;
  }

  if(pendingSetup !== shouldPending){
    patch.pending_setup = shouldPending;
  }

  if(shouldBeComplete && (!stage || stage === "New Signup")){
    patch.onboarding_status = "In Setup";
  }
  if(!shouldBeComplete && !stage){
    patch.onboarding_status = "New Signup";
  }

  if(shouldBeComplete && !row.setup_completed_at){
    patch.setup_completed_at = new Date().toISOString();
  }

  if(Object.keys(patch).length === 0) return row;

  patch.updated_at = new Date().toISOString();

  const { error } = await sb.from(TABLE).update(patch).eq("id", CUSTOMER_ID);
  if(error){
    console.warn("[Wizard] Backfill skipped (error):", error);
    return row;
  }

  return { ...row, ...patch };
}

/* ================= SAVE TO SUPABASE ================= */
async function saveToSupabase(){
  if(saving) return;
  saving = true;

  try{
    if(LOCKED && !EDIT_MODE){
      status("Wizard is complete (read-only). Click Unlock to edit.", "info");
      return;
    }

    if(!findNamedFields().length){
      status("No fields found on page (check your HTML ids/names).", "error");
      return;
    }

    setSaveState("saving");

    if(!CUSTOMER_ID){
      status("Missing customer_id. Open from dashboard using ?customer_id=...", "error");
      setSaveState("idle");
      return;
    }

    const { data: patch, complete } = buildCustomerPatchFromForm();

    const { error } = await sb.from(TABLE).update(patch).eq("id", CUSTOMER_ID);
    if(error){
      logErr("[Wizard] Save error:", error);
      status(`Save failed: ${error.message}`, "error");
      setSaveState("idle");
      return;
    }

    ORIGINAL = { ...patch };
    dirty = false;

    if(complete){
      LOCKED = true;
      EDIT_MODE = false;
      setReadOnly(true);
      showSave(false);
      status("üîí Setup Wizard complete ‚Äî saved to Supabase ‚úÖ", "success");
    }else{
      LOCKED = false;
      setReadOnly(false);
      showSave(true);
      status("Saved to Supabase ‚úÖ", "success");
    }

    updateUnlockUI();
    setSaveState("saved");
  } finally {
    saving = false;
  }
}

/* ================= STEP NAV ================= */
function getActiveStepPanel(){ return $(".step-panel.is-active"); }
function getActiveStep(){
  const p = getActiveStepPanel();
  return p ? Number(p.dataset.step) : 1;
}
function showStep(n){
  const step = Math.max(1, Math.min(4, n));
  $$(".step-panel").forEach(p=>p.classList.toggle("is-active", Number(p.dataset.step)===step));
  $$(".step-dot").forEach(d=>d.classList.toggle("is-active", Number(d.dataset.stepDot)===step));

  const back = $("#btn-back");
  if(back) back.disabled = (step === 1);

  const next = $("#btn-next");
  if(next) next.textContent = (step === 4 ? "Finish ‚Üí" : "Next step ‚Üí");

  const pct = $("#progress-percent");
  if(pct) pct.textContent = `Step ${step} of 4`;

  const bar = $("#progress-bar-inner");
  if(bar) bar.style.width = `${Math.round((step/4)*100)}%`;

  const ft = $("#wizard-footer-text");
  if(ft) ft.innerHTML = `Step <strong>${step}</strong> of <strong>4</strong>. You can tweak anything later.`;
}
function nextStep(){ showStep(getActiveStep()+1); }
function prevStep(){ showStep(getActiveStep()-1); }

/* ================= INIT ================= */
async function init(){
  ensureExitButton();
  ensureChipHiddens();
  wireChipClicks();
  ensureUnlockUI();
  bindDirtyTracking();

  // rename button from "Save draft..." to "Save"
  showSave(true);

  if(!CUSTOMER_ID){
    status("Missing customer_id. Open this from dashboard (Open wizard).", "error");
    LOCKED = false;
    EDIT_MODE = true;
    setReadOnly(false);
    updateUnlockUI();
    return;
  }

  let row = await loadCustomer(CUSTOMER_ID);
  if(!row) return;

  // ‚úÖ 2.1 backfill on load
  row = await backfillWizardFlagsOnLoad(row);

  const complete = !!row.setup_complete || !!row.wizard_completed;

  if(complete){
    LOCKED = true;
    EDIT_MODE = false;
    setReadOnly(true);
    showSave(false);
    status("üîí Setup Wizard complete ‚Äî read-only view.", "info");
  }else{
    LOCKED = false;
    EDIT_MODE = true;
    setReadOnly(false);
    showSave(true);
    status("[Wizard] Resumed ‚Äî editable.", "info");
  }

  updateUnlockUI();

  $("#btn-save-draft")?.addEventListener("click", (e)=>{
    e.preventDefault();
    saveToSupabase();
  });

  $("#btn-next")?.addEventListener("click", async (e)=>{
    e.preventDefault();
    await saveToSupabase();
    nextStep();
  });

  $("#btn-back")?.addEventListener("click", (e)=>{
    e.preventDefault();
    prevStep();
  });

  if(!getActiveStepPanel()){
    const first = $(".step-panel[data-step='1']");
    if(first) first.classList.add("is-active");
  }
  showStep(getActiveStep());
}

document.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>

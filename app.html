<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TradeBotPro – Set up your AI office</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta
    name="description"
    content="TradeBotPro business profile setup – update your pricing, service area and AI preferences."
  />
  <style>
    :root {
      --primary-blue: #1f4e79;
      --accent-blue: #00a3ff;
      --dark-text: #1b1b1f;
      --light-bg: #f5f7fa;
      --white: #ffffff;
      --border-subtle: rgba(0,0,0,0.08);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      background: var(--light-bg);
      color: var(--dark-text);
      line-height: 1.6;
    }

    a {
      color: inherit;
      text-decoration: none;
    }

    .page {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: var(--white);
      border-bottom: 1px solid var(--border-subtle);
    }

    .inner {
      max-width: 980px;
      margin: 0 auto;
      padding: 0 1.25rem;
    }

    .nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 0;
    }

    .logo-wrap {
      display: flex;
      align-items: center;
      gap: 0.6rem;
    }

    .logo-icon {
      width: 30px;
      height: 30px;
      border-radius: 9px;
      background: var(--primary-blue);
      position: relative;
    }

    .logo-icon::before,
    .logo-icon::after {
      content: "";
      position: absolute;
      background: var(--white);
      border-radius: 4px;
    }

    .logo-icon::before {
      width: 11px;
      height: 17px;
      left: 7px;
      top: 6px;
    }

    .logo-icon::after {
      width: 5px;
      height: 11px;
      right: 7px;
      top: 9px;
    }

    .logo-main {
      font-weight: 700;
      font-size: 1rem;
      color: var(--primary-blue);
    }

    .logo-tag {
      font-size: 0.7rem;
      opacity: 0.7;
    }

    main {
      flex: 1;
      padding: 2rem 0 3rem;
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1.15fr) minmax(0, 0.85fr);
      gap: 1.75rem;
      align-items: flex-start;
    }

    @media (max-width: 840px) {
      .layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    h1 {
      margin: 0 0 0.6rem;
      font-size: 1.6rem;
      color: var(--primary-blue);
    }

    .subheading {
      margin: 0 0 1.1rem;
      font-size: 0.98rem;
      max-width: 32rem;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.2rem 0.7rem;
      border-radius: 999px;
      background: #e4eef8;
      color: var(--primary-blue);
      font-size: 0.78rem;
      margin-bottom: 0.75rem;
    }

    .status-line {
      font-size: 0.85rem;
      margin-bottom: 1rem;
      padding: 0.6rem 0.75rem;
      border-radius: 0.6rem;
      background: #edf4ff;
      border: 1px solid rgba(31,78,121,0.18);
    }

    .status-line.error {
      background: #fff4f4;
      border-color: #e68a8a;
      color: #7d1616;
    }

    .status-line.ok {
      background: #ecfdf3;
      border-color: #68b97a;
      color: #155724;
    }

    .card {
      background: var(--white);
      border-radius: 1rem;
      padding: 1.3rem 1.4rem;
      box-shadow: 0 12px 30px rgba(0,0,0,0.06);
      font-size: 0.9rem;
    }

    .card h2 {
      margin: 0 0 0.8rem;
      font-size: 1.15rem;
      color: var(--primary-blue);
    }

    .card + .card {
      margin-top: 1rem;
    }

    form {
      margin-top: 0.25rem;
    }

    .field-group {
      margin-bottom: 0.85rem;
    }

    .field-row {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.8rem;
    }

    @media (max-width: 640px) {
      .field-row {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    label {
      display: block;
      font-size: 0.8rem;
      font-weight: 500;
      margin-bottom: 0.25rem;
    }

    label span.help {
      font-weight: 400;
      opacity: 0.7;
      font-size: 0.78rem;
      margin-left: 0.15rem;
    }

    input,
    select,
    textarea {
      width: 100%;
      padding: 0.55rem 0.65rem;
      border-radius: 0.5rem;
      border: 1px solid rgba(0,0,0,0.16);
      font: inherit;
    }

    input:focus,
    select:focus,
    textarea:focus {
      outline: 2px solid rgba(31,78,121,0.4);
      border-color: transparent;
    }

    textarea {
      min-height: 70px;
      resize: vertical;
    }

    .chips-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.35rem;
      margin-bottom: 0.4rem;
    }

    .chip {
      padding: 0.25rem 0.6rem;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.18);
      font-size: 0.78rem;
      cursor: pointer;
      background: #f8fafc;
    }

    .chip.selected {
      background: #1f4e79;
      color: #fff;
      border-color: #1f4e79;
    }

    .btn-primary {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.75rem 1.3rem;
      border-radius: 999px;
      border: none;
      background: var(--primary-blue);
      color: #fff;
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: default;
    }

    .btn-primary:hover:not(:disabled) {
      background: #163857;
    }

    .small {
      font-size: 0.8rem;
      opacity: 0.75;
      margin-top: 0.5rem;
    }

    footer {
      border-top: 1px solid var(--border-subtle);
      background: var(--white);
      font-size: 0.8rem;
    }

    .footer-inner {
      padding: 1.1rem 1.25rem 1.3rem;
      display: flex;
      justify-content: space-between;
      gap: 1rem;
      flex-wrap: wrap;
      align-items: center;
    }

    .muted {
      opacity: 0.7;
    }
  </style>
</head>
<body>
<div class="page">
  <header>
    <div class="inner">
      <div class="nav">
        <div class="logo-wrap">
          <div class="logo-icon" aria-hidden="true"></div>
          <div>
            <div class="logo-main">TradeBotPro</div>
            <div class="logo-tag">AI office assistant for trades</div>
          </div>
        </div>
        <div class="muted" style="font-size:0.8rem;">
          Profile link ID: <span id="debug-user-id">—</span>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="inner">
      <div class="layout">
        <div>
          <div class="pill">Step 1 · Business profile</div>
          <h1>Tell TradeBotPro how your business runs</h1>
          <p class="subheading">
            This page lets you update the key details your AI office will use for
            quoting, call-outs and messages. You can change this any time.
          </p>

          <div id="status" class="status-line">
            Loading your details…
          </div>

          <div class="card">
            <h2>Business & contact details</h2>
            <form id="profile-form">
              <div class="field-group field-row">
                <div>
                  <label for="business_name">Business name</label>
                  <input id="business_name" name="business_name" type="text" autocomplete="organization" />
                </div>
                <div>
                  <label for="contact_name">Main contact name</label>
                  <input id="contact_name" name="contact_name" type="text" autocomplete="name" />
                </div>
              </div>

              <div class="field-group field-row">
                <div>
                  <label for="email">Email</label>
                  <input id="email" name="email" type="email" autocomplete="email" />
                </div>
                <div>
                  <label for="whatsapp_number">Mobile / WhatsApp</label>
                  <input id="whatsapp_number" name="whatsapp_number" type="tel" autocomplete="tel" />
                </div>
              </div>

              <div class="field-group">
                <label for="phone">Optional landline</label>
                <input id="phone" name="phone" type="tel" autocomplete="tel" />
              </div>

              <div class="field-group field-row">
                <div>
                  <label for="trade_type">Trade</label>
                  <select id="trade_type" name="trade_type">
                    <option value="">Select your trade…</option>
                    <option>Plumber</option>
                    <option>Heating Engineer</option>
                    <option>Gas Engineer</option>
                    <option>Electrician</option>
                    <option>Builder</option>
                    <option>Handyman</option>
                    <option>Landscaper / Gardener</option>
                    <option>Cleaner / Carpet Cleaner</option>
                    <option>Pest Control</option>
                    <option>Other</option>
                  </select>
                </div>
                <div>
                  <label for="base_postcode">Base postcode</label>
                  <input id="base_postcode" name="base_postcode" type="text" />
                </div>
              </div>

              <div class="field-group">
                <label for="website_url">Website (if you have one)</label>
                <input id="website_url" name="website_url" type="url" />
              </div>

              <div class="field-group field-row">
                <div>
                  <label for="service_radius">
                    Service radius
                    <span class="help">(e.g. “15 miles from OX2”)</span>
                  </label>
                  <input id="service_radius" name="service_radius" type="text" />
                </div>
                <div>
                  <label for="callout_from">
                    Call-out from
                    <span class="help">(usual starting town / depot)</span>
                  </label>
                  <input id="callout_from" name="callout_from" type="text" />
                </div>
              </div>

              <div class="card">
                <h2>Pricing basics</h2>
                <div class="field-group field-row">
                  <div>
                    <label for="callout_fee">Standard call-out fee (£)</label>
                    <input id="callout_fee" name="callout_fee" type="number" step="0.01" />
                  </div>
                  <div>
                    <label for="first_hour_rate">First hour rate (£)</label>
                    <input id="first_hour_rate" name="first_hour_rate" type="number" step="0.01" />
                  </div>
                </div>

                <div class="field-group field-row">
                  <div>
                    <label for="hourly_rate">Hourly rate after first hour (£)</label>
                    <input id="hourly_rate" name="hourly_rate" type="number" step="0.01" />
                  </div>
                  <div>
                    <label for="boiler_service_from">Boiler service from (£)</label>
                    <input id="boiler_service_from" name="boiler_service_from" type="number" step="0.01" />
                  </div>
                </div>

                <div class="field-group">
                  <label for="quote_minimum">Minimum job value / quote (£)</label>
                  <input id="quote_minimum" name="quote_minimum" type="number" step="0.01" />
                </div>

                <div class="field-group">
                  <label for="pricing_notes">
                    Pricing notes
                    <span class="help">(anything your AI should know about evenings, weekends, emergencies)</span>
                  </label>
                  <textarea id="pricing_notes" name="pricing_notes"></textarea>
                </div>
              </div>

              <div class="card">
                <h2>What should your AI office focus on?</h2>

                <div class="field-group">
                  <label>
                    Quick picks
                    <span class="help">(choose as many as you like)</span>
                  </label>
                  <div id="focus-chips" class="chips-row">
                    <button type="button" class="chip" data-value="New enquiries & first response">
                      New enquiries & first response
                    </button>
                    <button type="button" class="chip" data-value="Quoting & rough estimates">
                      Quoting & rough estimates
                    </button>
                    <button type="button" class="chip" data-value="Booking jobs into the diary">
                      Booking jobs into the diary
                    </button>
                    <button type="button" class="chip" data-value="Out-of-hours & weekend cover">
                      Out-of-hours & weekend cover
                    </button>
                    <button type="button" class="chip" data-value="Chasing reviews & follow-ups">
                      Chasing reviews & follow-ups
                    </button>
                    <button type="button" class="chip" data-value="Filtering time-wasters / bad jobs">
                      Filtering time-wasters / bad jobs
                    </button>
                  </div>
                </div>

                <div class="field-group">
                  <label for="services_summary">
                    In your own words
                    <span class="help">(a sentence or two is fine)</span>
                  </label>
                  <textarea
                    id="services_summary"
                    name="services_summary"
                    placeholder="e.g. “Prioritise emergency leaks and boiler breakdowns in OX postcodes. Keep quotes sensible so I don’t work for free.”"
                  ></textarea>
                </div>

                <div class="field-group">
                  <label for="ai_style_notes">
                    How should TradeBotPro sound?
                    <span class="help">(tone of voice, things to avoid, etc.)</span>
                  </label>
                  <textarea
                    id="ai_style_notes"
                    name="ai_style_notes"
                    placeholder="Friendly but professional, no slang, don’t promise exact arrival times, always confirm if it’s an emergency."
                  ></textarea>
                </div>

                <div class="field-group">
                  <label for="callout_notes">
                    Any other important notes?
                    <span class="help">(parking, access, pets, special jobs you do or don’t do)</span>
                  </label>
                  <textarea id="callout_notes" name="callout_notes"></textarea>
                </div>
              </div>

              <div style="margin-top:1.1rem;">
                <button type="submit" class="btn-primary" id="save-btn">
                  Save my settings
                </button>
                <div class="small">
                  Changes update your profile in TradeBotPro instantly. You can come back to this link any time.
                </div>
              </div>
            </form>
          </div>
        </div>

        <aside>
          <div class="card">
            <h2>What this page controls</h2>
            <p>
              Your answers here tell TradeBotPro how to:
            </p>
            <ul style="padding-left:1.1rem;margin:0.4rem 0 0;">
              <li>Reply to customers with the right prices and areas.</li>
              <li>Decide which jobs to prioritise or turn away.</li>
              <li>Sound like a real member of your team.</li>
            </ul>
            <p style="margin-top:0.8rem;">
              If you’re not sure on any numbers yet, leave them blank or rough –
              we can tidy them up with you later.
            </p>
          </div>

          <div class="card">
            <h2>Need help?</h2>
            <p style="margin-bottom:0.4rem;">
              If anything on this page doesn’t make sense or doesn’t save properly,
              just email <a href="mailto:hello@tradebotpro.co.uk">hello@tradebotpro.co.uk</a>
              with your business name and we’ll sort it.
            </p>
            <p class="small">
              Tip: keep this page open while you test WhatsApp or web chat so you can tweak
              wording and prices as you go.
            </p>
          </div>
        </aside>
      </div>
    </div>
  </main>

  <footer>
    <div class="inner footer-inner">
      <div>&copy; <span id="year"></span> TradeBotPro. All rights reserved.</div>
      <div class="muted">Admin profile setup</div>
    </div>
  </footer>
</div>

<script>
  document.getElementById('year').textContent = new Date().getFullYear();

  // ============================
  // STEP 1 — PASTE YOUR SUPABASE DETAILS HERE
  // ============================
  // Replace ONLY the two lines below with your real values from Supabase Settings → API.
  const SUPABASE_URL = "https://yaiutswdcbfwkxfqxkzy.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlhaXV0c3dkY2Jmd2t4ZnF4a3p5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1MDE2MDgsImV4cCI6MjA4MDA3NzYwOH0.HOLFxzjsZ5Ieqg0b-aTdP0hAdLsPVXL6Zjs-HgOHgc8";

  // ============================
  // No changes needed below this line
  // ============================

  function getUserIdFromUrl() {
    const params = new URLSearchParams(window.location.search);
    return params.get('user_id');
  }

  function setStatus(message, type) {
    var statusEl = document.getElementById('status');
    statusEl.textContent = message;
    statusEl.classList.remove('error', 'ok');
    if (type === 'error') {
      statusEl.classList.add('error');
    } else if (type === 'ok') {
      statusEl.classList.add('ok');
    }
  }

  function getFieldValue(id) {
    var el = document.getElementById(id);
    if (!el) return '';
    return el.value == null ? '' : el.value;
  }

  function setFieldValue(id, value) {
    var el = document.getElementById(id);
    if (!el) return;
    el.value = value == null ? '' : value;
  }

  async function fetchJson(url, options) {
    const res = await fetch(url, options);
    if (!res.ok) {
      const text = await res.text();
      throw new Error('Fetch failed: ' + res.status + ' ' + text);
    }
    return res.json();
  }

  function initFocusChips() {
    var chipsContainer = document.getElementById('focus-chips');
    var chips = chipsContainer.querySelectorAll('.chip');
    var servicesSummary = document.getElementById('services_summary');

    function syncFromText() {
      var current = servicesSummary.value || '';
      chips.forEach(function (chip) {
        var value = chip.getAttribute('data-value');
        if (current.indexOf(value) !== -1) {
          chip.classList.add('selected');
        } else {
          chip.classList.remove('selected');
        }
      });
    }

    chips.forEach(function (chip) {
      chip.addEventListener('click', function () {
        var value = chip.getAttribute('data-value');
        var current = servicesSummary.value || '';

        if (chip.classList.contains('selected')) {
          chip.classList.remove('selected');
          var replaced = current.replace(value, '').replace('  ', ' ').trim();
          servicesSummary.value = replaced;
        } else {
          chip.classList.add('selected');
          if (!current) {
            servicesSummary.value = value;
          } else if (current.indexOf(value) === -1) {
            servicesSummary.value = current + (current.slice(-1) === '.' ? ' ' : ' • ') + value;
          }
        }
      });
    });

    servicesSummary.addEventListener('input', syncFromText);
  }

  async function loadProfile(userId) {
    if (!supabaseUrl || !supabaseAnonKey || supabaseUrl.indexOf('supabase.co') === -1) {
      setStatus('Supabase details are not configured. Please add supabaseUrl and supabaseAnonKey.', 'error');
      return;
    }

    setStatus('Loading your details…', null);

    try {
      var url = supabaseUrl +
        '/rest/v1/business_profiles' +
        '?id=eq.' + encodeURIComponent(userId) +
        '&select=*';

      var data = await fetchJson(url, {
        method: 'GET',
        headers: {
          apikey: supabaseAnonKey,
          Authorization: 'Bearer ' + supabaseAnonKey
        }
      });

      if (!data || !data.length) {
        setStatus('We could not find your profile. Please contact TradeBotPro.', 'error');
        return;
      }

      var profile = data[0];

      setFieldValue('business_name', profile.business_name);
      setFieldValue('contact_name', profile.contact_name);
      setFieldValue('email', profile.email);
      setFieldValue('whatsapp_number', profile.whatsapp_number);
      setFieldValue('phone', profile.phone);
      setFieldValue('trade_type', profile.trade_type);
      setFieldValue('base_postcode', profile.base_postcode);
      setFieldValue('website_url', profile.website_url);
      setFieldValue('service_radius', profile.service_radius);
      setFieldValue('callout_from', profile.callout_from);
      setFieldValue('callout_fee', profile.callout_fee);
      setFieldValue('first_hour_rate', profile.first_hour_rate);
      setFieldValue('hourly_rate', profile.hourly_rate);
      setFieldValue('boiler_service_from', profile.boiler_service_from);
      setFieldValue('quote_minimum', profile.quote_minimum);
      setFieldValue('pricing_notes', profile.pricing_notes);
      setFieldValue('services_summary', profile.services_summary);
      setFieldValue('ai_style_notes', profile.ai_style_notes);
      setFieldValue('callout_notes', profile.callout_notes);

      setStatus('Loaded. You can now review and update your details.', 'ok');
    } catch (err) {
      console.error('Fetch profile error:', err);
      setStatus('Something went wrong loading your details. Please refresh or contact us.', 'error');
    }
  }

  async function saveProfile(userId, event) {
    event.preventDefault();

    if (!supabaseUrl || !supabaseAnonKey || supabaseUrl.indexOf('supabase.co') === -1) {
      setStatus('Supabase details are not configured. Please add supabaseUrl and supabaseAnonKey.', 'error');
      return;
    }

    var saveBtn = document.getElementById('save-btn');
    saveBtn.disabled = true;
    setStatus('Saving your changes…', null);

    var payload = {
      business_name: getFieldValue('business_name'),
      contact_name: getFieldValue('contact_name'),
      email: getFieldValue('email'),
      whatsapp_number: getFieldValue('whatsapp_number'),
      phone: getFieldValue('phone'),
      trade_type: getFieldValue('trade_type'),
      base_postcode: getFieldValue('base_postcode'),
      website_url: getFieldValue('website_url'),
      service_radius: getFieldValue('service_radius'),
      callout_from: getFieldValue('callout_from'),
      callout_fee: getFieldValue('callout_fee'),
      first_hour_rate: getFieldValue('first_hour_rate'),
      hourly_rate: getFieldValue('hourly_rate'),
      boiler_service_from: getFieldValue('boiler_service_from'),
      quote_minimum: getFieldValue('quote_minimum'),
      pricing_notes: getFieldValue('pricing_notes'),
      services_summary: getFieldValue('services_summary'),
      ai_style_notes: getFieldValue('ai_style_notes'),
      callout_notes: getFieldValue('callout_notes')
    };

    try {
      var url = supabaseUrl +
        '/rest/v1/business_profiles' +
        '?id=eq.' + encodeURIComponent(userId);

      await fetchJson(url, {
        method: 'PATCH',
        headers: {
          apikey: supabaseAnonKey,
          Authorization: 'Bearer ' + supabaseAnonKey,
          'Content-Type': 'application/json',
          Prefer: 'return=representation'
        },
        body: JSON.stringify(payload)
      });

      setStatus('Saved. Your AI office will now use these settings.', 'ok');
    } catch (err) {
      console.error('Save profile error:', err);
      setStatus('There was a problem saving your changes. Please try again or contact us.', 'error');
    } finally {
      saveBtn.disabled = false;
    }
  }

  function initialise() {
    var userId = getUserIdFromUrl();
    document.getElementById('debug-user-id').textContent = userId || 'missing';

    initFocusChips();

    if (!userId) {
      setStatus('This link is missing a user ID. Please use the full link we sent you.', 'error');
      var form = document.getElementById('profile-form');
      form.querySelectorAll('input, select, textarea, button').forEach(function (el) {
        el.disabled = true;
      });
      return;
    }

    loadProfile(userId);

    var formEl = document.getElementById('profile-form');
    formEl.addEventListener('submit', function (e) {
      saveProfile(userId, e);
    });
  }

  window.addEventListener('DOMContentLoaded', initialise);
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TradeBotPro – Setup Wizard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="TradeBotPro setup wizard for new trade accounts." />

  <style>
    :root {
      --primary-blue: #1f4e79;
      --accent-blue: #00a3ff;
      --dark-text: #151820;
      --muted-text: #6b7280;
      --light-bg: #f3f4f9;
      --white: #ffffff;
      --border-subtle: rgba(15, 23, 42, 0.12);
      --success-green: #0f7b46;
      --error-red: #b3261e;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      background: radial-gradient(circle at top left, #e0ebff 0, #f3f4f9 40%, #fdfdfd 100%);
      color: var(--dark-text);
    }

    /* CHIP STYLES */
    .chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 6px;
    }

    .chip {
      padding: 0.4rem 0.9rem;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.15);
      background: #fff;
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.15s ease;
    }

    .chip:hover {
      border-color: var(--primary-blue);
      background: rgba(31,78,121,0.05);
    }

    .chip.is-active {
      background: #e8f0fa;
      border-color: var(--primary-blue);
      color: var(--primary-blue);
      font-weight: 600;
      box-shadow: 0 0 0 2px rgba(31,78,121,0.15);
    }

    /* BUTTONS */
    .btn {
      border-radius: 999px;
      padding: 0.55rem 1.1rem;
      font-size: 0.86rem;
      cursor: pointer;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary-blue), #163857);
      color: #fff;
      border: none;
    }

    .btn-secondary {
      background: #f1f5f9;
      border: 1px solid var(--border-subtle);
    }

    .btn-ghost {
      background: transparent;
      border: none;
      color: var(--muted-text);
    }

    /* SIMPLE LAYOUT HELPERS */
    main { padding: 2rem; }
    .wizard-footer {
      display: flex;
      justify-content: space-between;
      margin-top: 1.5rem;
      padding-top: 1rem;
      border-top: 1px dashed rgba(148,163,184,0.6);
    }
  </style>
</head>

<body>

<main>

  <!-- STEP 1 (example, rest of your steps unchanged) -->
  <div class="step-panel is-active" data-step="1">

    <label>Main trade</label>
    <div class="chip-row" data-field="main_trade" data-select="single">
      <button class="chip" type="button">Plumbing & heating</button>
      <button class="chip" type="button">Heating only</button>
      <button class="chip" type="button">Gas engineer</button>
      <button class="chip" type="button">Electrician</button>
    </div>

    <label style="margin-top:1rem;">Preferred jobs</label>
    <div class="chip-row" data-field="preferred_jobs" data-select="multi">
      <button class="chip" type="button">Emergency / urgent jobs</button>
      <button class="chip" type="button">Small jobs / quick wins</button>
      <button class="chip" type="button">Maintenance / servicing</button>
    </div>

  </div>

  <!-- FOOTER -->
  <div class="wizard-footer">
    <button class="btn btn-ghost" id="btn-save-draft">Save draft</button>
    <div>
      <button class="btn btn-secondary" id="btn-back">← Back</button>
      <button class="btn btn-primary" id="btn-next">Next step →</button>
    </div>
  </div>

</main>

<!-- SUPABASE (ONCE, CLEAN) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.48.0/dist/umd/supabase.js"></script>

<script>
(function () {
  function boot() {
    if (!window.supabase) return setTimeout(boot, 50);

    const SUPABASE_URL = "https://yaiutswdcbfwkxfqxkzy.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlhaXV0c3dkY2Jmd2t4ZnF4a3p5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1MDE2MDgsImV4cCI6MjA4MDA3NzYwOH0.HOLFxzjsZ5Ieqg0b-aTdP0hAdLsPVXL6Zjs-HgOHgc8";

    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const customer_id = new URLSearchParams(location.search).get("customer_id");

    function getHidden(field) {
      let el = document.getElementById(field);
      if (!el) {
        el = document.createElement("input");
        el.type = "hidden";
        el.id = field;
        el.name = field;
        document.body.appendChild(el);
      }
      return el;
    }

    function chipText(btn) {
      return btn.textContent.trim();
    }

    document.addEventListener("click", (e) => {
      const chip = e.target.closest(".chip-row[data-field] .chip");
      if (!chip) return;

      const group = chip.closest(".chip-row");
      const field = group.dataset.field;
      const mode = group.dataset.select;
      const hidden = getHidden(field);
      const value = chipText(chip);

      if (mode === "single") {
        hidden.value = value;
        group.querySelectorAll(".chip").forEach(c => c.classList.remove("is-active"));
        chip.classList.add("is-active");
      } else {
        let arr = [];
        try { arr = JSON.parse(hidden.value || "[]"); } catch {}
        const idx = arr.indexOf(value);
        if (idx >= 0) arr.splice(idx, 1);
        else arr.push(value);
        hidden.value = JSON.stringify(arr);
        chip.classList.toggle("is-active");
      }
    });

    async function prefill() {
      if (!customer_id) return;
      const { data } = await sb
        .from("customers")
        .select("wizard_answers")
        .eq("id", customer_id)
        .single();

      if (!data?.wizard_answers) return;

      Object.entries(data.wizard_answers).forEach(([field, val]) => {
        const hidden = getHidden(field);
        hidden.value = Array.isArray(val) ? JSON.stringify(val) : val;

        document.querySelectorAll(`.chip-row[data-field="${field}"] .chip`)
          .forEach(chip => {
            const txt = chipText(chip);
            if (Array.isArray(val) ? val.includes(txt) : txt === val) {
              chip.classList.add("is-active");
            }
          });
      });
    }

    prefill();
  }

  boot();
})();
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TradeBotPro — Business Profile</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --primary-blue: #1f4e79;
      --accent-blue: #00a3ff;
      --dark-text: #1b1b1f;
      --muted-text: #6b7280;
      --light-bg: #f5f7fa;
      --white: #ffffff;
      --border: #e5e7eb;
      --danger: #b91c1c;
      --success: #15803d;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      background: var(--light-bg);
      color: var(--dark-text);
    }

    header {
      background: var(--white);
      border-bottom: 1px solid var(--border);
      padding: 12px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 700;
      color: var(--primary-blue);
      font-size: 18px;
    }

    .brand-badge {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      background: linear-gradient(135deg, var(--primary-blue), var(--accent-blue));
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--white);
      font-weight: 700;
      font-size: 16px;
    }

    main {
      max-width: 1100px;
      margin: 20px auto;
      padding: 0 16px 32px;
    }

    h1 {
      margin: 0 0 6px;
      font-size: 26px;
    }

    .subtitle {
      margin: 0 0 20px;
      color: var(--muted-text);
      font-size: 14px;
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 2.3fr) minmax(260px, 1.2fr);
      gap: 20px;
    }

    @media (max-width: 900px) {
      .layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      background: var(--white);
      border-radius: 14px;
      border: 1px solid var(--border);
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.04);
      padding: 16px 18px 18px;
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .card-title {
      font-size: 16px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .chip {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      background: #e0efff;
      color: var(--primary-blue);
      font-weight: 500;
    }

    form {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .field-group {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px 14px;
    }

    @media (max-width: 700px) {
      .field-group {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 13px;
    }

    label {
      font-weight: 500;
    }

    .hint {
      font-size: 11px;
      color: var(--muted-text);
    }

    input[type="text"],
    input[type="email"],
    input[type="tel"],
    input[type="number"],
    select,
    textarea {
      border-radius: 8px;
      border: 1px solid var(--border);
      padding: 7px 9px;
      font-size: 13px;
      font-family: inherit;
      width: 100%;
      background: var(--white);
    }

    textarea {
      min-height: 70px;
      resize: vertical;
    }

    .small-row {
      display: flex;
      gap: 10px;
    }

    .small-row .field {
      flex: 1;
    }

    .section-divider {
      margin: 8px 0;
      border-top: 1px dashed #e5e7eb;
    }

    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      margin-top: 2px;
    }

    .checkbox-row input[type="checkbox"] {
      width: 15px;
      height: 15px;
    }

    .actions {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 10px;
      gap: 10px;
    }

    .btn-primary {
      border: none;
      border-radius: 999px;
      padding: 8px 18px;
      font-size: 13px;
      font-weight: 600;
      background: linear-gradient(135deg, var(--primary-blue), var(--accent-blue));
      color: white;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn-primary[disabled] {
      opacity: 0.6;
      cursor: wait;
    }

    .status-message {
      font-size: 12px;
      padding: 6px 9px;
      border-radius: 8px;
      border: 1px solid transparent;
    }

    .status-success {
      border-color: #bbf7d0;
      background: #ecfdf3;
      color: var(--success);
    }

    .status-error {
      border-color: #fecaca;
      background: #fef2f2;
      color: var(--danger);
    }

    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .badge-list {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .badge {
      padding: 3px 10px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
    }

    .pill {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      background: #f97316;
      color: white;
      font-weight: 500;
    }
  </style>
</head>
<body>
<header>
  <div class="brand">
    <div class="brand-badge">TB</div>
    <span>TradeBotPro</span>
  </div>
  <div style="font-size:12px; color:var(--muted-text);">
    Signed in • 24/7 AI office assistant
  </div>
</header>

<main>
  <h1>Tell us about your business</h1>
  <p class="subtitle">
    This profile feeds your TradeBotPro assistant. Keep it accurate and we’ll handle quotes, messages and jobs in your style.
  </p>

  <div class="layout">
    <!-- MAIN FORM CARD -->
    <section class="card">
      <div class="card-header">
        <div class="card-title">
          Business profile
          <span class="chip">Syncs with Supabase</span>
        </div>
      </div>

      <form id="businessProfileForm">
        <!-- CONTACT & BUSINESS -->
        <div class="field-group">
          <div class="field">
            <label for="contact_name">Your name</label>
            <input type="text" id="contact_name" name="contact_name" autocomplete="name" />
            <div class="hint">Who should TradeBotPro say the customer is dealing with?</div>
          </div>
          <div class="field">
            <label for="business_name">Business name</label>
            <input type="text" id="business_name" name="business_name" />
            <div class="hint">Shown on quotes, invoices and messages.</div>
          </div>
        </div>

        <div class="field-group">
          <div class="field">
            <label for="email">Email address</label>
            <input type="email" id="email" name="email" autocomplete="email" />
          </div>
          <div class="field">
            <label for="phone">Phone number</label>
            <input type="tel" id="phone" name="phone" autocomplete="tel" />
          </div>
        </div>

        <div class="field-group">
          <div class="field">
            <label for="whatsapp_number">WhatsApp number</label>
            <input type="tel" id="whatsapp_number" name="whatsapp_number" />
            <div class="hint">The number linked to your TradeBotPro WhatsApp.</div>
          </div>
          <div class="field">
            <label for="trade_type">Trade type</label>
            <select id="trade_type" name="trade_type">
              <option value="">Select a trade…</option>
              <option value="Plumbing & Heating">Plumbing &amp; Heating</option>
              <option value="Gas & Boilers">Gas &amp; Boilers</option>
              <option value="Electrical">Electrical</option>
              <option value="Landscaping">Landscaping</option>
              <option value="Roofing">Roofing</option>
              <option value="General Building">General Building</option>
              <option value="Other">Other</option>
            </select>
          </div>
        </div>

        <div class="section-divider"></div>

        <!-- AREA & RADIUS -->
        <div class="field-group">
          <div class="field">
            <label for="base_postcode">Base postcode</label>
            <input type="text" id="base_postcode" name="base_postcode" />
            <div class="hint">Where you usually start jobs from.</div>
          </div>
          <div class="field">
            <label for="service_radius">Service radius (miles)</label>
            <input type="number" id="service_radius" name="service_radius" min="1" max="99" />
          </div>
        </div>

        <div class="field-group">
          <div class="field">
            <label for="callout_from">Callout from</label>
            <input type="text" id="callout_from" name="callout_from" placeholder="e.g. £60+VAT" />
            <div class="hint">We’ll use this in quotes and price ranges.</div>
          </div>
          <div class="field">
            <label for="callout_fee">Standard callout fee (£)</label>
            <input type="number" id="callout_fee" name="callout_fee" step="0.01" />
          </div>
        </div>

        <div class="field-group">
          <div class="field">
            <label for="first_hour_rate">First hour rate (£)</label>
            <input type="number" id="first_hour_rate" name="first_hour_rate" step="0.01" />
          </div>
          <div class="field">
            <label for="hourly_rate">Hourly rate after first hour (£)</label>
            <input type="number" id="hourly_rate" name="hourly_rate" step="0.01" />
          </div>
        </div>

        <div class="field-group">
          <div class="field">
            <label for="website_url">Website</label>
            <input type="text" id="website_url" name="website_url" placeholder="https://…" />
          </div>
          <div class="field">
            <label for="services_summary">Services summary</label>
            <textarea id="services_summary" name="services_summary" placeholder="Short list of what you do…"></textarea>
          </div>
        </div>

        <div class="section-divider"></div>

        <!-- STYLE & NOTES -->
        <div class="field-group">
          <div class="field">
            <label for="pricing_notes">Pricing notes</label>
            <textarea id="pricing_notes" name="pricing_notes" placeholder="Any rules, minimum charges or special pricing details."></textarea>
          </div>
          <div class="field">
            <label for="ai_style_notes">AI style notes</label>
            <textarea id="ai_style_notes" name="ai_style_notes" placeholder="How should TradeBotPro sound? Formal, friendly, emojis, no emojis…"></textarea>
          </div>
        </div>

        <div class="field">
          <label for="notes">Internal notes (optional)</label>
          <textarea id="notes" name="notes" placeholder="Anything else we should know about how you run your jobs."></textarea>
        </div>

        <!-- HIDDEN/IMPLICIT FIELDS WE STILL SYNC -->
        <!-- These are not shown but we keep them in sync between tables with sensible defaults -->
        <input type="hidden" id="plan_status" name="plan_status" value="Trial" />
        <input type="hidden" id="account_status" name="account_status" value="Active" />
        <input type="hidden" id="account_status_reason" name="account_status_reason" value="" />
        <input type="hidden" id="pending_setup" name="pending_setup" value="false" />
        <input type="hidden" id="hourly_rate_from" name="hourly_rate_from" />
        <input type="hidden" id="boiler_service_from" name="boiler_service_from" />
        <input type="hidden" id="quote_minimum" name="quote_minimum" />
        <input type="hidden" id="callout_notes" name="callout_notes" />

        <div class="checkbox-row">
          <input type="checkbox" id="is_active" name="is_active" checked />
          <label for="is_active">Business is currently taking on new work</label>
        </div>

        <div class="actions">
          <div id="saveStatus" class="status-message" hidden></div>
          <button type="submit" id="saveButton" class="btn-primary">
            <span>Save profile</span>
            <span id="saveSpinner" style="display:none;">⏳</span>
          </button>
        </div>
      </form>
    </section>

    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="card">
        <div class="card-header">
          <div class="card-title">
            Live assistant
          </div>
        </div>
        <p style="font-size:13px; margin-top:0;">
          Once this profile is saved, your TradeBotPro assistant will:
        </p>
        <ul style="font-size:13px; padding-left:18px; margin-top:4px;">
          <li>Use your prices and service area.</li>
          <li>Answer in your tone of voice.</li>
          <li>Log leads into your Supabase tables.</li>
        </ul>
        <div class="badge-list" style="margin-top:10px;">
          <span class="badge">Quotes &amp; estimates</span>
          <span class="badge">WhatsApp replies</span>
          <span class="badge">Job booking</span>
          <span class="badge">Chasing reviews</span>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-title">
            Data sync status
          </div>
        </div>
        <p style="font-size:13px; margin-top:0;">
          This page keeps <strong>business_profiles</strong> and
          <strong>tradebotpro_signups</strong> in sync for the same
          <code style="font-size:11px;">user_id</code>.
        </p>
        <p style="font-size:12px; color:var(--muted-text); margin-top:6px;">
          If you see any 400 errors in the console, it usually means:
        </p>
        <ul style="font-size:12px; color:var(--muted-text); padding-left:18px; margin-top:4px;">
          <li>Column names in Supabase don’t match this form; or</li>
          <li><code>SUPABASE_URL</code> / key are wrong.</li>
        </ul>
        <p style="font-size:12px; margin-top:8px;">
          Current user:
          <code id="currentUserIdLabel" style="font-size:11px;">(none)</code>
        </p>
        <span class="pill">Beta profile editor</span>
      </div>
    </aside>
  </div>
</main>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2.48.0";

  // TODO: Put your real Supabase values here
  const SUPABASE_URL = "https://yaiutswdcbfwkxfqxkzy.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlhaXV0c3dkY2Jmd2t4ZnF4a3p5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1MDE2MDgsImV4cCI6MjA4MDA3NzYwOH0.HOLFxzjsZ5Ieqg0b-aTdP0hAdLsPVXL6Zjs-HgOHgc8";

  if (!SUPABASE_URL || !SUPABASE_ANON_KEY || SUPABASE_URL.includes("YOUR-PROJECT")) {
    console.error("Missing SUPABASE_URL or SUPABASE_ANON_KEY – please set them in app.html");
  }

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const params = new URLSearchParams(window.location.search);
  const userId = params.get("user_id") || null;

  const form = document.getElementById("businessProfileForm");
  const saveButton = document.getElementById("saveButton");
  const saveSpinner = document.getElementById("saveSpinner");
  const saveStatus = document.getElementById("saveStatus");
  const currentUserIdLabel = document.getElementById("currentUserIdLabel");

  if (userId && currentUserIdLabel) {
    currentUserIdLabel.textContent = userId;
  } else if (currentUserIdLabel) {
    currentUserIdLabel.textContent = "Missing ?user_id=… in URL";
  }

  function setStatus(message, type = "success") {
    if (!saveStatus) return;
    saveStatus.hidden = !message;
    saveStatus.textContent = message || "";
    saveStatus.className = "status-message " + (
      type === "error" ? "status-error" : "status-success"
    );
  }

  function setSaving(isSaving) {
    if (!saveButton || !saveSpinner) return;
    saveButton.disabled = isSaving;
    saveSpinner.style.display = isSaving ? "inline-block" : "none";
  }

  function fillFormFromData(data) {
    if (!data) return;
    for (const [key, value] of Object.entries(data)) {
      const field = form.elements.namedItem(key);
      if (!field) continue;

      if (field.type === "checkbox") {
        field.checked = Boolean(value);
      } else {
        field.value = value ?? "";
      }
    }
  }

  async function loadProfile() {
    if (!userId) {
      setStatus("No user id found in URL (?user_id=…)", "error");
      return;
    }

    try {
      setStatus("Loading profile…");
      // 1. Try business_profiles first
      let { data: bp, error: bpError } = await supabase
        .from("business_profiles")
        .select("*")
        .eq("user_id", userId)
        .maybeSingle();

      if (bpError && bpError.code !== "PGRST116") {
        console.error("Error loading business_profiles:", bpError);
      }

      if (bp) {
        fillFormFromData(bp);
        setStatus("Profile loaded from business_profiles.");
        return;
      }

      // 2. Fallback to tradebotpro_signups
      let { data: su, error: suError } = await supabase
        .from("tradebotpro_signups")
        .select("*")
        .eq("user_id", userId)
        .maybeSingle();

      if (suError && suError.code !== "PGRST116") {
        console.error("Error loading tradebotpro_signups:", suError);
      }

      if (su) {
        fillFormFromData(su);
        setStatus("Profile loaded from tradebotpro_signups.");
      } else {
        setStatus("No profile found yet. Fill in the form and click Save.", "success");
      }
    } catch (err) {
      console.error("Unexpected error loading profile:", err);
      setStatus("Could not load profile (check console for details).", "error");
    }
  }

  function collectProfileData() {
    const data = {};
    const fields = [
      "contact_name",
      "business_name",
      "owner_name",
      "email",
      "phone",
      "whatsapp_number",
      "trade_type",
      "base_postcode",
      "service_radius",
      "callout_from",
      "callout_fee",
      "first_hour_rate",
      "hourly_rate",
      "notes",
      "ai_style_notes",
      "base_postcode",
      "callout_from",
      "contact_name",
      "service_radius",
      "website_url",
      "pricing_notes",
      "hourly_rate_from",
      "boiler_service_from",
      "quote_minimum",
      "plan_status",
      "services_summary",
      "pending_setup",
      "account_status",
      "account_status_reason",
      "callout_notes"
    ];

    for (const name of fields) {
      const field = form.elements.namedItem(name);
      if (!field) continue;

      if (field.type === "checkbox") {
        data[name] = field.checked;
      } else if (field.type === "number") {
        const val = field.value.trim();
        data[name] = val === "" ? null : Number(val);
      } else {
        const val = field.value.trim();
        data[name] = val === "" ? null : val;
      }
    }

    // is_active as boolean
    const isActiveField = form.elements.namedItem("is_active");
    data.is_active = isActiveField ? Boolean(isActiveField.checked) : true;

    // Ensure plan/account defaults
    if (!data.plan_status) data.plan_status = "Trial";
    if (!data.account_status) data.account_status = "Active";

    // Strong link to this auth user
    data.user_id = userId;

    return data;
  }

  async function saveProfile(event) {
    event.preventDefault();
    if (!userId) {
      setStatus("Missing user id in URL (?user_id=…)", "error");
      return;
    }

    setSaving(true);
    setStatus("");

    const payload = collectProfileData();

    try {
      // FIRST: keep business_profiles in sync
      const { data: bpExisting, error: bpFindError } = await supabase
        .from("business_profiles")
        .select("id")
        .eq("user_id", userId)
        .maybeSingle();

      if (bpFindError && bpFindError.code !== "PGRST116") {
        console.error("Error searching business_profiles:", bpFindError);
      }

      const bpPayload = { ...payload };
      if (bpExisting && bpExisting.id) {
        bpPayload.id = bpExisting.id;
      }

      const { error: bpSaveError } = await supabase
        .from("business_profiles")
        .upsert(bpPayload);

      if (bpSaveError) {
        console.error("Error saving business_profiles:", bpSaveError);
        throw new Error("Could not save to business_profiles (" + bpSaveError.message + ")");
      }

      // SECOND: keep tradebotpro_signups in sync
      const { data: suExisting, error: suFindError } = await supabase
        .from("tradebotpro_signups")
        .select("id")
        .eq("user_id", userId)
        .maybeSingle();

      if (suFindError && suFindError.code !== "PGRST116") {
        console.error("Error searching tradebotpro_signups:", suFindError);
      }

      const suPayload = { ...payload };
      if (suExisting && suExisting.id) {
        suPayload.id = suExisting.id;
      }

      const { error: suSaveError } = await supabase
        .from("tradebotpro_signups")
        .upsert(suPayload);

      if (suSaveError) {
        console.error("Error saving tradebotpro_signups:", suSaveError);
        throw new Error("Could not save to tradebotpro_signups (" + suSaveError.message + ")");
      }

      setStatus("Enquiry sent successfully. Profile saved to both tables.", "success");
    } catch (err) {
      console.error("Unexpected save error:", err);
      setStatus(err.message || "Something went wrong saving your profile.", "error");
    } finally {
      setSaving(false);
    }
  }

  form.addEventListener("submit", saveProfile);
  loadProfile();
</script>
</body>
</html>

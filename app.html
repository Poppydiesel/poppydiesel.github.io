<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TradeBotPro ‚Äî Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --primary-blue: #1f4e79;
      --accent-blue: #00a3ff;
      --dark-text: #1b1b1f;
      --light-bg: #f5f7fa;
      --white: #ffffff;
      --border: #d0d4dc;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      background: var(--light-bg);
      color: var(--dark-text);
    }

    header {
      background: var(--primary-blue);
      color: var(--white);
      padding: 1rem 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    header h1 {
      margin: 0;
      font-size: 1.25rem;
    }

    header .user-badge {
      font-size: 0.9rem;
      opacity: 0.9;
    }

    main {
      max-width: 1100px;
      margin: 1.5rem auto;
      padding: 0 1rem 2.5rem;
    }

    .status-bar {
      margin-bottom: 1rem;
      padding: 0.75rem 1rem;
      border-radius: 8px;
      font-size: 0.9rem;
    }

    .status-bar.info {
      background: #e8f2ff;
      border: 1px solid #c5d9ff;
      color: #1f3b64;
    }

    .status-bar.error {
      background: #ffe8e8;
      border: 1px solid #ffbcbc;
      color: #7a1414;
    }

    .grid {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 1.5fr);
      gap: 1.25rem;
    }

    @media (max-width: 900px) {
      .grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      background: var(--white);
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 1rem 1.25rem 1.25rem;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
    }

    .card h2 {
      margin: 0 0 0.75rem;
      font-size: 1.1rem;
    }

    .card p {
      margin: 0.25rem 0;
      font-size: 0.95rem;
    }

    .field-group {
      margin-bottom: 0.75rem;
    }

    .field-group label {
      display: block;
      font-size: 0.85rem;
      margin-bottom: 0.2rem;
      color: #555b66;
    }

    .field-group input,
    .field-group select,
    .field-group textarea {
      width: 100%;
      padding: 0.45rem 0.5rem;
      font-size: 0.95rem;
      border-radius: 6px;
      border: 1px solid var(--border);
    }

    .field-inline {
      display: flex;
      gap: 0.7rem;
    }

    .field-inline .field-group {
      flex: 1;
    }

    .muted {
      font-size: 0.85rem;
      color: #6d7583;
    }

    .pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      margin-top: 0.5rem;
    }

    .pill {
      font-size: 0.8rem;
      padding: 0.2rem 0.55rem;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #f8fafc;
    }

    button.primary {
      background: var(--primary-blue);
      color: var(--white);
      border: none;
      border-radius: 6px;
      padding: 0.5rem 1rem;
      font-size: 0.95rem;
      cursor: pointer;
    }

    button.primary:disabled {
      opacity: 0.6;
      cursor: default;
    }

    .section-footer {
      margin-top: 0.75rem;
      text-align: right;
      font-size: 0.85rem;
      color: #6d7583;
    }
  </style>

  <!-- Supabase JS (v2) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <header>
    <h1>TradeBotPro ‚Äî My Dashboard</h1>
    <div class="user-badge" id="headerUser">
      Loading user‚Ä¶
    </div>
  </header>

  <main>
    <div id="statusArea" class="status-bar info">
      Connecting to TradeBotPro‚Ä¶
    </div>

    <div class="grid">
      <!-- LEFT: Business profile & trade settings -->
      <section class="card">
        <h2>Business profile</h2>
        <p class="muted">
          Check your details below. This is what TradeBotPro uses when talking to your customers.
        </p>

        <div class="field-group">
          <label>Business name</label>
          <input id="businessName" type="text" placeholder="Your trading name" disabled />
        </div>

        <div class="field-group">
          <label>Main contact name</label>
          <input id="contactName" type="text" disabled />
        </div>

        <div class="field-inline">
          <div class="field-group">
            <label>Primary trade</label>
            <select id="tradeType" disabled>
              <!-- Core trades from Supabase -->
              <option value="">Select your trade‚Ä¶</option>
              <option value="Plumbers &amp; Heating Engineers">Plumbers &amp; Heating Engineers</option>
              <option value="Roofers &amp; Guttering">Roofers &amp; Guttering</option>
              <option value="Cleaners &amp; Carpet Cleaners">Cleaners &amp; Carpet Cleaners</option>
              <option value="Electricians">Electricians</option>
              <option value="Pest Control">Pest Control</option>
              <option value="Window Cleaners">Window Cleaners</option>
              <option value="Landscapers &amp; Gardeners">Landscapers &amp; Gardeners</option>
              <option value="Home Repairs &amp; Maintenance">Home Repairs &amp; Maintenance</option>
              <option value="Builders &amp; Handymen">Builders &amp; Handymen</option>
              <option value="Painters &amp; Decorators">Painters &amp; Decorators</option>

              <!-- Extra expansion trades -->
              <option value="Gas Engineer">Gas Engineer</option>
              <option value="Drainage / Blockages">Drainage / Blockages</option>
              <option value="Boiler Specialist">Boiler Specialist</option>
              <option value="Bathroom Installer">Bathroom Installer</option>
              <option value="Heat Pump / Renewables">Heat Pump / Renewables</option>
              <option value="General Builder">General Builder</option>
              <option value="Locksmith">Locksmith</option>
            </select>
          </div>

          <div class="field-group">
            <label>Service area (example)</label>
            <input id="serviceArea" type="text" placeholder="e.g. SW London, HP14, M25 corridor" disabled />
          </div>
        </div>

        <div class="field-group">
          <label>Public ‚Äúabout you‚Äù blurb (future website)</label>
          <textarea id="aboutText" rows="3" placeholder="Short description customers will see" disabled></textarea>
        </div>

        <div class="section-footer">
          V1: Read-only view from <code>tradebotpro_signups</code>. Editing & saving will come in Phase 4.
        </div>
      </section>

      <!-- RIGHT: Pricing & assistant behaviour (static for now) -->
      <section class="card">
        <h2>Assistant & pricing (coming soon)</h2>
        <p class="muted">
          This is where you‚Äôll control your call-out fees and how TradeBotPro answers customers.
        </p>

        <div class="field-group">
          <label>Standard call-out fee (¬£)</label>
          <input id="calloutFee" type="number" placeholder="e.g. 80" disabled />
        </div>

        <div class="field-inline">
          <div class="field-group">
            <label>Weekday hourly rate (¬£)</label>
            <input id="weekdayRate" type="number" placeholder="e.g. 65" disabled />
          </div>
          <div class="field-group">
            <label>Out-of-hours rate (¬£)</label>
            <input id="oohRate" type="number" placeholder="e.g. 95" disabled />
          </div>
        </div>

        <div class="field-group">
          <label>How ‚Äúsalesy‚Äù should the assistant be?</label>
          <select id="tone" disabled>
            <option value="calm">Calm & helpful</option>
            <option value="balanced" selected>Balanced ‚Äî helpful & proactive</option>
            <option value="pushy">Very proactive</option>
          </select>
        </div>

        <div class="field-group">
          <label>Let customers help improve answers (future)</label>
          <div class="pill-row">
            <span class="pill">üëç ‚ÄúThat was helpful‚Äù</span>
            <span class="pill">üëé ‚ÄúNot quite right‚Äù</span>
            <span class="pill">‚≠ê Save good replies</span>
          </div>
          <p class="muted" style="margin-top:0.4rem;">
            In a later phase, we‚Äôll let you see what customers liked and tweak how the assistant responds.
          </p>
        </div>

        <div class="section-footer">
          <button class="primary" disabled>Save changes (Phase 4)</button>
        </div>
      </section>
    </div>
  </main>

  <script>
    // 1. Supabase setup (PUT YOUR KEYS HERE)
    const SUPABASE_URL = "https://yaiutswdcbfwkxfqxkzy.supabase.co";       // ‚Üê replace this
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlhaXV0c3dkY2Jmd2t4ZnF4a3p5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1MDE2MDgsImV4cCI6MjA4MDA3NzYwOH0.HOLFxzjsZ5Ieqg0b-aTdP0hAdLsPVXL6Zjs-HgOHgc8";            // ‚Üê and this

    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // 2. Helper: get user_id from URL query string
    function getUserIdFromUrl() {
      const params = new URLSearchParams(window.location.search);
      return params.get("user_id");
    }

    // 3. Update status bar
    function setStatus(message, type = "info") {
      const bar = document.getElementById("statusArea");
      bar.textContent = message;
      bar.className = "status-bar " + type;
    }

    // 4. Fill the dashboard from a signup row
    function populateFromSignup(row) {
      const headerUser = document.getElementById("headerUser");
      const businessName = document.getElementById("businessName");
      const contactName = document.getElementById("contactName");
      const tradeType = document.getElementById("tradeType");
      const serviceArea = document.getElementById("serviceArea");
      const aboutText = document.getElementById("aboutText");

      headerUser.textContent = row.business_name
        ? row.business_name
        : (row.contact_name || "Signed-up user");

      businessName.value = row.business_name || "";
      contactName.value = row.contact_name || "";

      // If your signup table has a 'trade_type' column:
      if (row.trade_type) {
        tradeType.value = row.trade_type;
      }

      // Optional columns if you add them later
      serviceArea.value = row.service_area || "";
      aboutText.value = row.about_text || "";
    }

    // 5. Main loader
    async function initDashboard() {
      const userId = getUserIdFromUrl();

      if (!userId) {
        setStatus("No user_id in the URL. Please open the link from your signup email.", "error");
        document.getElementById("headerUser").textContent = "No user ID found";
        return;
      }

      setStatus("Loading your details from TradeBotPro‚Ä¶");

      try {
        const { data, error } = await supabaseClient
          .from("tradebotpro_signups")
          .select("*")
          .eq("user_id", userId)
          .single();

        if (error) {
          console.error("Supabase error:", error);
          setStatus("Could not load your details (Supabase error).", "error");
          document.getElementById("headerUser").textContent = "Load failed";
          return;
        }

        if (!data) {
          setStatus("We couldn't find your signup record. Please contact support.", "error");
          document.getElementById("headerUser").textContent = "Record not found";
          return;
        }

        populateFromSignup(data);
        setStatus("Loaded your TradeBotPro profile from tradebotpro_signups.");
      } catch (err) {
        console.error("Unexpected error:", err);
        setStatus("Unexpected error loading dashboard.", "error");
        document.getElementById("headerUser").textContent = "Error";
      }
    }

    initDashboard();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TradeBotPro – Your Business Profile</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: #f5f7fa;
      margin: 0;
      padding: 2rem;
    }

    .container {
      max-width: 720px;
      margin: 0 auto;
      background: #fff;
      border-radius: 12px;
      padding: 1.5rem 1.75rem 2rem;
      box-shadow: 0 10px 25px rgba(0,0,0,0.06);
    }

    h1 {
      margin-top: 0;
      color: #1f4e79;
    }

    .field {
      margin-bottom: 1rem;
    }

    label {
      display: block;
      font-size: 0.8rem;
      font-weight: 600;
      margin-bottom: 0.3rem;
    }

    input,
    select,
    textarea {
      width: 100%;
      padding: 0.6rem 0.65rem;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 0.9rem;
    }

    textarea {
      min-height: 90px;
    }

    button {
      background: #1f4e79;
      color: #fff;
      border: none;
      border-radius: 999px;
      padding: 0.7rem 1.4rem;
      font-weight: 600;
      cursor: pointer;
      margin-top: 0.5rem;
    }

    button:hover {
      background: #163857;
    }

    .status {
      margin-bottom: 0.75rem;
      font-size: 0.85rem;
    }

    .status.success {
      color: #0f7b46;
    }

    .status.error {
      color: #b3261e;
    }
  </style>
</head>
<body>

<div class="container">
  <h1>Your TradeBotPro profile</h1>

  <div id="status" class="status"></div>

  <form id="profile-form">
    <div class="field">
      <label for="business_name">Business name</label>
      <input id="business_name" required />
    </div>

    <div class="field">
      <label for="contact_name">Contact name</label>
      <input id="contact_name" required />
    </div>

    <div class="field">
      <label for="email">Email</label>
      <input id="email" type="email" required />
    </div>

    <div class="field">
      <label for="phone">Phone / WhatsApp</label>
      <input id="phone" />
    </div>

    <div class="field">
      <label for="trade_type">Trade type</label>
      <input id="trade_type" />
    </div>

    <div class="field">
      <label for="base_postcode">Main service area</label>
      <input id="base_postcode" />
    </div>

    <div class="field">
      <label for="plan_status">Plan</label>
      <input id="plan_status" />
    </div>

    <div class="field">
      <label for="services_summary">Notes / services</label>
      <textarea id="services_summary"></textarea>
    </div>

    <button type="submit">Save changes</button>
  </form>
</div>

<!-- Supabase -->
<script src="https://unpkg.com/@supabase/supabase-js@2.48.0/dist/umd/supabase.js"></script>

<script>
  // ------------------------
  // SUPABASE CONFIG
  // ------------------------
  const SUPABASE_URL = "https://yaiutswdcbfwkxfqxkzy.supabase.co";
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlhaXV0c3dkY2Jmd2t4ZnF4a3p5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1MDE2MDgsImV4cCI6MjA4MDA3NzYwOH0.HOLFxzjsZ5Ieqg0b-aTdP0hAdLsPVXL6Zjs-HgOHgc8";

  const supabaseClient = supabase.createClient(
    SUPABASE_URL,
    SUPABASE_ANON_KEY
  );

  // ------------------------
  // HELPERS
  // ------------------------
  const statusEl = document.getElementById("status");

  function setStatus(msg, type) {
    statusEl.textContent = msg || "";
    statusEl.className = "status " + (type || "");
  }

  // ------------------------
  // READ user_id FROM URL
  // ------------------------
  const params = new URLSearchParams(window.location.search);
  const signupId = params.get("user_id");

  if (!signupId) {
    setStatus("Missing user ID in link.", "error");
    throw new Error("No user_id in URL");
  }

  // ------------------------
  // LOAD PROFILE
  // ------------------------
  async function loadProfile() {
    const { data, error } = await supabaseClient
      .from("tradebotpro_signups")
      .select("*")
      .eq("id", signupId)
      .single();

    if (error) {
      console.error(error);
      setStatus("Could not load your profile.", "error");
      return;
    }

    document.getElementById("business_name").value = data.business_name || "";
    document.getElementById("contact_name").value = data.contact_name || "";
    document.getElementById("email").value = data.email || "";
    document.getElementById("phone").value = data.phone || "";
    document.getElementById("trade_type").value = data.trade_type || "";
    document.getElementById("base_postcode").value = data.base_postcode || "";
    document.getElementById("plan_status").value = data.plan_status || "";
    document.getElementById("services_summary").value =
      data.services_summary || "";

    setStatus("Profile loaded.", "success");
  }

  // ------------------------
  // SAVE PROFILE
  // ------------------------
  async function saveProfile(e) {
    e.preventDefault();

    setStatus("Saving changes…");

    const payload = {
      business_name: document.getElementById("business_name").value.trim(),
      contact_name: document.getElementById("contact_name").value.trim(),
      owner_name: document.getElementById("contact_name").value.trim(),
      email: document.getElementById("email").value.trim(),
      phone: document.getElementById("phone").value.trim(),
      trade_type: document.getElementById("trade_type").value.trim(),
      base_postcode: document.getElementById("base_postcode").value.trim(),
      plan_status: document.getElementById("plan_status").value.trim(),
      services_summary: document
        .getElementById("services_summary")
        .value.trim()
    };

    const { error } = await supabaseClient
      .from("tradebotpro_signups")
      .update(payload)
      .eq("id", signupId);

    if (error) {
      console.error(error);
      setStatus("Failed to save changes.", "error");
    } else {
      setStatus("Changes saved successfully.", "success");
    }
  }

  document
    .getElementById("profile-form")
    .addEventListener("submit", saveProfile);

  // ------------------------
  // INIT
  // ------------------------
  loadProfile();
</script>

</body>
</html>

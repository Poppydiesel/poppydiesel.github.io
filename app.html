<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TradeBotPro ‚Äì Setup your AI office</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta
    name="description"
    content="TradeBotPro ‚Äì update your pricing and AI style so your 24/7 office works the way you do."
  />
  <style>
    :root {
      --primary-blue: #1f4e79;
      --accent-blue: #00a3ff;
      --dark-text: #1b1b1f;
      --light-bg: #f5f7fa;
      --white: #ffffff;
      --danger: #b3261e;
      --success: #146c43;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      background: var(--light-bg);
      color: var(--dark-text);
      line-height: 1.5;
    }

    a {
      color: inherit;
      text-decoration: none;
    }

    .page {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: var(--white);
      border-bottom: 1px solid rgba(0,0,0,0.06);
      padding: 0.75rem 1.25rem;
    }

    .header-inner {
      max-width: 1100px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
    }

    .logo-wrap {
      display: flex;
      align-items: center;
      gap: 0.6rem;
    }

    .logo-icon {
      width: 32px;
      height: 32px;
      border-radius: 9px;
      background: var(--primary-blue);
      position: relative;
    }

    .logo-icon::before,
    .logo-icon::after {
      content: "";
      position: absolute;
      background: var(--white);
      border-radius: 4px;
    }

    .logo-icon::before {
      width: 12px;
      height: 18px;
      left: 7px;
      top: 7px;
    }

    .logo-icon::after {
      width: 6px;
      height: 12px;
      right: 7px;
      top: 10px;
    }

    .logo-main {
      font-weight: 700;
      font-size: 1.05rem;
      color: var(--primary-blue);
    }

    .logo-tag {
      font-size: 0.75rem;
      opacity: 0.7;
    }

    main {
      flex: 1;
    }

    .inner {
      max-width: 1100px;
      margin: 0 auto;
      padding: 1.75rem 1.25rem 2.5rem;
    }

    h1 {
      margin: 0 0 0.4rem;
      font-size: 1.8rem;
      color: var(--primary-blue);
    }

    .lead {
      margin: 0 0 1.4rem;
      max-width: 40rem;
      font-size: 0.95rem;
      opacity: 0.9;
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.1fr);
      gap: 1.6rem;
      align-items: flex-start;
    }

    .card {
      background: var(--white);
      border-radius: 1rem;
      padding: 1.25rem 1.3rem 1.4rem;
      box-shadow: 0 8px 20px rgba(0,0,0,0.04);
      font-size: 0.9rem;
    }

    .card h2 {
      margin: 0 0 0.75rem;
      font-size: 1.15rem;
      color: var(--primary-blue);
    }

    .meta-row {
      display: grid;
      grid-template-columns: minmax(0,1fr) minmax(0,1fr);
      gap: 0.75rem;
      margin-bottom: 0.6rem;
    }

    .meta-item {
      font-size: 0.85rem;
    }

    .meta-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      opacity: 0.6;
    }

    .meta-value {
      font-weight: 500;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 0.2rem 0.55rem;
      border-radius: 999px;
      font-size: 0.75rem;
      background: #e4eef8;
      color: var(--primary-blue);
      margin-right: 0.3rem;
    }

    form {
      margin-top: 0.2rem;
    }

    .field {
      margin-bottom: 0.85rem;
    }

    .field label {
      display: block;
      font-size: 0.8rem;
      font-weight: 500;
      margin-bottom: 0.25rem;
    }

    .field small {
      display: block;
      font-size: 0.7rem;
      opacity: 0.7;
      margin-top: 0.15rem;
    }

    .field input,
    .field textarea,
    .field select {
      width: 100%;
      padding: 0.55rem 0.6rem;
      border-radius: 0.5rem;
      border: 1px solid rgba(0,0,0,0.16);
      font: inherit;
      resize: vertical;
      min-height: 0;
    }

    .field input:focus,
    .field textarea:focus,
    .field select:focus {
      outline: 2px solid rgba(31,78,121,0.4);
      border-color: transparent;
    }

    .chips-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.35rem;
      margin-bottom: 0.25rem;
    }

    .chip-toggle {
      display: inline-flex;
      align-items: center;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.15);
      padding: 0.25rem 0.65rem;
      font-size: 0.78rem;
      cursor: pointer;
      background: var(--white);
    }

    .chip-toggle input {
      display: none;
    }

    .chip-toggle.active {
      background: #e4eef8;
      border-color: var(--primary-blue);
      color: var(--primary-blue);
      font-weight: 500;
    }

    .actions {
      margin-top: 1.1rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
      align-items: center;
    }

    .btn-primary {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.7rem 1.3rem;
      border-radius: 999px;
      border: none;
      background: var(--primary-blue);
      color: var(--white);
      font-weight: 600;
      font-size: 0.92rem;
      cursor: pointer;
    }

    .btn-primary:hover {
      background: #163857;
    }

    .status-text {
      font-size: 0.8rem;
      opacity: 0.85;
    }

    .status-text.success {
      color: var(--success);
      opacity: 1;
    }

    .status-text.error {
      color: var(--danger);
      opacity: 1;
    }

    .notice {
      font-size: 0.78rem;
      opacity: 0.75;
      margin-top: 0.7rem;
    }

    .error-box {
      margin-top: 0.7rem;
      padding: 0.55rem 0.7rem;
      border-radius: 0.5rem;
      background: #fef2f2;
      color: #b3261e;
      font-size: 0.8rem;
      border: 1px solid rgba(179,38,30,0.3);
    }

    footer {
      padding: 1rem 1.25rem;
      font-size: 0.78rem;
      text-align: center;
      color: rgba(0,0,0,0.6);
    }

    @media (max-width: 800px) {
      .layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }
  </style>
</head>
<body>
<div class="page">
  <header>
    <div class="header-inner">
      <div class="logo-wrap">
        <div class="logo-icon" aria-hidden="true"></div>
        <div>
          <div class="logo-main">TradeBotPro</div>
          <div class="logo-tag">More jobs. Less admin. Powered by AI.</div>
        </div>
      </div>
      <div style="font-size:0.8rem; opacity:0.8;">
        Secure setup link ‚Äì keep this page to yourself.
      </div>
    </div>
  </header>

  <main>
    <div class="inner">
      <h1>Set up your AI office</h1>
      <p class="lead">
        Check your business details, add your pricing and tell the AI how you like to work.
        This helps TradeBotPro sound like you and quote jobs the way you would.
      </p>

      <div id="global-error" class="error-box" style="display:none;"></div>

      <div class="layout">
        <!-- LEFT: business summary -->
        <section class="card" aria-labelledby="summary-heading">
          <h2 id="summary-heading">Your business details</h2>

          <p style="font-size:0.84rem; margin-top:0;">
            These come from the form you filled in when you joined TradeBotPro.
            If something looks wrong, just update it and hit save.
          </p>

          <div class="meta-row" style="margin-top:0.9rem;">
            <div class="meta-item">
              <div class="meta-label">Business name</div>
              <div class="meta-value" id="summary-business">‚Äì</div>
            </div>
            <div class="meta-item">
              <div class="meta-label">Contact name</div>
              <div class="meta-value" id="summary-contact">‚Äì</div>
            </div>
          </div>

          <div class="meta-row">
            <div class="meta-item">
              <div class="meta-label">Email</div>
              <div class="meta-value" id="summary-email">‚Äì</div>
            </div>
            <div class="meta-item">
              <div class="meta-label">Phone / WhatsApp</div>
              <div class="meta-value" id="summary-phone">‚Äì</div>
            </div>
          </div>

          <div class="meta-row">
            <div class="meta-item">
              <div class="meta-label">Trade</div>
              <div class="meta-value" id="summary-trade">‚Äì</div>
            </div>
            <div class="meta-item">
              <div class="meta-label">Base postcode / area</div>
              <div class="meta-value" id="summary-postcode">‚Äì</div>
            </div>
          </div>

          <div class="meta-row">
            <div class="meta-item">
              <div class="meta-label">Website</div>
              <div class="meta-value" id="summary-website">‚Äì</div>
            </div>
            <div class="meta-item">
              <div class="meta-label">Plan</div>
              <div class="meta-value" id="summary-plan">‚Äì</div>
            </div>
          </div>

          <p class="notice">
            Your setup link is tied to this account. If you lose it, just ask the TradeBotPro team
            and we‚Äôll send a new one.
          </p>
        </section>

        <!-- RIGHT: editable profile -->
        <section class="card" aria-labelledby="profile-heading">
          <h2 id="profile-heading">Pricing & AI profile</h2>

          <form id="profile-form">
            <div class="field">
              <label for="callout_fee">Standard call-out fee (¬£)</label>
              <input type="number" step="1" min="0" id="callout_fee" name="callout_fee" />
              <small>What you normally charge just to attend (before parts).</small>
            </div>

            <div class="field">
              <label for="first_hour_rate">Typical first hour (labour) (¬£)</label>
              <input type="number" step="1" min="0" id="first_hour_rate" name="first_hour_rate" />
              <small>For standard daytime jobs in your main area.</small>
            </div>

            <div class="field">
              <label for="hourly_rate">Hourly rate after first hour (¬£)</label>
              <input type="number" step="1" min="0" id="hourly_rate" name="hourly_rate" />
            </div>

            <div class="field">
              <label for="boiler_service_from">Boiler / system service from (¬£)</label>
              <input type="number" step="1" min="0" id="boiler_service_from" name="boiler_service_from" />
            </div>

            <div class="field">
              <label for="quote_minimum">Minimum job value you want to attend (¬£)</label>
              <input type="number" step="1" min="0" id="quote_minimum" name="quote_minimum" />
              <small>For example, ¬£80‚Äì¬£100 if you don‚Äôt want lots of tiny jobs.</small>
            </div>

            <div class="field">
              <label>What should your AI office focus on?</label>
              <div class="chips-row" id="focus-chips">
                <button type="button" class="chip-toggle" data-value="24/7 enquiry response">
                  24/7 enquiry response
                </button>
                <button type="button" class="chip-toggle" data-value="Booking more jobs">
                  Booking more jobs
                </button>
                <button type="button" class="chip-toggle" data-value="Better quality leads">
                  Better quality leads
                </button>
                <button type="button" class="chip-toggle" data-value="Chasing quotes & follow-ups">
                  Chasing quotes &amp; follow-ups
                </button>
                <button type="button" class="chip-toggle" data-value="Getting more Google reviews">
                  Getting more Google reviews
                </button>
              </div>
              <input
                type="hidden"
                id="services_summary"
                name="services_summary"
              />
              <small>
                Pick as many as you like. We‚Äôll use this to tune the AI‚Äôs priorities.
              </small>
            </div>

            <div class="field">
              <label for="ai_style_notes">Anything else we should know about how you work?</label>
              <textarea
                id="ai_style_notes"
                name="ai_style_notes"
                rows="4"
                placeholder="Examples: We don‚Äôt do oil or solid-fuel. We offer genuine 24/7 emergency cover within 15 miles of HP14. We prefer WhatsApp over calls when possible."
              ></textarea>
              <small>
                This is where you can add tone of voice, ‚Äúred lines‚Äù, areas you avoid, rough pricing rules ‚Äì anything that makes TradeBotPro feel like a real member of your team.
              </small>
            </div>

            <div class="actions">
              <button type="submit" class="btn-primary">Save my settings</button>
              <span id="save-status" class="status-text"></span>
            </div>
          </form>

          <p class="notice">
            You can come back and tweak this anytime. Changes you make here will be picked up by your
            TradeBotPro assistant for future conversations.
          </p>
        </section>
      </div>
    </div>
  </main>

  <footer>
    &copy; <span id="year"></span> TradeBotPro. All rights reserved.
  </footer>
</div>

<script>
  // ---------------------------------------------------------------------------
  // üîë SUPABASE CONFIG ‚Äì ANDY, THIS IS THE BIT YOU CARE ABOUT
  // ---------------------------------------------------------------------------
  // Leave the URL as it is (that's your project).
  // Replace the anon key with your real anon public key from:
  //   Supabase > Settings > API > "anon public"
  // Same key you used on the main signup form.
  const SUPABASE_URL = "https://yaiutswdcbfwkxfqxkzy.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlhaXV0c3dkY2Jmd2t4ZnF4a3p5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1MDE2MDgsImV4cCI6MjA4MDA3NzYwOH0.HOLFxzjsZ5Ieqg0b-aTdP0hAdLsPVXL6Zjs-HgOHgc8";

  // ---------------------------------------------------------------------------
  // UTILITIES
  // ---------------------------------------------------------------------------
  function getUserIdFromQuery() {
    const params = new URLSearchParams(window.location.search);
    const id = params.get('user_id') || '';
    return id.trim();
  }

  function setText(id, value) {
    const el = document.getElementById(id);
    if (el) el.textContent = value || '‚Äì';
  }

  function showGlobalError(message) {
    const box = document.getElementById('global-error');
    if (!box) return;
    if (!message) {
      box.style.display = 'none';
      box.textContent = '';
    } else {
      box.style.display = 'block';
      box.textContent = message;
    }
  }

  function setSaveStatus(message, type) {
    const el = document.getElementById('save-status');
    if (!el) return;
    el.textContent = message || '';
    el.className = 'status-text ' + (type || '');
  }

  // ---------------------------------------------------------------------------
  // FOCUS CHIPS HANDLING
  // ---------------------------------------------------------------------------
  function initFocusChips() {
    const container = document.getElementById('focus-chips');
    const hidden = document.getElementById('services_summary');
    if (!container || !hidden) return;

    function syncHidden() {
      const active = Array.from(container.querySelectorAll('.chip-toggle.active'))
        .map(btn => btn.getAttribute('data-value'));
      hidden.value = active.join(', ');
    }

    container.addEventListener('click', function (e) {
      const btn = e.target.closest('.chip-toggle');
      if (!btn) return;
      btn.classList.toggle('active');
      syncHidden();
    });

    // expose a helper to pre-populate from existing values
    container._setInitialFromString = function (value) {
      const current = (value || '').split(',').map(v => v.trim()).filter(Boolean);
      Array.from(container.querySelectorAll('.chip-toggle')).forEach(btn => {
        const v = btn.getAttribute('data-value');
        if (current.includes(v)) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });
      syncHidden();
    };
  }

  // ---------------------------------------------------------------------------
  // FETCH & SAVE PROFILE (business_profiles table)
  // ---------------------------------------------------------------------------
  async function fetchProfile(userId) {
    if (!supabaseUrl || !supabaseAnonKey) {
      throw new Error('Supabase config missing ‚Äì check supabaseUrl / supabaseAnonKey.');
    }

    const url = supabaseUrl +
      '/rest/v1/business_profiles?id=eq.' +
      encodeURIComponent(userId) +
      '&select=*';

    const res = await fetch(url, {
      method: 'GET',
      headers: {
        apikey: supabaseAnonKey,
        Authorization: 'Bearer ' + supabaseAnonKey,
        Accept: 'application/json'
      }
    });

    if (!res.ok) {
      const text = await res.text();
      throw new Error('Fetch failed: ' + res.status + ' ' + text);
    }

    const data = await res.json();
    if (!data || !data.length) {
      return null;
    }
    return data[0];
  }

  async function saveProfile(userId, currentProfile, form) {
    if (!supabaseUrl || !supabaseAnonKey) {
      throw new Error('Supabase config missing ‚Äì check supabaseUrl / supabaseAnonKey.');
    }

    // Start from the row we loaded from the DB so we don't accidentally
    // drop any columns that exist but we don't show in the form.
    const payload = currentProfile ? JSON.parse(JSON.stringify(currentProfile)) : {};

    function numValue(name) {
      const val = form[name]?.value ?? '';
      if (val === '') return null;
      const n = Number(val);
      return isNaN(n) ? null : n;
    }

    function textValue(name) {
      const val = form[name]?.value ?? '';
      const trimmed = val.trim();
      return trimmed === '' ? null : trimmed;
    }

    payload.callout_fee = numValue('callout_fee');
    payload.first_hour_rate = numValue('first_hour_rate');
    payload.hourly_rate = numValue('hourly_rate');
    payload.boiler_service_from = numValue('boiler_service_from');
    payload.quote_minimum = numValue('quote_minimum');
    payload.services_summary = textValue('services_summary');
    payload.ai_style_notes = textValue('ai_style_notes');

    const url = supabaseUrl +
      '/rest/v1/business_profiles?id=eq.' +
      encodeURIComponent(userId);

    const res = await fetch(url, {
      method: 'PATCH',
      headers: {
        apikey: supabaseAnonKey,
        Authorization: 'Bearer ' + supabaseAnonKey,
        'Content-Type': 'application/json',
        Prefer: 'return=representation'
      },
      body: JSON.stringify(payload)
    });

    if (!res.ok) {
      const text = await res.text();
      throw new Error('Save failed: ' + res.status + ' ' + text);
    }

    const data = await res.json();
    return data && data.length ? data[0] : payload;
  }

  // ---------------------------------------------------------------------------
  // INITIALISE
  // ---------------------------------------------------------------------------
  (function initialise() {
    document.getElementById('year').textContent = new Date().getFullYear();
    initFocusChips();

    const userId = getUserIdFromQuery();
    let currentProfile = null;

    if (!userId) {
      showGlobalError('This page needs a ?user_id=‚Ä¶ in the URL. Please use the secure setup link sent to you.');
      return;
    }

    // Load profile
    (async function () {
      try {
        showGlobalError('');
        setSaveStatus('Loading your profile‚Ä¶', '');

        const profile = await fetchProfile(userId);
        if (!profile) {
          setSaveStatus('', '');
          showGlobalError('We couldn‚Äôt find a profile for this link. Please contact TradeBotPro support.');
          return;
        }

        currentProfile = profile;

        // Fill summary block
        setText('summary-business', profile.business_name || '');
        setText('summary-contact', profile.contact_name || '');
        setText('summary-email', profile.email || '');
        setText('summary-phone', profile.phone || profile.whatsapp_number || '');
        setText('summary-trade', profile.trade_type || '');
        setText('summary-postcode', profile.base_postcode || '');
        setText('summary-website', profile.website_url || '');
        setText('summary-plan', profile.plan_status || '');

        // Fill editable fields
        const form = document.getElementById('profile-form');
        if (form) {
          if (profile.callout_fee != null) form.callout_fee.value = profile.callout_fee;
          if (profile.first_hour_rate != null) form.first_hour_rate.value = profile.first_hour_rate;
          if (profile.hourly_rate != null) form.hourly_rate.value = profile.hourly_rate;
          if (profile.boiler_service_from != null) form.boiler_service_from.value = profile.boiler_service_from;
          if (profile.quote_minimum != null) form.quote_minimum.value = profile.quote_minimum;
          if (profile.services_summary) {
            form.services_summary.value = profile.services_summary;
            const chipsContainer = document.getElementById('focus-chips');
            if (chipsContainer && typeof chipsContainer._setInitialFromString === 'function') {
              chipsContainer._setInitialFromString(profile.services_summary);
            }
          }
          if (profile.ai_style_notes) form.ai_style_notes.value = profile.ai_style_notes;
        }

        setSaveStatus('', '');
      } catch (err) {
        console.error('Fetch profile error:', err);
        setSaveStatus('', '');
        showGlobalError('There was a problem loading your profile. Please refresh the page or contact TradeBotPro.');
      }
    })();

    // Handle save
    const form = document.getElementById('profile-form');
    if (form) {
      form.addEventListener('submit', async function (e) {
        e.preventDefault();
        setSaveStatus('Saving‚Ä¶', '');
        showGlobalError('');

        try {
          const updated = await saveProfile(userId, currentProfile, form);
          currentProfile = updated;
          setSaveStatus('Saved. Your AI office will use these settings from now on.', 'success');
        } catch (err) {
          console.error('Save profile error:', err);
          setSaveStatus('Something went wrong saving your settings.', 'error');
          showGlobalError('We couldn‚Äôt save your changes. Please check your connection and try again. If it keeps happening, send a screenshot to TradeBotPro support.');
        }
      });
    }
  })();
</script>
</body>
</html>

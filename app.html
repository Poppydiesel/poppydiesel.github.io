<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TradeBotPro — Your AI Office Setup</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta
    name="description"
    content="Update your TradeBotPro business profile so your AI office can reply in your tone, with your prices and service area."
  />

  <style>
    :root {
      --primary-blue: #1f4e79;
      --accent-blue: #00a3ff;
      --dark-text: #1b1b1f;
      --light-bg: #f5f7fa;
      --white: #ffffff;
      --border-soft: rgba(0,0,0,0.08);
    }

    * {
      box-sizing: border-box;
    }

    html {
      scroll-behavior: smooth;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      background: var(--light-bg);
      color: var(--dark-text);
      line-height: 1.6;
    }

    a {
      color: inherit;
      text-decoration: none;
    }

    .page {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .inner {
      max-width: 1120px;
      margin: 0 auto;
      padding: 0 1.25rem;
    }

    /* HEADER */
    header {
      background: rgba(245, 247, 250, 0.97);
      backdrop-filter: blur(6px);
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      padding: 0.75rem 0;
      font-size: 0.9rem;
    }

    .logo-wrap {
      display: flex;
      align-items: center;
      gap: 0.6rem;
    }

    .logo-icon {
      width: 32px;
      height: 32px;
      border-radius: 9px;
      background: var(--primary-blue);
      position: relative;
    }

    .logo-icon::before,
    .logo-icon::after {
      content: "";
      position: absolute;
      background: var(--white);
      border-radius: 4px;
    }

    .logo-icon::before {
      width: 12px;
      height: 18px;
      left: 7px;
      top: 7px;
    }

    .logo-icon::after {
      width: 6px;
      height: 12px;
      right: 7px;
      top: 10px;
    }

    .logo-main {
      font-weight: 700;
      font-size: 1.05rem;
      color: var(--primary-blue);
    }

    .logo-tag {
      font-size: 0.7rem;
      opacity: 0.7;
    }

    /* MAIN LAYOUT */
    main {
      padding: 2.5rem 0 3rem;
      flex: 1;
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1fr);
      gap: 2rem;
      align-items: flex-start;
    }

    @media (max-width: 900px) {
      .layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .intro {
      font-size: 0.95rem;
    }

    .intro h1 {
      margin: 0 0 0.5rem;
      font-size: 2rem;
      color: var(--primary-blue);
    }

    .intro-kicker {
      font-size: 0.82rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--accent-blue);
      margin-bottom: 0.3rem;
      font-weight: 600;
    }

    .intro-highlight {
      margin-top: 0.9rem;
      padding: 0.85rem 0.95rem;
      border-radius: 0.9rem;
      border: 1px dashed rgba(0,0,0,0.18);
      background: var(--white);
      font-size: 0.85rem;
    }

    .intro-highlight strong {
      color: var(--primary-blue);
    }

    /* CARD / FORM */
    .card {
      background: var(--white);
      border-radius: 1rem;
      padding: 1.4rem 1.5rem 1.6rem;
      box-shadow: 0 10px 26px rgba(0, 0, 0, 0.06);
      font-size: 0.9rem;
      border: 1px solid rgba(0,0,0,0.02);
    }

    .card h2 {
      margin: 0 0 0.4rem;
      font-size: 1.15rem;
      color: var(--primary-blue);
    }

    .card-subtitle {
      font-size: 0.82rem;
      opacity: 0.8;
      margin-bottom: 1rem;
    }

    .form-section-title {
      font-size: 0.82rem;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--accent-blue);
      margin: 1.1rem 0 0.35rem;
      font-weight: 600;
    }

    .form-grid-two {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.75rem 0.9rem;
    }

    @media (max-width: 640px) {
      .form-grid-two {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .field {
      margin-bottom: 0.75rem;
    }

    .field label {
      display: block;
      font-size: 0.8rem;
      margin-bottom: 0.22rem;
      font-weight: 500;
    }

    .field small {
      display: block;
      font-size: 0.75rem;
      opacity: 0.7;
      margin-top: 0.15rem;
    }

    .field input,
    .field select,
    .field textarea {
      width: 100%;
      padding: 0.55rem 0.65rem;
      border-radius: 0.5rem;
      border: 1px solid rgba(0,0,0,0.16);
      font: inherit;
      resize: vertical;
      min-height: 2.4rem;
    }

    .field textarea {
      min-height: 4.4rem;
    }

    .field input:focus,
    .field select:focus,
    .field textarea:focus {
      outline: 2px solid rgba(31, 78, 121, 0.45);
      border-color: transparent;
    }

    .status-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
      align-items: center;
      margin-top: 0.4rem;
    }

    .status-pill {
      padding: 0.25rem 0.75rem;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      font-size: 0.78rem;
      cursor: pointer;
      background: #f7f9fc;
    }

    .status-pill.active {
      background: var(--primary-blue);
      color: #fff;
      border-color: var(--primary-blue);
    }

    .checkbox-row {
      display: flex;
      gap: 0.45rem;
      align-items: flex-start;
      font-size: 0.8rem;
      margin-top: 0.4rem;
    }

    .checkbox-row input {
      margin-top: 0.15rem;
    }

    .btn-row {
      margin-top: 1.3rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.7rem;
      align-items: center;
    }

    .btn-primary {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.75rem 1.4rem;
      border-radius: 999px;
      border: none;
      background: var(--primary-blue);
      color: var(--white);
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
    }

    .btn-primary:hover {
      background: #163857;
    }

    .btn-secondary {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.6rem 1.1rem;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: #f5f7fa;
      font-size: 0.83rem;
      cursor: pointer;
    }

    .hint-text {
      font-size: 0.78rem;
      opacity: 0.75;
    }

    .status-banner {
      margin-bottom: 0.9rem;
      padding: 0.6rem 0.75rem;
      border-radius: 0.7rem;
      font-size: 0.8rem;
      display: none;
    }

    .status-banner.info {
      background: #e9f0f7;
      border: 1px solid rgba(0,0,0,0.04);
    }

    .status-banner.error {
      background: #ffe8e8;
      border: 1px solid rgba(168, 16, 16, 0.2);
      color: #661111;
    }

    .status-banner.success {
      background: #e4f6ea;
      border: 1px solid rgba(29, 115, 60, 0.25);
      color: #215b35;
    }

    .status-dot {
      display: inline-block;
      width: 7px;
      height: 7px;
      border-radius: 50%;
      margin-right: 0.3rem;
      background: var(--accent-blue);
    }

    .status-banner.error .status-dot {
      background: #d13438;
    }

    .status-banner.success .status-dot {
      background: #107c41;
    }

    footer {
      background: var(--white);
      border-top: 1px solid rgba(0, 0, 0, 0.06);
      font-size: 0.8rem;
    }

    .footer-inner {
      padding: 1rem 1.25rem 1.3rem;
      display: flex;
      justify-content: space-between;
      gap: 1rem;
      flex-wrap: wrap;
      align-items: center;
    }
  </style>
</head>
<body>
<div class="page">

  <!-- HEADER -->
  <header>
    <div class="inner">
      <div class="nav">
        <div class="logo-wrap">
          <div class="logo-icon" aria-hidden="true"></div>
          <div>
            <div class="logo-main">TradeBotPro</div>
            <div class="logo-tag">More jobs. Less admin. Powered by AI.</div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="inner layout">
      <!-- LEFT COLUMN: EXPLANATION -->
      <section class="intro">
        <div class="intro-kicker">Your AI office profile</div>
        <h1>Tell TradeBotPro how you work.</h1>
        <p>
          This page lets you keep your <strong>business details, pricing and service area</strong> up to date
          so your AI office sounds like you, quotes sensibly and only books work you actually want.
        </p>
        <p>
          You can update this any time. If something doesn’t make sense, leave it blank and we’ll help you
          during onboarding.
        </p>
        <div class="intro-highlight">
          <strong>Quick tip:</strong> Start with the basics (business name, contact details, service area)
          and a rough idea of your call-out / first hour pricing. We can refine the rest with you.
        </div>
      </section>

      <!-- RIGHT COLUMN: FORM -->
      <section class="card">
        <h2>Your TradeBotPro profile</h2>
        <div class="card-subtitle">
          This link is unique to your signup. Please don’t share it publicly.
        </div>

        <div id="statusBanner" class="status-banner info">
          <span class="status-dot"></span>
          <span id="statusText">Please wait while we load your profile…</span>
        </div>

        <form id="profileForm" style="display:none;">
          <!-- BUSINESS DETAILS -->
          <div class="form-section-title">Business details</div>
          <div class="form-grid-two">
            <div class="field">
              <label for="business_name">Business name</label>
              <input id="business_name" name="business_name" type="text" autocomplete="organization" />
            </div>
            <div class="field">
              <label for="owner_name">Owner / main contact</label>
              <input id="owner_name" name="owner_name" type="text" autocomplete="name" />
            </div>
          </div>

          <div class="form-grid-two">
            <div class="field">
              <label for="email">Email</label>
              <input id="email" name="email" type="email" autocomplete="email" />
            </div>
            <div class="field">
              <label for="whatsapp_number">Mobile / WhatsApp number</label>
              <input id="whatsapp_number" name="whatsapp_number" type="tel" autocomplete="tel" />
              <small>Where TradeBotPro will handle your chats.</small>
            </div>
          </div>

          <div class="field">
            <label for="phone">Optional landline</label>
            <input id="phone" name="phone" type="tel" autocomplete="tel" />
          </div>

          <div class="form-grid-two">
            <div class="field">
              <label for="trade_type">Trade</label>
              <select id="trade_type" name="trade_type">
                <option value="">Select your trade…</option>
                <option>Plumber</option>
                <option>Heating Engineer</option>
                <option>Gas Engineer</option>
                <option>Electrician</option>
                <option>Builder</option>
                <option>Handyman</option>
                <option>Landscaper / Gardener</option>
                <option>Cleaner / Carpet Cleaner</option>
                <option>Pest Control</option>
                <option>Other</option>
              </select>
            </div>
            <div class="field">
              <label for="website_url">Website (optional)</label>
              <input id="website_url" name="website_url" type="url" placeholder="https://…" />
            </div>
          </div>

          <!-- SERVICE AREA & PRICING -->
          <div class="form-section-title">Service area & pricing</div>

          <div class="form-grid-two">
            <div class="field">
              <label for="base_postcode">Base postcode / town</label>
              <input id="base_postcode" name="base_postcode" type="text" />
            </div>
            <div class="field">
              <label for="service_radius">Service radius (miles)</label>
              <input id="service_radius" name="service_radius" type="number" min="0" step="1" />
            </div>
          </div>

          <div class="form-grid-two">
            <div class="field">
              <label for="callout_fee">Typical call-out fee (£)</label>
              <input id="callout_fee" name="callout_fee" type="number" min="0" step="1" />
            </div>
            <div class="field">
              <label for="first_hour_rate">First hour rate (£)</label>
              <input id="first_hour_rate" name="first_hour_rate" type="number" min="0" step="1" />
            </div>
          </div>

          <div class="form-grid-two">
            <div class="field">
              <label for="hourly_rate">Hourly rate after first hour (£)</label>
              <input id="hourly_rate" name="hourly_rate" type="number" min="0" step="1" />
            </div>
            <div class="field">
              <label for="boiler_service_from">Boiler service from (£, if relevant)</label>
              <input id="boiler_service_from" name="boiler_service_from" type="number" min="0" step="1" />
            </div>
          </div>

          <div class="field">
            <label for="quote_minimum">Minimum quote amount (£)</label>
            <input id="quote_minimum" name="quote_minimum" type="number" min="0" step="1" />
            <small>Below this, TradeBotPro can politely decline or group into other work.</small>
          </div>

          <!-- WHAT THE AI SHOULD FOCUS ON -->
          <div class="form-section-title">What should your AI office focus on?</div>
          <div class="field">
            <label for="services_summary">Main services you want more of</label>
            <textarea id="services_summary" name="services_summary"
              placeholder="E.g. Boiler breakdowns in Oxford, boiler servicing, landlord certificates, emergency leaks within 15 miles of OX5…"></textarea>
          </div>

          <div class="field">
            <label for="ai_style_notes">How should TradeBotPro sound & behave?</label>
            <textarea id="ai_style_notes" name="ai_style_notes"
              placeholder="E.g. Friendly but straight-talking, avoid jargon, give rough prices not exact, never promise same-day unless clearly available…"></textarea>
          </div>

          <!-- INTERNAL / ACCOUNT STATUS (for you, but visible here) -->
          <div class="form-section-title">Account status</div>

          <div class="field">
            <label>Plan status</label>
            <div class="status-row" id="planStatusRow">
              <button type="button" class="status-pill" data-plan-status="Trial">Trial</button>
              <button type="button" class="status-pill" data-plan-status="Live">Live</button>
              <button type="button" class="status-pill" data-plan-status="Paused">Paused</button>
              <button type="button" class="status-pill" data-plan-status="Pending setup">Pending setup</button>
            </div>
            <input type="hidden" id="plan_status" name="plan_status" />
          </div>

          <div class="checkbox-row">
            <input id="is_active" name="is_active" type="checkbox" />
            <label for="is_active">TradeBotPro is active for this business</label>
          </div>

          <div class="field">
            <label for="account_status">Internal account status (optional)</label>
            <input id="account_status" name="account_status" type="text"
              placeholder="e.g. Good payer, Needs training call, On hold…" />
          </div>

          <div class="field">
            <label for="account_status_reason">Notes about status</label>
            <textarea id="account_status_reason" name="account_status_reason"
              placeholder="Anything you or support should remember about this account."></textarea>
          </div>

          <input type="hidden" id="pending_setup" name="pending_setup" />

          <div class="btn-row">
            <button type="submit" class="btn-primary">Save changes</button>
            <button type="button" class="btn-secondary" id="resetBtn">Reset to last saved</button>
            <span class="hint-text" id="lastSavedHint"></span>
          </div>
        </form>
      </section>
    </div>
  </main>

  <footer>
    <div class="inner footer-inner">
      <div>&copy; <span id="year"></span> TradeBotPro. All rights reserved.</div>
      <div>Need help? Email <a href="mailto:hello@tradebotpro.co.uk">hello@tradebotpro.co.uk</a></div>
    </div>
  </footer>
</div>

<script>
  document.getElementById('year').textContent = new Date().getFullYear();

  // ====== SUPABASE CONFIG – REQUIRED ======
  // 1) Replace the URL below with your Supabase project URL
  // 2) Replace the anon key below with your PUBLIC anon key
  //    (the same one you already use on your main signup form).
  const SUPABASE_URL = "https://yaiutswdcbfwkxfqxkzy.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlhaXV0c3dkY2Jmd2t4ZnF4a3p5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1MDE2MDgsImV4cCI6MjA4MDA3NzYwOH0.HOLFxzjsZ5Ieqg0b-aTdP0hAdLsPVXL6Zjs-HgOHgc8";
  // =======================================

  // Small sanity check so we don't silently fail
  if (!supabaseUrl || supabaseUrl.indexOf('supabase.co') === -1) {
    console.error('Supabase URL is not set. Please update supabaseUrl at the top of app.html.');
  }
  if (!supabaseAnonKey || supabaseAnonKey === 'PASTE_YOUR_SUPABASE_ANON_KEY_HERE') {
    console.error('Supabase anon key is not set. Please update supabaseAnonKey at the top of app.html.');
  }

  const statusBanner = document.getElementById('statusBanner');
  const statusText = document.getElementById('statusText');
  const form = document.getElementById('profileForm');
  const resetBtn = document.getElementById('resetBtn');
  const lastSavedHint = document.getElementById('lastSavedHint');

  let currentSignupId = null;
  let currentProfileId = null;
  let lastLoadedProfile = null;

  function setBanner(mode, message) {
    // mode: 'info' | 'error' | 'success' | 'hidden'
    statusBanner.style.display = (mode === 'hidden') ? 'none' : 'block';
    statusBanner.classList.remove('info', 'error', 'success');
    if (mode !== 'hidden') {
      statusBanner.classList.add(mode);
    }
    if (message !== undefined && message !== null) {
      statusText.textContent = message;
    }
  }

  function getSignupIdFromUrl() {
    const params = new URLSearchParams(window.location.search);
    const id = params.get('user_id') || '';
    return id.trim();
  }

  async function fetchJson(url, options) {
    const res = await fetch(url, options);
    const text = await res.text();
    if (!res.ok) {
      throw new Error('Fetch failed: ' + res.status + ' ' + text);
    }
    try {
      return text ? JSON.parse(text) : null;
    } catch (e) {
      return null;
    }
  }

  async function loadProfile(signupId) {
    setBanner('info', 'Please wait while we load your profile…');
    form.style.display = 'none';

    if (!signupId) {
      setBanner('error', 'We could not find a signup for this link (missing user_id in URL).');
      return;
    }

    try {
      // Fetch profile by signup_id
      const url = supabaseUrl +
        '/rest/v1/business_profiles?signup_id=eq.' +
        encodeURIComponent(signupId) +
        '&select=*';

      const data = await fetchJson(url, {
        method: 'GET',
        headers: {
          apikey: supabaseAnonKey,
          Authorization: 'Bearer ' + supabaseAnonKey
        }
      });

      if (!Array.isArray(data) || data.length === 0) {
        // No profile yet — show form but empty, with a note
        currentProfileId = null;
        lastLoadedProfile = {};
        populateForm({});
        form.style.display = 'block';
        setBanner('info', 'We could not find a signup for this link. You can still fill this in and save it.');
        return;
      }

      const profile = data[0];
      currentProfileId = profile.id || null;
      lastLoadedProfile = profile;

      populateForm(profile);
      form.style.display = 'block';
      setBanner('hidden');
      updateLastSavedHint();
    } catch (err) {
      console.error('Fetch profile error:', err);
      setBanner('error', 'There was a problem loading your profile. Please refresh the page, or email hello@tradebotpro.co.uk with a screenshot.');
    }
  }

  function populateForm(p) {
    function setValue(id, value) {
      const el = document.getElementById(id);
      if (!el) return;
      if (el.type === 'checkbox') {
        el.checked = !!value;
      } else {
        el.value = value == null ? '' : String(value);
      }
    }

    setValue('business_name', p.business_name);
    setValue('owner_name', p.owner_name);
    setValue('email', p.email);
    setValue('whatsapp_number', p.whatsapp_number);
    setValue('phone', p.phone);
    setValue('trade_type', p.trade_type);
    setValue('website_url', p.website_url);
    setValue('base_postcode', p.base_postcode);
    setValue('service_radius', p.service_radius);
    setValue('callout_fee', p.callout_fee);
    setValue('first_hour_rate', p.first_hour_rate);
    setValue('hourly_rate', p.hourly_rate);
    setValue('boiler_service_from', p.boiler_service_from);
    setValue('quote_minimum', p.quote_minimum);
    setValue('services_summary', p.services_summary);
    setValue('ai_style_notes', p.ai_style_notes);
    setValue('plan_status', p.plan_status);
    setValue('account_status', p.account_status);
    setValue('account_status_reason', p.account_status_reason);
    setValue('pending_setup', p.pending_setup);
    setValue('is_active', p.is_active);

    // Update plan status pills
    syncPlanStatusPills();
  }

  function readFormValues() {
    function getValue(id) {
      const el = document.getElementById(id);
      if (!el) return null;
      if (el.type === 'checkbox') {
        return !!el.checked;
      }
      return el.value.trim() === '' ? null : el.value.trim();
    }

    const payload = {
      business_name: getValue('business_name'),
      owner_name: getValue('owner_name'),
      email: getValue('email'),
      whatsapp_number: getValue('whatsapp_number'),
      phone: getValue('phone'),
      trade_type: getValue('trade_type'),
      website_url: getValue('website_url'),
      base_postcode: getValue('base_postcode'),
      service_radius: getValue('service_radius') ? Number(getValue('service_radius')) : null,
      callout_fee: getValue('callout_fee') ? Number(getValue('callout_fee')) : null,
      first_hour_rate: getValue('first_hour_rate') ? Number(getValue('first_hour_rate')) : null,
      hourly_rate: getValue('hourly_rate') ? Number(getValue('hourly_rate')) : null,
      boiler_service_from: getValue('boiler_service_from') ? Number(getValue('boiler_service_from')) : null,
      quote_minimum: getValue('quote_minimum') ? Number(getValue('quote_minimum')) : null,
      services_summary: getValue('services_summary'),
      ai_style_notes: getValue('ai_style_notes'),
      plan_status: getValue('plan_status'),
      is_active: getValue('is_active'),
      account_status: getValue('account_status'),
      account_status_reason: getValue('account_status_reason'),
      pending_setup: getValue('pending_setup')
    };

    return payload;
  }

  async function saveProfile(event) {
    event.preventDefault();
    if (!currentSignupId) {
      setBanner('error', 'This link is missing a user_id. Please contact support.');
      return;
    }

    const payload = readFormValues();

    try {
      setBanner('info', 'Saving your changes…');

      let url, method;

      if (currentProfileId) {
        // Update existing profile
        url = supabaseUrl + '/rest/v1/business_profiles?id=eq.' + encodeURIComponent(currentProfileId);
        method = 'PATCH';
      } else {
        // Create new profile, linked to signup
        payload.signup_id = currentSignupId;
        url = supabaseUrl + '/rest/v1/business_profiles';
        method = 'POST';
      }

      const data = await fetchJson(url, {
        method: method,
        headers: {
          apikey: supabaseAnonKey,
          Authorization: 'Bearer ' + supabaseAnonKey,
          'Content-Type': 'application/json',
          Prefer: 'return=representation'
        },
        body: JSON.stringify(payload)
      });

      if (Array.isArray(data) && data.length > 0) {
        const profile = data[0];
        currentProfileId = profile.id || currentProfileId;
        lastLoadedProfile = profile;
        populateForm(profile);
      }

      setBanner('success', 'Saved. Your AI office will now use these details.');
      updateLastSavedHint();
    } catch (err) {
      console.error('Save profile error:', err);
      setBanner('error', 'There was an error saving your profile. Please try again, or email us if it keeps happening.');
    }
  }

  function updateLastSavedHint() {
    if (!lastLoadedProfile || !lastLoadedProfile.updated_at && !lastLoadedProfile.created_at) {
      lastSavedHint.textContent = '';
      return;
    }
    const ts = lastLoadedProfile.updated_at || lastLoadedProfile.created_at;
    try {
      const d = new Date(ts);
      if (!isNaN(d.getTime())) {
        lastSavedHint.textContent = 'Last saved: ' + d.toLocaleString();
      }
    } catch (e) {
      lastSavedHint.textContent = '';
    }
  }

  // Plan status pill helpers
  function syncPlanStatusPills() {
    const current = (document.getElementById('plan_status').value || '').trim();
    const row = document.getElementById('planStatusRow');
    if (!row) return;
    const pills = row.querySelectorAll('.status-pill');
    pills.forEach(function(pill) {
      const value = pill.getAttribute('data-plan-status') || '';
      if (value === current) {
        pill.classList.add('active');
      } else {
        pill.classList.remove('active');
      }
    });
  }

  function setupPlanStatusPills() {
    const row = document.getElementById('planStatusRow');
    if (!row) return;
    row.addEventListener('click', function(e) {
      const target = e.target;
      if (!target.classList.contains('status-pill')) return;
      const value = target.getAttribute('data-plan-status') || '';
      const hidden = document.getElementById('plan_status');
      hidden.value = value;
      syncPlanStatusPills();
    });
  }

  function resetForm() {
    if (!lastLoadedProfile) return;
    populateForm(lastLoadedProfile);
    setBanner('info', 'Reverted to last saved version.');
    updateLastSavedHint();
  }

  async function initialise() {
    setupPlanStatusPills();

    currentSignupId = getSignupIdFromUrl();

    if (!currentSignupId) {
      setBanner('error', 'We could not find a signup for this link (no user_id in URL).');
      return;
    }

    await loadProfile(currentSignupId);
  }

  form.addEventListener('submit', saveProfile);
  resetBtn.addEventListener('click', resetForm);

  window.addEventListener('DOMContentLoaded', initialise);
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TradeBotPro — Business Setup</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --primary-blue: #1f4e79;
      --accent-blue: #00a3ff;
      --dark-text: #1b1b1f;
      --light-bg: #f5f7fa;
      --white: #ffffff;
      --border-subtle: #dde3ee;
      --muted-text: #6c7280;
      --danger: #c0392b;
      --success: #1f8f4d;
    }

    * {
      box-sizing: border-box;
    }

    html {
      scroll-behavior: smooth;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      background: var(--light-bg);
      color: var(--dark-text);
      line-height: 1.6;
    }

    .page-shell {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: var(--white);
      border-bottom: 1px solid var(--border-subtle);
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .logo-lockup {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-circle {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      background: var(--primary-blue);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--white);
      font-weight: 700;
      font-size: 18px;
    }

    .logo-text-main {
      font-weight: 700;
      letter-spacing: 0.04em;
    }

    .logo-text-sub {
      font-size: 12px;
      color: var(--muted-text);
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 16px;
      font-size: 14px;
    }

    .pill {
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      padding: 4px 10px;
      font-size: 12px;
      color: var(--muted-text);
      background: #f8fafc;
    }

    .main-layout {
      flex: 1;
      display: grid;
      grid-template-columns: minmax(0, 1.4fr) minmax(0, 2fr);
      gap: 24px;
      padding: 24px;
      max-width: 1200px;
      margin: 0 auto;
    }

    @media (max-width: 900px) {
      .main-layout {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: var(--white);
      border-radius: 16px;
      border: 1px solid var(--border-subtle);
      padding: 20px 20px 16px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.03);
    }

    .hero-heading {
      font-size: 26px;
      font-weight: 700;
      margin: 0 0 8px;
      color: var(--primary-blue);
    }

    .hero-subheading {
      margin: 0 0 16px;
      font-size: 14px;
      color: var(--muted-text);
    }

    .badge-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 14px;
    }

    .badge {
      font-size: 11px;
      padding: 3px 9px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: #f8fafc;
      color: var(--muted-text);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .badge-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--accent-blue);
    }

    .steps-list {
      list-style: none;
      padding: 0;
      margin: 0 0 12px;
      font-size: 13px;
      color: var(--muted-text);
    }

    .steps-list li {
      margin-bottom: 4px;
      display: flex;
      align-items: flex-start;
      gap: 8px;
    }

    .steps-bullet {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      color: var(--primary-blue);
      flex-shrink: 0;
      margin-top: 2px;
    }

    .mini-metrics {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
      margin-top: 12px;
      font-size: 12px;
    }

    .mini-metric {
      border-radius: 10px;
      border: 1px dashed var(--border-subtle);
      padding: 8px;
      background: #fbfcff;
    }

    .mini-metric-label {
      color: var(--muted-text);
      margin-bottom: 4px;
    }

    .mini-metric-value {
      font-weight: 600;
      color: var(--primary-blue);
    }

    .status-pill-row {
      margin-top: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      font-size: 11px;
    }

    .status-pill {
      padding: 3px 10px;
      border-radius: 999px;
      background: #eefcf4;
      color: var(--success);
      border: 1px solid rgba(31, 143, 77, 0.3);
    }

    .status-pill.danger {
      background: #fff3f1;
      color: var(--danger);
      border-color: rgba(192, 57, 43, 0.35);
    }

    /* FORM SIDE */

    h2.form-title {
      margin: 0 0 4px;
      font-size: 20px;
      color: var(--primary-blue);
    }

    .form-subtitle {
      margin: 0 0 16px;
      font-size: 13px;
      color: var(--muted-text);
    }

    form {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .field-group {
      display: flex;
      gap: 12px;
    }

    .field {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 13px;
    }

    .field label {
      font-weight: 500;
    }

    .field small {
      font-size: 11px;
      color: var(--muted-text);
    }

    input[type="text"],
    input[type="email"],
    input[type="tel"],
    input[type="number"],
    select,
    textarea {
      width: 100%;
      font-family: inherit;
      font-size: 13px;
      padding: 7px 9px;
      border-radius: 8px;
      border: 1px solid var(--border-subtle);
      background: #fdfdff;
      transition: border-color 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    }

    textarea {
      min-height: 70px;
      resize: vertical;
    }

    input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: var(--accent-blue);
      box-shadow: 0 0 0 1px rgba(0, 163, 255, 0.2);
      background: #ffffff;
    }

    .inline-checkbox-row {
      display: flex;
      flex-wrap: wrap;
      gap: 14px;
      font-size: 13px;
      margin-top: 4px;
    }

    .inline-checkbox {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .inline-checkbox input[type="checkbox"] {
      width: 14px;
      height: 14px;
    }

    .form-footer {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-top: 6px;
    }

    button.primary {
      background: linear-gradient(135deg, var(--primary-blue), #163555);
      border: none;
      color: var(--white);
      padding: 9px 18px;
      border-radius: 999px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.12);
      transition: transform 0.1s ease, box-shadow 0.1s ease, filter 0.1s ease;
    }

    button.primary:hover {
      filter: brightness(1.03);
      transform: translateY(-1px);
      box-shadow: 0 14px 26px rgba(0, 0, 0, 0.16);
    }

    button.primary:disabled {
      opacity: 0.7;
      cursor: default;
      transform: none;
      box-shadow: none;
    }

    .button-label-sub {
      font-size: 11px;
      color: var(--muted-text);
    }

    .status-text {
      font-size: 12px;
      color: var(--muted-text);
    }

    .status-text strong {
      color: var(--primary-blue);
    }

    .status-text.error {
      color: var(--danger);
    }

    .status-text.success {
      color: var(--success);
    }

    .tiny {
      font-size: 10px;
      color: var(--muted-text);
      margin-top: 2px;
    }

    footer {
      text-align: center;
      font-size: 11px;
      color: var(--muted-text);
      padding: 10px 16px 18px;
    }
  </style>
</head>
<body>
  <div class="page-shell">
    <header>
      <div class="logo-lockup">
        <div class="logo-circle">T</div>
        <div>
          <div class="logo-text-main">TradeBotPro</div>
          <div class="logo-text-sub">24/7 AI office for trades &amp; home services</div>
        </div>
      </div>
      <div class="header-right">
        <div class="pill">Step 2 of 3 — Tell us about your business</div>
        <div style="font-size: 12px; color: var(--muted-text);">
          Support: <strong>hello@tradebotpro.co.uk</strong>
        </div>
      </div>
    </header>

    <main class="main-layout">
      <!-- LEFT: EXPLANATION / HERO -->
      <section class="card">
        <h1 class="hero-heading">More jobs. Less admin.</h1>
        <p class="hero-subheading">
          This page connects your signup details with your live business profile.  
          Fill it in once — TradeBotPro will re-use it in quotes, messages and invoices.
        </p>

        <div class="badge-row">
          <span class="badge">
            <span class="badge-dot"></span>
            AI assistant for plumbers, heating &amp; trades
          </span>
          <span class="badge">
            <span class="badge-dot"></span>
            WhatsApp, website &amp; Facebook enquiries
          </span>
          <span class="badge">
            <span class="badge-dot"></span>
            Estimates, bookings, invoices &amp; payment chasing
          </span>
        </div>

        <ul class="steps-list">
          <li>
            <span class="steps-bullet">1</span>
            <span>
              <strong>Trade basics:</strong> who you are, where you work, and how customers contact you.
            </span>
          </li>
          <li>
            <span class="steps-bullet">2</span>
            <span>
              <strong>Pricing rules:</strong> call-out fee, first hour, hourly rates and typical jobs.
            </span>
          </li>
          <li>
            <span class="steps-bullet">3</span>
            <span>
              <strong>AI style:</strong> how you like to sound in messages and quotes.
            </span>
          </li>
        </ul>

        <div class="mini-metrics">
          <div class="mini-metric">
            <div class="mini-metric-label">Expected setup time</div>
            <div class="mini-metric-value">3–5 minutes</div>
          </div>
          <div class="mini-metric">
            <div class="mini-metric-label">You stay in control</div>
            <div class="mini-metric-value">Approve first quotes</div>
          </div>
          <div class="mini-metric">
            <div class="mini-metric-label">Jobs we’re great at</div>
            <div class="mini-metric-value">Boilers, leaks, bathrooms…</div>
          </div>
          <div class="mini-metric">
            <div class="mini-metric-label">Admin we handle</div>
            <div class="mini-metric-value">Messages, reminders, follow-ups</div>
          </div>
        </div>

        <div class="status-pill-row">
          <span class="status-pill">Your signup details are stored securely in Supabase</span>
          <span class="status-pill danger">We never share your data with other trades</span>
        </div>

        <p class="tiny">
          By completing this page you agree we can store your details to power your TradeBotPro assistant.
          You stay in control of prices and booking decisions.
        </p>
      </section>

      <!-- RIGHT: PROFILE FORM -->
      <section class="card">
        <h2 class="form-title">Tell us about your business</h2>
        <p class="form-subtitle">
          We’ll use this to sync your original signup (<code>tradebotpro_signups</code>) with your live
          <code>business_profiles</code> record, so everything stays in step.
        </p>

        <form id="profile-form">
          <!-- Business & contact -->
          <div class="field-group">
            <div class="field">
              <label for="business_name">Business name</label>
              <input id="business_name" name="business_name" type="text" autocomplete="organization" required />
            </div>
            <div class="field">
              <label for="contact_name">Your name</label>
              <input id="contact_name" name="contact_name" type="text" autocomplete="name" />
            </div>
          </div>

          <div class="field-group">
            <div class="field">
              <label for="email">Email for quotes &amp; bookings</label>
              <input id="email" name="email" type="email" autocomplete="email" required />
              <small>This links your signup and business profile together.</small>
            </div>
            <div class="field">
              <label for="phone">Phone</label>
              <input id="phone" name="phone" type="tel" autocomplete="tel" />
            </div>
          </div>

          <div class="field-group">
            <div class="field">
              <label for="whatsapp_number">WhatsApp number</label>
              <input id="whatsapp_number" name="whatsapp_number" type="tel" />
              <small>The number your TradeBotPro WhatsApp chats will appear from.</small>
            </div>
            <div class="field">
              <label for="trade_type">Main trade</label>
              <select id="trade_type" name="trade_type">
                <option value="">Select trade</option>
                <option value="Plumbing & Heating">Plumbing &amp; Heating</option>
                <option value="Gas & Boilers">Gas &amp; Boilers</option>
                <option value="Electrical">Electrical</option>
                <option value="Bathrooms & Kitchens">Bathrooms &amp; Kitchens</option>
                <option value="Landscaping & Gardens">Landscaping &amp; Gardens</option>
                <option value="Roofing">Roofing</option>
                <option value="Other">Other</option>
              </select>
            </div>
          </div>

          <!-- Area & website -->
          <div class="field-group">
            <div class="field">
              <label for="base_postcode">Base postcode</label>
              <input id="base_postcode" name="base_postcode" type="text" />
              <small>Where you start jobs from (e.g. HP14 3QF).</small>
            </div>
            <div class="field">
              <label for="service_radius">Service radius (miles)</label>
              <input id="service_radius" name="service_radius" type="number" min="1" step="1" />
            </div>
          </div>

          <div class="field">
            <label for="website_url">Website</label>
            <input id="website_url" name="website_url" type="text" placeholder="https://example.co.uk" />
          </div>

          <!-- Pricing basics -->
          <div class="field-group">
            <div class="field">
              <label for="callout_from">Call-out from</label>
              <input id="callout_from" name="callout_from" type="text" placeholder="e.g. £75+VAT" />
            </div>
            <div class="field">
              <label for="callout_fee">Call-out fee (number)</label>
              <input id="callout_fee" name="callout_fee" type="number" step="0.01" />
            </div>
          </div>

          <div class="field-group">
            <div class="field">
              <label for="first_hour_rate">First hour rate</label>
              <input id="first_hour_rate" name="first_hour_rate" type="number" step="0.01" />
            </div>
            <div class="field">
              <label for="hourly_rate">Hourly rate after first hour</label>
              <input id="hourly_rate" name="hourly_rate" type="number" step="0.01" />
            </div>
          </div>

          <div class="field-group">
            <div class="field">
              <label for="hourly_rate_from">Hourly rate “from” text</label>
              <input id="hourly_rate_from" name="hourly_rate_from" type="text" placeholder="e.g. From £85+VAT/hr" />
            </div>
            <div class="field">
              <label for="boiler_service_from">Boiler service “from”</label>
              <input id="boiler_service_from" name="boiler_service_from" type="text" placeholder="e.g. From £95+VAT" />
            </div>
          </div>

          <div class="field">
            <label for="quote_minimum">Minimum quote value (if any)</label>
            <input id="quote_minimum" name="quote_minimum" type="number" step="0.01" />
          </div>

          <!-- Services & style -->
          <div class="field">
            <label for="services_summary">What do you want to be known for?</label>
            <textarea id="services_summary" name="services_summary" placeholder="e.g. Boiler installs & servicing, emergency leaks, bathroom refits, underfloor heating..."></textarea>
          </div>

          <div class="field">
            <label for="pricing_notes">Any special pricing notes?</label>
            <textarea id="pricing_notes" name="pricing_notes" placeholder="e.g. Parking & congestion charged at cost, evening/weekend rates, discounts for OAPs, etc."></textarea>
          </div>

          <div class="field">
            <label for="ai_style_notes">How should your AI assistant sound?</label>
            <textarea id="ai_style_notes" name="ai_style_notes" placeholder="e.g. Friendly but professional, no emojis, always confirm prices clearly, never promise exact arrival times without checking my diary, etc."></textarea>
          </div>

          <div class="field">
            <label for="callout_notes">Anything else we should know about call-outs?</label>
            <textarea id="callout_notes" name="callout_notes" placeholder="Access notes, dogs on site, keysafe codes, large driveway, etc. (optional)"></textarea>
          </div>

          <!-- Status flags -->
          <div class="field">
            <label>Status &amp; setup</label>
            <div class="inline-checkbox-row">
              <label class="inline-checkbox">
                <input id="is_active" name="is_active" type="checkbox" />
                <span>Account active</span>
              </label>
              <label class="inline-checkbox">
                <input id="pending_setup" name="pending_setup" type="checkbox" />
                <span>Pending final setup call</span>
              </label>
            </div>
            <small>We’ll keep these in step between <code>business_profiles</code> and <code>tradebotpro_signups</code>.</small>
          </div>

          <div class="field-group">
            <div class="field">
              <label for="plan_status">Plan status</label>
              <select id="plan_status" name="plan_status">
                <option value="">Not set</option>
                <option value="Trial">Trial</option>
                <option value="Active - Monthly">Active — Monthly</option>
                <option value="Active - Yearly">Active — Yearly</option>
                <option value="Paused">Paused</option>
                <option value="Cancelled">Cancelled</option>
              </select>
            </div>
            <div class="field">
              <label for="account_status">Internal account status</label>
              <select id="account_status" name="account_status">
                <option value="">Normal</option>
                <option value="Needs onboarding call">Needs onboarding call</option>
                <option value="At risk">At risk</option>
                <option value="Do not renew">Do not renew</option>
              </select>
            </div>
          </div>

          <div class="field">
            <label for="account_status_reason">Status notes (internal only)</label>
            <textarea id="account_status_reason" name="account_status_reason"></textarea>
          </div>

          <!-- FORM FOOTER -->
          <div class="form-footer">
            <div>
              <button class="primary" type="submit" id="save-button">
                <span id="save-button-label">Save profile &amp; keep in sync</span>
              </button>
              <div class="button-label-sub">
                This will update <strong>business_profiles</strong> and your original <strong>tradebotpro_signups</strong> row.
              </div>
            </div>
            <div>
              <p class="status-text" id="status-message"></p>
            </div>
          </div>
        </form>
      </section>
    </main>

    <footer>
      TradeBotPro &copy; <span id="year"></span>. Built for real trades — plumbers, sparkies, roofers and more.
    </footer>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const SUPABASE_URL = "https://yaiutswdcbfwkxfqxkzy.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlhaXV0c3dkY2Jmd2t4ZnF4a3p5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1MDE2MDgsImV4cCI6MjA4MDA3NzYwOH0.HOLFxzjsZ5Ieqg0b-aTdP0hAdLsPVXL6Zjs-HgOHgc8";

    if (!SUPABASE_URL || !SUPABASE_ANON_KEY || SUPABASE_URL.includes("YOUR_SUPABASE_URL_HERE")) {
      console.error("Missing SUPABASE_URL or SUPABASE_ANON_KEY in app.html");
    }

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const statusEl = document.getElementById("status-message");
    const saveButton = document.getElementById("save-button");
    const saveButtonLabel = document.getElementById("save-button-label");
    const form = document.getElementById("profile-form");

    document.getElementById("year").textContent = new Date().getFullYear();

    const FIELD_NAMES = [
      "business_name",
      "contact_name",
      "email",
      "phone",
      "whatsapp_number",
      "trade_type",
      "base_postcode",
      "service_radius",
      "website_url",
      "callout_from",
      "callout_fee",
      "first_hour_rate",
      "hourly_rate",
      "hourly_rate_from",
      "boiler_service_from",
      "quote_minimum",
      "services_summary",
      "pricing_notes",
      "ai_style_notes",
      "callout_notes",
      "is_active",
      "pending_setup",
      "plan_status",
      "services_summary",
      "pricing_notes",
      "ai_style_notes",
      "callout_notes",
      "account_status",
      "account_status_reason"
    ];

    function getUserIdFromUrl() {
      const params = new URLSearchParams(window.location.search);
      const id = params.get("user_id");
      return id;
    }

    function setStatus(message, type = "info") {
      statusEl.textContent = message || "";
      statusEl.classList.remove("error", "success");
      if (type === "error") statusEl.classList.add("error");
      if (type === "success") statusEl.classList.add("success");
    }

    function loading(isLoading) {
      saveButton.disabled = isLoading;
      saveButtonLabel.textContent = isLoading ? "Saving…" : "Save profile & keep in sync";
    }

    function readFormData() {
      const data = {};
      for (const name of FIELD_NAMES) {
        const el = document.getElementById(name);
        if (!el) continue;

        if (el.type === "checkbox") {
          data[name] = el.checked;
        } else if (el.type === "number") {
          const v = el.value.trim();
          data[name] = v === "" ? null : Number(v);
        } else {
          data[name] = el.value.trim() === "" ? null : el.value.trim();
        }
      }
      return data;
    }

    function writeFormData(row) {
      if (!row) return;
      for (const name of FIELD_NAMES) {
        const el = document.getElementById(name);
        if (!el) continue;
        const value = row[name];

        if (el.type === "checkbox") {
          el.checked = !!value;
        } else if (el.type === "number") {
          el.value = value == null ? "" : value;
        } else {
          el.value = value == null ? "" : value;
        }
      }
    }

    async function loadProfile() {
      const userId = getUserIdFromUrl();
      if (!userId) {
        setStatus("Missing user_id in URL. Please open this link from your signup email.", "error");
        console.error("No user_id in URL");
        return;
      }

      setStatus("Loading your profile from Supabase…");

      // First try business_profiles (source of truth once they’ve saved)
      const { data: profile, error } = await supabase
        .from("business_profiles")
        .select("*")
        .eq("supabase_user_id", userId)
        .maybeSingle();

      if (error) {
        console.error("Error loading business_profiles:", error);
        setStatus("Couldn't load your business profile. You can still fill this in and save.", "error");
        return;
      }

      if (profile) {
        writeFormData(profile);
        setStatus("Loaded your business profile. You can make changes and save.");
      } else {
        // Fall back to tradebotpro_signups by trying to match email from URL (if provided)
        const params = new URLSearchParams(window.location.search);
        const emailFromUrl = params.get("email");

        if (!emailFromUrl) {
          setStatus("No existing profile found. Fill in the form to create one.", "info");
          return;
        }

        const { data: signupRow, error: signupError } = await supabase
          .from("tradebotpro_signups")
          .select("*")
          .eq("email", emailFromUrl)
          .maybeSingle();

        if (signupError) {
          console.error("Error loading tradebotpro_signups:", signupError);
          setStatus("No existing profile found. Fill in the form to create one.", "info");
          return;
        }

        if (signupRow) {
          writeFormData(signupRow);
          setStatus("Loaded your signup details. Save to create a business profile.");
        } else {
          setStatus("No existing profile found. Fill in the form to create one.", "info");
        }
      }
    }

    async function saveProfile(evt) {
      evt.preventDefault();
      const userId = getUserIdFromUrl();
      if (!userId) {
        setStatus("Missing user_id in URL. Please open this link from your signup email.", "error");
        return;
      }

      const formData = readFormData();

      if (!formData.email) {
        setStatus("Please enter an email — we use this to link your signup.", "error");
        return;
      }

      loading(true);
      setStatus("Saving your details to Supabase…");

      try {
        const businessPayload = {
          ...formData,
          supabase_user_id: userId
        };

        // 1) Upsert into business_profiles on supabase_user_id
        const { error: bpError } = await supabase
          .from("business_profiles")
          .upsert(businessPayload, {
            onConflict: "supabase_user_id"
          });

        if (bpError) {
          console.error("Error saving business_profiles:", bpError);
          setStatus("Couldn't save your business profile. Please try again.", "error");
          return;
        }

        // 2) Keep tradebotpro_signups in sync (update by email)
        const signupUpdatePayload = {
          business_name: formData.business_name,
          contact_name: formData.contact_name,
          email: formData.email,
          phone: formData.phone,
          whatsapp_number: formData.whatsapp_number,
          trade_type: formData.trade_type,
          base_postcode: formData.base_postcode,
          service_radius: formData.service_radius,
          website_url: formData.website_url,
          callout_from: formData.callout_from,
          callout_fee: formData.callout_fee,
          first_hour_rate: formData.first_hour_rate,
          hourly_rate: formData.hourly_rate,
          hourly_rate_from: formData.hourly_rate_from,
          boiler_service_from: formData.boiler_service_from,
          quote_minimum: formData.quote_minimum,
          services_summary: formData.services_summary,
          pricing_notes: formData.pricing_notes,
          ai_style_notes: formData.ai_style_notes,
          callout_notes: formData.callout_notes,
          is_active: formData.is_active,
          pending_setup: formData.pending_setup,
          plan_status: formData.plan_status,
          account_status: formData.account_status,
          account_status_reason: formData.account_status_reason
        };

        const { error: signupError } = await supabase
          .from("tradebotpro_signups")
          .update(signupUpdatePayload)
          .eq("email", formData.email);

        if (signupError) {
          console.warn("Warning: couldn't update tradebotpro_signups:", signupError);
          // Not fatal, they still have a working business_profiles record
        }

        setStatus("Saved. Your business profile and signup record are now in sync.", "success");
      } catch (err) {
        console.error("Unexpected error during save:", err);
        setStatus("Something went wrong while saving. Please try again.", "error");
      } finally {
        loading(false);
      }
    }

    form.addEventListener("submit", saveProfile);
    loadProfile();
  </script>
</body>
</html>

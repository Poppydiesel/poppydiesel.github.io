<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TradeBotPro ‚Äì Your AI Office Setup</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --primary-blue: #1f4e79;
      --accent-blue: #00a3ff;
      --dark-text: #1b1b1f;
      --light-bg: #f5f7fa;
      --white: #ffffff;
      --border-subtle: rgba(0,0,0,0.12);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      background: var(--light-bg);
      color: var(--dark-text);
      line-height: 1.6;
    }

    a { color: inherit; text-decoration: none; }

    .page {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: var(--white);
      border-bottom: 1px solid rgba(0,0,0,0.06);
    }

    .inner {
      max-width: 1100px;
      margin: 0 auto;
      padding: 0 1.25rem;
    }

    .nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      padding: 0.75rem 0;
      font-size: 0.9rem;
    }

    .logo-wrap {
      display: flex;
      align-items: center;
      gap: 0.6rem;
    }

    .logo-icon {
      width: 32px;
      height: 32px;
      border-radius: 9px;
      background: var(--primary-blue);
      position: relative;
    }

    .logo-icon::before,
    .logo-icon::after {
      content: "";
      position: absolute;
      background: var(--white);
      border-radius: 4px;
    }

    .logo-icon::before {
      width: 12px;
      height: 18px;
      left: 7px;
      top: 7px;
    }

    .logo-icon::after {
      width: 6px;
      height: 12px;
      right: 7px;
      top: 10px;
    }

    .logo-main {
      font-weight: 700;
      font-size: 1.05rem;
      color: var(--primary-blue);
    }

    .logo-tag {
      font-size: 0.7rem;
      opacity: 0.7;
    }

    main {
      padding: 2rem 0 3rem;
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1.25fr) minmax(0, 1fr);
      gap: 2rem;
      align-items: flex-start;
    }

    .intro h1 {
      margin: 0 0 0.4rem;
      font-size: 1.9rem;
      color: var(--primary-blue);
    }

    .intro p {
      margin: 0.1rem 0 0.8rem;
      font-size: 0.95rem;
    }

    .pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      margin-top: 0.6rem;
    }

    .pill {
      padding: 0.25rem 0.7rem;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.1);
      font-size: 0.75rem;
      background: var(--white);
    }

    .card {
      background: var(--white);
      border-radius: 1rem;
      padding: 1.25rem 1.4rem;
      box-shadow: 0 10px 24px rgba(0,0,0,0.06);
      font-size: 0.9rem;
    }

    .card h2 {
      margin: 0 0 0.8rem;
      font-size: 1.25rem;
      color: var(--primary-blue);
    }

    form {
      margin-top: 0.6rem;
    }

    .field-group {
      margin-bottom: 0.9rem;
    }

    .field-row {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.9rem;
    }

    .field-group label {
      display: block;
      font-size: 0.78rem;
      font-weight: 500;
      margin-bottom: 0.25rem;
    }

    .field-group input,
    .field-group select,
    .field-group textarea {
      width: 100%;
      padding: 0.55rem 0.65rem;
      border-radius: 0.45rem;
      border: 1px solid var(--border-subtle);
      font: inherit;
    }

    .field-group input:focus,
    .field-group select:focus,
    .field-group textarea:focus {
      outline: 2px solid rgba(31,78,121,0.4);
      border-color: transparent;
    }

    textarea {
      min-height: 80px;
      resize: vertical;
    }

    .status-row {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 0.8rem;
    }

    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 0.45rem;
      font-size: 0.8rem;
      margin-top: 0.2rem;
    }

    .checkbox-row input {
      margin: 0;
    }

    .actions {
      margin-top: 1.1rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.7rem;
      align-items: center;
    }

    .btn-primary {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.7rem 1.4rem;
      border-radius: 999px;
      border: none;
      background: var(--primary-blue);
      color: var(--white);
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
    }

    .btn-primary:hover {
      background: #163857;
    }

    .btn-ghost {
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.12);
      background: var(--white);
      padding: 0.55rem 1.1rem;
      font-size: 0.85rem;
    }

    .muted {
      font-size: 0.8rem;
      opacity: 0.75;
    }

    .status-line {
      margin-top: 0.6rem;
      font-size: 0.82rem;
    }

    .status-ok {
      color: #137333;
    }

    .status-error {
      color: #b31412;
    }

    .status-neutral {
      color: #5f6368;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.15rem 0.55rem;
      border-radius: 999px;
      font-size: 0.75rem;
      background: #e4eef8;
      color: var(--primary-blue);
    }

    footer {
      margin-top: auto;
      border-top: 1px solid rgba(0,0,0,0.06);
      background: var(--white);
      font-size: 0.8rem;
    }

    .footer-inner {
      padding: 1rem 1.25rem 1.2rem;
      display: flex;
      justify-content: space-between;
      gap: 1rem;
      flex-wrap: wrap;
      align-items: center;
    }

    @media (max-width: 860px) {
      .layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    @media (max-width: 520px) {
      .field-row { grid-template-columns: minmax(0, 1fr); }
      .status-row { grid-template-columns: minmax(0, 1fr); }
    }
  </style>
</head>
<body>
<div class="page">

  <header>
    <div class="inner">
      <div class="nav">
        <div class="logo-wrap">
          <div class="logo-icon" aria-hidden="true"></div>
          <div>
            <div class="logo-main">TradeBotPro</div>
            <div class="logo-tag">AI office assistant for trades.</div>
          </div>
        </div>
        <div class="muted">
          Profile setup
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="inner">
      <div class="layout">
        <section class="intro">
          <h1>Your TradeBotPro setup</h1>
          <p>
            This page lets you update the details your AI office uses day-to-day:
            contact info, service area, pricing and how you want it to talk to customers.
          </p>
          <p class="muted">
            The link you clicked is unique to your signup. If you lose it, just ask us to resend your secure profile link.
          </p>

          <div class="pill-row">
            <div class="pill">Update prices without emailing support</div>
            <div class="pill">Change service radius &amp; area</div>
            <div class="pill">Tweak how the AI speaks</div>
          </div>

          <div style="margin-top:1.4rem;">
            <div class="badge" id="link-status">
              <span>‚óè</span>
              <span>Checking your link‚Ä¶</span>
            </div>
            <div class="status-line status-neutral" id="status-line">
              Please wait while we load your profile.
            </div>
          </div>
        </section>

        <section class="card">
          <h2>Your business profile</h2>
          <p class="muted" style="margin-top:0;">
            Make changes and hit ‚ÄúSave changes‚Äù. We‚Äôll use this for your AI office setup.
          </p>

          <form id="profile-form">
            <!-- CONTACT / BUSINESS -->
            <div class="field-row">
              <div class="field-group">
                <label for="contact_name">Contact name</label>
                <input id="contact_name" name="contact_name" type="text" autocomplete="name">
              </div>
              <div class="field-group">
                <label for="business_name">Business name</label>
                <input id="business_name" name="business_name" type="text" autocomplete="organization">
              </div>
            </div>

            <div class="field-row">
              <div class="field-group">
                <label for="email">Email for bookings / quotes</label>
                <input id="email" name="email" type="email" autocomplete="email">
              </div>
              <div class="field-group">
                <label for="whatsapp_number">WhatsApp / mobile (primary)</label>
                <input id="whatsapp_number" name="whatsapp_number" type="tel" autocomplete="tel">
              </div>
            </div>

            <div class="field-row">
              <div class="field-group">
                <label for="phone">Optional landline</label>
                <input id="phone" name="phone" type="tel" autocomplete="tel">
              </div>
              <div class="field-group">
                <label for="website_url">Website (optional)</label>
                <input id="website_url" name="website_url" type="url" placeholder="https://">
              </div>
            </div>

            <div class="field-row">
              <div class="field-group">
                <label for="trade_type">Trade</label>
                <select id="trade_type" name="trade_type">
                  <option value="">Select your trade‚Ä¶</option>
                  <option>Plumber</option>
                  <option>Heating Engineer</option>
                  <option>Gas Engineer</option>
                  <option>Electrician</option>
                  <option>Builder</option>
                  <option>Handyman</option>
                  <option>Landscaper / Gardener</option>
                  <option>Cleaner / Carpet Cleaner</option>
                  <option>Pest Control</option>
                  <option>Other</option>
                </select>
              </div>
              <div class="field-group">
                <label for="base_postcode">Base postcode</label>
                <input id="base_postcode" name="base_postcode" type="text" placeholder="e.g. OX2 7AA">
              </div>
            </div>

            <div class="field-group">
              <label for="service_radius">Service radius (miles from base)</label>
              <input id="service_radius" name="service_radius" type="number" min="0" step="1">
            </div>

            <!-- PRICING -->
            <hr style="margin:1.2rem 0;border:none;border-top:1px solid rgba(0,0,0,0.08);" />

            <div class="field-row">
              <div class="field-group">
                <label for="callout_fee">Call-out fee (¬£)</label>
                <input id="callout_fee" name="callout_fee" type="number" min="0" step="1">
              </div>
              <div class="field-group">
                <label for="first_hour_rate">First hour (¬£)</label>
                <input id="first_hour_rate" name="first_hour_rate" type="number" min="0" step="1">
              </div>
            </div>

            <div class="field-row">
              <div class="field-group">
                <label for="hourly_rate">Hourly rate after first hour (¬£)</label>
                <input id="hourly_rate" name="hourly_rate" type="number" min="0" step="1">
              </div>
              <div class="field-group">
                <label for="boiler_service_from">Boiler service from (¬£)</label>
                <input id="boiler_service_from" name="boiler_service_from" type="number" min="0" step="1">
              </div>
            </div>

            <div class="field-group">
              <label for="quote_minimum">Minimum job / quote value (¬£)</label>
              <input id="quote_minimum" name="quote_minimum" type="number" min="0" step="1">
            </div>

            <div class="field-group">
              <label for="pricing_notes">Anything special about your pricing? (optional)</label>
              <textarea id="pricing_notes" name="pricing_notes" placeholder="E.g. emergency evening rates, weekend premiums, areas you charge extra for‚Ä¶"></textarea>
            </div>

            <!-- HOW THE AI SHOULD TALK -->
            <hr style="margin:1.2rem 0;border:none;border-top:1px solid rgba(0,0,0,0.08);" />

            <div class="field-group">
              <label for="services_summary">What services do you MOST want to promote?</label>
              <textarea id="services_summary" name="services_summary" placeholder="E.g. boiler breakdowns, installs, landlord certs, bathroom refurbs‚Ä¶"></textarea>
            </div>

            <div class="field-group">
              <label for="ai_style_notes">How should your AI office sound?</label>
              <textarea id="ai_style_notes" name="ai_style_notes" placeholder="E.g. friendly but no emojis, plain-English, firm on pricing, prefer to avoid exact quotes on WhatsApp‚Ä¶"></textarea>
            </div>

            <!-- STATUS / INTERNAL -->
            <hr style="margin:1.2rem 0;border:none;border-top:1px solid rgba(0,0,0,0.08);" />

            <div class="status-row">
              <div class="field-group">
                <label for="plan_status">Plan status</label>
                <select id="plan_status" name="plan_status">
                  <option value="">Select‚Ä¶</option>
                  <option value="Lead only">Lead only</option>
                  <option value="Pending setup">Pending setup</option>
                  <option value="Live ‚Äì Starter">Live ‚Äì Starter</option>
                  <option value="Live ‚Äì Pro">Live ‚Äì Pro</option>
                  <option value="Live ‚Äì Premium">Live ‚Äì Premium</option>
                  <option value="Paused">Paused</option>
                  <option value="Cancelled">Cancelled</option>
                </select>
              </div>

              <div class="field-group">
                <label for="account_status">Account status</label>
                <select id="account_status" name="account_status">
                  <option value="">Select‚Ä¶</option>
                  <option value="OK">OK</option>
                  <option value="Needs onboarding call">Needs onboarding call</option>
                  <option value="Payment issue">Payment issue</option>
                  <option value="Requested pause">Requested pause</option>
                  <option value="Requested cancel">Requested cancel</option>
                </select>
              </div>

              <div class="field-group">
                <label for="pending_setup">Pending setup?</label>
                <select id="pending_setup" name="pending_setup">
                  <option value="">Select‚Ä¶</option>
                  <option value="true">Yes</option>
                  <option value="false">No</option>
                </select>
              </div>
            </div>

            <div class="field-group">
              <label for="account_status_reason">Internal notes (account status / pause reasons)</label>
              <textarea id="account_status_reason" name="account_status_reason"></textarea>
            </div>

            <div class="checkbox-row">
              <input id="is_active" name="is_active" type="checkbox">
              <label for="is_active">Account is active (AI allowed to respond to customers)</label>
            </div>

            <div class="actions">
              <button type="submit" class="btn-primary">Save changes</button>
              <button type="button" class="btn-ghost" id="refresh-btn">Reload from server</button>
              <span class="muted" id="last-saved"></span>
            </div>

            <div class="status-line status-neutral" id="form-status" style="margin-top:0.7rem;">
              Waiting to load profile‚Ä¶
            </div>
          </form>
        </section>
      </div>
    </div>
  </main>

  <footer>
    <div class="inner footer-inner">
      <div>&copy; <span id="year"></span> TradeBotPro.</div>
      <div class="muted">If anything looks wrong, just email <a href="mailto:hello@tradebotpro.co.uk">hello@tradebotpro.co.uk</a>.</div>
    </div>
  </footer>
</div>

<script>
  // üî¥üî¥üî¥ IMPORTANT: PASTE YOUR SUPABASE DETAILS HERE üî¥üî¥üî¥
  //
  // 1) Log in to Supabase ‚Üí Project Settings ‚Üí API
  // 2) Copy the "Project URL" (starts with https://....supabase.co)
  // 3) Copy the "anon public" key
  // 4) Paste them below between the quotes:

  const SUPABASE_URL = "https://yaiutswdcbfwkxfqxkzy.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlhaXV0c3dkY2Jmd2t4ZnF4a3p5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1MDE2MDgsImV4cCI6MjA4MDA3NzYwOH0.HOLFxzjsZ5Ieqg0b-aTdP0hAdLsPVXL6Zjs-HgOHgc8";

  // ------------------------------------------------------------------//
  // HELPER FUNCTIONS
  // ------------------------------------------------------------------//

  const yearSpan = document.getElementById('year');
  if (yearSpan) yearSpan.textContent = new Date().getFullYear();

  const linkStatusEl = document.getElementById('link-status');
  const statusLineEl = document.getElementById('status-line');
  const formStatusEl = document.getElementById('form-status');
  const lastSavedEl = document.getElementById('last-saved');
  const profileForm = document.getElementById('profile-form');
  const refreshBtn = document.getElementById('refresh-btn');

  function setLinkStatus(text, type = 'neutral') {
    if (!linkStatusEl) return;
    const dot = linkStatusEl.querySelector('span');
    const label = linkStatusEl.querySelectorAll('span')[1];
    if (label) label.textContent = text;

    if (type === 'ok') {
      linkStatusEl.style.background = '#e6f4ea';
      linkStatusEl.style.color = '#137333';
      if (dot) dot.textContent = '‚óè';
    } else if (type === 'error') {
      linkStatusEl.style.background = '#fce8e6';
      linkStatusEl.style.color = '#b31412';
      if (dot) dot.textContent = '‚óè';
    } else {
      linkStatusEl.style.background = '#e4eef8';
      linkStatusEl.style.color = '#1f4e79';
      if (dot) dot.textContent = '‚óè';
    }
  }

  function setFormStatus(msg, type = 'neutral') {
    if (!formStatusEl) return;
    formStatusEl.textContent = msg;
    formStatusEl.classList.remove('status-ok', 'status-error', 'status-neutral');
    if (type === 'ok') formStatusEl.classList.add('status-ok');
    else if (type === 'error') formStatusEl.classList.add('status-error');
    else formStatusEl.classList.add('status-neutral');
  }

  function getUserIdFromUrl() {
    const params = new URLSearchParams(window.location.search);
    return params.get('user_id') || '';
  }

  function getSupabaseHeaders() {
    return {
      'apikey': SUPABASE_ANON_KEY,
      'Authorization': 'Bearer ' + SUPABASE_ANON_KEY,
      'Content-Type': 'application/json',
      'Accept': 'application/json'
    };
  }

  async function supabaseFetch(path, options = {}) {
    const url = `${SUPABASE_URL}/rest/v1/${path}`;
    const headers = {
      ...getSupabaseHeaders(),
      ...(options.headers || {})
    };

    const res = await fetch(url, { ...options, headers });

    let data = null;
    try {
      data = await res.json();
    } catch (e) {
      // no JSON body
    }

    if (!res.ok) {
      console.error('Fetch failed:', res.status, data || res.statusText);
      const err = new Error(`Fetch failed: ${res.status} ${res.statusText}`);
      err.status = res.status;
      err.details = data;
      throw err;
    }

    return data;
  }

  // ------------------------------------------------------------------//
  // LOAD + SAVE PROFILE
  // ------------------------------------------------------------------//

  let signupRow = null;
  let profileRow = null;
  let signupId = null; // this comes from user_id in URL

  async function loadProfile() {
    signupId = getUserIdFromUrl();

    if (!signupId) {
      setLinkStatus('This link is missing a user_id.', 'error');
      if (statusLineEl) statusLineEl.textContent = 'Ask TradeBotPro to resend your secure profile link.';
      setFormStatus('Cannot load profile without a valid link.', 'error');
      profileForm && (profileForm.style.display = 'none');
      return;
    }

    setLinkStatus('Link looks valid. Loading your details‚Ä¶', 'neutral');
    setFormStatus('Loading from Supabase‚Ä¶', 'neutral');

    try {
      // 1) Get signup row
      const signups = await supabaseFetch(
        `tradebotpro_signups?id=eq.${encodeURIComponent(signupId)}&select=*`
      );

      if (!Array.isArray(signups) || !signups.length) {
        setLinkStatus('We could not find a signup for this link.', 'error');
        setFormStatus('No signup found. Please contact support.', 'error');
        return;
      }

      signupRow = signups[0];

      // 2) Get existing profile row for this signup_id (NOT user_id)
      const profiles = await supabaseFetch(
        `business_profiles?signup_id=eq.${encodeURIComponent(signupId)}&select=*`
      );

      if (Array.isArray(profiles) && profiles.length) {
        profileRow = profiles[0];
      } else {
        // 3) If no profile yet, create a blank one seeded from signup
        const payload = {
          signup_id: signupId,
          contact_name: signupRow.contact_name || '',
          business_name: signupRow.business_name || '',
          email: signupRow.email || '',
          whatsapp_number: signupRow.whatsapp_number || '',
          phone: signupRow.phone || '',
          trade_type: signupRow.trade_type || '',
          base_postcode: signupRow.base_postcode || signupRow.service_area || '',
          website_url: signupRow.website_url || '',
          plan_status: signupRow.plan_status || 'Lead only',
          pending_setup: signupRow.pending_setup ?? true,
          is_active: signupRow.is_active ?? false,
          services_summary: signupRow.services_summary || '',
          ai_style_notes: signupRow.ai_style_notes || ''
        };

        const created = await supabaseFetch(
          'business_profiles',
          {
            method: 'POST',
            body: JSON.stringify(payload),
            headers: {
              Prefer: 'return=representation'
            }
          }
        );

        profileRow = Array.isArray(created) && created.length ? created[0] : null;
      }

      // 4) Fill the form
      fillFormFromProfile();

      setLinkStatus('Profile loaded for your signup.', 'ok');
      setFormStatus('Profile loaded. Make changes and click ‚ÄúSave changes‚Äù.', 'ok');

    } catch (err) {
      console.error('Fetch profile error:', err);
      setLinkStatus('Error loading your profile.', 'error');
      setFormStatus('Something went wrong loading from Supabase.', 'error');
    }
  }

  function fillFormFromProfile() {
    const p = profileRow || {};
    const s = signupRow || {};

    function setVal(id, value) {
      const el = document.getElementById(id);
      if (el) el.value = value ?? '';
    }

    setVal('contact_name', p.contact_name ?? s.contact_name ?? '');
    setVal('business_name', p.business_name ?? s.business_name ?? '');
    setVal('email', p.email ?? s.email ?? '');
    setVal('whatsapp_number', p.whatsapp_number ?? s.whatsapp_number ?? '');
    setVal('phone', p.phone ?? s.phone ?? '');
    setVal('website_url', p.website_url ?? s.website_url ?? '');
    setVal('trade_type', p.trade_type ?? s.trade_type ?? '');
    setVal('base_postcode', p.base_postcode ?? s.base_postcode ?? s.service_area ?? '');
    setVal('service_radius', p.service_radius ?? '');

    setVal('callout_fee', p.callout_fee ?? '');
    setVal('first_hour_rate', p.first_hour_rate ?? '');
    setVal('hourly_rate', p.hourly_rate ?? '');
    setVal('boiler_service_from', p.boiler_service_from ?? '');
    setVal('quote_minimum', p.quote_minimum ?? '');
    setVal('pricing_notes', p.pricing_notes ?? '');

    setVal('services_summary', p.services_summary ?? '');
    setVal('ai_style_notes', p.ai_style_notes ?? '');

    setVal('plan_status', p.plan_status ?? s.plan_status ?? '');
    setVal('account_status', p.account_status ?? '');
    setVal('pending_setup', p.pending_setup === true ? 'true' : p.pending_setup === false ? 'false' : '');

    setVal('account_status_reason', p.account_status_reason ?? '');

    const isActiveEl = document.getElementById('is_active');
    if (isActiveEl) isActiveEl.checked = !!(p.is_active ?? s.is_active ?? false);
  }

  async function saveProfile(event) {
    event.preventDefault();
    if (!signupId) {
      setFormStatus('Missing signup id in the URL ‚Äì cannot save.', 'error');
      return;
    }

    setFormStatus('Saving to Supabase‚Ä¶', 'neutral');

    const payload = {
      signup_id: signupId,
      contact_name: document.getElementById('contact_name').value.trim(),
      business_name: document.getElementById('business_name').value.trim(),
      email: document.getElementById('email').value.trim(),
      whatsapp_number: document.getElementById('whatsapp_number').value.trim(),
      phone: document.getElementById('phone').value.trim(),
      website_url: document.getElementById('website_url').value.trim(),
      trade_type: document.getElementById('trade_type').value,
      base_postcode: document.getElementById('base_postcode').value.trim(),
      service_radius: document.getElementById('service_radius').value || null,
      callout_fee: document.getElementById('callout_fee').value || null,
      first_hour_rate: document.getElementById('first_hour_rate').value || null,
      hourly_rate: document.getElementById('hourly_rate').value || null,
      boiler_service_from: document.getElementById('boiler_service_from').value || null,
      quote_minimum: document.getElementById('quote_minimum').value || null,
      pricing_notes: document.getElementById('pricing_notes').value.trim(),
      services_summary: document.getElementById('services_summary').value.trim(),
      ai_style_notes: document.getElementById('ai_style_notes').value.trim(),
      plan_status: document.getElementById('plan_status').value,
      account_status: document.getElementById('account_status').value,
      pending_setup: (function () {
        const v = document.getElementById('pending_setup').value;
        if (v === 'true') return true;
        if (v === 'false') return false;
        return null;
      })(),
      account_status_reason: document.getElementById('account_status_reason').value.trim(),
      is_active: document.getElementById('is_active').checked
    };

    try {
      // PATCH the row where signup_id matches (NOT user_id)
      await supabaseFetch(
        `business_profiles?signup_id=eq.${encodeURIComponent(signupId)}`,
        {
          method: 'PATCH',
          body: JSON.stringify(payload),
          headers: {
            Prefer: 'return=minimal'
          }
        }
      );

      setFormStatus('Saved. Your AI will use these details going forward.', 'ok');
      const now = new Date();
      if (lastSavedEl) {
        lastSavedEl.textContent = 'Last saved at ' +
          now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      }

    } catch (err) {
      console.error('Save profile error:', err);
      setFormStatus('Error saving profile to Supabase. Check console for details.', 'error');
    }
  }

  // ------------------------------------------------------------------//
  // INIT
  // ------------------------------------------------------------------//

  async function initialise() {
    if (!SUPABASE_URL || !SUPABASE_ANON_KEY || SUPABASE_URL.includes('PASTE') || SUPABASE_ANON_KEY.includes('PASTE')) {
      setLinkStatus('Supabase keys not configured.', 'error');
      setFormStatus('Please paste SUPABASE_URL and SUPABASE_ANON_KEY at the top of this file.', 'error');
      return;
    }

    await loadProfile();
  }

  if (profileForm) {
    profileForm.addEventListener('submit', saveProfile);
  }
  if (refreshBtn) {
    refreshBtn.addEventListener('click', function () {
      setFormStatus('Reloading from server‚Ä¶', 'neutral');
      loadProfile();
    });
  }

  window.addEventListener('DOMContentLoaded', initialise);
</script>
</body>
</html>

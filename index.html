<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TradeBotPro – Get your AI office set up</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --primary-blue: #1f4e79;
      --accent-blue: #00a3ff;
      --dark-text: #1b1b1f;
      --light-bg: #f5f7fa;
      --white: #ffffff;
      --border-radius: 12px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      background: var(--light-bg);
      color: var(--dark-text);
    }

    .page {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }

    .card {
      width: 100%;
      max-width: 860px;
      background: var(--white);
      border-radius: 18px;
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.12);
      padding: 32px 28px;
    }

    @media (min-width: 960px) {
      .card {
        padding: 40px 48px;
      }
    }

    .header {
      display: flex;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }

    .title-block h1 {
      margin: 0 0 6px;
      font-size: 1.6rem;
      letter-spacing: 0.02em;
    }

    .title-block p {
      margin: 0;
      font-size: 0.95rem;
      color: #4b5563;
    }

    .badge {
      background: rgba(31, 78, 121, 0.06);
      color: var(--primary-blue);
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 0.8rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .badge span {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 18px;
      height: 18px;
      border-radius: 999px;
      border: 1px solid rgba(31, 78, 121, 0.25);
      font-size: 0.7rem;
      font-weight: 600;
    }

    /* Progress bar */

    .progress-wrapper {
      margin-bottom: 24px;
    }

    .progress-labels {
      display: flex;
      justify-content: space-between;
      font-size: 0.8rem;
      color: #6b7280;
      margin-bottom: 6px;
    }

    .progress-bar {
      position: relative;
      width: 100%;
      height: 8px;
      background: #e5e7eb;
      border-radius: 999px;
      overflow: hidden;
    }

    .progress-bar-inner {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--primary-blue), var(--accent-blue));
      border-radius: 999px;
      transition: width 0.3s ease;
    }

    .progress-step-labels {
      display: flex;
      justify-content: space-between;
      margin-top: 8px;
      font-size: 0.78rem;
      color: #9ca3af;
    }

    .progress-step-labels span.active {
      color: var(--primary-blue);
      font-weight: 600;
    }

    /* Form layout */

    form {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .step {
      display: none;
    }
    .step.active {
      display: block;
    }

    .field-row {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
    }

    @media (min-width: 768px) {
      .field-row.two {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
      .field-row.three {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    label {
      font-size: 0.86rem;
      font-weight: 500;
      color: #374151;
    }

    .hint {
      font-size: 0.78rem;
      color: #6b7280;
    }

    input[type="text"],
    input[type="email"],
    input[type="tel"],
    input[type="number"],
    textarea,
    select {
      border-radius: 10px;
      border: 1px solid #d1d5db;
      padding: 8px 10px;
      font-size: 0.9rem;
      font-family: inherit;
      outline: none;
      background: #f9fafb;
      transition: border-color 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    }

    input:focus,
    textarea:focus,
    select:focus {
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 1px rgba(31, 78, 121, 0.2);
      background: var(--white);
    }

    textarea {
      min-height: 72px;
      resize: vertical;
    }

    /* AI focus checkboxes */

    .checkbox-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin-top: 8px;
    }

    @media (min-width: 768px) {
      .checkbox-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    .checkbox-pill {
      border-radius: 999px;
      padding: 8px 10px;
      border: 1px solid #d1d5db;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.85rem;
      cursor: pointer;
      background: #f9fafb;
      transition: all 0.15s ease;
    }

    .checkbox-pill input[type="checkbox"] {
      width: 14px;
      height: 14px;
      margin: 0;
    }

    .checkbox-pill span {
      flex: 1;
    }

    .checkbox-pill.active {
      border-color: var(--primary-blue);
      background: rgba(31, 78, 121, 0.06);
    }

    /* Footer / buttons */

    .footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 8px;
      gap: 16px;
      flex-wrap: wrap;
    }

    .footer-left {
      font-size: 0.8rem;
      color: #6b7280;
    }

    .buttons {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    .btn {
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 0.9rem;
      font-weight: 500;
      border: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn-primary {
      background: linear-gradient(90deg, var(--primary-blue), var(--accent-blue));
      color: #ffffff;
    }

    .btn-secondary {
      background: #e5e7eb;
      color: #374151;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: default;
    }

    .status {
      margin-top: 10px;
      font-size: 0.85rem;
    }

    .status.error {
      color: #b91c1c;
    }

    .status.success {
      color: #15803d;
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="card">
      <div class="header">
        <div class="title-block">
          <h1>Tell us about your business</h1>
          <p>We’ll set up your AI office around how you actually work day-to-day.</p>
        </div>
        <div class="badge">
          <span>⚡</span>
          <div>
            <div style="font-size:0.78rem;font-weight:600;">Done in under 2 minutes</div>
            <div style="font-size:0.72rem;">No payment needed yet</div>
          </div>
        </div>
      </div>

      <!-- Progress bar -->
      <div class="progress-wrapper">
        <div class="progress-labels">
          <span>Step <span id="progress-step">1</span> of 4</span>
          <span id="progress-percent">0%</span>
        </div>
        <div class="progress-bar">
          <div class="progress-bar-inner" id="progress-inner"></div>
        </div>
        <div class="progress-step-labels">
          <span id="label-step-1" class="active">Business basics</span>
          <span id="label-step-2">AI focus</span>
          <span id="label-step-3">Pricing</span>
          <span id="label-step-4">Finish</span>
        </div>
      </div>

      <form id="signup-form" novalidate>
        <!-- STEP 1: business basics -->
        <div class="step active" data-step="1">
          <div class="field-row two">
            <div class="field">
              <label for="business_name">Business / trading name *</label>
              <input type="text" id="business_name" name="business_name" required />
              <div class="hint">E.g. “Test Plumber Ltd”</div>
            </div>

            <div class="field">
              <label for="trade_type">What do you mainly do? *</label>
              <select id="trade_type" name="trade_type" required>
                <option value="">Select a trade</option>
                <option value="Plumbing & Heating">Plumbing &amp; Heating</option>
                <option value="Gas & Boilers">Gas &amp; Boiler Specialist</option>
                <option value="Bathrooms">Bathrooms</option>
                <option value="Drainage">Drainage</option>
                <option value="Electrical">Electrical</option>
                <option value="Multi-trade">Multi-trade / Property Maintenance</option>
                <option value="Other">Other (tell us below)</option>
              </select>
            </div>
          </div>

          <div class="field-row two">
            <div class="field">
              <label for="owner_name">Owner’s name *</label>
              <input type="text" id="owner_name" name="owner_name" required />
            </div>
            <div class="field">
              <label for="contact_name">Main contact we’ll work with</label>
              <input type="text" id="contact_name" name="contact_name" />
              <div class="hint">Leave blank if that’s you.</div>
            </div>
          </div>

          <div class="field-row two">
            <div class="field">
              <label for="email">Best email for setup *</label>
              <input type="email" id="email" name="email" required />
            </div>
            <div class="field">
              <label for="phone">Mobile / WhatsApp number *</label>
              <input type="tel" id="phone" name="phone" required />
              <div class="hint">We use this to connect your WhatsApp if you choose that later.</div>
            </div>
          </div>

          <div class="field-row two">
            <div class="field">
              <label for="base_postcode">Base postcode *</label>
              <input type="text" id="base_postcode" name="base_postcode" required />
              <div class="hint">E.g. HP14 3QF.</div>
            </div>
            <div class="field">
              <label for="website_url">Website (if you have one)</label>
              <input type="text" id="website_url" name="website_url" />
            </div>
          </div>
        </div>

        <!-- STEP 2: AI focus (checkboxes + notes) -->
        <div class="step" data-step="2">
          <div class="field">
            <label>What should your AI office focus on first? *</label>
            <div class="hint">Tick all that apply – we’ll prioritise these in your setup.</div>

            <div class="checkbox-grid" id="ai-focus-grid">
              <label class="checkbox-pill">
                <input type="checkbox" name="ai_focus" value="Answer new enquiries quickly" />
                <span>Answer new enquiries quickly</span>
              </label>
              <label class="checkbox-pill">
                <input type="checkbox" name="ai_focus" value="Quote simple jobs automatically" />
                <span>Quote simple jobs automatically</span>
              </label>
              <label class="checkbox-pill">
                <input type="checkbox" name="ai_focus" value="Book jobs into my diary" />
                <span>Book jobs into my diary</span>
              </label>
              <label class="checkbox-pill">
                <input type="checkbox" name="ai_focus" value="Handle boiler service reminders" />
                <span>Handle boiler service reminders</span>
              </label>
              <label class="checkbox-pill">
                <input type="checkbox" name="ai_focus" value="Chase unpaid invoices" />
                <span>Chase unpaid invoices</span>
              </label>
              <label class="checkbox-pill">
                <input type="checkbox" name="ai_focus" value="Turn website visitors into WhatsApp chats" />
                <span>Turn website visitors into WhatsApp chats</span>
              </label>
            </div>
          </div>

          <div class="field">
            <label for="ai_style_notes">Anything else we should know?</label>
            <textarea id="ai_style_notes" name="ai_style_notes"
              placeholder="Tell us about how you like to speak to customers, typical jobs, areas you cover, anything you want the AI to know..."></textarea>
          </div>
        </div>

        <!-- STEP 3: pricing basics -->
        <div class="step" data-step="3">
          <div class="field-row three">
            <div class="field">
              <label for="callout_fee">Call-out fee (if any)</label>
              <input type="number" id="callout_fee" name="callout_fee" min="0" step="1" />
              <div class="hint">Leave blank if you don’t charge a call-out.</div>
            </div>
            <div class="field">
              <label for="first_hour_rate">First hour rate (£)</label>
              <input type="number" id="first_hour_rate" name="first_hour_rate" min="0" step="1" />
            </div>
            <div class="field">
              <label for="hourly_rate">Ongoing hourly rate (£)</label>
              <input type="number" id="hourly_rate" name="hourly_rate" min="0" step="1" />
            </div>
          </div>

          <div class="field-row two">
            <div class="field">
              <label for="boiler_service_from">Boiler service from (£)</label>
              <input type="number" id="boiler_service_from" name="boiler_service_from" min="0" step="1" />
            </div>
            <div class="field">
              <label for="quote_minimum">Minimum job value (£)</label>
              <input type="number" id="quote_minimum" name="quote_minimum" min="0" step="1" />
              <div class="hint">E.g. £80 – below this we might suggest grouping work.</div>
            </div>
          </div>
        </div>

        <!-- STEP 4: finish -->
        <div class="step" data-step="4">
          <div class="field">
            <label>Before you submit</label>
            <div class="hint">
              We’ll configure TradeBotPro for your trade, area and pricing, then email you a link to test it.
            </div>
          </div>

          <div class="field">
            <label for="services_summary">Anything specific you want this AI to do in the next 30 days?</label>
            <textarea id="services_summary" name="services_summary"
              placeholder="E.g. “Reply to all boiler service enquiries within 30 seconds and book them into my existing diary slots.”"></textarea>
          </div>
        </div>

        <div class="footer">
          <div class="footer-left">
            We’ll never share your details. You’re not committing to anything yet.
          </div>
          <div class="buttons">
            <button type="button" class="btn btn-secondary" id="back-btn" disabled>Back</button>
            <button type="button" class="btn btn-primary" id="next-btn">Next</button>
            <button type="submit" class="btn btn-primary" id="submit-btn" style="display:none;">
              Submit details
            </button>
          </div>
        </div>

        <div id="status" class="status" aria-live="polite"></div>
      </form>
    </div>
  </div>

  <script>
    // ==== CONFIG – PUT YOUR REAL VALUES HERE ====
    const SUPABASE_URL = "https://yaiutswdcbfwkxfqxkzy.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlhaXV0c3dkY2Jmd2t4ZnF4a3p5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1MDE2MDgsImV4cCI6MjA4MDA3NzYwOH0.HOLFxzjsZ5Ieqg0b-aTdP0hAdLsPVXL6Zjs-HgOHgc8";

    // ==== PROGRESS / STEPS ====
    const form = document.getElementById('signup-form');
    const steps = Array.from(document.querySelectorAll('.step'));
    const backBtn = document.getElementById('back-btn');
    const nextBtn = document.getElementById('next-btn');
    const submitBtn = document.getElementById('submit-btn');
    const statusEl = document.getElementById('status');

    let currentStep = 1;
    const totalSteps = steps.length;

    function updateProgress() {
      const percent = Math.round(((currentStep - 1) / (totalSteps - 1)) * 100);
      document.getElementById('progress-step').textContent = currentStep;
      document.getElementById('progress-percent').textContent = percent + '%';
      document.getElementById('progress-inner').style.width = percent + '%';

      for (let i = 1; i <= totalSteps; i++) {
        const label = document.getElementById('label-step-' + i);
        if (!label) continue;
        label.classList.toggle('active', i === currentStep);
      }

      steps.forEach(step => {
        const stepNum = Number(step.getAttribute('data-step'));
        step.classList.toggle('active', stepNum === currentStep);
      });

      backBtn.disabled = currentStep === 1;
      if (currentStep === totalSteps) {
        nextBtn.style.display = 'none';
        submitBtn.style.display = 'inline-flex';
      } else {
        nextBtn.style.display = 'inline-flex';
        submitBtn.style.display = 'none';
      }
    }

    function validateCurrentStep() {
      const stepEl = steps[currentStep - 1];
      const requiredFields = Array.from(stepEl.querySelectorAll('[required]'));

      for (const field of requiredFields) {
        if (!field.value || field.value.trim() === '') {
          field.focus();
          return false;
        }
      }
      return true;
    }

    backBtn.addEventListener('click', () => {
      if (currentStep > 1) {
        currentStep--;
        updateProgress();
      }
    });

    nextBtn.addEventListener('click', () => {
      if (!validateCurrentStep()) {
        statusEl.textContent = 'Please complete the required fields on this step.';
        statusEl.className = 'status error';
        return;
      }
      statusEl.textContent = '';
      statusEl.className = 'status';
      if (currentStep < totalSteps) {
        currentStep++;
        updateProgress();
      }
    });

    // Make checkbox pills toggle appearance
    const aiFocusGrid = document.getElementById('ai-focus-grid');
    if (aiFocusGrid) {
      aiFocusGrid.addEventListener('change', (e) => {
        if (e.target.type === 'checkbox') {
          const label = e.target.closest('.checkbox-pill');
          if (!label) return;
          label.classList.toggle('active', e.target.checked);
        }
      });
    }

    // ==== SUPABASE INSERT ====

    async function submitToSupabase(formData) {
      // Build AI focus list
      const aiFocusSelections = [];
      document.querySelectorAll('input[name="ai_focus"]:checked').forEach(cb => {
        aiFocusSelections.push(cb.value);
      });

      const aiFocusSummary = aiFocusSelections.length
        ? 'AI focus priorities: ' + aiFocusSelections.join(', ')
        : '';

      const extraNotes = formData.get('services_summary') || '';
      const combinedServicesSummary = [aiFocusSummary, extraNotes]
        .filter(Boolean)
        .join(' | ');

      const aiStyleNotes = formData.get('ai_style_notes') || '';

      const payload = {
        business_name: formData.get('business_name') || '',
        owner_name: formData.get('owner_name') || '',
        contact_name: formData.get('contact_name') || '',
        email: formData.get('email') || '',
        phone: formData.get('phone') || '',
        trade_type: formData.get('trade_type') || '',
        base_postcode: formData.get('base_postcode') || '',
        website_url: formData.get('website_url') || '',
        callout_fee: formData.get('callout_fee') || null,
        first_hour_rate: formData.get('first_hour_rate') || null,
        hourly_rate: formData.get('hourly_rate') || null,
        boiler_service_from: formData.get('boiler_service_from') || null,
        quote_minimum: formData.get('quote_minimum') || null,
        services_summary: combinedServicesSummary,
        ai_style_notes: aiStyleNotes,
        plan_status: 'Trial requested',
        pending_setup: true,
        is_active: false,
        account_status: 'Pending setup',
        account_status_reason: 'New signup',
      };

      console.log('Submitting payload to Supabase:', payload);

      const res = await fetch(
        `${SUPABASE_URL}/rest/v1/tradebotpro_signups?select=*`,
        {
          method: 'POST',
          headers: {
            apikey: SUPABASE_ANON_KEY,
            Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
            'Content-Type': 'application/json',
            Prefer: 'return=representation',
          },
          body: JSON.stringify(payload),
        }
      );

      let data;
      try {
        data = await res.json();
      } catch (e) {
        console.error('Failed to parse Supabase response as JSON:', e);
        throw new Error('Supabase did not return valid JSON');
      }

      if (!res.ok) {
        console.error('Supabase insert error:', data);
        throw new Error(data?.message || 'Supabase insert failed');
      }

      console.log('Supabase insert success:', data);
      return data[0];
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      if (!validateCurrentStep()) {
        statusEl.textContent = 'Please complete the required fields.';
        statusEl.className = 'status error';
        return;
      }

      statusEl.textContent = 'Saving your details...';
      statusEl.className = 'status';

      backBtn.disabled = true;
      nextBtn.disabled = true;
      submitBtn.disabled = true;

      try {
        const formData = new FormData(form);
        await submitToSupabase(formData);

        statusEl.textContent = 'Thank you – we’ve received your details. We’ll be in touch shortly.';
        statusEl.className = 'status success';

        // Optionally reset form / stay on same screen
        // form.reset();
      } catch (err) {
        console.error(err);
        statusEl.textContent = 'Something went wrong saving your details. Please try again or contact us.';
        statusEl.className = 'status error';
      } finally {
        backBtn.disabled = false;
        nextBtn.disabled = false;
        submitBtn.disabled = false;
      }
    });

    // Initialise
    updateProgress();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TradeBotPro â€” Tell us about your business</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --primary-blue: #1f4e79;
      --accent-blue: #00a3ff;
      --dark-text: #1b1b1f;
      --light-bg: #f5f7fa;
      --white: #ffffff;
      --border: #d0d7e2;
      --danger: #d02828;
      --success: #16843a;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      background: var(--light-bg);
      color: var(--dark-text);
      line-height: 1.5;
    }

    .page {
      max-width: 960px;
      margin: 0 auto;
      padding: 24px 16px 48px;
    }

    header {
      margin-bottom: 16px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    header h1 {
      margin: 0;
      font-size: 1.8rem;
      color: var(--primary-blue);
    }

    header p {
      margin: 0;
      color: #555b6a;
      font-size: 0.95rem;
    }

    .card {
      background: var(--white);
      border-radius: 12px;
      border: 1px solid var(--border);
      padding: 20px 18px;
      box-shadow: 0 4px 12px rgba(15, 23, 42, 0.06);
    }

    form {
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .grid-2 {
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      gap: 14px 18px;
    }

    @media (min-width: 720px) {
      .grid-2 {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    label {
      font-size: 0.88rem;
      font-weight: 600;
      color: #333749;
    }

    input[type="text"],
    input[type="email"],
    input[type="tel"],
    input[type="number"],
    select,
    textarea {
      border-radius: 8px;
      border: 1px solid var(--border);
      padding: 8px 10px;
      font: inherit;
      background: #fcfdff;
      min-height: 36px;
    }

    textarea {
      min-height: 70px;
      resize: vertical;
    }

    input:focus,
    select:focus,
    textarea:focus {
      outline: 2px solid var(--accent-blue);
      outline-offset: 0;
      border-color: var(--accent-blue);
      background: #ffffff;
    }

    .small-hint {
      font-size: 0.78rem;
      color: #7a8191;
    }

    .switch-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 4px;
    }

    .switch-row input[type="checkbox"] {
      width: 18px;
      height: 18px;
    }

    .section-title {
      margin: 12px 0 4px;
      font-size: 0.9rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: #6a7283;
      border-top: 1px solid #e1e6f0;
      padding-top: 10px;
    }

    .buttons {
      display: flex;
      gap: 10px;
      margin-top: 6px;
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 9px 18px;
      font: inherit;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .btn-primary {
      background: var(--primary-blue);
      color: var(--white);
    }

    .btn-primary:disabled {
      opacity: 0.7;
      cursor: progress;
    }

    .btn-secondary {
      background: #e4e9f3;
      color: #1b2335;
    }

    .status-bar {
      margin-top: 12px;
      font-size: 0.85rem;
      padding: 8px 10px;
      border-radius: 8px;
      display: none;
      align-items: center;
      gap: 8px;
    }

    .status-bar.show {
      display: inline-flex;
    }

    .status-bar.success {
      background: #e6f6ec;
      color: var(--success);
      border: 1px solid #c4ebd3;
    }

    .status-bar.error {
      background: #ffecec;
      color: var(--danger);
      border: 1px solid #f4c3c3;
    }

    .status-bar.neutral {
      background: #eef2fb;
      color: #384152;
      border: 1px solid #d4dbf0;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: currentColor;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 3px 9px;
      border-radius: 999px;
      font-size: 0.75rem;
      background: #ecf3ff;
      color: var(--primary-blue);
      border: 1px solid #c3d4ff;
    }

    .danger-text {
      color: var(--danger);
    }

    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <h1>Tell us about your business</h1>
      <p>
        This information helps your TradeBotPro assistant quote correctly and talk like you.
        You can update it any time.
      </p>
    </header>

    <div class="card">
      <form id="profile-form">
        <!-- SECTION: Basic details -->
        <div class="section-title">Business details</div>
        <div class="grid-2">
          <div class="field">
            <label for="business_name">Business name</label>
            <input type="text" id="business_name" name="business_name" autocomplete="organization" />
          </div>

          <div class="field">
            <label for="trade_type">Main trade / service</label>
            <input type="text" id="trade_type" name="trade_type" placeholder="e.g. Plumbing & heating" />
          </div>

          <div class="field">
            <label for="owner_name">Owner / director name</label>
            <input type="text" id="owner_name" name="owner_name" autocomplete="name" />
          </div>

          <div class="field">
            <label for="contact_name">Day-to-day contact</label>
            <input type="text" id="contact_name" name="contact_name" placeholder="Who should we say is replying?" />
          </div>
        </div>

        <!-- SECTION: Contact -->
        <div class="section-title">Contact & online</div>
        <div class="grid-2">
          <div class="field">
            <label for="email">Email for bookings</label>
            <input type="email" id="email" name="email" autocomplete="email" />
          </div>

          <div class="field">
            <label for="phone">Main phone number</label>
            <input type="tel" id="phone" name="phone" autocomplete="tel" />
          </div>

          <div class="field">
            <label for="whatsapp_number">WhatsApp number</label>
            <input type="tel" id="whatsapp_number" name="whatsapp_number" />
            <div class="small-hint">The number your TradeBotPro WhatsApp assistant will use.</div>
          </div>

          <div class="field">
            <label for="website_url">Website</label>
            <input type="text" id="website_url" name="website_url" placeholder="https://â€¦" />
          </div>
        </div>

        <!-- SECTION: Area & radius -->
        <div class="section-title">Area you cover</div>
        <div class="grid-2">
          <div class="field">
            <label for="base_postcode">Base postcode</label>
            <input type="text" id="base_postcode" name="base_postcode" placeholder="e.g. HP14 3QF" />
          </div>

          <div class="field">
            <label for="service_radius">Service radius (miles)</label>
            <input type="number" id="service_radius" name="service_radius" min="0" step="1" />
          </div>

          <div class="field">
            <label for="callout_from">Callout hours from</label>
            <input type="text" id="callout_from" name="callout_from" placeholder="e.g. 8am â€“ 6pm" />
          </div>

          <div class="field">
            <label>Currently taking on new work?</label>
            <div class="switch-row">
              <input type="checkbox" id="is_active" name="is_active" />
              <label for="is_active" style="font-weight:400;">Yes, show us as available</label>
            </div>
          </div>
        </div>

        <!-- SECTION: Pricing -->
        <div class="section-title">Pricing basics</div>
        <div class="grid-2">
          <div class="field">
            <label for="callout_fee">Call-out fee (Â£)</label>
            <input type="number" id="callout_fee" name="callout_fee" min="0" step="1" />
          </div>

          <div class="field">
            <label for="first_hour_rate">First hour rate (Â£)</label>
            <input type="number" id="first_hour_rate" name="first_hour_rate" min="0" step="1" />
          </div>

          <div class="field">
            <label for="hourly_rate_from">Hourly rate from (Â£)</label>
            <input type="number" id="hourly_rate_from" name="hourly_rate_from" min="0" step="1" />
          </div>

          <div class="field">
            <label for="hourly_rate">Standard hourly rate (Â£)</label>
            <input type="number" id="hourly_rate" name="hourly_rate" min="0" step="1" />
          </div>

          <div class="field">
            <label for="boiler_service_from">Boiler service from (Â£)</label>
            <input type="number" id="boiler_service_from" name="boiler_service_from" min="0" step="1" />
          </div>

          <div class="field">
            <label for="quote_minimum">Minimum job value (Â£)</label>
            <input type="number" id="quote_minimum" name="quote_minimum" min="0" step="1" />
          </div>
        </div>

        <div class="field">
          <label for="pricing_notes">Pricing notes</label>
          <textarea
            id="pricing_notes"
            name="pricing_notes"
            placeholder="Any extras, weekend rates, parking, congestion charge, materials, VAT, etc."
          ></textarea>
        </div>

        <!-- SECTION: Services & style -->
        <div class="section-title">What you do & how you talk</div>

        <div class="field">
          <label for="services_summary">Services summary</label>
          <textarea
            id="services_summary"
            name="services_summary"
            placeholder="Short list of typical jobs you want TradeBotPro to promote."
          ></textarea>
        </div>

        <div class="field">
          <label for="ai_style_notes">How should your assistant sound?</label>
          <textarea
            id="ai_style_notes"
            name="ai_style_notes"
            placeholder='e.g. "Friendly but professional, no emojis, keep replies under 4 lines."'
          ></textarea>
        </div>

        <div class="field">
          <label for="notes">Internal notes (only you see this)</label>
          <textarea
            id="notes"
            name="notes"
            placeholder="Anything else we should know about how you work."
          ></textarea>
        </div>

        <div class="field">
          <label for="callout_notes">Call-out notes</label>
          <textarea
            id="callout_notes"
            name="callout_notes"
            placeholder="Key rules for call-outs, emergencies, access, etc."
          ></textarea>
        </div>

        <!-- SECTION: Account / setup (simple text fields so they sync with signups) -->
        <div class="section-title">Account / setup (optional)</div>
        <div class="grid-2">
          <div class="field">
            <label for="plan_status">Plan status</label>
            <input
              type="text"
              id="plan_status"
              name="plan_status"
              placeholder="e.g. Trial, Active, Paused"
            />
          </div>

          <div class="field">
            <label for="account_status">Account status</label>
            <input
              type="text"
              id="account_status"
              name="account_status"
              placeholder="e.g. OK, Payment issue"
            />
          </div>

          <div class="field">
            <label for="account_status_reason">Account status reason</label>
            <input
              type="text"
              id="account_status_reason"
              name="account_status_reason"
              placeholder="Short note"
            />
          </div>

          <div class="field">
            <label>Pending setup tasks?</label>
            <div class="switch-row">
              <input type="checkbox" id="pending_setup" name="pending_setup" />
              <label for="pending_setup" style="font-weight:400;">Yes, still setting things up</label>
            </div>
          </div>
        </div>

        <!-- Buttons + status -->
        <div class="buttons">
          <button type="submit" class="btn-primary" id="save-btn">
            <span id="save-btn-text">Save details</span>
            <span id="save-btn-spinner" class="hidden">Savingâ€¦</span>
          </button>
          <button type="button" class="btn-secondary" id="reset-btn" title="Reload from Supabase">
            Reset to saved version
          </button>
          <span class="pill">
            <span style="width:8px;height:8px;border-radius:999px;background:#10b981;"></span>
            business_profiles + tradebotpro_signups stay in sync
          </span>
        </div>

        <div id="status-bar" class="status-bar neutral">
          <span class="status-dot"></span>
          <span id="status-text">Loadingâ€¦</span>
        </div>
      </form>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // ðŸ”§ TODO: plug in your real project values
    const SUPABASE_URL = "https://yaiutswdcbfwkxfqxkzy.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlhaXV0c3dkY2Jmd2t4ZnF4a3p5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1MDE2MDgsImV4cCI6MjA4MDA3NzYwOH0.HOLFxzjsZ5Ieqg0b-aTdP0hAdLsPVXL6Zjs-HgOHgc8";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const form = document.getElementById("profile-form");
    const statusBar = document.getElementById("status-bar");
    const statusText = document.getElementById("status-text");
    const saveBtn = document.getElementById("save-btn");
    const saveBtnText = document.getElementById("save-btn-text");
    const saveBtnSpinner = document.getElementById("save-btn-spinner");
    const resetBtn = document.getElementById("reset-btn");

    let currentUserId = null;
    let signupId = null;

    function setStatus(message, variant = "neutral") {
      statusText.textContent = message;
      statusBar.classList.remove("success", "error", "neutral", "show");
      statusBar.classList.add(variant, "show");
    }

    function setSaving(isSaving) {
      saveBtn.disabled = isSaving;
      if (isSaving) {
        saveBtnText.classList.add("hidden");
        saveBtnSpinner.classList.remove("hidden");
      } else {
        saveBtnText.classList.remove("hidden");
        saveBtnSpinner.classList.add("hidden");
      }
    }

    function getUserIdFromUrl() {
      const params = new URLSearchParams(window.location.search);
      const userId = params.get("user_id") || params.get("userId");
      return userId;
    }

    function fillFormFromRecord(record) {
      if (!record) return;

      for (const [key, value] of Object.entries(record)) {
        const field = form.elements.namedItem(key);
        if (!field) continue;

        if (field.type === "checkbox") {
          field.checked = !!value;
        } else {
          field.value = value == null ? "" : value;
        }
      }
    }

    function collectPayloadFromForm() {
      const fd = new FormData(form);

      // IMPORTANT: only include columns that exist in both tables
      const payload = {
        business_name: fd.get("business_name")?.trim() || null,
        owner_name: fd.get("owner_name")?.trim() || null,
        contact_name: fd.get("contact_name")?.trim() || null,
        email: fd.get("email")?.trim() || null,
        phone: fd.get("phone")?.trim() || null,
        whatsapp_number: fd.get("whatsapp_number")?.trim() || null,
        trade_type: fd.get("trade_type")?.trim() || null,

        base_postcode: fd.get("base_postcode")?.trim() || null,
        service_radius: fd.get("service_radius") || null,
        callout_from: fd.get("callout_from")?.trim() || null,

        callout_fee: fd.get("callout_fee") || null,
        first_hour_rate: fd.get("first_hour_rate") || null,
        hourly_rate_from: fd.get("hourly_rate_from") || null,
        hourly_rate: fd.get("hourly_rate") || null,
        boiler_service_from: fd.get("boiler_service_from") || null,
        quote_minimum: fd.get("quote_minimum") || null,

        website_url: fd.get("website_url")?.trim() || null,
        pricing_notes: fd.get("pricing_notes")?.trim() || null,
        services_summary: fd.get("services_summary")?.trim() || null,
        notes: fd.get("notes")?.trim() || null,
        callout_notes: fd.get("callout_notes")?.trim() || null,
        ai_style_notes: fd.get("ai_style_notes")?.trim() || null,

        plan_status: fd.get("plan_status")?.trim() || null,
        account_status: fd.get("account_status")?.trim() || null,
        account_status_reason: fd.get("account_status_reason")?.trim() || null,

        is_active: fd.get("is_active") === "on",
        pending_setup: fd.get("pending_setup") === "on",
      };

      return payload;
    }

    async function loadProfile() {
      try {
        setStatus("Loading your saved detailsâ€¦", "neutral");

        const userId = getUserIdFromUrl();
        if (!userId) {
          setStatus("Missing user_id in URL â€” please check the link.", "error");
          console.error("No user_id in query string");
          return;
        }
        currentUserId = userId;

        // 1) Try business_profiles first (this is now your primary)
        const { data: profile, error: profileError } = await supabase
          .from("business_profiles")
          .select("*")
          .eq("user_id", userId)
          .maybeSingle();

        if (profileError && profileError.code !== "PGRST116") {
          console.error("Error loading business_profiles:", profileError);
        }

        // 2) Try tradebotpro_signups as well so we can sync id + any legacy values
        const { data: signup, error: signupError } = await supabase
          .from("tradebotpro_signups")
          .select("*")
          .eq("user_id", userId)
          .maybeSingle();

        if (signupError && signupError.code !== "PGRST116") {
          console.error("Error loading tradebotpro_signups:", signupError);
        }

        if (signup && signup.id) {
          signupId = signup.id;
        }

        const source = profile || signup;

        if (source) {
          fillFormFromRecord(source);
          setStatus(
            "Loaded your details. Update anything and press Save â€” both tables will stay in sync.",
            "success"
          );
        } else {
          setStatus("No details saved yet. Fill in the form and press Save.", "neutral");
        }
      } catch (err) {
        console.error("Unexpected load error:", err);
        setStatus("There was a problem loading your details.", "error");
      }
    }

    async function saveProfile(e) {
      e.preventDefault();
      if (!currentUserId) {
        setStatus("Missing user_id â€” cannot save.", "error");
        return;
      }

      const payload = collectPayloadFromForm();
      setSaving(true);
      setStatus("Saving your detailsâ€¦", "neutral");

      try {
        // ---- 1) Upsert into business_profiles (by user_id) ----
        const profilePayload = {
          ...payload,
          user_id: currentUserId,
        };

        const { error: profileError } = await supabase
          .from("business_profiles")
          .upsert(profilePayload, {
            onConflict: "user_id",
          });

        if (profileError) {
          console.error("business_profiles upsert error:", profileError);
          throw profileError;
        }

        // ---- 2) Keep tradebotpro_signups in sync ----
        // First see if we already have a signup row for this user_id
        if (!signupId) {
          const { data: existingSignup, error: lookupError } = await supabase
            .from("tradebotpro_signups")
            .select("id")
            .eq("user_id", currentUserId)
            .maybeSingle();

          if (lookupError && lookupError.code !== "PGRST116") {
            console.error("tradebotpro_signups lookup error:", lookupError);
          }

          if (existingSignup && existingSignup.id) {
            signupId = existingSignup.id;
          }
        }

        if (signupId) {
          // Update existing signup row
          const { error: signupUpdateError } = await supabase
            .from("tradebotpro_signups")
            .update(payload)
            .eq("id", signupId);

          if (signupUpdateError) {
            console.error("tradebotpro_signups update error:", signupUpdateError);
            throw signupUpdateError;
          }
        } else {
          // Insert new signup row tied to this user_id
          const { data: insertData, error: signupInsertError } = await supabase
            .from("tradebotpro_signups")
            .insert({
              ...payload,
              user_id: currentUserId,
            })
            .select("id")
            .maybeSingle();

          if (signupInsertError) {
            console.error("tradebotpro_signups insert error:", signupInsertError);
            throw signupInsertError;
          }

          if (insertData && insertData.id) {
            signupId = insertData.id;
          }
        }

        setStatus("Saved. business_profiles and tradebotpro_signups are now in sync.", "success");
      } catch (err) {
        console.error("Save profile error:", err);
        setStatus(
          `Save failed: ${err?.message || "Check the console for details."}`,
          "error"
        );
      } finally {
        setSaving(false);
      }
    }

    // Wire up events
    form.addEventListener("submit", saveProfile);
    resetBtn.addEventListener("click", (e) => {
      e.preventDefault();
      loadProfile();
    });

    // Initial load
    loadProfile();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TradeBotPro â€” Control Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --primary-blue: #1f4e79;
      --accent-blue: #00a3ff;
      --bg: #f5f7fa;
      --card-bg: #ffffff;
      --border: #dde2eb;
      --text-main: #1b1b1f;
      --text-muted: #6b7280;
      --danger: #b91c1c;
      --success: #15803d;
      --warning: #b45309;
      --row-hover: #eef3ff;
      --row-selected: #dbeafe;
      --chip-bg: #e5e7eb;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--text-main);
    }

    .app-shell {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: #ffffff;
      border-bottom: 1px solid var(--border);
      padding: 12px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand-mark {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      background: radial-gradient(circle at 30% 30%, #ffffff 0, #a8c3ff 18%, #1f4e79 70%, #0b1f33 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #ffffff;
      font-weight: 700;
      font-size: 18px;
    }

    .brand-text-main {
      font-weight: 600;
      letter-spacing: 0.02em;
    }

    .brand-text-sub {
      font-size: 12px;
      color: var(--text-muted);
    }

    .header-badge {
      font-size: 12px;
      border-radius: 999px;
      padding: 4px 10px;
      background: #e5f3ff;
      color: var(--primary-blue);
      border: 1px solid #c4ddff;
    }

    main {
      flex: 1;
      padding: 16px;
      max-width: 1400px;
      margin: 0 auto 32px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .top-row {
      display: grid;
      grid-template-columns: minmax(0, 2.1fr) minmax(0, 1.4fr);
      gap: 16px;
      align-items: flex-start;
    }

    .card {
      background: var(--card-bg);
      border-radius: 14px;
      border: 1px solid var(--border);
      padding: 14px 16px;
      box-shadow: 0 6px 18px rgba(15, 23, 42, 0.04);
    }

    .card-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 8px;
    }

    .card-title {
      font-size: 16px;
      font-weight: 600;
    }

    .card-subtitle {
      font-size: 12px;
      color: var(--text-muted);
    }

    .chips-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }

    .chip {
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid #e5e7eb;
      background: var(--chip-bg);
      color: var(--text-muted);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .chip-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #9ca3af;
    }

    .chip-live .chip-dot {
      background: var(--success);
    }

    .chip-trial .chip-dot {
      background: var(--accent-blue);
    }

    .chip-pending .chip-dot {
      background: var(--warning);
    }

    .chip-risk .chip-dot {
      background: var(--danger);
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 8px;
      margin-top: 4px;
    }

    .metric-card {
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      padding: 8px 10px;
      background: #f9fafb;
    }

    .metric-label {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .metric-value {
      font-size: 18px;
      font-weight: 600;
    }

    .metric-footnote {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .filters-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 8px 0 4px;
      align-items: center;
    }

    .filters-group {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }

    .filters-label {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    select,
    input[type="search"] {
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 6px 10px;
      font-size: 12px;
      background: #ffffff;
      min-width: 120px;
    }

    input[type="search"] {
      min-width: 160px;
    }

    .table-wrapper {
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      background: #ffffff;
      margin-top: 6px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    thead {
      background: #f3f4f6;
    }

    th,
    td {
      padding: 8px 10px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
    }

    th {
      font-weight: 500;
      color: var(--text-muted);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    tbody tr {
      cursor: pointer;
      transition: background 0.08s ease;
    }

    tbody tr:hover {
      background: var(--row-hover);
    }

    tbody tr.selected {
      background: var(--row-selected);
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid transparent;
    }

    .status-pill.live {
      background: #dcfce7;
      color: #166534;
      border-color: #bbf7d0;
    }

    .status-pill.trial {
      background: #dbeafe;
      color: #1d4ed8;
      border-color: #bfdbfe;
    }

    .status-pill.pending {
      background: #fef9c3;
      color: #854d0e;
      border-color: #fef3c7;
    }

    .status-pill.cancelled {
      background: #fee2e2;
      color: #b91c1c;
      border-color: #fecaca;
    }

    .detail-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px 16px;
      margin-top: 6px;
    }

    .field-label {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 2px;
    }

    .field-value {
      font-size: 13px;
      font-weight: 500;
      word-break: break-word;
    }

    .field-value.muted {
      color: var(--text-muted);
      font-weight: 400;
    }

    .detail-section-title {
      margin-top: 8px;
      font-size: 13px;
      font-weight: 600;
    }

    textarea {
      width: 100%;
      min-height: 70px;
      resize: vertical;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      font-family: inherit;
      font-size: 13px;
    }

    .stack-vertical {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .stack-horizontal {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    .btn {
      border-radius: 999px;
      border: none;
      padding: 6px 14px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn-primary {
      background: var(--primary-blue);
      color: #ffffff;
    }

    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
    }

    .btn-ghost {
      background: transparent;
      border: 1px solid var(--border);
      color: #374151;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: default;
    }

    .status-row {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 6px;
      margin-top: 4px;
      margin-bottom: 4px;
    }

    .status-row select {
      width: 100%;
    }

    .small-hint {
      font-size: 11px;
      color: var(--text-muted);
    }

    .message-panel {
      margin-top: 4px;
    }

    .message-panel select {
      width: 100%;
      margin-bottom: 4px;
    }

    .message-footer {
      margin-top: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .message-footer .small-hint {
      flex: 1;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #e5e7eb;
      color: #4b5563;
      gap: 4px;
    }

    .pill-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #9ca3af;
    }

    .pill-ok .pill-dot {
      background: var(--success);
    }

    .pill-risk .pill-dot {
      background: var(--danger);
    }

    .pill-break .pill-dot {
      background: #f97316;
    }

    .inline-badge {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      color: var(--text-muted);
      background: #f9fafb;
    }

    .loading {
      font-size: 13px;
      color: var(--text-muted);
      padding: 4px 0;
    }

    .error {
      color: var(--danger);
      font-size: 12px;
      margin-top: 4px;
    }

    @media (max-width: 960px) {
      .top-row {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    @media (max-width: 768px) {
      header {
        flex-direction: column;
        align-items: flex-start;
      }

      .metrics-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }

      th:nth-child(4),
      td:nth-child(4),
      th:nth-child(5),
      td:nth-child(5),
      th:nth-child(6),
      td:nth-child(6) {
        display: none;
      }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header>
      <div class="brand">
        <div class="brand-mark">T</div>
        <div>
          <div class="brand-text-main">TradeBotPro Control Panel</div>
          <div class="brand-text-sub">Signups, statuses & setup at a glance</div>
        </div>
      </div>
      <div class="stack-horizontal">
        <span class="header-badge">Internal Â· v4B / v4C baseline</span>
        <span class="small-hint">Changes save to Supabase in real time.</span>
      </div>
    </header>

    <main>
      <div class="top-row">
        <!-- LEFT: SIGNUPS TABLE + METRICS -->
        <section class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Signups overview</div>
              <div class="card-subtitle">Read/write view of <code>tradebotpro_signups</code></div>
              <div class="chips-row">
                <span class="chip chip-live">
                  <span class="chip-dot"></span> Live
                </span>
                <span class="chip chip-trial">
                  <span class="chip-dot"></span> Trials
                </span>
                <span class="chip chip-pending">
                  <span class="chip-dot"></span> Pending setup
                </span>
                <span class="chip chip-risk">
                  <span class="chip-dot"></span> Churn risk / issues
                </span>
              </div>
            </div>
          </div>

          <div class="metrics-grid" id="metrics">
            <div class="metric-card">
              <div class="metric-label">Total signups</div>
              <div class="metric-value" id="metric-total">â€“</div>
              <div class="metric-footnote">All time</div>
            </div>
            <div class="metric-card">
              <div class="metric-label">Pending setup</div>
              <div class="metric-value" id="metric-pending">â€“</div>
              <div class="metric-footnote">Need onboarding</div>
            </div>
            <div class="metric-card">
              <div class="metric-label">Live / active</div>
              <div class="metric-value" id="metric-live">â€“</div>
              <div class="metric-footnote">Plan status = live</div>
            </div>
            <div class="metric-card">
              <div class="metric-label">Trials</div>
              <div class="metric-value" id="metric-trial">â€“</div>
              <div class="metric-footnote">Plan status = trial</div>
            </div>
          </div>

          <div class="filters-row">
            <div class="filters-group">
              <span class="filters-label">Plan</span>
              <select id="filter-plan">
                <option value="all">All</option>
                <option value="live">Live</option>
                <option value="trial">Trial</option>
                <option value="cancelled">Cancelled</option>
                <option value="paused">Paused / break</option>
              </select>
            </div>

            <div class="filters-group">
              <span class="filters-label">Account</span>
              <select id="filter-account">
                <option value="all">All</option>
                <option value="ok">All OK</option>
                <option value="churn_risk">Churn risk</option>
                <option value="blocked">Blocked</option>
              </select>
            </div>

            <div class="filters-group">
              <span class="filters-label">Trade</span>
              <select id="filter-trade">
                <option value="all">All trades</option>
                <option value="plumbing_heating">Plumbing &amp; Heating</option>
                <option value="heating_only">Heating only</option>
                <option value="general_plumbing">General plumbing</option>
                <option value="other">Other</option>
              </select>
            </div>

            <div class="filters-group" style="margin-left:auto;">
              <span class="filters-label">Search</span>
              <input
                type="search"
                id="filter-search"
                placeholder="Business, contact, postcodeâ€¦"
              />
            </div>
          </div>

          <div id="table-loading" class="loading">Loading signups from Supabaseâ€¦</div>
          <div id="table-error" class="error" style="display:none;">
            Something went wrong loading signups. Check the console.
          </div>

          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Business & contact</th>
                  <th>Trade</th>
                  <th>Postcode</th>
                  <th>Plan</th>
                  <th>Setup</th>
                  <th>Account</th>
                </tr>
              </thead>
              <tbody id="signups-body">
                <!-- injected via JS -->
              </tbody>
            </table>
          </div>
        </section>

        <!-- RIGHT: SELECTED SIGNUP DETAILS + MESSAGING -->
        <section class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Selected signup</div>
              <div class="card-subtitle">Choose a signup on the left to see full details</div>
            </div>
            <button class="btn btn-ghost" id="btn-refresh" type="button">Refresh</button>
          </div>

          <div id="detail-empty">
            <p class="small-hint">
              Nothing selected yet. Click any row in the signups table to load full details here.
            </p>
          </div>

          <div id="detail-panel" style="display:none;">
            <div class="detail-section-title">Who they are</div>
            <div class="detail-grid">
              <div>
                <div class="field-label">Business name</div>
                <div class="field-value" id="detail-business">â€“</div>
              </div>
              <div>
                <div class="field-label">Trade type</div>
                <div class="field-value" id="detail-trade">â€“</div>
              </div>
              <div>
                <div class="field-label">Contact name</div>
                <div class="field-value" id="detail-contact">â€“</div>
              </div>
              <div>
                <div class="field-label">Owner name</div>
                <div class="field-value" id="detail-owner">â€“</div>
              </div>
              <div>
                <div class="field-label">Base postcode</div>
                <div class="field-value" id="detail-postcode">â€“</div>
              </div>
              <div>
                <div class="field-label">Website</div>
                <div class="field-value" id="detail-website">â€“</div>
              </div>
              <div>
                <div class="field-label">Email</div>
                <div class="field-value" id="detail-email">â€“</div>
              </div>
              <div>
                <div class="field-label">Phone / WhatsApp</div>
                <div class="field-value" id="detail-phone">â€“</div>
              </div>
            </div>

            <div class="detail-section-title">Status & plan</div>
            <div class="status-row">
              <div class="stack-vertical">
                <span class="field-label">Plan status</span>
                <select id="detail-plan-status">
                  <option value="">(no value)</option>
                  <option value="trial">Trial</option>
                  <option value="live">Live</option>
                  <option value="cancelled">Cancelled</option>
                  <option value="paused">Paused / break</option>
                </select>
              </div>
              <div class="stack-vertical">
                <span class="field-label">Setup status</span>
                <select id="detail-pending-setup">
                  <option value="">(no value)</option>
                  <option value="not_started">Not started</option>
                  <option value="needs_info">Needs info from customer</option>
                  <option value="building_assistant">Building assistant</option>
                  <option value="awaiting_signoff">Awaiting sign-off</option>
                  <option value="complete">Complete</option>
                </select>
              </div>
              <div class="stack-vertical">
                <span class="field-label">Account status</span>
                <select id="detail-account-status">
                  <option value="">(no value)</option>
                  <option value="ok">All OK</option>
                  <option value="churn_risk">Churn risk</option>
                  <option value="blocked">Blocked</option>
                </select>
              </div>
            </div>
            <div class="stack-vertical" style="margin-top:4px;">
              <span class="field-label">Account status reason</span>
              <textarea id="detail-account-reason" placeholder="Notes e.g. slow payer, tech issues, wants a breakâ€¦"></textarea>
            </div>
            <div class="message-footer" style="margin-top:6px;">
              <button class="btn btn-primary" id="btn-save-status" type="button">
                Save status
              </button>
              <span class="small-hint" id="status-save-hint">Changes save to Supabase & refresh the list.</span>
            </div>

            <div class="detail-section-title">Pricing signals</div>
            <div class="detail-grid">
              <div>
                <div class="field-label">Call-out fee</div>
                <div class="field-value" id="detail-callout">â€“</div>
              </div>
              <div>
                <div class="field-label">First hour</div>
                <div class="field-value" id="detail-first-hour">â€“</div>
              </div>
              <div>
                <div class="field-label">Hourly rate</div>
                <div class="field-value" id="detail-hourly-rate">â€“</div>
              </div>
              <div>
                <div class="field-label">Boiler service from</div>
                <div class="field-value" id="detail-boiler">â€“</div>
              </div>
              <div>
                <div class="field-label">Quote minimum</div>
                <div class="field-value" id="detail-quote-min">â€“</div>
              </div>
            </div>

            <div class="detail-section-title">What they want from the AI</div>
            <div class="stack-vertical">
              <div>
                <div class="field-label">Services summary</div>
                <div class="field-value" id="detail-services" style="white-space:pre-wrap;">â€“</div>
              </div>
              <div>
                <div class="field-label">AI style notes</div>
                <div class="field-value" id="detail-ai-notes" style="white-space:pre-wrap;">â€“</div>
              </div>
            </div>

            <div class="detail-section-title">System fields</div>
            <div class="detail-grid">
              <div>
                <div class="field-label">Created at</div>
                <div class="field-value muted" id="detail-created-at">â€“</div>
              </div>
              <div>
                <div class="field-label">Raw ID</div>
                <div class="field-value muted" id="detail-id">â€“</div>
              </div>
            </div>

            <div class="detail-section-title">Assistant messaging (stub)</div>
            <div class="message-panel">
              <select id="message-template">
                <option value="">Choose a quick messageâ€¦</option>
                <option value="welcome_trial">
                  Welcome â€” trial started & expectations
                </option>
                <option value="setup_call">
                  Ask for setup call / missing info
                </option>
                <option value="go_live">
                  Confirm they are live & what to expect
                </option>
                <option value="break">
                  Offer to pause plan for a month instead of cancelling
                </option>
              </select>
              <textarea
                id="message-body"
                placeholder="Choose a template above, or write a message youâ€™ll paste into WhatsApp/email."
              ></textarea>
              <div class="message-footer">
                <span class="small-hint">
                  This doesnâ€™t send automatically yet â€” itâ€™s a drafting area so you can
                  copy/paste into WhatsApp, email or SMS.
                </span>
                <div class="stack-horizontal">
                  <button class="btn btn-secondary" id="btn-copy-message" type="button">
                    Copy message
                  </button>
                  <button class="btn btn-ghost" id="btn-clear-message" type="button">
                    Clear
                  </button>
                </div>
              </div>
            </div>

            <div style="margin-top:8px;">
              <span class="pill pill-ok">
                <span class="pill-dot"></span> All OK
              </span>
              <span class="pill pill-break">
                <span class="pill-dot"></span> Wants a break
              </span>
              <span class="pill pill-risk">
                <span class="pill-dot"></span> Churn risk
              </span>
            </div>
          </div>
        </section>
      </div>
    </main>
  </div>

  <!-- Supabase client -->
  <script src="https://esm.sh/@supabase/supabase-js@2.48.0"></script>
  <script>
    // ðŸ”‘ 1) Supabase config (REPLACE with your real values)
    const SUPABASE_URL = "https://yaiutswdcbfwkxfqxkzy.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlhaXV0c3dkY2Jmd2t4ZnF4a3p5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1MDE2MDgsImV4cCI6MjA4MDA3NzYwOH0.HOLFxzjsZ5Ieqg0b-aTdP0hAdLsPVXL6Zjs-HgOHgc8";

    if (!supabaseUrl || !supabaseAnonKey) {
      console.error("Supabase URL or anon key is missing. Set them at the top of admin-dashboard.html");
    }

    const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);

    // State
    let allSignups = [];
    let filteredSignups = [];
    let selectedSignupId = null;
    let isSavingStatus = false;

    // Elements
    const tableLoadingEl = document.getElementById("table-loading");
    const tableErrorEl = document.getElementById("table-error");
    const signupsBodyEl = document.getElementById("signups-body");

    const filterPlanEl = document.getElementById("filter-plan");
    const filterAccountEl = document.getElementById("filter-account");
    const filterTradeEl = document.getElementById("filter-trade");
    const filterSearchEl = document.getElementById("filter-search");

    const metricTotalEl = document.getElementById("metric-total");
    const metricPendingEl = document.getElementById("metric-pending");
    const metricLiveEl = document.getElementById("metric-live");
    const metricTrialEl = document.getElementById("metric-trial");

    const detailEmptyEl = document.getElementById("detail-empty");
    const detailPanelEl = document.getElementById("detail-panel");

    const detailBusinessEl = document.getElementById("detail-business");
    const detailTradeEl = document.getElementById("detail-trade");
    const detailContactEl = document.getElementById("detail-contact");
    const detailOwnerEl = document.getElementById("detail-owner");
    const detailPostcodeEl = document.getElementById("detail-postcode");
    const detailWebsiteEl = document.getElementById("detail-website");
    const detailEmailEl = document.getElementById("detail-email");
    const detailPhoneEl = document.getElementById("detail-phone");

    const detailPlanStatusEl = document.getElementById("detail-plan-status");
    const detailPendingSetupEl = document.getElementById("detail-pending-setup");
    const detailAccountStatusEl = document.getElementById("detail-account-status");
    const detailAccountReasonEl = document.getElementById("detail-account-reason");

    const detailCalloutEl = document.getElementById("detail-callout");
    const detailFirstHourEl = document.getElementById("detail-first-hour");
    const detailHourlyRateEl = document.getElementById("detail-hourly-rate");
    const detailBoilerEl = document.getElementById("detail-boiler");
    const detailQuoteMinEl = document.getElementById("detail-quote-min");

    const detailServicesEl = document.getElementById("detail-services");
    const detailAiNotesEl = document.getElementById("detail-ai-notes");

    const detailCreatedAtEl = document.getElementById("detail-created-at");
    const detailIdEl = document.getElementById("detail-id");

    const btnRefreshEl = document.getElementById("btn-refresh");
    const btnSaveStatusEl = document.getElementById("btn-save-status");
    const statusSaveHintEl = document.getElementById("status-save-hint");

    const messageTemplateEl = document.getElementById("message-template");
    const messageBodyEl = document.getElementById("message-body");
    const btnCopyMessageEl = document.getElementById("btn-copy-message");
    const btnClearMessageEl = document.getElementById("btn-clear-message");

    // Helpers
    function formatMoney(value) {
      if (value === null || value === undefined || value === "") return "â€“";
      const num = Number(value);
      if (Number.isNaN(num)) return String(value);
      return "Â£" + num.toFixed(0);
    }

    function safe(value) {
      if (value === null || value === undefined || value === "") return "â€“";
      return String(value);
    }

    function getPlanClass(planStatus) {
      switch (planStatus) {
        case "live":
          return "live";
        case "trial":
          return "trial";
        case "cancelled":
          return "cancelled";
        case "paused":
          return "pending";
        default:
          return "pending";
      }
    }

    function applyFilters() {
      const planFilter = filterPlanEl.value;
      const accountFilter = filterAccountEl.value;
      const tradeFilter = filterTradeEl.value;
      const search = filterSearchEl.value.trim().toLowerCase();

      filteredSignups = allSignups.filter((row) => {
        if (planFilter !== "all") {
          if ((row.plan_status || "") !== planFilter) return false;
        }
        if (accountFilter !== "all") {
          if ((row.account_status || "") !== accountFilter) return false;
        }
        if (tradeFilter !== "all") {
          const t = (row.trade_type || "").toLowerCase();
          if (tradeFilter === "plumbing_heating" && !t.includes("plumb")) return false;
          if (tradeFilter === "heating_only" && !t.includes("heat")) return false;
          if (tradeFilter === "general_plumbing" && !t.includes("plumb")) return false; // simple heuristic
          if (tradeFilter === "other" && (t.includes("plumb") || t.includes("heat"))) return false;
        }

        if (search) {
          const haystack =
            (row.business_name || "") +
            " " +
            (row.owner_name || "") +
            " " +
            (row.contact_name || "") +
            " " +
            (row.email || "") +
            " " +
            (row.base_postcode || "");
          if (!haystack.toLowerCase().includes(search)) return false;
        }

        return true;
      });

      renderTable();
    }

    function renderMetrics() {
      const total = allSignups.length;
      const pendingSetup = allSignups.filter((r) => (r.pending_setup || "") !== "" && (r.pending_setup || "") !== "complete").length;
      const live = allSignups.filter((r) => r.plan_status === "live").length;
      const trial = allSignups.filter((r) => r.plan_status === "trial").length;

      metricTotalEl.textContent = total;
      metricPendingEl.textContent = pendingSetup;
      metricLiveEl.textContent = live;
      metricTrialEl.textContent = trial;
    }

    function renderTable() {
      signupsBodyEl.innerHTML = "";

      filteredSignups.forEach((row) => {
        const tr = document.createElement("tr");
        tr.dataset.id = row.id;

        if (String(row.id) === String(selectedSignupId)) {
          tr.classList.add("selected");
        }

        // Business & contact
        const tdBiz = document.createElement("td");
        const biz = safe(row.business_name);
        const contact = safe(row.contact_name);
        const email = safe(row.email);
        tdBiz.innerHTML =
          `<strong>${biz}</strong><br>` +
          `<span class="small-hint">${contact !== "â€“" ? contact : ""}${contact !== "â€“" && email !== "â€“" ? " Â· " : ""}${email !== "â€“" ? email : ""}</span>`;
        tr.appendChild(tdBiz);

        // Trade
        const tdTrade = document.createElement("td");
        tdTrade.textContent = safe(row.trade_type);
        tr.appendChild(tdTrade);

        // Postcode
        const tdPost = document.createElement("td");
        tdPost.textContent = safe(row.base_postcode);
        tr.appendChild(tdPost);

        // Plan
        const tdPlan = document.createElement("td");
        const planStatus = row.plan_status || "";
        const planLabel = planStatus ? planStatus.replace("_", " ") : "no plan";
        const planClass = getPlanClass(planStatus);
        tdPlan.innerHTML = `<span class="status-pill ${planClass}">${planLabel}</span>`;
        tr.appendChild(tdPlan);

        // Setup
        const tdSetup = document.createElement("td");
        tdSetup.textContent = safe(row.pending_setup);
        tr.appendChild(tdSetup);

        // Account
        const tdAccount = document.createElement("td");
        const accStatus = row.account_status || "";
        tdAccount.textContent = accStatus || "â€“";
        tr.appendChild(tdAccount);

        tr.addEventListener("click", () => {
          selectRow(row.id);
        });

        signupsBodyEl.appendChild(tr);
      });

      renderMetrics();
    }

    function selectRow(id) {
      selectedSignupId = id;

      // highlight selected row
      Array.from(signupsBodyEl.querySelectorAll("tr")).forEach((tr) => {
        tr.classList.toggle("selected", tr.dataset.id === String(id));
      });

      const row = allSignups.find((r) => String(r.id) === String(id));
      if (!row) return;

      detailEmptyEl.style.display = "none";
      detailPanelEl.style.display = "block";

      detailBusinessEl.textContent = safe(row.business_name);
      detailTradeEl.textContent = safe(row.trade_type);
      detailContactEl.textContent = safe(row.contact_name);
      detailOwnerEl.textContent = safe(row.owner_name);
      detailPostcodeEl.textContent = safe(row.base_postcode);
      detailWebsiteEl.textContent = safe(row.website_url);
      detailEmailEl.textContent = safe(row.email);
      detailPhoneEl.textContent = safe(row.phone || row.whatsapp_number);

      detailPlanStatusEl.value = row.plan_status || "";
      detailPendingSetupEl.value = row.pending_setup || "";
      detailAccountStatusEl.value = row.account_status || "";
      detailAccountReasonEl.value = row.account_status_reason || "";

      detailCalloutEl.textContent = formatMoney(row.callout_fee);
      detailFirstHourEl.textContent = formatMoney(row.first_hour_rate);
      detailHourlyRateEl.textContent = formatMoney(row.hourly_rate);
      detailBoilerEl.textContent = formatMoney(row.boiler_service_from);
      detailQuoteMinEl.textContent = formatMoney(row.quote_minimum);

      detailServicesEl.textContent = safe(row.services_summary);
      detailAiNotesEl.textContent = safe(row.ai_style_notes);

      detailCreatedAtEl.textContent = row.created_at || "â€“";
      detailIdEl.textContent = row.id || "â€“";

      // reset messaging
      messageTemplateEl.value = "";
      messageBodyEl.value = "";
    }

    async function loadSignups() {
      tableLoadingEl.style.display = "block";
      tableErrorEl.style.display = "none";

      try {
        const { data, error } = await supabase
          .from("tradebotpro_signups")
          .select("*")
          .order("created_at", { ascending: false });

        if (error) {
          console.error("Error loading signups:", error);
          tableErrorEl.style.display = "block";
          tableLoadingEl.style.display = "none";
          return;
        }

        allSignups = data || [];
        filteredSignups = [...allSignups];
        tableLoadingEl.style.display = "none";

        applyFilters(); // will call renderTable
      } catch (err) {
        console.error("Network / fetch error:", err);
        tableErrorEl.style.display = "block";
        tableLoadingEl.style.display = "none";
      }
    }

    async function saveStatus() {
      if (!selectedSignupId || isSavingStatus) return;

      isSavingStatus = true;
      btnSaveStatusEl.disabled = true;
      statusSaveHintEl.textContent = "Saving changesâ€¦";

      const updates = {
        plan_status: detailPlanStatusEl.value || null,
        pending_setup: detailPendingSetupEl.value || null,
        account_status: detailAccountStatusEl.value || null,
        account_status_reason: detailAccountReasonEl.value || null
      };

      try {
        const { error } = await supabase
          .from("tradebotpro_signups")
          .update(updates)
          .eq("id", selectedSignupId);

        if (error) {
          console.error("Error updating status:", error);
          statusSaveHintEl.textContent = "Error saving â€“ see console.";
        } else {
          statusSaveHintEl.textContent = "Saved. Refreshing listâ€¦";
          await loadSignups();
          // reselect the same signup after refresh
          if (selectedSignupId) {
            selectRow(selectedSignupId);
          }
          statusSaveHintEl.textContent = "Changes saved.";
        }
      } catch (err) {
        console.error("Network / save error:", err);
        statusSaveHintEl.textContent = "Network error â€“ see console.";
      } finally {
        isSavingStatus = false;
        btnSaveStatusEl.disabled = false;
        setTimeout(() => {
          statusSaveHintEl.textContent = "Changes save to Supabase & refresh the list.";
        }, 2500);
      }
    }

    function applyMessageTemplate() {
      if (!selectedSignupId) {
        alert("Select a signup first.");
        messageTemplateEl.value = "";
        return;
      }

      const row = allSignups.find((r) => String(r.id) === String(selectedSignupId));
      const biz = row ? row.business_name || "there" : "there";
      const template = messageTemplateEl.value;

      let text = "";

      switch (template) {
        case "welcome_trial":
          text =
            `Hi ${biz}, thanks for signing up to TradeBotPro ðŸ‘‹\n\n` +
            `You're now in a trial period while we get your AI office set up. ` +
            `We'll confirm your call-out pricing, service areas and the tone of voice for your assistant before going live.\n\n` +
            `If anything changes in the meantime, just reply to this message.`;
          break;
        case "setup_call":
          text =
            `Hi ${biz}, itâ€™s TradeBotPro here.\n\n` +
            `We just need a quick setup call to finish configuring your AI office â€“ ` +
            `things like service radius, pricing and how youâ€™d like us to respond to common questions.\n\n` +
            `Reply with a couple of times that work for you and weâ€™ll get you booked in.`;
          break;
        case "go_live":
          text =
            `Hi ${biz}, great news â€” your TradeBotPro AI office is now live âœ…\n\n` +
            `New enquiries will be handled 24/7. Weâ€™ll keep an eye on the first few conversations and tune the assistant where needed.\n\n` +
            `If youâ€™d like any changes to pricing, wording or availability, just let us know.`;
          break;
        case "break":
          text =
            `Hi ${biz}, totally understand you might want to slow things down.\n\n` +
            `Instead of cancelling outright, we can pause your TradeBotPro subscription for a month ` +
            `so you donâ€™t lose your setup. You wonâ€™t be billed during a pause.\n\n` +
            `Would you like us to pause you, or keep things running as they are?`;
          break;
        default:
          text = "";
      }

      messageBodyEl.value = text;
    }

    async function copyMessage() {
      const text = messageBodyEl.value.trim();
      if (!text) {
        alert("Nothing to copy yet â€“ choose a template or type a message first.");
        return;
      }

      try {
        await navigator.clipboard.writeText(text);
        alert("Message copied. Paste into WhatsApp, email or SMS.");
      } catch (err) {
        console.error("Clipboard error:", err);
        alert("Could not copy to clipboard â€“ you can still select and copy manually.");
      }
    }

    function clearMessage() {
      messageTemplateEl.value = "";
      messageBodyEl.value = "";
    }

    // Event wiring
    filterPlanEl.addEventListener("change", applyFilters);
    filterAccountEl.addEventListener("change", applyFilters);
    filterTradeEl.addEventListener("change", applyFilters);
    filterSearchEl.addEventListener("input", applyFilters);

    btnRefreshEl.addEventListener("click", () => {
      loadSignups();
    });

    btnSaveStatusEl.addEventListener("click", saveStatus);
    messageTemplateEl.addEventListener("change", applyMessageTemplate);
    btnCopyMessageEl.addEventListener("click", copyMessage);
    btnClearMessageEl.addEventListener("click", clearMessage);

    // Initial load
    loadSignups();
  </script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>TradeBotPro — Secure Client Dashboard</title>

  <style>
    :root{
      --primary:#1f4e79;
      --bg:#f3f4f9;
      --text:#151820;
      --muted:#6b7280;
      --border:rgba(15,23,42,.12);
      --err:#b3261e;
      --ok:#0f7b46;
      --white:#ffffff;
    }

    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
    }

    header{
      background:var(--white);
      border-bottom:1px solid var(--border);
    }

    .inner{
      max-width:1100px;
      margin:0 auto;
      padding:14px 18px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
    }

    .brand{font-weight:900}
    .muted{color:var(--muted)}

    .btn{
      border-radius:999px;
      padding:10px 14px;
      border:1px solid var(--border);
      background:#fff;
      font-weight:800;
      cursor:pointer;
    }

    .btnPrimary{
      background:var(--primary);
      color:#fff;
      border-color:transparent;
    }

    main{
      max-width:1100px;
      margin:0 auto;
      padding:18px;
    }

    .card{
      background:#fff;
      border:1px solid var(--border);
      border-radius:16px;
      padding:18px;
      box-shadow:0 20px 50px rgba(15,23,42,.10);
    }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }

    .pill{
      display:inline-flex;
      padding:6px 10px;
      border-radius:999px;
      font-weight:900;
      border:1px solid var(--border);
      background:#f8fafc;
    }

    #err{
      margin-top:12px;
      color:var(--err);
      font-weight:900;
      white-space:pre-wrap;
    }

    #ok{
      margin-top:12px;
      color:var(--ok);
      font-weight:900;
    }

    #instructions{
      margin-top:14px;
      font-size:14px;
      line-height:1.55;
      color:var(--muted);
    }

    #instructions ol{
      margin:8px 0 0 18px;
      padding:0;
    }

    #instructions a{
      color:var(--primary);
      font-weight:900;
      text-decoration:none;
    }
  </style>
</head>

<body>

<header>
  <div class="inner">
    <div>
      <div class="brand">TradeBotPro</div>
      <div class="muted">Secure Client Dashboard</div>
    </div>
    <div class="row">
      <button id="btnLogin" class="btn btnPrimary" type="button" style="display:none">
        Go to customer login
      </button>
      <button id="btnLogout" class="btn" type="button">
        Logout
      </button>
    </div>
  </div>
</header>

<main>
  <div class="card">

    <div class="row">
      <div>
        <h2 id="biz" style="margin:0 0 6px">Secure dashboard</h2>
        <div id="who" class="muted"></div>
      </div>
      <div id="status" class="pill">Status: —</div>
    </div>

    <div id="instructions">
      <strong>Why do I need to verify my email?</strong><br>
      This dashboard contains private business information.  
      To protect your data, TradeBotPro only shows it after your email address is verified.
      <ol>
        <li>Go to <a href="customer-login.html">Customer Login</a></li>
        <li>Enter the <strong>same email</strong> you used when signing up</li>
        <li>Click <strong>Send secure link</strong></li>
        <li>Open the email and click the link — this verifies your email and signs you in</li>
      </ol>
      If you don’t see the email, please check spam or junk and request a new link.
    </div>

    <div id="ok"></div>
    <div id="err"></div>

  </div>
</main>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  const SUPABASE_URL = "https://yaiutswdcbfwkxfqxkzy.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlhaXV0c3dkY2Jmd2t4ZnF4a3p5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1MDE2MDgsImV4cCI6MjA4MDA3NzYwOH0.HOLFxzjsZ5Ieqg0b-aTdP0hAdLsPVXL6Zjs-HgOHgc8";
  const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const biz = document.getElementById("biz");
  const who = document.getElementById("who");
  const status = document.getElementById("status");
  const errEl = document.getElementById("err");
  const okEl = document.getElementById("ok");
  const btnLogin = document.getElementById("btnLogin");
  const btnLogout = document.getElementById("btnLogout");

  function setErr(t){ errEl.textContent = t || ""; }
  function setOk(t){ okEl.textContent = t || ""; }

  btnLogin.onclick = () => location.href = "customer-login.html";
  btnLogout.onclick = async () => {
    await sb.auth.signOut();
    location.href = "customer-login.html";
  };

  async function exchangeCodeIfPresent(){
    const url = new URL(location.href);
    if (url.searchParams.get("code")) {
      const { error } = await sb.auth.exchangeCodeForSession(location.href);
      if (error) throw error;
      url.searchParams.delete("code");
      history.replaceState({}, "", url.toString());
    }
  }

  async function linkAuthUser(user){
    const email = (user?.email || "").toLowerCase();
    if (!email) return;

    const { data: cust } = await sb
      .from("customers")
      .select("id, auth_user_id")
      .eq("email", email)
      .single();

    if (cust && !cust.auth_user_id) {
      await sb
        .from("customers")
        .update({ auth_user_id: user.id })
        .eq("id", cust.id);
    }
  }

  async function boot(){
    try{
      await exchangeCodeIfPresent();

      const { data: { user } } = await sb.auth.getUser();

      if (!user) {
        biz.textContent = "Secure dashboard";
        who.textContent = "You are not logged in yet.";
        btnLogin.style.display = "";
        btnLogout.style.display = "none";
        return;
      }

      const confirmed = user.email_confirmed_at || user.confirmed_at;
      if (!confirmed) {
        biz.textContent = "Email verification required";
        who.textContent = "Please verify your email to access your dashboard.";
        btnLogin.style.display = "";
        setOk("Request a secure login link to verify your email.");
        return;
      }

      await linkAuthUser(user);

      const { data, error } = await sb
        .from("customers")
        .select("business_name, contact_name, email, signup_status")
        .eq("auth_user_id", user.id)
        .single();

      if (error) throw error;

      biz.textContent = data.business_name || "Your business";
      who.textContent = [data.contact_name, data.email].filter(Boolean).join(" • ");
      status.textContent = "Status: " + (data.signup_status || "—");
      setOk("Secure access confirmed ✔");

    } catch (e){
      console.error("[TBP] Secure dashboard error:", e);
      setErr(e.message || "Failed to load secure dashboard.");
    }
  }

  boot();
</script>

</body>
</html>

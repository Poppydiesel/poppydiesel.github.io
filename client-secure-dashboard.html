<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  const SUPABASE_URL = "https://yaiutswdcbfwkxfqxkzy.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlhaXV0c3dkY2Jmd2t4ZnF4a3p5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1MDE2MDgsImV4cCI6MjA4MDA3NzYwOH0.HOLFxzjsZ5Ieqg0b-aTdP0hAdLsPVXL6Zjs-HgOHgc8";
  const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const biz = document.getElementById("biz");
  const who = document.getElementById("who");
  const status = document.getElementById("status");
  const errEl = document.getElementById("err");

  function setErr(t){
    if (!errEl) return;
    errEl.textContent = t || "";
  }

  document.getElementById("btnLogout").addEventListener("click", async () => {
    await sb.auth.signOut();
    location.href = "customer-login.html";
  });

  async function linkAuthUserToCustomerByEmail(user){
    const email = (user?.email || "").trim().toLowerCase();
    if (!email) return;

    // Find customer by email
    const { data: cust, error: findErr } = await sb
      .from("customers")
      .select("id, auth_user_id")
      .eq("email", email)
      .single();

    if (findErr || !cust) return;

    // If not linked, link it once
    if (!cust.auth_user_id) {
      const { error: upErr } = await sb
        .from("customers")
        .update({ auth_user_id: user.id })
        .eq("id", cust.id);

      if (upErr) console.warn("[TBP] link auth_user_id failed:", upErr);
    }
  }

  async function boot(){
    // Ensure session exists
    const { data: { user } } = await sb.auth.getUser();
    if (!user) {
      location.href = "customer-login.html";
      return;
    }

    // First login: attempt linking by email
    await linkAuthUserToCustomerByEmail(user);

    // Load customer by auth_user_id
    const { data, error } = await sb
      .from("customers")
      .select("business_name, contact_name, email, signup_status, demo_status, trial_status, plan_status")
      .eq("auth_user_id", user.id)
      .single();

    if (error) {
      console.error("[TBP] secure dashboard load error:", error);
      setErr(error.message || "Failed to load customer record.");
      if (biz) biz.textContent = "Could not load";
      return;
    }

    if (biz) biz.textContent = data.business_name || "Your business";
    if (who) who.textContent = [data.contact_name, data.email].filter(Boolean).join(" • ");
    if (status) status.textContent = "Status: " + (data.signup_status || "—");
    setErr("");
  }

  boot();
</script>
</body>
</html>

</body>
</html>
